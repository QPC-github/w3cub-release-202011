
<!DOCTYPE HTML>

<html lang="en" class="_theme-default">

<head>
  <meta charset="utf-8">
  <title>Force_balance_tags() - WordPress - W3cubDocs</title>
  
  <meta name="description" content=" Balances tags of string using a modified stack. ">
  <meta name="keywords" content="force, balance, tags, string, &#36;text, wordpress">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="mobile-web-app-capable" content="yes">
  
  <link rel="canonical" href="https://docs.w3cub.com/wordpress/functions/force_balance_tags.html">
  <link href="/favicon.png" rel="icon">
  <link rel="stylesheet" type="text/css" href="/assets/application-e498cd0ebe8746846fec95b1a53ab3bb0fb7f47f794f0a38f44c98a1f0d03b21d777ae2c583732e44a5a890f6eacb79a5333545db9d5f3616091ba21ca17d916.css">
  <script src="/assets/application-79c555f6b25481fffac2cac30a7f3e54e608ca09e9e8e42bb1790095ba6d0fcace47d6bc624ddce952c70370892f2d46864f89e6943d4f7f7ff16c8a3231a91a.js" type="text/javascript"></script>
  <script src="/json/wordpress.js"></script>
  
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-R3WC07G3GB"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-R3WC07G3GB');
</script>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2572770204602497"
     crossorigin="anonymous"></script>
<script async custom-element="amp-auto-ads"
  src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
</script>


</head>

<body class="docs">
	<amp-auto-ads type="adsense"
              data-ad-client="ca-pub-2572770204602497">
	</amp-auto-ads>
	<div class="_app">
	<header class="_header">

  <a class="_home-link" href="/" ></a>
  <a class="_menu-link"></a>
  <h1 class="_logo">
    <a href="/" class="_nav-link" title="API Documentation Browser">W3cubDocs</a>
  </h1>
  
  <span class="_logo-sub-nav">/</span><span class="_logo-sub-nav"><a href="/wordpress/" class="_nav-link" title="" style="margin-left:0;">WordPress</a></span>
  
  <nav class="_nav">
    <a href="https://tools.w3cub.com/?_sp=docs" target="_blank" class="_nav-link ">W3cubTools</a>
    <a href="/cheatsheets/" class="_nav-link ">Cheatsheets</a>
    <a href="/about/" class="_nav-link ">About</a>
  </nav>
</header>
	<section class="_sidebar">
		
		<form class="_search">
		  <input type="search" class="_search-input" placeholder="Search&hellip;" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" maxlength="20">
		  <a class="_search-clear"></a>
		  <div class="_search-tag"></div>
		</form>
		
		<div class="_list-wrap">
			<div class="_list">
			
			</div>
		</div>
	</section>
	<section class="_container ">
		<div class="_content">
			<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-2572770204602497"
     data-ad-slot="6861657091"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
			<div class="_page _wordpress">
				
				
<h1>force_balance_tags( string $text )</h1>  <section class="summary"> <p>Balances tags of string using a modified stack.</p> </section> <div class="content-toc">  <section class="parameters"> <h2 class="toc-heading" id="parameters" tabindex="-1">Parameters </h2> <dl> <dt>$text</dt> <dd> <p class="desc"> <span class="type">(<span class="string">string</span>)</span> <span class="required">(Required)</span> <span class="description">Text to be balanced.</span> </p> </dd> </dl> </section>  <section class="return"> <h2 class="toc-heading" id="return" tabindex="-1">Return </h2> <p><span class="return-type">(string)</span> Balanced text.</p> </section>  <section class="explanation"> <h2 class="toc-heading" id="more-information" tabindex="-1">More Information </h2> <h5>Usage:</h5> <pre class="brush: php; title: ; notranslate" title="" data-language="php">&lt;?php $balanced_text = force_balance_tags( $text ); ?&gt;</pre> <p>This function is used in the short post excerpt list, to prevent unmatched elements. For example, it makes</p> <pre class="brush: php; title: ; notranslate" title="" data-language="php">&lt;div&gt;&lt;b&gt;This is an excerpt. &lt;!--more--&gt; and this is more text... &lt;/b&gt;&lt;/div&gt;</pre> <p>not break, when the html after the more tag is cut off. </p> <pre class="brush: php; title: ; notranslate" title="" data-language="php">&lt;div&gt;&lt;b&gt;This is an excerpt.</pre> <p>should be changed to:</p> <pre class="brush: php; title: ; notranslate" title="" data-language="php">&lt;div&gt;&lt;b&gt;This is an excerpt. &lt;/b&gt;&lt;/div&gt;</pre> <p>by the <code>force_balance_tags</code> function.</p> <h5>Notes:</h5> <ul> <li>Ignores the ‘<code>use_balanceTags</code>‘ option.</li> <li>This function is not used for all WP pages due to bugs and performance issues. This function doesn’t use an HTML parser but some potentially expensive regular expressions. This function shall only be used if the length of the excerpt can be controlled; otherwise memory issues or some <a href="https://core.trac.wordpress.org/ticket/19855">obscure bugs</a> can occur.</li> <li>This function uses two hard-coded lists of elements for single tags and nestable tags. WordPress uses multiple such lists and the lists not kept in sync. If an element isn’t part of these lists or changed its nesting behavior, it may lead to incorrect markup.</li> </ul> </section>  <section class="source-content"> <h2 class="toc-heading" id="source" tabindex="-1">Source </h2> <p> File: <a href="https://developer.wordpress.org/reference/files/wp-includes/formatting.php/">wp-includes/formatting.php</a> </p> <pre class="source-code-container" data-language="php">function force_balance_tags( $text ) {
	$tagstack  = array();
	$stacksize = 0;
	$tagqueue  = '';
	$newtext   = '';
	// Known single-entity/self-closing tags.
	$single_tags = array( 'area', 'base', 'basefont', 'br', 'col', 'command', 'embed', 'frame', 'hr', 'img', 'input', 'isindex', 'link', 'meta', 'param', 'source' );
	// Tags that can be immediately nested within themselves.
	$nestable_tags = array( 'blockquote', 'div', 'object', 'q', 'span' );

	// WP bug fix for comments - in case you REALLY meant to type '&lt; !--'.
	$text = str_replace( '&lt; !--', '&lt;    !--', $text );
	// WP bug fix for LOVE &lt;3 (and other situations with '&lt;' before a number).
	$text = preg_replace( '#&lt;([0-9]{1})#', '&amp;lt;$1', $text );

	/**
	 * Matches supported tags.
	 *
	 * To get the pattern as a string without the comments paste into a PHP
	 * REPL like `php -a`.
	 *
	 * @see https://html.spec.whatwg.org/#elements-2
	 * @see https://w3c.github.io/webcomponents/spec/custom/#valid-custom-element-name
	 *
	 * @example
	 * ~# php -a
	 * php &gt; $s = [paste copied contents of expression below including parentheses];
	 * php &gt; echo $s;
	 */
	$tag_pattern = (
		'#&lt;' . // Start with an opening bracket.
		'(/?)' . // Group 1 - If it's a closing tag it'll have a leading slash.
		'(' . // Group 2 - Tag name.
			// Custom element tags have more lenient rules than HTML tag names.
			'(?:[a-z](?:[a-z0-9._]*)-(?:[a-z0-9._-]+)+)' .
				'|' .
			// Traditional tag rules approximate HTML tag names.
			'(?:[\w:]+)' .
		')' .
		'(?:' .
			// We either immediately close the tag with its '&gt;' and have nothing here.
			'\s*' .
			'(/?)' . // Group 3 - "attributes" for empty tag.
				'|' .
			// Or we must start with space characters to separate the tag name from the attributes (or whitespace).
			'(\s+)' . // Group 4 - Pre-attribute whitespace.
			'([^&gt;]*)' . // Group 5 - Attributes.
		')' .
		'&gt;#' // End with a closing bracket.
	);

	while ( preg_match( $tag_pattern, $text, $regex ) ) {
		$full_match        = $regex[0];
		$has_leading_slash = ! empty( $regex[1] );
		$tag_name          = $regex[2];
		$tag               = strtolower( $tag_name );
		$is_single_tag     = in_array( $tag, $single_tags, true );
		$pre_attribute_ws  = isset( $regex[4] ) ? $regex[4] : '';
		$attributes        = trim( isset( $regex[5] ) ? $regex[5] : $regex[3] );
		$has_self_closer   = '/' === substr( $attributes, -1 );

		$newtext .= $tagqueue;

		$i = strpos( $text, $full_match );
		$l = strlen( $full_match );

		// Clear the shifter.
		$tagqueue = '';
		if ( $has_leading_slash ) { // End tag.
			// If too many closing tags.
			if ( $stacksize &lt;= 0 ) {
				$tag = '';
				// Or close to be safe $tag = '/' . $tag.

				// If stacktop value = tag close value, then pop.
			} elseif ( $tagstack[ $stacksize - 1 ] === $tag ) { // Found closing tag.
				$tag = '&lt;/' . $tag . '&gt;'; // Close tag.
				array_pop( $tagstack );
				$stacksize--;
			} else { // Closing tag not at top, search for it.
				for ( $j = $stacksize - 1; $j &gt;= 0; $j-- ) {
					if ( $tagstack[ $j ] === $tag ) {
						// Add tag to tagqueue.
						for ( $k = $stacksize - 1; $k &gt;= $j; $k-- ) {
							$tagqueue .= '&lt;/' . array_pop( $tagstack ) . '&gt;';
							$stacksize--;
						}
						break;
					}
				}
				$tag = '';
			}
		} else { // Begin tag.
			if ( $has_self_closer ) { // If it presents itself as a self-closing tag...
				// ...but it isn't a known single-entity self-closing tag, then don't let it be treated as such
				// and immediately close it with a closing tag (the tag will encapsulate no text as a result).
				if ( ! $is_single_tag ) {
					$attributes = trim( substr( $attributes, 0, -1 ) ) . "&gt;&lt;/$tag";
				}
			} elseif ( $is_single_tag ) { // Else if it's a known single-entity tag but it doesn't close itself, do so.
				$pre_attribute_ws = ' ';
				$attributes      .= '/';
			} else { // It's not a single-entity tag.
				// If the top of the stack is the same as the tag we want to push, close previous tag.
				if ( $stacksize &gt; 0 &amp;&amp; ! in_array( $tag, $nestable_tags, true ) &amp;&amp; $tagstack[ $stacksize - 1 ] === $tag ) {
					$tagqueue = '&lt;/' . array_pop( $tagstack ) . '&gt;';
					$stacksize--;
				}
				$stacksize = array_push( $tagstack, $tag );
			}

			// Attributes.
			if ( $has_self_closer &amp;&amp; $is_single_tag ) {
				// We need some space - avoid &lt;br/&gt; and prefer &lt;br /&gt;.
				$pre_attribute_ws = ' ';
			}

			$tag = '&lt;' . $tag . $pre_attribute_ws . $attributes . '&gt;';
			// If already queuing a close tag, then put this tag on too.
			if ( ! empty( $tagqueue ) ) {
				$tagqueue .= $tag;
				$tag       = '';
			}
		}
		$newtext .= substr( $text, 0, $i ) . $tag;
		$text     = substr( $text, $i + $l );
	}

	// Clear tag queue.
	$newtext .= $tagqueue;

	// Add remaining text.
	$newtext .= $text;

	while ( $x = array_pop( $tagstack ) ) {
		$newtext .= '&lt;/' . $x . '&gt;'; // Add remaining tags to close.
	}

	// WP fix for the bug with HTML comments.
	$newtext = str_replace( '&lt; !--', '&lt;!--', $newtext );
	$newtext = str_replace( '&lt;    !--', '&lt; !--', $newtext );

	return $newtext;
}</pre>  </section>  <section class="related"> <h2 class="toc-heading" id="related" tabindex="-1">Related </h2> <article class="used-by"> <h3 class="toc-heading" id="used-by" tabindex="-1">Used By </h3> <table id="used-by-table">  <thead> <tr> <th>Used By</th> <th class="related-desc">Description</th> </tr> </thead> <tbody> <tr> <td> <span>wp-includes/formatting.php:</span> <a href="balancetags">balanceTags()</a> </td> <td class="related-desc"> <p>Balances tags if forced to, or if the ‘use_balanceTags’ option is set to true.</p> </td> </tr> <tr> <td> <span>wp-includes/post-template.php:</span> <a href="get_the_content">get_the_content()</a> </td> <td class="related-desc"> <p>Retrieve the post content.</p> </td> </tr> </tbody>

</table> </article> </section>  <section class="changelog"> <h2 class="toc-heading" id="changelog" tabindex="-1">Changelog </h2> <table>  <thead> <tr> <th class="changelog-version">Version</th> <th class="changelog-desc">Description</th> </tr> </thead> <tbody> <tr> <td><a href="https://developer.wordpress.org/reference/since/5.3.0/" alt="WordPress 5.3.0">5.3.0</a></td> <td><span class="since-description">Improve accuracy and add support for custom element tags.</span></td> </tr> <tr> <td><a href="https://developer.wordpress.org/reference/since/2.0.4/" alt="WordPress 2.0.4">2.0.4</a></td> <td>Introduced.</td> </tr> </tbody> </table> </section>   </div>
<div class="_attribution">
  <p class="_attribution-p">
    © 2003–2019 WordPress Foundation<br>Licensed under the GNU GPLv2+ License.<br>
    <a href="https://developer.wordpress.org/reference/functions/force_balance_tags" class="_attribution-link">https://developer.wordpress.org/reference/functions/force_balance_tags</a>
  </p>
</div>

				
			</div>
			<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-2572770204602497"
     data-ad-slot="1992473792"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
		</div>
	</section>

	</div>
	<svg style="display:none">
		<symbol id="icon-dir"><svg viewBox="0 0 20 20"><path d="M15 10c0 .3-.305.515-.305.515l-8.56 5.303c-.625.41-1.135.106-1.135-.67V4.853c0-.777.51-1.078 1.135-.67l8.56 5.305S15 9.702 15 10z"/></svg></symbol>
	  </svg>
</body>
</html>
