
<!DOCTYPE HTML>

<html lang="en" class="_theme-default">

<head>
  <meta charset="utf-8">
  <title>Recipes - Chef 12 - W3cubDocs</title>
  
  <meta name="description" content=" A recipe is the most fundamental configuration element within the organization. A recipe&#58; ">
  <meta name="keywords" content="about, recipes, chef, chef~12">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="mobile-web-app-capable" content="yes">
  
  <link rel="canonical" href="https://docs.w3cub.com/chef~12/12-13/recipes.html">
  <link href="/favicon.png" rel="icon">
  <link rel="stylesheet" type="text/css" href="/assets/application-01fda2ddb8339756caccf7add5ad4cf849ab52d069bd799015c7f04f93164f64753bff0d15a49d8060b1e66e41002bb301ccadc2350937df079cea3cd52d3cca.css">
  <script src="/assets/application-d9be6f56a823612443fc15b2e027a630e02c4ad2685bb750d13fa4fae28d46c3e7f7ebb69bd4bafddf116f218f9372e9be44021d4247dc20424e2fd1ff8cef81.js" type="text/javascript"></script>
  <script src="/json/chef~12.js"></script>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-71174418-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>
  <script data-ad-client="ca-pub-2572770204602497" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script async custom-element="amp-auto-ads"
  src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
</script>


</head>

<body class="docs">
	<amp-auto-ads type="adsense"
              data-ad-client="ca-pub-2572770204602497">
	</amp-auto-ads>
	<div class="_app">
	<header class="_header">

  <a class="_home-link" href="/" ></a>
  <a class="_menu-link"></a>
  <h1 class="_logo">
    <a href="/" class="_nav-link" title="API Documentation Browser">W3cubDocs</a>
  </h1>
  
  <span class="_logo-sub-nav">/</span><span class="_logo-sub-nav"><a href="/chef~12/" class="_nav-link" title="" style="margin-left:0;">Chef 12</a></span>
  
  <nav class="_nav">
    <a href="https://tools.w3cub.com/?_sp=docs" target="_blank" class="_nav-link ">W3cubTools</a>
    <a href="/cheatsheets/" class="_nav-link ">Cheatsheets</a>
    <a href="/about/" class="_nav-link ">About</a>
  </nav>
</header>
	<section class="_sidebar">
		
		<form class="_search">
		  <input type="search" class="_search-input" placeholder="Search&hellip;" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" maxlength="20">
		  <a class="_search-clear"></a>
		  <div class="_search-tag"></div>
		</form>
		
		<div class="_list-wrap">
			<div class="_list">
			
			</div>
		</div>
	</section>
	<section class="_container ">
		<div class="_content">
			<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-2572770204602497"
     data-ad-slot="6861657091"
     data-ad-format="link"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
			<div class="_page _sphinx_simple">
				
				
<h1 id="about-recipes">About Recipes</h1> <p>A recipe is the most fundamental configuration element within the organization. A recipe:</p> <ul class="simple"> <li>Is authored using Ruby, which is a programming language designed to read and behave in a predictable manner</li> <li>Is mostly a collection of resources, defined using patterns (resource names, attribute-value pairs, and actions); helper code is added around this using Ruby, when needed</li> <li>Must define everything that is required to configure part of a system</li> <li>Must be stored in a cookbook</li> <li>May be included in a recipe</li> <li>May use the results of a search query and read the contents of a data bag (including an encrypted data bag)</li> <li>May have a dependency on one (or more) recipes</li> <li>May tag a node to facilitate the creation of arbitrary groupings</li> <li>Must be added to a run-list before it can be used by the chef-client</li> <li>Is always executed in the same order as listed in a run-list</li> </ul>  <h2 id="recipe-attributes">Recipe Attributes</h2> <p>An attribute can be defined in a cookbook (or a recipe) and then used to override the default settings on a node. When a cookbook is loaded during a chef-client run, these attributes are compared to the attributes that are already present on the node. Attributes that are defined in attribute files are first loaded according to cookbook order. For each cookbook, attributes in the <code class="docutils literal">default.rb</code> file are loaded first, and then additional attribute files (if present) are loaded in lexical sort order. When the cookbook attributes take precedence over the default attributes, the chef-client will apply those new settings and values during the chef-client run on the node.</p> <div class="admonition note"> <p class="first admonition-title">Note</p> <p class="last">Attributes can be configured in cookbooks (attribute files and recipes), roles, and environments. In addition, Ohai collects attribute data about each node at the start of the chef-client run. See <a class="reference external" href="https://docs.chef.io/attributes.html">https://docs.chef.io/attributes.html</a> for more information about how all of these attributes fit together.</p> </div>  <h3 id="attribute-types">Attribute Types</h3> <p>The chef-client uses six types of attributes to determine the value that is applied to a node during the chef-client run. In addition, the chef-client sources attribute values from up to five locations. The combination of attribute types and sources allows for up to 15 different competing values to be available to the chef-client during the chef-client run:</p> <table class="docutils"> <colgroup> <col width="40%"> <col width="60%"> </colgroup> <thead valign="bottom"> <tr class="row-odd">
<th class="head">Attribute Type</th> <th class="head">Description</th> </tr> </thead> <tbody valign="top"> <tr class="row-even">
<td><code class="docutils literal">default</code></td> <td>A <code class="docutils literal">default</code> attribute is automatically reset at the start of every chef-client run and has the lowest attribute precedence. Use <code class="docutils literal">default</code> attributes as often as possible in cookbooks.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">force_default</code></td> <td>Use the <code class="docutils literal">force_default</code> attribute to ensure that an attribute defined in a cookbook (by an attribute file or by a recipe) takes precedence over a <code class="docutils literal">default</code> attribute set by a role or an environment.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">normal</code></td> <td>A <code class="docutils literal">normal</code> attribute is a setting that persists in the node object. A <code class="docutils literal">normal</code> attribute has a higher attribute precedence than a <code class="docutils literal">default</code> attribute.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">override</code></td> <td>An <code class="docutils literal">override</code> attribute is automatically reset at the start of every chef-client run and has a higher attribute precedence than <code class="docutils literal">default</code>, <code class="docutils literal">force_default</code>, and <code class="docutils literal">normal</code> attributes. An <code class="docutils literal">override</code> attribute is most often specified in a recipe, but can be specified in an attribute file, for a role, and/or for an environment. A cookbook should be authored so that it uses <code class="docutils literal">override</code> attributes only when required.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">force_override</code></td> <td>Use the <code class="docutils literal">force_override</code> attribute to ensure that an attribute defined in a cookbook (by an attribute file or by a recipe) takes precedence over an <code class="docutils literal">override</code> attribute set by a role or an environment.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">automatic</code></td> <td>An <code class="docutils literal">automatic</code> attribute contains data that is identified by Ohai at the beginning of every chef-client run. An <code class="docutils literal">automatic</code> attribute cannot be modified and always has the highest attribute precedence.</td> </tr> </tbody> </table>   <h3 id="attribute-persistence">Attribute Persistence</h3> <p>At the beginning of a chef-client run, all attributes are reset. The chef-client rebuilds them using automatic attributes collected by Ohai at the beginning of the chef-client run and then using default and override attributes that are specified in cookbooks or by roles and environments. Normal attributes are never reset. All attributes are then merged and applied to the node according to attribute precedence. At the conclusion of the chef-client run, the attributes that were applied to the node are saved to the Chef server as part of the node object.</p>   <h3 id="attribute-precedence">Attribute Precedence</h3> <p>Attributes are always applied by the chef-client in the following order:</p> <ol class="arabic simple"> <li>A <code class="docutils literal">default</code> attribute located in a cookbook attribute file</li> <li>A <code class="docutils literal">default</code> attribute located in a recipe</li> <li>A <code class="docutils literal">default</code> attribute located in an environment</li> <li>A <code class="docutils literal">default</code> attribute located in a role</li> <li>A <code class="docutils literal">force_default</code> attribute located in a cookbook attribute file</li> <li>A <code class="docutils literal">force_default</code> attribute located in a recipe</li> <li>A <code class="docutils literal">normal</code> attribute located in a cookbook attribute file</li> <li>A <code class="docutils literal">normal</code> attribute located in a recipe</li> <li>An <code class="docutils literal">override</code> attribute located in a cookbook attribute file</li> <li>An <code class="docutils literal">override</code> attribute located in a recipe</li> <li>An <code class="docutils literal">override</code> attribute located in a role</li> <li>An <code class="docutils literal">override</code> attribute located in an environment</li> <li>A <code class="docutils literal">force_override</code> attribute located in a cookbook attribute file</li> <li>A <code class="docutils literal">force_override</code> attribute located in a recipe</li> <li>An <code class="docutils literal">automatic</code> attribute identified by Ohai at the start of the chef-client run</li> </ol> <p>where the last attribute in the list is the one that is applied to the node.</p> <div class="admonition note"> <p class="first admonition-title">Note</p> <p class="last">The attribute precedence order for roles and environments is reversed for <code class="docutils literal">default</code> and <code class="docutils literal">override</code> attributes. The precedence order for <code class="docutils literal">default</code> attributes is environment, then role. The precedence order for <code class="docutils literal">override</code> attributes is role, then environment. Applying environment <code class="docutils literal">override</code> attributes after role <code class="docutils literal">override</code> attributes allows the same role to be used across multiple environments, yet ensuring that values can be set that are specific to each environment (when required). For example, the role for an application server may exist in all environments, yet one environment may use a database server that is different from other environments.</p> </div> <p>Attribute precedence, viewed from the same perspective as the overview diagram, where the numbers in the diagram match the order of attribute precedence:</p> <img alt="_images/overview_chef_attributes_precedence.png" src="https://docs-archive.chef.io/release/12-13/_images/overview_chef_attributes_precedence.png"> <p>Attribute precedence, when viewed as a table:</p> <img alt="_images/overview_chef_attributes_table.png" src="https://docs-archive.chef.io/release/12-13/_images/overview_chef_attributes_table.png">  <h4 id="whitelist-attributes">Whitelist Attributes</h4> <div class="admonition warning"> <p class="first admonition-title">Warning</p> <p class="last">When these settings are used, any attribute not defined in a whitelist will not be saved. Each attribute type is whitelisted independently of the other attribute types. For example, if <code class="docutils literal">automatic_attribute_whitelist</code> defines attributes to be saved, but <code class="docutils literal">normal_attribute_whitelist</code>, <code class="docutils literal">default_attribute_whitelist</code>, and <code class="docutils literal">override_attribute_whitelist</code> are not defined, then all normal, default and override attributes are saved, along with only the specified automatic attributes.</p> </div> <p>Attributes that should be saved by a node may be whitelisted in the client.rb file. The whitelist is a Hash of keys that specify each attribute to be saved.</p> <p>Attributes are whitelisted by attribute type, with each attribute type being whitelisted independently. Each attribute type—<code class="docutils literal">automatic</code>, <code class="docutils literal">default</code>, <code class="docutils literal">normal</code>, and <code class="docutils literal">override</code>—may define whitelists by using the following settings in the client.rb file:</p> <table class="docutils"> <colgroup> <col width="40%"> <col width="60%"> </colgroup> <thead valign="bottom"> <tr class="row-odd">
<th class="head">Setting</th> <th class="head">Description</th> </tr> </thead> <tbody valign="top"> <tr class="row-even">
<td><code class="docutils literal">automatic_attribute_whitelist</code></td> <td>A Hash that whitelists <code class="docutils literal">automatic</code> attributes, preventing non-whitelisted attributes from being saved. For example: <code class="docutils literal">['network/interfaces/eth0']</code>. Default value: all attributes are saved. If the Hash is empty, no attributes are saved.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">default_attribute_whitelist</code></td> <td>A Hash that whitelists <code class="docutils literal">default</code> attributes, preventing non-whitelisted attributes from being saved. For example: <code class="docutils literal">['filesystem/dev/disk0s2/size']</code>. Default value: all attributes are saved. If the Hash is empty, no attributes are saved.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">normal_attribute_whitelist</code></td> <td>A Hash that whitelists <code class="docutils literal">normal</code> attributes, preventing non-whitelisted attributes from being saved. For example: <code class="docutils literal">['filesystem/dev/disk0s2/size']</code>. Default value: all attributes are saved. If the Hash is empty, no attributes are saved.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">override_attribute_whitelist</code></td> <td>A Hash that whitelists <code class="docutils literal">override</code> attributes, preventing non-whitelisted attributes from being saved. For example: <code class="docutils literal">['map - autohome/size']</code>. Default value: all attributes are saved. If the Hash is empty, no attributes are saved.</td> </tr> </tbody> </table> <div class="admonition warning"> <p class="first admonition-title">Warning</p> <p class="last">It is recommended that only <code class="docutils literal">automatic_attribute_whitelist</code> be used to whitelist attributes. This is primarily because automatic attributes generate the most data, but also that normal, default, and override attributes are typically much more important attributes and are more likely to cause issues if they are whitelisted incorrectly.</p> </div> <p>For example, normal attribute data similar to:</p> <pre class="highlight-javascript" data-language="javascript">{
  "filesystem" =&gt; {
    "/dev/disk0s2" =&gt; {
      "size" =&gt; "10mb"
    },
    "map - autohome" =&gt; {
      "size" =&gt; "10mb"
    }
  },
  "network" =&gt; {
    "interfaces" =&gt; {
      "eth0" =&gt; {...},
      "eth1" =&gt; {...},
    }
  }
}</pre> <p>To whitelist the <code class="docutils literal">network</code> attributes and prevent the other attributes from being saved, update the client.rb file:</p> <pre class="highlight-ruby" data-language="ruby">normal_attribute_whitelist ['network/interfaces/']</pre> <p>When a whitelist is defined, any attribute of that type that is not specified in that attribute whitelist <strong>will not</strong> be saved. So based on the previous whitelist for normal attributes, the <code class="docutils literal">filesystem</code> and <code class="docutils literal">map - autohome</code> attributes will not be saved, but the <code class="docutils literal">network</code> attributes will.</p> <p>Leave the value empty to prevent all attributes of that attribute type from being saved:</p> <pre class="highlight-ruby" data-language="ruby">normal_attribute_whitelist []</pre> <p>For attributes that contain slashes (<code class="docutils literal">/</code>) within the attribute value, such as the <code class="docutils literal">filesystem</code> attribute <code class="docutils literal">'/dev/diskos2'</code>, use an array. For example:</p> <pre class="highlight-ruby" data-language="ruby">automatic_attribute_whitelist [['filesystem','/dev/diskos2']]</pre>     <h2 id="file-methods">File Methods</h2> <p>Use the following methods within the attributes file for a cookbook or within a recipe. These methods correspond to the attribute type of the same name:</p> <ul> <li>
<p class="first"><code class="docutils literal">override</code></p> </li> <li>
<p class="first"><code class="docutils literal">default</code></p> </li> <li>
<p class="first"><code class="docutils literal">normal</code> (or <code class="docutils literal">set</code>, where <code class="docutils literal">set</code> is an alias for <code class="docutils literal">normal</code>)</p>  </li> <li>
<p class="first"><code class="docutils literal">_unless</code></p> </li> <li>
<p class="first"><code class="docutils literal">attribute?</code></p> </li> </ul>   <h2 id="environment-variables">Environment Variables</h2> <p>In UNIX, a process environment is a set of key-value pairs made available to a process. Programs expect their environment to contain information required for the program to run. The details of how these key-value pairs are accessed depends on the API of the language being used.</p> <p>If processes is started by using the <strong>execute</strong> or <strong>script</strong> resources (or any of the resources based on those two resources, such as <strong>bash</strong>), use the <code class="docutils literal">environment</code> attribute to alter the environment that will be passed to the process.</p> <pre class="highlight-bash" data-language="bash">bash 'env_test' do
  code &lt;&lt;-EOF
  echo $FOO
EOF
  environment ({ 'FOO' =&gt; 'bar' })
end</pre> <p>The only environment being altered is the one being passed to the child process that is started by the <strong>bash</strong> resource. This will not affect the environment of the chef-client or any child processes.</p>   <h2 id="work-with-recipes">Work with Recipes</h2> <p>The following sections show approaches to working with recipes.</p>  <h3 id="use-data-bags">Use Data Bags</h3> <p>A data bag is a global variable that is stored as JSON data and is accessible from a Chef server. A data bag is indexed for searching and can be loaded by a recipe or accessed during a search.</p> <p>The contents of a data bag can be loaded into a recipe. For example, a data bag named <code class="docutils literal">apps</code> and a data bag item named <code class="docutils literal">my_app</code>:</p> <pre class="highlight-javascript" data-language="javascript">{
  "id": "my_app",
  "repository": "git://github.com/company/my_app.git"
}</pre> <p>can be accessed in a recipe, like this:</p> <pre class="highlight-ruby" data-language="ruby">my_bag = data_bag_item('apps', 'my_app')</pre> <p>The data bag item’s keys and values can be accessed with a Hash:</p> <pre class="highlight-ruby" data-language="ruby">my_bag['repository'] #=&gt; 'git://github.com/company/my_app.git'</pre>  <h4 id="secret-keys">Secret Keys</h4> <p>Encrypting a data bag item requires a secret key. A secret key can be created in any number of ways. For example, OpenSSL can be used to generate a random number, which can then be used as the secret key:</p> <pre class="highlight-bash" data-language="bash">$ openssl rand -base64 512 | tr -d '\r\n' &gt; encrypted_data_bag_secret</pre> <p>where <code class="docutils literal">encrypted_data_bag_secret</code> is the name of the file which will contain the secret key. For example, to create a secret key named “my_secret_key”:</p> <pre class="highlight-bash" data-language="bash">$ openssl rand -base64 512 | tr -d '\r\n' &gt; my_secret_key</pre> <p>The <code class="docutils literal">tr</code> command eliminates any trailing line feeds. Doing so avoids key corruption when transferring the file between platforms with different line endings.</p>   <h4 id="store-keys-on-nodes">Store Keys on Nodes</h4> <p>An encryption key can also be stored in an alternate file on the nodes that need it and specify the path location to the file inside an attribute; however, <code class="docutils literal">EncryptedDataBagItem.load</code> expects to see the actual secret as the third argument, rather than a path to the secret file. In this case, you can use <code class="docutils literal">EncryptedDataBagItem.load_secret</code> to slurp the secret file contents and then pass them:</p> <pre class="highlight-ruby" data-language="ruby"># inside your attribute file:
# default[:mysql][:secretpath] = 'C:\\chef\\any_secret_filename'
#
# inside your recipe:
# look for secret in file pointed to by mysql attribute :secretpath
mysql_secret = Chef::EncryptedDataBagItem.load_secret('#{node[:mysql][:secretpath]}')
mysql_creds = Chef::EncryptedDataBagItem.load('passwords', 'mysql', mysql_secret)
mysql_creds['pass'] # will be decrypted</pre>    <h3 id="assign-dependencies">Assign Dependencies</h3> <p>If a cookbook has a dependency on a recipe that is located in another cookbook, that dependency must be declared in the metadata.rb file for that cookbook using the <code class="docutils literal">depends</code> keyword.</p> <div class="admonition note"> <p class="first admonition-title">Note</p> <p class="last">Declaring cookbook dependencies is not required with chef-solo.</p> </div> <p>For example, if the following recipe is included in a cookbook named <code class="docutils literal">my_app</code>:</p> <pre class="highlight-ruby" data-language="ruby">include_recipe 'apache2::mod_ssl'</pre> <p>Then the metadata.rb file for that cookbook would have:</p> <pre class="highlight-ruby" data-language="ruby">depends 'apache2'</pre>   <h3 id="include-recipes">Include Recipes</h3> <p>A recipe can include one (or more) recipes located in external cookbooks by using the <code class="docutils literal">include_recipe</code> method. When a recipe is included, the resources found in that recipe will be inserted (in the same exact order) at the point where the <code class="docutils literal">include_recipe</code> keyword is located.</p> <p>The syntax for including a recipe is like this:</p> <pre class="highlight-ruby" data-language="ruby">include_recipe 'recipe'</pre> <p>For example:</p> <pre class="highlight-ruby" data-language="ruby">include_recipe 'apache2::mod_ssl'</pre> <p>If the <code class="docutils literal">include_recipe</code> method is used more than once to include a recipe, only the first inclusion is processed and any subsequent inclusions are ignored.</p>   <h3 id="reload-attributes">Reload Attributes</h3> <p>Attributes sometimes depend on actions taken from within recipes, so it may be necessary to reload a given attribute from within a recipe. For example:</p> <pre class="highlight-ruby" data-language="ruby">ruby_block 'some_code' do
  block do
    node.from_file(run_context.resolve_attribute('COOKBOOK_NAME', 'ATTR_FILE'))
  end
  action :nothing
end</pre>   <h3 id="use-ruby">Use Ruby</h3> <p>Anything that can be done with Ruby can be used within a recipe, such as expressions (if, unless, etc.), case statements, loop statements, arrays, hashes, and variables. In Ruby, the conditionals <code class="docutils literal">nil</code> and <code class="docutils literal">false</code> are false; every other conditional is <code class="docutils literal">true</code>.</p>  <h4 id="assign-a-value">Assign a value</h4> <p>A variable uses an equals sign (<code class="docutils literal">=</code>) to assign a value.</p> <p>To assign a value to a variable:</p> <pre class="highlight-ruby" data-language="ruby">package_name = "apache2"</pre>   <h4 id="use-case-statement">Use Case Statement</h4> <p>A case statement can be used to compare an expression, and then execute the code that matches.</p> <p>To select a package name based on platform:</p> <pre class="highlight-ruby" data-language="ruby">package "apache2" do
  case node[:platform]
  when "centos","redhat","fedora","suse"
    package_name "httpd"
  when "debian","ubuntu"
    package_name "apache2"
  when "arch"
    package_name "apache"
  end
  action :install
end</pre>   <h4 id="check-conditions">Check Conditions</h4> <p>An if expression can be used to check for conditions (true or false).</p> <p>To check for condition only for Debian and Ubuntu platforms:</p> <pre class="highlight-ruby" data-language="ruby">if platform?("debian", "ubuntu")
  # do something if node['platform'] is debian or ubuntu
else
  # do other stuff
end</pre>   <h4 id="execute-conditions">Execute Conditions</h4> <p>An unless expression can be used to execute code when a condition returns a false value (effectively, an unless expression is the opposite of an if statement).</p> <p>To use an expression to execute when a condition returns a false value:</p> <pre class="highlight-ruby" data-language="ruby">unless node[:platform_version] == "5.0"
  # do stuff on everything but 5.0
end</pre>   <h4 id="loop-over-array">Loop over Array</h4> <p>A loop statement is used to execute a block of code one (or more) times. A loop statement is created when <code class="docutils literal">.each</code> is added to an expression that defines an array or a hash. An array is an integer-indexed collection of objects. Each element in an array can be associated with and referred to by an index.</p> <p>To loop over an array of package names by platform:</p> <pre class="highlight-ruby" data-language="ruby">["apache2", "apache2-mpm"].each do |p|
  package p
end</pre>   <h4 id="loop-over-hash">Loop over Hash</h4> <p>A hash is a collection of key-value pairs. Indexing for a hash is done using arbitrary keys of any object (as opposed to the indexing done by an array). The syntax for a hash is: <code class="docutils literal">key =&gt; "value"</code>.</p> <p>To loop over a hash of gem package names:</p> <pre class="highlight-ruby" data-language="ruby">{"fog" =&gt; "0.6.0", "highline" =&gt; "1.6.0"}.each do |g,v|
  gem_package g do
    version v
  end
end</pre>    <h3 id="apply-to-run-lists">Apply to Run-lists</h3> <p>A recipe must be assigned to a run-list using the appropriate name, as defined by the cookbook directory and namespace. For example, a cookbook directory has the following structure:</p> <pre class="highlight-python" data-language="python">cookbooks/
  apache2/
    recipes/
      default.rb
      mod_ssl.rb</pre> <p>There are two recipes: a default recipe (that has the same name as the cookbook) and a recipe named <code class="docutils literal">mod_ssl</code>. The syntax that applies a recipe to a run-list is similar to:</p> <pre class="highlight-ruby" data-language="ruby">{
  'run_list': [
  'recipe[cookbook_name::default_recipe]',
  'recipe[cookbook_name::recipe_name]'
  ]
}</pre> <p>where <code class="docutils literal">::default_recipe</code> is implied (and does not need to be specified). On a node, these recipes can be assigned to a node’s run-list similar to:</p> <pre class="highlight-ruby" data-language="ruby">{
  'run_list': [
  'recipe[apache2]',
  'recipe[apache2::mod_ssl]'
  ]
}</pre>  <h4 id="chef-server">Chef Server</h4> <p>Use knife to add a recipe to the run-list for a node. For example:</p> <pre class="highlight-bash" data-language="bash">$ knife node run list add NODENAME "recipe[apache2]"</pre> <p>More than one recipe can be added:</p> <pre class="highlight-bash" data-language="bash">% knife node run list add NODENAME "recipe[apache2],recipe[mysql],role[ssh]"</pre> <p>which creates a run-list similar to:</p> <pre class="highlight-ruby" data-language="ruby">run_list:
   recipe[apache2]
   recipe[mysql]
   role[ssh]</pre>   <h4 id="chef-solo">chef-solo</h4> <p>Use a JSON file to pass run-list details to chef-solo as long as the cookbook in which the recipe is located is available to the system on which chef-solo is running. For example, a file named <code class="docutils literal">dna.json</code> contains the following details:</p> <pre class="highlight-none" data-language="none">{
  "run_list": ["recipe[apache2]"]
}</pre> <p>To add the run-list to the node, enter the following:</p> <pre class="highlight-bash" data-language="bash">$ sudo chef-solo -j /etc/chef/dna.json</pre>    <h3 id="use-search-results">Use Search Results</h3> <p>Search indexes allow queries to be made for any type of data that is indexed by the Chef server, including data bags (and data bag items), environments, nodes, and roles. A defined query syntax is used to support search patterns like exact, wildcard, range, and fuzzy. A search is a full-text query that can be done from several locations, including from within a recipe, by using the <code class="docutils literal">search</code> subcommand in knife, the <code class="docutils literal">search</code> method in the Recipe DSL, the search box in the Chef management console, and by using the <code class="docutils literal">/search</code> or <code class="docutils literal">/search/INDEX</code> endpoints in the Chef server API. The search engine is based on Apache Solr and is run from the Chef server.</p> <p>The results of a search query can be loaded into a recipe. For example, a very simple search query (in a recipe) might look like this:</p> <pre class="highlight-ruby" data-language="ruby">search(:node, 'attribute:value')</pre> <p>A search query can be assigned to variables and then used elsewhere in a recipe. For example, to search for all nodes that have a role assignment named <code class="docutils literal">webserver</code>, and then render a template which includes those role assignments:</p> <pre class="highlight-ruby" data-language="ruby">webservers = search(:node, 'role:webserver')

template '/tmp/list_of_webservers' do
  source 'list_of_webservers.erb'
  variables(:webservers =&gt; webservers)
end</pre>   <h3 id="use-tags">Use Tags</h3> <p>A tag is a custom description that is applied to a node. A tag, once applied, can be helpful when managing nodes using knife or when building recipes by providing alternate methods of grouping similar types of information.</p> <p>Tags can be added and removed. Machines can be checked to see if they already have a specific tag. To use tags in your recipe simply add the following:</p> <pre class="highlight-ruby" data-language="ruby">tag('mytag')</pre> <p>To test if a machine is tagged, add the following:</p> <pre class="highlight-ruby" data-language="ruby">tagged?('mytag')</pre> <p>to return <code class="docutils literal">true</code> or <code class="docutils literal">false</code>. <code class="docutils literal">tagged?</code> can also use an array as an argument.</p> <p>To remove a tag:</p> <pre class="highlight-ruby" data-language="ruby">untag('mytag')</pre> <p>For example:</p> <pre class="highlight-ruby" data-language="ruby">tag('machine')

if tagged?('machine')
   Chef::Log.info('Hey I'm #{node[:tags]}')
end

untag('machine')

if not tagged?('machine')
   Chef::Log.info('I has no tagz')
end</pre> <p>Will return something like this:</p> <pre class="highlight-none" data-language="none">[Thu, 22 Jul 2010 18:01:45 +0000] INFO: Hey I'm machine
[Thu, 22 Jul 2010 18:01:45 +0000] INFO: I has no tagz</pre>   <h3 id="end-chef-client-run">End chef-client Run</h3> <p>Sometimes it may be necessary to stop processing a recipe and/or stop processing the entire chef-client run. There are a few ways to do this:</p> <ul class="simple"> <li>Use the <code class="docutils literal">return</code> keyword to stop processing a recipe based on a condition, but continue processing the chef-client run</li> <li>Use the <code class="docutils literal">raise</code> keyword to stop a chef-client run by triggering an unhandled exception</li> <li>Use a <code class="docutils literal">rescue</code> block in Ruby code</li> <li>Use an <a class="reference internal" href="handlers">exception handler</a>
</li> <li>Use <code class="docutils literal">Chef::Application.fatal!</code> to log a fatal message to the logger and <code class="docutils literal">STDERR</code>, and then stop the chef-client run</li> </ul> <p>The following sections show various approaches to ending a chef-client run.</p>  <h4 id="return-keyword">return Keyword</h4> <p>The <code class="docutils literal">return</code> keyword can be used to stop processing a recipe based on a condition, but continue processing the chef-client run. For example:</p> <pre class="highlight-ruby" data-language="ruby">file '/tmp/name_of_file' do
  action :create
end

return if node['platform'] == 'windows'

package 'name_of_package' do
  action :install
end</pre> <p>where <code class="docutils literal">node['platform'] == 'windows'</code> is the condition set on the <code class="docutils literal">return</code> keyword. When the condition is met, stop processing the recipe. This approach is useful when there is no need to continue processing, such as when a package cannot be installed. In this situation, it’s OK for a recipe to stop processing.</p>   <h4 id="fail-raise-keywords">fail/raise Keywords</h4> <p>In certain situations it may be useful to stop a chef-client run entirely by using an unhandled exception. The <code class="docutils literal">raise</code> and <code class="docutils literal">fail</code> keywords can be used to stop a chef-client run in both the compile and execute phases.</p> <div class="admonition note"> <p class="first admonition-title">Note</p> <p class="last">Both <code class="docutils literal">raise</code> and <code class="docutils literal">fail</code> behave the same way when triggering unhandled exceptions and may be used interchangeably.</p> </div> <p>Use these keywords in a recipe—but outside of any resource blocks—to trigger an unhandled exception during the compile phase. For example:</p> <pre class="highlight-ruby" data-language="ruby">file '/tmp/name_of_file' do
  action :create
end

raise "message" if node['platform'] == 'windows'

package 'name_of_package' do
  action :install
end</pre> <p>where <code class="docutils literal">node['platform'] == 'windows'</code> is the condition that will trigger the unhandled exception.</p> <p>Use these keywords in the <strong>ruby_block</strong> resource to trigger an unhandled exception during the execute phase. For example:</p> <pre class="highlight-ruby" data-language="ruby">ruby_block "name" do
  block do
    # Ruby code with a condition, e.g. if ::File.exist?(::File.join(path, "/tmp"))
    fail "message"  # e.g. "Ordering issue with file path, expected foo"
  end
end</pre> <p>Use these keywords in a class. For example:</p> <pre class="highlight-ruby" data-language="ruby">class CustomError &lt; StandardError; end</pre> <p>and then later on:</p> <pre class="highlight-ruby" data-language="ruby">def custom_error
  raise CustomError, "error message"
end</pre> <p>or:</p> <pre class="highlight-ruby" data-language="ruby">def custom_error
  fail CustomError, "error message"
end</pre>   <h4 id="rescue-blocks">Rescue Blocks</h4> <p>Since recipes are written in Ruby, they can be written to attempt to handle error conditions using the <code class="docutils literal">rescue</code> block.</p> <p>For example:</p> <pre class="highlight-ruby" data-language="ruby">begin
  dater = data_bag_item(:basket, "flowers")
  rescue Net::HTTPServerException
    # maybe some retry code here?
  raise "message_to_be_raised"
end</pre> <p>where <code class="docutils literal">data_bag_item</code> makes an HTTP request to the Chef server to get a data bag item named <code class="docutils literal">flowers</code>. If there is a problem, the request will return a <code class="docutils literal">Net::HTTPServerException</code>. The <code class="docutils literal">rescue</code> block can be used to try to retry or otherwise handle the situation. If the <code class="docutils literal">rescue</code> block is unable to handle the situation, then the <code class="docutils literal">raise</code> keyword is used to specify the message to be raised.</p>   <h4 id="fatal-messages">Fatal Messages</h4> <p>A chef-client run is stopped after a fatal message is sent to the logger and <code class="docutils literal">STDERR</code>. For example:</p> <pre class="highlight-ruby" data-language="ruby">Chef::Application.fatal!("log_message", error_code) if condition</pre> <p>where <code class="docutils literal">condition</code> defines when a <code class="docutils literal">"log_message"</code> and an <code class="docutils literal">error_code</code> are sent to the logger and <code class="docutils literal">STDERR</code>, after which the chef-client will exit. The <code class="docutils literal">error_code</code> itself is arbitrary and is assigned by the individual who writes the code that triggers the fatal message. Assigning an error code is optional, but they can be useful during log file analysis.</p> <p>This approach is used within the chef-client itself to help ensure consistent messaging around certain behaviors. That said, this approach is not recommended for use within recipes and cookbooks and should only be used when the other approaches are not applicable.</p> <div class="admonition note"> <p class="first admonition-title">Note</p> <p class="last">This approach should be used carefully when the chef-client is run as a daemonized service. Some services—such as a runit service—should restart, but others—such as an init.d services—likely will not.</p> </div>    <h3 id="node-run-state">node.run_state</h3> <p>Use <code class="docutils literal">node.run_state</code> to stash transient data during a chef-client run. This data may be passed between resources, and then evaluated during the execution phase. <code class="docutils literal">run_state</code> is an empty Hash that is always discarded at the end of the chef-client run.</p> <p>For example, the following recipe will install the Apache web server, randomly choose PHP or Perl as the scripting language, and then install that scripting language:</p> <pre class="highlight-ruby" data-language="ruby">package 'httpd' do
  action :install
end

ruby_block 'randomly_choose_language' do
  block do
    if Random.rand &gt; 0.5
      node.run_state['scripting_language'] = 'php'
    else
      node.run_state['scripting_language'] = 'perl'
    end
  end
end

package 'scripting_language' do
  package_name lazy { node.run_state['scripting_language'] }
  action :install
end</pre> <p>where:</p> <ul class="simple"> <li>The <strong>ruby_block</strong> resource declares a <code class="docutils literal">block</code> of Ruby code that is run during the execution phase of the chef-client run</li> <li>The <code class="docutils literal">if</code> statement randomly chooses PHP or Perl, saving the choice to <code class="docutils literal">node.run_state['scripting_language']</code>
</li> <li>When the <strong>package</strong> resource has to install the package for the scripting language, it looks up the scripting language and uses the one defined in <code class="docutils literal">node.run_state['scripting_language']</code>
</li> <li>
<code class="docutils literal">lazy {}</code> ensures that the <strong>package</strong> resource evaluates this during the execution phase of the chef-client run (as opposed to during the compile phase)</li> </ul> <p>When this recipe runs, the chef-client will print something like the following:</p> <pre class="highlight-bash" data-language="bash">* ruby_block[randomly_choose_language] action run
 - execute the ruby block randomly_choose_language

* package[scripting_language] action install
 - install version 5.3.3-27.el6_5 of package php</pre>
<div class="_attribution">
  <p class="_attribution-p">
    © Chef Software, Inc.<br>Licensed under the Creative Commons Attribution 3.0 Unported License.<br>The Chef™ Mark and Chef Logo are either registered trademarks/service marks or trademarks/servicemarks of Chef, in the United States and other countries and are used with Chef Inc's permission.<br>We are not affiliated with, endorsed or sponsored by Chef Inc.<br>
    <a href="https://docs-archive.chef.io/release/12-13/recipes.html" class="_attribution-link">https://docs-archive.chef.io/release/12-13/recipes.html</a>
  </p>
</div>

				
			</div>
			<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-2572770204602497"
     data-ad-slot="1992473792"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
		</div>
	</section>

	</div>
	<svg style="display:none">
		<symbol id="icon-dir"><svg viewBox="0 0 20 20"><path d="M15 10c0 .3-.305.515-.305.515l-8.56 5.303c-.625.41-1.135.106-1.135-.67V4.853c0-.777.51-1.078 1.135-.67l8.56 5.305S15 9.702 15 10z"/></svg></symbol>
	  </svg>
</body>
</html>
