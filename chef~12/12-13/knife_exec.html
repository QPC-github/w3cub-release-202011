
<!DOCTYPE HTML>

<html lang="en" class="_theme-default">

<head>
  <meta charset="utf-8">
  <title>Knife Exec - Chef 12 - W3cubDocs</title>
  
  <meta name="description" content="The knife exec subcommand uses the knife configuration file to execute Ruby scripts in the context of a fully configured chef-client. Use this &hellip;">
  <meta name="keywords" content="knife, exec, chef, chef~12">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="mobile-web-app-capable" content="yes">
  
  <link rel="canonical" href="https://docs.w3cub.com/chef~12/12-13/knife_exec.html">
  <link href="/favicon.png" rel="icon">
  <link rel="stylesheet" type="text/css" href="/assets/application-e4ebd3a2a5652ff55173659804c4390a004917f3bdd17b5bb3ba78ea5c9c46fe181cadaac34517ccd815f5bdc982bbfe67179d6f4ac2f084ef2265e2a3dc8dc5.css" integrity="sha512-5OvToqVlL/VRc2WYBMQ5CgBJF/O90Xtbs7p46lycRv4YHK2qw0UXzNgV9b3Jgrv+Zxedb0rC8ITvImXio9yNxQ==" crossorigin="anonymous">
  <script type="text/javascript" integrity="sha512-EpkDeu98lN/jPKijllzVWdRg/dUSSMCaldYZNFz6bcNoBvpWRNz0HSTRQJ3ENmQc5Cuj1zDW1vHd7b0DzpOgyA==" crossorigin="anonymous" src="/assets/application-1299037aef7c94dfe33ca8a3965cd559d460fdd51248c09a95d619345cfa6dc36806fa5644dcf41d24d1409dc436641ce42ba3d730d6d6f1ddedbd03ce93a0c8.js"></script>
  <script src="/json/chef~12.js"></script>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-71174418-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>
  <script data-ad-client="ca-pub-2572770204602497" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script async custom-element="amp-auto-ads"
  src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
</script>


</head>

<body>
	<amp-auto-ads type="adsense"
              data-ad-client="ca-pub-2572770204602497">
	</amp-auto-ads>
	<div class="_app">
	<header class="_header">
  
  <form class="_search">
    <input type="search" class="_search-input" placeholder="Search&hellip;" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" maxlength="20">
    <a class="_search-clear"></a>
    <div class="_search-tag"></div>
  </form>
  
  <a class="_home-link" href="/" ></a>
  <a class="_menu-link"></a>
  <h1 class="_logo">
    <a href="/" class="_nav-link" title="API Documentation Browser">W3cubDocs</a>
  </h1>
  
  <span class="_logo-sub-nav">/</span><span class="_logo-sub-nav"><a href="/chef~12/" class="_nav-link" title="" style="margin-left:0;">Chef 12</a></span>
  
  <nav class="_nav">
    <a href="https://tools.w3cub.com/?_sp=docs" target="_blank" class="_nav-link ">W3cubTools</a>
    <a href="/cheatsheets/" class="_nav-link ">Cheatsheets</a>
    <a href="/about/" class="_nav-link ">About</a>
  </nav>
</header>
	<section class="_sidebar">
		<div class="_list-wrap">
			<div class="_list">
			
			</div>
		</div>
	</section>
	<section class="_container ">
		<div class="_content">
			<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-2572770204602497"
     data-ad-slot="6861657091"
     data-ad-format="link"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
			<div class="_page _sphinx_simple">
				
				
<h1 id="knife-exec">knife exec</h1> <p>The <code class="docutils literal">knife exec</code> subcommand uses the knife configuration file to execute Ruby scripts in the context of a fully configured chef-client. Use this subcommand to run scripts that will only access Chef server one time (or otherwise very infrequently) or any time that an operation does not warrant full usage of the knife subcommand library.</p>  <h2 id="authenticated-api-requests">Authenticated API Requests</h2> <p>The <code class="docutils literal">knife exec</code> subcommand can be used to make authenticated API requests to the Chef server using the following methods:</p> <table class="docutils"> <colgroup> <col width="13%"> <col width="88%"> </colgroup> <thead valign="bottom"> <tr class="row-odd">
<th class="head">Method</th> <th class="head">Description</th> </tr> </thead> <tbody valign="top"> <tr class="row-even">
<td><code class="docutils literal">api.delete</code></td> <td>Use to delete an object from the Chef server.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">api.get</code></td> <td>Use to get the details of an object on the Chef server.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">api.post</code></td> <td>Use to add an object to the Chef server.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">api.put</code></td> <td>Use to update an object on the Chef server.</td> </tr> </tbody> </table> <p>These methods are used with the <code class="docutils literal">-E</code> option, which executes that string locally on the workstation using chef-shell. These methods have the following syntax:</p> <pre class="highlight-bash" data-language="bash">$ knife exec -E 'api.method(/endpoint)'</pre> <p>where:</p> <ul class="simple"> <li>
<code class="docutils literal">api.method</code> is the corresponding authentication method — <code class="docutils literal">api.delete</code>, <code class="docutils literal">api.get</code>, <code class="docutils literal">api.post</code>, or <code class="docutils literal">api.put</code>
</li> <li>
<code class="docutils literal">/endpoint</code> is an endpoint in the Chef server API</li> </ul> <p>For example, to get the data for a node named “Example_Node”:</p> <pre class="highlight-bash" data-language="bash">$ knife exec -E 'puts api.get("/nodes/Example_Node")'</pre> <p>and to ensure that the output is visible in the console, add the <code class="docutils literal">puts</code> in front of the API authorization request:</p> <pre class="highlight-bash" data-language="bash">$ knife exec -E 'puts api.get("/nodes/Example_Node")'</pre> <p>where <code class="docutils literal">puts</code> is the shorter version of the <code class="docutils literal">$stdout.puts</code> predefined variable in Ruby.</p> <p>The following example shows how to add a client named “IBM305RAMAC” and the <code class="docutils literal">/clients</code> endpoint, and then return the private key for that user in the console:</p> <pre class="highlight-bash" data-language="bash">$ client_desc = {
    "name"  =&gt; "IBM305RAMAC",
    "admin" =&gt; false
  }

  new_client = api.post("/clients", client_desc)
  puts new_client["private_key"]</pre>   <h2 id="ruby-scripts">Ruby Scripts</h2> <p>For Ruby scripts that will be run using the <code class="docutils literal">exec</code> subcommand, note the following:</p> <blockquote> <div>
<ul class="simple"> <li>The Ruby script must be located on the system from which knife is run (and not be located on any of the systems that knife will be managing).</li> <li>Shell commands will be run from a management workstation. For example, something like <code class="docutils literal">%x[ls -lash /opt/only-on-a-node]</code> would give you the directory listing for the “opt/only-on-a-node” directory or a “No such file or directory” error if the file does not already exist locally.</li> <li>When the chef-shell DSL is available, the chef-client DSL will not be (unless the management workstation is also a chef-client). Without the chef-client DSL, a bash block cannot be used to run bash commands.</li> </ul> </div>
</blockquote>   <h2 id="syntax">Syntax</h2> <p>This subcommand has the following syntax:</p> <pre class="highlight-bash" data-language="bash">$ knife exec SCRIPT (options)</pre>   <h2 id="options">Options</h2> <div class="admonition note"> <p class="first admonition-title">Note</p> <p class="last">Review the list of <a class="reference internal" href="knife_common_options">common options</a> available to this (and all) knife subcommands and plugins.</p> </div> <p>This subcommand has the following options:</p> <dl class="docutils"> <dt>
<code class="docutils literal">-E CODE</code>, <code class="docutils literal">--exec CODE</code>
</dt> <dd>A string of code that to be executed.</dd> <dt>
<code class="docutils literal">-p PATH:PATH</code>, <code class="docutils literal">--script-path PATH:PATH</code>
</dt> <dd>A colon-separated path at which Ruby scripts are located. Use to override the default location for scripts. When this option is not specified, knife will look for scripts located in <code class="docutils literal">chef-repo/.chef/scripts</code> directory.</dd> </dl> <div class="admonition note"> <p class="first admonition-title">Note</p> <p class="last">See <a class="reference internal" href="config_rb_knife_optional_settings">knife.rb</a> for more information about how to add certain knife options as settings in the knife.rb file.</p> </div>   <h2 id="examples">Examples</h2> <p>The following examples show how to use this knife subcommand:</p> <p><strong>Run Ruby scripts</strong></p> <p>There are three ways to use <code class="docutils literal">knife exec</code> to run Ruby script files. For example:</p> <pre class="highlight-bash" data-language="bash">$ knife exec /path/to/script_file</pre> <p>or:</p> <pre class="highlight-bash" data-language="bash">$ knife exec -E 'RUBY CODE'</pre> <p>or:</p> <pre class="highlight-bash" data-language="bash">$ knife exec
RUBY CODE
^D</pre> <p><strong>Chef Knife status</strong></p> <p>To check the status of knife using a Ruby script named <code class="docutils literal">status.rb</code> (which looks like):</p> <pre class="highlight-ruby" data-language="ruby">printf "%-5s %-12s %-8s %s\n", "Check In", "Name", "Ruby", "Recipes"
nodes.all do |n|
   checkin = Time.at(n['ohai_time']).strftime("%F %R")
   rubyver = n['languages']['ruby']['version']
   recipes = n.run_list.expand(_default).recipes.join(", ")
   printf "%-20s %-12s %-8s %s\n", checkin, n.name, rubyver, recipes
end</pre> <p>and is located in a directory named <code class="docutils literal">scripts/</code>, enter:</p> <pre class="highlight-bash" data-language="bash">$ knife exec scripts/status.rb</pre> <p><strong>List available free memory</strong></p> <p>To show the available free memory for all nodes, enter:</p> <pre class="highlight-bash" data-language="bash">$ knife exec -E 'nodes.all {|n| puts "#{n.name} has #{n.memory.total} free memory"}'</pre> <p><strong>List available search indexes</strong></p> <p>To list all of the available search indexes, enter:</p> <pre class="highlight-bash" data-language="bash">$ knife exec -E 'puts api.get("search").keys'</pre> <p><strong>Query for multiple attributes</strong></p> <p>To query a node for multiple attributes using a Ruby script named <code class="docutils literal">search_attributes.rb</code> (which looks like):</p> <pre class="highlight-ruby" data-language="ruby">% cat scripts/search_attributes.rb
query = ARGV[2]
attributes = ARGV[3].split(",")
puts "Your query: #{query}"
puts "Your attributes: #{attributes.join(" ")}"
results = {}
search(:node, query) do |n|
   results[n.name] = {}
   attributes.each {|a| results[n.name][a] = n[a]}
end

puts results
exit 0</pre> <p>enter:</p> <pre class="highlight-bash" data-language="bash">% knife exec scripts/search_attributes.rb "hostname:test_system" ipaddress,fqdn</pre> <p>to return something like:</p> <pre class="highlight-bash" data-language="bash">Your query: hostname:test_system
Your attributes: ipaddress fqdn
{"test_system.example.com"=&gt;{"ipaddress"=&gt;"10.1.1.200", "fqdn"=&gt;"test_system.example.com"}}</pre> <p><strong>Find shadow cookbooks</strong></p> <p>To find all of the locations in which cookbooks exist that may shadow each other, create a file called <code class="docutils literal">shadow-check.rb</code> that contains the following Ruby code:</p> <pre class="highlight-ruby" data-language="ruby">config = Chef::Config

cookbook_loader = begin
  Chef::Cookbook::FileVendor.on_create { |manifest| Chef::Cookbook::FileSystemFileVendor.new(manifest, config[:cookbook_path]) }
  Chef::CookbookLoader.new(config[:cookbook_path])
end

ui = Chef::Knife::UI.new($stdout, $stderr, $stdin, {})

cookbook_loader.load_cookbooks

if cookbook_loader.merged_cookbooks.empty?
  ui.msg "cookbooks ok"
else
  ui.warn "* " * 40
  ui.warn(&lt;&lt;-WARNING)
The cookbooks: #{cookbook_loader.merged_cookbooks.join(', ')} exist in multiple places in your cookbook_path.
A composite version of these cookbooks has been compiled for uploading.

#{ui.color('IMPORTANT:', :red, :bold)} In a future version of Chef, this behavior will be removed and you will no longer
be able to have the same version of a cookbook in multiple places in your cookbook_path.
WARNING
  ui.warn "The affected cookbooks are located:"
  ui.output ui.format_for_display(cookbook_loader.merged_cookbook_paths)
  ui.warn "* " * 40
end</pre> <p>Put this file in the directory of your choice. Run the following command:</p> <pre class="highlight-bash" data-language="bash">$ knife exec shadow-check.rb</pre> <p>and be sure to edit <code class="docutils literal">shadow-check.rb</code> so that it defines the path to that file correctly.</p>
<div class="_attribution">
  <p class="_attribution-p">
    © Chef Software, Inc.<br>Licensed under the Creative Commons Attribution 3.0 Unported License.<br>The Chef™ Mark and Chef Logo are either registered trademarks/service marks or trademarks/servicemarks of Chef, in the United States and other countries and are used with Chef Inc's permission.<br>We are not affiliated with, endorsed or sponsored by Chef Inc.<br>
    <a href="https://docs-archive.chef.io/release/12-13/knife_exec.html" class="_attribution-link">https://docs-archive.chef.io/release/12-13/knife_exec.html</a>
  </p>
</div>

				
			</div>
			<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-2572770204602497"
     data-ad-slot="1992473792"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
		</div>
	</section>

	</div>
	<svg style="display:none">
		<symbol id="icon-dir"><svg viewBox="0 0 20 20"><path d="M15 10c0 .3-.305.515-.305.515l-8.56 5.303c-.625.41-1.135.106-1.135-.67V4.853c0-.777.51-1.078 1.135-.67l8.56 5.305S15 9.702 15 10z"/></svg></symbol>
	  </svg>
</body>
</html>
