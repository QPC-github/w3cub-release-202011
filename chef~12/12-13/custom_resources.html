
<!DOCTYPE HTML>

<html lang="en" class="_theme-default">

<head>
  <meta charset="utf-8">
  <title>Custom Resources - Chef 12 - W3cubDocs</title>
  
  <meta name="description" content=" Warning ">
  <meta name="keywords" content="custom, resources, chef, chef~12">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="mobile-web-app-capable" content="yes">
  
  <link rel="canonical" href="https://docs.w3cub.com/chef~12/12-13/custom_resources.html">
  <link href="/favicon.png" rel="icon">
  <link rel="stylesheet" type="text/css" href="/assets/application-01fda2ddb8339756caccf7add5ad4cf849ab52d069bd799015c7f04f93164f64753bff0d15a49d8060b1e66e41002bb301ccadc2350937df079cea3cd52d3cca.css">
  <script src="/assets/application-d9be6f56a823612443fc15b2e027a630e02c4ad2685bb750d13fa4fae28d46c3e7f7ebb69bd4bafddf116f218f9372e9be44021d4247dc20424e2fd1ff8cef81.js" type="text/javascript"></script>
  <script src="/json/chef~12.js"></script>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-71174418-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>
  <script data-ad-client="ca-pub-2572770204602497" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script async custom-element="amp-auto-ads"
  src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
</script>


</head>

<body class="docs">
	<amp-auto-ads type="adsense"
              data-ad-client="ca-pub-2572770204602497">
	</amp-auto-ads>
	<div class="_app">
	<header class="_header">

  <a class="_home-link" href="/" ></a>
  <a class="_menu-link"></a>
  <h1 class="_logo">
    <a href="/" class="_nav-link" title="API Documentation Browser">W3cubDocs</a>
  </h1>
  
  <span class="_logo-sub-nav">/</span><span class="_logo-sub-nav"><a href="/chef~12/" class="_nav-link" title="" style="margin-left:0;">Chef 12</a></span>
  
  <nav class="_nav">
    <a href="https://tools.w3cub.com/?_sp=docs" target="_blank" class="_nav-link ">W3cubTools</a>
    <a href="/cheatsheets/" class="_nav-link ">Cheatsheets</a>
    <a href="/about/" class="_nav-link ">About</a>
  </nav>
</header>
	<section class="_sidebar">
		
		<form class="_search">
		  <input type="search" class="_search-input" placeholder="Search&hellip;" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" maxlength="20">
		  <a class="_search-clear"></a>
		  <div class="_search-tag"></div>
		</form>
		
		<div class="_list-wrap">
			<div class="_list">
			
			</div>
		</div>
	</section>
	<section class="_container ">
		<div class="_content">
			<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-2572770204602497"
     data-ad-slot="6861657091"
     data-ad-format="link"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
			<div class="_page _sphinx_simple">
				
				
<h1 id="custom-resources">Custom Resources</h1> <div class="admonition warning"> <p class="first admonition-title">Warning</p> <p class="last">This approach to building custom resources was introduced in chef-client, version 12.5. It is the recommended approach for all custom resources starting with that version of the chef-client. Refer to the notes about custom resources if you’re curious about other approaches that use the older styles. If you are using an older version of the chef-client, please use the version picker (in the top left of the navigation) to select your version, and then choose the same topic from the navigation tree (“Extend Chef &gt; Custom Resources”). See also <a class="reference external" href="https://github.com/chef-cookbooks/compat_resource">https://github.com/chef-cookbooks/compat_resource</a> for using this features with previous versions of the chef-client.</p> </div> <p>A custom resource:</p> <ul class="simple"> <li>Is a simple extension of Chef</li> <li>Is implemented as part of a cookbook</li> <li>Follows easy, repeatable syntax patterns</li> <li>Effectively leverages resources that are built into Chef</li> <li>Is reusable in the same way as resources that are built into Chef</li> </ul> <p>For example, Chef includes built-in resources to manage files, packages, templates, and services, but it does not include a resource that manages websites.</p>  <h2 id="syntax">Syntax</h2> <p>A custom resource is defined as a Ruby file and is located in a cookbook’s <code class="docutils literal">/resources</code> directory. This file</p> <ul class="simple"> <li>Declares the properties of the custom resource</li> <li>Loads current properties, if the resource already exists</li> <li>Defines each action the custom resource may take</li> </ul> <p>The syntax for a custom resource is. For example:</p> <pre class="highlight-ruby" data-language="ruby">property :name, RubyType, default: 'value'

load_current_value do
  # some Ruby
end

action :name do
 # a mix of built-in Chef resources and Ruby
end

action :name do
 # a mix of built-in Chef resources and Ruby
end</pre> <p>where the first action listed is the default action.</p>  <h3 id="example">Example</h3> <p>For example, the <code class="docutils literal">site.rb</code> file in the <code class="docutils literal">exampleco</code> cookbook could be similar to:</p> <pre class="highlight-ruby" data-language="ruby">property :homepage, String, default: '&lt;h1&gt;Hello world!&lt;/h1&gt;'

load_current_value do
  if ::File.exist?('/var/www/html/index.html')
    homepage IO.read('/var/www/html/index.html')
  end
end

action :create do
  package 'httpd'

  service 'httpd' do
    action [:enable, :start]
  end

  file '/var/www/html/index.html' do
    content homepage
  end
end

action :delete do
  package 'httpd' do
    action :delete
  end
end</pre> <p>where</p> <ul class="simple"> <li>
<code class="docutils literal">homepage</code> is a property that sets the default HTML for the <code class="docutils literal">index.html</code> file with a default value of <code class="docutils literal">'&lt;h1&gt;Hello world!&lt;/h1&gt;'</code>
</li> <li>the (optional) <code class="docutils literal">load_current_value</code> block loads the current values for all specified properties, in this example there is just a single property: <code class="docutils literal">homepage</code>
</li> <li>the <code class="docutils literal">if</code> statement checks to see if the <code class="docutils literal">index.html</code> file is already present on the node. If that file is already present, its contents are loaded <strong>instead</strong> of the default value for <code class="docutils literal">homepage</code>
</li> <li>the <code class="docutils literal">action</code> block uses the built-in collection of resources to tell the chef-client how to install Apache, start the service, and then create the contents of the file located at <code class="docutils literal">/var/www/html/index.html</code>
</li> <li>
<code class="docutils literal">action :create</code> is the default resource; <code class="docutils literal">action :delete</code> must be called specifically (because it is not the default resource)</li> </ul> <p>Once built, the custom resource may be used in a recipe just like the any of the resources that are built into Chef. The resource gets its name from the cookbook and from the file name in the <code class="docutils literal">/resources</code> directory, with an underscore (<code class="docutils literal">_</code>) separating them. For example, a cookbook named <code class="docutils literal">exampleco</code> with a custom resource named <code class="docutils literal">site.rb</code> is used in a recipe like this:</p> <pre class="highlight-ruby" data-language="ruby">exampleco_site 'httpd' do
  homepage '&lt;h1&gt;Welcome to the Example Co. website!&lt;/h1&gt;'
  action :create
end</pre> <p>and to delete the exampleco website, do the following:</p> <pre class="highlight-ruby" data-language="ruby">exampleco_site 'httpd' do
  action :delete
end</pre>   <h3 id="resource-name">resource_name</h3> <div class="admonition note"> <p class="first admonition-title">Note</p> <p class="last">Cookbook and custom resource names should contain only alphanumeric characters. A hyphen (<code class="docutils literal">-</code>) is a valid character and may be used in cookbook and custom resource names, but it is discouraged. The chef-client will return an error if a hyphen is not converted to an underscore (<code class="docutils literal">_</code>) when referencing from a recipe the name of a custom resource in which a hyphen is located.</p> </div> <p>Use the <code class="docutils literal">resource_name</code> method at the top of a custom resource to declare a custom name for that resource. For example:</p> <pre class="highlight-ruby" data-language="ruby">resource_name :custom_name</pre> <p>where <code class="docutils literal">:custom_name</code> is the resource name as it may be used in a recipe. For example, a cookbook named <code class="docutils literal">website</code> and a custom resource file named <code class="docutils literal">httpd</code> is by default used in a recipe with <code class="docutils literal">website_httpd</code>. If <code class="docutils literal">:custom_name</code> is <code class="docutils literal">web_httpd</code> then it may be used like this:</p> <pre class="highlight-ruby" data-language="ruby">web_httpd 'name' do
  # properties
end</pre> <p>For example, the <code class="docutils literal">httpd.rb</code> file in the <code class="docutils literal">website</code> cookbook could be assigned a custom resource name like this:</p> <pre class="highlight-ruby" data-language="ruby">resource_name :httpd

property :homepage, String, default: '&lt;h1&gt;Hello world!&lt;/h1&gt;'

load_current_value do
  if ::File.exist?('/var/www/html/index.html')
    homepage IO.read('/var/www/html/index.html')
  end
end

action :create do
  package 'httpd'

  service 'httpd' do
    action [:enable, :start]
  end

  file '/var/www/html/index.html' do
    content homepage
  end
end</pre> <p>and is then usable in a recipe like this:</p> <pre class="highlight-ruby" data-language="ruby">httpd 'build website' do
  homepage '&lt;h1&gt;Welcome to the Example Co. website!&lt;/h1&gt;'
  action :create
end</pre>    <h2 id="scenario-website-resource">Scenario: website Resource</h2> <p>Create a resource that configures Apache httpd for Red Hat Enterprise Linux 7 and CentOS 7.</p> <p>This scenario covers the following:</p> <ol class="arabic simple"> <li>Defining a cookbook named <code class="docutils literal">website</code>
</li> <li>Defining two properties</li> <li>Defining an action</li> <li>For the action, defining the steps to configure the system using resources that are built into Chef</li> <li>Creating two templates that support the custom resource</li> <li>Adding the resource to a recipe</li> </ol>  <h3 id="create-a-cookbook">Create a Cookbook</h3> <p>This article assumes that a cookbook directory named <code class="docutils literal">website</code> exists in a chef-repo with (at least) the following directories:</p> <pre class="highlight-text" data-language="text">/website
  /recipes
  /resources
  /templates</pre> <p>You may use a cookbook that already exists or you may create a new cookbook.</p> <p>See for more information about how to use the <code class="docutils literal">chef</code> command-line tool that is packaged with the Chef development kit to build the chef-repo, plus related cookbook sub-directories.</p>   <h3 id="objectives">Objectives</h3> <p>Define a custom resource!</p> <p>A custom resource typically contains:</p> <ul class="simple"> <li>A list of defined custom properties (property values are specified in recipes)</li> <li>At least one action (actions tell the chef-client what to do)</li> <li>For each action, use a collection of resources that are built into Chef to define the steps required to complete the action</li> </ul>  <h4 id="what-is-needed">What is needed?</h4> <p>This custom resource requires:</p> <ul class="simple"> <li>Two template files</li> <li>Two properties</li> <li>An action that defines all of the steps necessary to create the website</li> </ul>    <h3 id="define-properties">Define Properties</h3> <p>Custom properties are defined in the resource. This custom resource needs two:</p> <ul class="simple"> <li><code class="docutils literal">instance_name</code></li> <li><code class="docutils literal">port</code></li> </ul> <p>These properties are defined as variables in the <code class="docutils literal">httpd.conf.erb</code> file. A <strong>template</strong> block in recipes will tell the chef-client how to apply these variables.</p> <p>In the custom resource, add the following custom properties:</p> <pre class="highlight-ruby" data-language="ruby">property :instance_name, String, name_property: true
property :port, Fixnum, required: true</pre> <p>where</p> <ul class="simple"> <li>
<code class="docutils literal">String</code> and <code class="docutils literal">Fixnum</code> are Ruby types (all custom properties must have an assigned Ruby type)</li> <li>
<code class="docutils literal">name_property: true</code> allows the value for this property to be equal to the <code class="docutils literal">'name'</code> of the resource block</li> </ul> <p>The <code class="docutils literal">instance_name</code> property is then used within the custom resource in many locations, including defining paths to configuration files, services, and virtual hosts.</p>   <h3 id="define-actions">Define Actions</h3> <p>Each custom resource must have at least one action that is defined within an <code class="docutils literal">action</code> block:</p> <pre class="highlight-ruby" data-language="ruby">action :create do
  # the steps that define the action
end</pre> <p>where <code class="docutils literal">:create</code> is a value that may be assigned to the <code class="docutils literal">action</code> property for when this resource is used in a recipe.</p> <p>For example, the <code class="docutils literal">action</code> appears as a property when this custom resource is used in a recipe:</p> <pre class="highlight-ruby" data-language="ruby">custom_resource 'name' do
  # some properties
  action :create
end</pre>   <h3 id="define-resource">Define Resource</h3> <p>Use the <strong>package</strong>, <strong>template</strong> (two times), <strong>directory</strong>, and <strong>service</strong> resources to define the <code class="docutils literal">website</code> resource. Remember: order matters !</p>  <h4 id="package">package</h4> <p>Use the <strong>package</strong> resource to install httpd:</p> <pre class="highlight-ruby" data-language="ruby">package 'httpd' do
  action :install
end</pre>   <h4 id="template-httpd-service">template, httpd.service</h4> <p>Use the <strong>template</strong> resource to create an <code class="docutils literal">httpd.service</code> on the node based on the <code class="docutils literal">httpd.service.erb</code> template located in the cookbook:</p> <pre class="highlight-ruby" data-language="ruby">template "/lib/systemd/system/httpd-#{instance_name}.service" do
  source 'httpd.service.erb'
  variables(
    :instance_name =&gt; instance_name
  )
  owner 'root'
  group 'root'
  mode '0644'
  action :create
end</pre> <p>where</p> <ul class="simple"> <li>
<code class="docutils literal">source</code> gets the <code class="docutils literal">httpd.service.erb</code> template from this cookbook</li> <li>
<code class="docutils literal">variables</code> assigns the <code class="docutils literal">instance_name</code> property to a variable in the template</li> </ul>   <h4 id="template-httpd-conf">template, httpd.conf</h4> <p>Use the <strong>template</strong> resource to configure httpd on the node based on the <code class="docutils literal">httpd.conf.erb</code> template located in the cookbook:</p> <pre class="highlight-ruby" data-language="ruby">template "/etc/httpd/conf/httpd-#{instance_name}.conf" do
  source 'httpd.conf.erb'
  variables(
    :instance_name =&gt; instance_name,
    :port =&gt; port
  )
  owner 'root'
  group 'root'
  mode '0644'
  action :create
end</pre> <p>where</p> <ul class="simple"> <li>
<code class="docutils literal">source</code> gets the <code class="docutils literal">httpd.conf.erb</code> template from this cookbook</li> <li>
<code class="docutils literal">variables</code> assigns the <code class="docutils literal">instance_name</code> and <code class="docutils literal">port</code> properties to variables in the template</li> </ul>   <h4 id="directory">directory</h4> <p>Use the <strong>directory</strong> resource to create the <code class="docutils literal">/var/www/vhosts</code> directory on the node:</p> <pre class="highlight-ruby" data-language="ruby">directory "/var/www/vhosts/#{instance_name}" do
  recursive true
  owner 'root'
  group 'root'
  mode '0755'
  action :create
end</pre>   <h4 id="service">service</h4> <p>Use the <strong>service</strong> resource to enable, and then start the service:</p> <pre class="highlight-ruby" data-language="ruby">service "httpd-#{instance_name}" do
  action [:enable, :start]
end</pre>    <h3 id="create-templates">Create Templates</h3> <p>The <code class="docutils literal">/templates</code> directory must contain two templates:</p> <ul class="simple"> <li>
<code class="docutils literal">httpd.conf.erb</code> to configure Apache httpd</li> <li>
<code class="docutils literal">httpd.service.erb</code> to tell systemd how to start and stop the website</li> </ul>  <h4 id="httpd-conf-erb">httpd.conf.erb</h4> <p><code class="docutils literal">httpd.conf.erb</code> stores information about the website and is typically located under the <code class="docutils literal">/etc/httpd</code>:</p> <pre class="highlight-ruby" data-language="ruby">ServerRoot "/etc/httpd"
Listen &lt;%= @port %&gt;
Include conf.modules.d/*.conf
User apache
Group apache
&lt;Directory /&gt;
  AllowOverride none
  Require all denied
&lt;/Directory&gt;
DocumentRoot "/var/www/vhosts/&lt;%= @instance_name %&gt;"
&lt;IfModule mime_module&gt;
  TypesConfig /etc/mime.types
&lt;/IfModule&gt;</pre> <p>Copy it as shown, add it under <code class="docutils literal">/templates/default</code>, and then name the file <code class="docutils literal">httpd.conf.erb</code>.</p>  <h5 id="template-variables">Template Variables</h5> <p>The <code class="docutils literal">httpd.conf.erb</code> template has two variables:</p> <ul class="simple"> <li><code class="docutils literal">&lt;%= @instance_name %&gt;</code></li> <li><code class="docutils literal">&lt;%= @port %&gt;</code></li> </ul> <p>They are:</p> <ul class="simple"> <li>Declared as properties of the custom resource</li> <li>Defined as variables in a <strong>template</strong> resource block within the custom resource</li> <li>Tunable from a recipe when using <code class="docutils literal">port</code> and <code class="docutils literal">instance_name</code> as properties in that recipe</li> <li>
<code class="docutils literal">instance_name</code> defaults to the <code class="docutils literal">'name'</code> of the custom resource if not specified as a property</li> </ul>    <h4 id="httpd-service-erb">httpd.service.erb</h4> <p><code class="docutils literal">httpd.service.erb</code> tells systemd how to start and stop the website:</p> <pre class="highlight-none" data-language="none">[Unit]
Description=The Apache HTTP Server - instance &lt;%= @instance_name %&gt;
After=network.target remote-fs.target nss-lookup.target

[Service]
Type=notify

ExecStart=/usr/sbin/httpd -f /etc/httpd/conf/httpd-&lt;%= @instance_name %&gt;.conf -DFOREGROUND
ExecReload=/usr/sbin/httpd -f /etc/httpd/conf/httpd-&lt;%= @instance_name %&gt;.conf -k graceful
ExecStop=/bin/kill -WINCH ${MAINPID}

KillSignal=SIGCONT
PrivateTmp=true

[Install]
WantedBy=multi-user.target</pre> <p>Copy it as shown, add it under <code class="docutils literal">/templates/default</code>, and then name it <code class="docutils literal">httpd.service.erb</code>.</p>    <h3 id="final-resource">Final Resource</h3> <pre class="highlight-ruby" data-language="ruby">property :instance_name, String, name_property: true
property :port, Fixnum, required: true

action :create do
  package 'httpd' do
    action :install
  end

  template "/lib/systemd/system/httpd-#{instance_name}.service" do
    source 'httpd.service.erb'
    variables(
      :instance_name =&gt; instance_name
    )
    owner 'root'
    group 'root'
    mode '0644'
    action :create
  end

  template "/etc/httpd/conf/httpd-#{instance_name}.conf" do
    source 'httpd.conf.erb'
    variables(
      :instance_name =&gt; instance_name,
      :port =&gt; port
    )
    owner 'root'
    group 'root'
    mode '0644'
    action :create
  end

  directory "/var/www/vhosts/#{instance_name}" do
    recursive true
    owner 'root'
    group 'root'
    mode '0755'
    action :create
  end

  service "httpd-#{instance_name}" do
    action [:enable, :start]
  end

end</pre>   <h3 id="final-cookbook-directory">Final Cookbook Directory</h3> <p>When finished adding the templates and building the custom resource, the cookbook directory structure should look like this:</p> <pre class="highlight-text" data-language="text">/website
  metadata.rb
  /recipes
    default.rb
  README.md
  /resources
    httpd.rb
  /templates
    /default
      httpd.conf.erb
      httpd.service.erb</pre>   <h3 id="recipe">Recipe</h3> <p>The custom resource name is inferred from the name of the cookbook (<code class="docutils literal">website</code>), the name of the recipe (<code class="docutils literal">httpd</code>), and is separated by an underscore(<code class="docutils literal">_</code>): <code class="docutils literal">website_httpd</code>.</p> <pre class="highlight-ruby" data-language="ruby">website_httpd 'httpd_site' do
  port 81
  action :create
end</pre> <p>which does the following:</p> <ul class="simple"> <li>Installs Apache httpd</li> <li>Assigns an instance name of <code class="docutils literal">httpd_site</code> that uses port 81</li> <li>Configures httpd and systemd from a template</li> <li>Creates the virtual host for the website</li> <li>Starts the website using systemd</li> </ul>    <h2 id="custom-resource-dsl">Custom Resource DSL</h2> <p>The following sections describe additional Custom Resource DSL methods that were not used in the preceding scenario:</p>  <h3 id="converge-if-changed">converge_if_changed</h3> <p>Use the <code class="docutils literal">converge_if_changed</code> method inside an <code class="docutils literal">action</code> block in a custom resource to compare the desired property values against the current property values (as loaded by the <code class="docutils literal">load_current_value</code> method). Use the <code class="docutils literal">converge_if_changed</code> method to ensure that updates only occur when property values on the system are not the desired property values and to otherwise prevent a resource from being converged.</p> <p>To use the <code class="docutils literal">converge_if_changed</code> method, wrap it around the part of a recipe or custom resource that should only be converged when the current state is not the desired state:</p> <pre class="highlight-ruby" data-language="ruby">action :some_action do

  converge_if_changed do
    # some property
  end

end</pre> <p>For example, a custom resource defines two properties (<code class="docutils literal">content</code> and <code class="docutils literal">path</code>) and a single action (<code class="docutils literal">:create</code>). Use the <code class="docutils literal">load_current_value</code> method to load the property value to be compared, and then use the <code class="docutils literal">converge_if_changed</code> method to tell the chef-client what to do if that value is not the desired value:</p> <pre class="highlight-ruby" data-language="ruby">property :content, String
property :path, String, name_property: true

load_current_value do
  if File.exist?(path)
    content IO.read(path)
  end
end

action :create do
  converge_if_changed do
    IO.write(path, content)
  end
end</pre> <p>When the file does not exist, the <code class="docutils literal">IO.write(path, content)</code> code is executed and the chef-client output will print something similar to:</p> <pre class="highlight-bash" data-language="bash">Recipe: recipe_name::block
  * resource_name[blah] action create
    - update my_file[blah]
    -   set content to "hola mundo" (was "hello world")</pre>  <h4 id="multiple-properties">Multiple Properties</h4> <p>The <code class="docutils literal">converge_if_changed</code> method may be used multiple times. The following example shows how to use the <code class="docutils literal">converge_if_changed</code> method to compare the multiple desired property values against the current property values (as loaded by the <code class="docutils literal">load_current_value</code> method).</p> <pre class="highlight-ruby" data-language="ruby">property :path, String, name_property: true
property :content, String
property :mode, String

load_current_value do
  if File.exist?(path)
    content IO.read(path)
    mode File.stat(path).mode
  end
end

action :create do
  converge_if_changed :content do
    IO.write(path, content)
  end
  converge_if_changed :mode do
    File.chmod(mode, path)
  end
end</pre> <p>where</p> <ul class="simple"> <li>
<code class="docutils literal">load_current_value</code> loads the property values for both <code class="docutils literal">content</code> and <code class="docutils literal">mode</code>
</li> <li>A <code class="docutils literal">converge_if_changed</code> block tests only <code class="docutils literal">content</code>
</li> <li>A <code class="docutils literal">converge_if_changed</code> block tests only <code class="docutils literal">mode</code>
</li> </ul> <p>The chef-client will only update the property values that require updates and will not make changes when the property values are already in the desired state</p>    <h3 id="default-action">default_action</h3> <p>The default action in a custom resource is, by default, the first action listed in the custom resource. For example, action <code class="docutils literal">aaaaa</code> is the default resource:</p> <pre class="highlight-ruby" data-language="ruby">property :name, RubyType, default: 'value'

...

action :aaaaa do
 # the first action listed in the custom resource
end

action :bbbbb do
 # the second action listed in the custom resource
end</pre> <p>The <code class="docutils literal">default_action</code> method may also be used to specify the default action. For example:</p> <pre class="highlight-ruby" data-language="ruby">property :name, RubyType, default: 'value'

default_action :aaaaa

action :aaaaa do
 # the first action listed in the custom resource
end

action :bbbbb do
 # the second action listed in the custom resource
end</pre> <p>defines action <code class="docutils literal">aaaaa</code> as the default action. If <code class="docutils literal">default_action :bbbbb</code> is specified, then action <code class="docutils literal">bbbbb</code> is the default action. Use this method for clarity in custom resources, if deliberately stating the default resource is desired, or to specify a default action that is not listed first in the custom resource.</p>   <h3 id="load-current-value">load_current_value</h3> <p>Use the <code class="docutils literal">load_current_value</code> method to load the specified property values from the node, and then use those values when the resource is converged. This method may take a block argument.</p> <p>Use the <code class="docutils literal">load_current_value</code> method to guard against property values being replaced. For example:</p> <pre class="highlight-ruby" data-language="ruby">action :some_action do

  load_current_value do
    if File.exist?('/var/www/html/index.html')
      homepage IO.read('/var/www/html/index.html')
    end
    if File.exist?('/var/www/html/404.html')
      page_not_found IO.read('/var/www/html/404.html')
    end
  end

end</pre> <p>This ensures the values for <code class="docutils literal">homepage</code> and <code class="docutils literal">page_not_found</code> are not changed to the default values when the chef-client configures the node.</p>   <h3 id="new-resource-property">new_resource.property</h3> <p>Custom resources are designed to use core resources that are built into Chef. In some cases, it may be necessary to specify a property in the custom resource that is the same as a property in a core resource, for the purpose of overriding that property when used with the custom resource. For example:</p> <pre class="highlight-ruby" data-language="ruby">resource_name :node_execute

property :command, kind_of: String, name_property: true
property :version, kind_of: String

# Useful properties from the `execute` resource
property :cwd, kind_of: String
property :environment, kind_of: Hash, default: {}
property :user, kind_of: [String, Integer]
property :sensitive, kind_of: [TrueClass, FalseClass], default: false

prefix = '/opt/languages/node'

load_current_value do
  current_value_does_not_exist! if node.run_state['nodejs'].nil?
  version node.run_state['nodejs'][:version]
end

action :run do
  execute 'execute-node' do
    cwd cwd
    environment environment
    user user
    sensitive sensitive
    # gsub replaces 10+ spaces at the beginning of the line with nothing
    command &lt;&lt;-CODE.gsub(/^ {10}/, '')
      #{prefix}/#{version}/#{command}
    CODE
  end
end</pre> <p>where the <code class="docutils literal">property :cwd</code>, <code class="docutils literal">property :environment</code>, <code class="docutils literal">property :user</code>, and <code class="docutils literal">property :sensitive</code> are identical to properties in the <strong>execute</strong> resource, embedded as part of the <code class="docutils literal">action :run</code> action. Because both the custom properties and the <strong>execute</strong> properties are identical, this will result in an error message similar to:</p> <pre class="highlight-ruby" data-language="ruby">ArgumentError
-------------
wrong number of arguments (0 for 1)</pre> <p>To prevent this behavior, use <code class="docutils literal">new_resource.</code> to tell the chef-client to process the properties from the core resource instead of the properties in the custom resource. For example:</p> <pre class="highlight-ruby" data-language="ruby">resource_name :node_execute

property :command, kind_of: String, name_property: true
property :version, kind_of: String

# Useful properties from the `execute` resource
property :cwd, kind_of: String
property :environment, kind_of: Hash, default: {}
property :user, kind_of: [String, Integer]
property :sensitive, kind_of: [TrueClass, FalseClass], default: false

prefix = '/opt/languages/node'

load_current_value do
  current_value_does_not_exist! if node.run_state['nodejs'].nil?
  version node.run_state['nodejs'][:version]
end

action :run do
  execute 'execute-node' do
    cwd new_resource.cwd
    environment new_resource.environment
    user new_resource.user
    sensitive new_resource.sensitive
    # gsub replaces 10+ spaces at the beginning of the line with nothing
    command &lt;&lt;-CODE.gsub(/^ {10}/, '')
      #{prefix}/#{new_resource.version}/#{new_resource.command}
    CODE
  end
end</pre> <p>where <code class="docutils literal">cwd new_resource.cwd</code>, <code class="docutils literal">environment new_resource.environment</code>, <code class="docutils literal">user new_resource.user</code>, and <code class="docutils literal">sensitive new_resource.sensitive</code> correctly use the properties of the <strong>execute</strong> resource and not the identically-named override properties of the custom resource.</p>   <h3 id="property">property</h3> <p>Use the <code class="docutils literal">property</code> method to define properties for the custom resource. The syntax is:</p> <pre class="highlight-ruby" data-language="ruby">property :name, ruby_type, default: 'value', parameter: 'values'</pre> <p>where</p> <ul class="simple"> <li>
<code class="docutils literal">:name</code> is the name of the property</li> <li>
<code class="docutils literal">ruby_type</code> is the optional Ruby type, such as <code class="docutils literal">String</code>, <code class="docutils literal">Integer</code>, <code class="docutils literal">TrueClass</code>, or <code class="docutils literal">FalseClass</code>
</li> <li>
<code class="docutils literal">default: 'value'</code> is the optional default value loaded into the resource</li> <li>
<code class="docutils literal">parameter: 'values'</code> are optional validation parameters and values</li> </ul> <p>For example, the following properties define <code class="docutils literal">username</code> and <code class="docutils literal">password</code> properties with no default values specified:</p> <pre class="highlight-ruby" data-language="ruby">property :username, String
property :password, String</pre>  <h4 id="desired-state">desired_state</h4> <p>Add <code class="docutils literal">desired_state:</code> to get or set the list of desired state properties for a resource, which describe the desired state of the node, such as permissions on an existing file. This value may be <code class="docutils literal">true</code> or <code class="docutils literal">false</code>.</p> <ul class="simple"> <li>When <code class="docutils literal">true</code>, the state of the system will determine the value.</li> <li>When <code class="docutils literal">false</code>, the values defined by the recipe or custom resource will determine the value, i.e. “the desired state of this system includes setting the value defined in this custom resource or recipe”</li> </ul> <p>For example, the following properties define the <code class="docutils literal">owner</code>, <code class="docutils literal">group</code>, and <code class="docutils literal">mode</code> properties for a file that already exists on the node, and with <code class="docutils literal">desired_state</code> set to <code class="docutils literal">false</code>:</p> <pre class="highlight-ruby" data-language="ruby">property :owner, String, default: 'root', desired_state: false
property :group, String, default: 'root', desired_state: false
property :mode, String, default: '0755', desired_state: false</pre>   <h4 id="identity">identity</h4> <p>Add <code class="docutils literal">identity:</code> to set a resource to a particular set of properties. This value may be <code class="docutils literal">true</code> or <code class="docutils literal">false</code>.</p> <ul class="simple"> <li>When <code class="docutils literal">true</code>, data for that property is returned as part of the resource data set and may be available to external applications, such as reporting</li> <li>When <code class="docutils literal">false</code>, no data for that property is returned.</li> </ul> <p>If no properties are marked <code class="docutils literal">true</code>, the property that defaults to the <code class="docutils literal">name</code> of the resource is marked <code class="docutils literal">true</code>.</p> <p>For example, the following properties define <code class="docutils literal">username</code> and <code class="docutils literal">password</code> properties with no default values specified, but with <code class="docutils literal">identity</code> set to <code class="docutils literal">true</code> for the user name:</p> <pre class="highlight-ruby" data-language="ruby">property :username, String, identity: true
property :password, String</pre>   <h4 id="block-arguments">Block Arguments</h4> <p>Any properties that are marked <code class="docutils literal">identity: true</code> or <code class="docutils literal">desired_state: false</code> will be available from <code class="docutils literal">load_current_value</code>. If access to other properties of a resource is needed, use a block argument that contains all of the properties of the requested resource. For example:</p> <pre class="highlight-ruby" data-language="ruby">resource_name :file

load_current_value do |desired|
  puts "The user typed content = #{desired.content} in the resource"
end</pre>    <h3 id="property-is-set">property_is_set?</h3> <p>Use the <code class="docutils literal">property_is_set?</code> method to check if the value for a property is set. The syntax is:</p> <pre class="highlight-ruby" data-language="ruby">property_is_set?(:property_name)</pre> <p>The <code class="docutils literal">property_is_set?</code> method will return <code class="docutils literal">true</code> if the property is set.</p> <p>For example, the following custom resource creates and/or updates user properties, but not their password. The <code class="docutils literal">property_is_set?</code> method checks if the user has specified a password and then tells the chef-client what to do if the password is not identical:</p> <pre class="highlight-ruby" data-language="ruby">action :create do
  converge_if_changed do
    system("rabbitmqctl create_or_update_user #{username} --prop1 #{prop1} ... ")
  end

  if property_is_set?(:password)
    if system("rabbitmqctl authenticate_user #{username} #{password}") != 0 do
      converge_by "Updating password for user #{username} ..." do
    system("rabbitmqctl update_user #{username} --password #{password}")
  end
end</pre>   <h3 id="provides">provides</h3> <p>Use the <code class="docutils literal">provides</code> method to associate a custom resource with the Recipe DSL on different operating systems. When multiple custom resources use the same DSL, specificity rules are applied to determine the priority, from highest to lowest:</p> <ol class="arabic simple"> <li>provides :resource_name, platform_version: ‘0.1.2’</li> <li>provides :resource_name, platform: ‘platform_name’</li> <li>provides :resource_name, platform_family: ‘platform_family’</li> <li>provides :resource_name, os: ‘operating_system’</li> <li>provides :resource_name</li> </ol> <p>For example:</p> <pre class="highlight-ruby" data-language="ruby">provides :my_custom_resource, platform: 'redhat' do |node|
  node['platform_version'].to_i &gt;= 7
end

provides :my_custom_resource, platform: 'redhat'

provides :my_custom_resource, platform_family: 'rhel'

provides :my_custom_resource, os: 'linux'

provides :my_custom_resource</pre> <p>This allows you to use multiple custom resources files that provide the same resource to the user, but for different operating systems or operation system versions. With this you can eliminate the need for platform or platform version logic within your resources.</p>  <h4 id="override">override</h4> <p>Chef will warn you if the Recipe DSL is provided by another custom resource or built-in resource. For example:</p> <pre class="highlight-ruby" data-language="ruby">class X &lt; Chef::Resource
  provides :file
end

class Y &lt; Chef::Resource
  provides :file
end</pre> <p>This will emit a warning that <code class="docutils literal">Y</code> is overriding <code class="docutils literal">X</code>. To disable this warning, use <code class="docutils literal">override: true</code>:</p> <pre class="highlight-ruby" data-language="ruby">class X &lt; Chef::Resource
  provides :file
end

class Y &lt; Chef::Resource
  provides :file, override: true
end</pre>    <h3 id="reset-property">reset_property</h3> <p>Use the <code class="docutils literal">reset_property</code> method to clear the value for a property as if it had never been set, and then use the default value. For example, to clear the value for a property named <code class="docutils literal">password</code>:</p> <pre class="highlight-ruby" data-language="ruby">reset_property(:password)</pre>
<div class="_attribution">
  <p class="_attribution-p">
    © Chef Software, Inc.<br>Licensed under the Creative Commons Attribution 3.0 Unported License.<br>The Chef™ Mark and Chef Logo are either registered trademarks/service marks or trademarks/servicemarks of Chef, in the United States and other countries and are used with Chef Inc's permission.<br>We are not affiliated with, endorsed or sponsored by Chef Inc.<br>
    <a href="https://docs-archive.chef.io/release/12-13/custom_resources.html" class="_attribution-link">https://docs-archive.chef.io/release/12-13/custom_resources.html</a>
  </p>
</div>

				
			</div>
			<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-2572770204602497"
     data-ad-slot="1992473792"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
		</div>
	</section>

	</div>
	<svg style="display:none">
		<symbol id="icon-dir"><svg viewBox="0 0 20 20"><path d="M15 10c0 .3-.305.515-.305.515l-8.56 5.303c-.625.41-1.135.106-1.135-.67V4.853c0-.777.51-1.078 1.135-.67l8.56 5.305S15 9.702 15 10z"/></svg></symbol>
	  </svg>
</body>
</html>
