
<!DOCTYPE HTML>

<html lang="en" class="_theme-default">

<head>
  <meta charset="utf-8">
  <title>Common Functionality - Chef 12 - W3cubDocs</title>
  
  <meta name="description" content="All resources (including custom resources) share a set of common actions, properties, conditional executions, notifications, and relative path &hellip;">
  <meta name="keywords" content="common, functionality, chef, chef~12">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="mobile-web-app-capable" content="yes">
  
  <link rel="canonical" href="https://docs.w3cub.com/chef~12/12-13/resource_common.html">
  <link href="/favicon.png" rel="icon">
  <link rel="stylesheet" type="text/css" href="/assets/application-e498cd0ebe8746846fec95b1a53ab3bb0fb7f47f794f0a38f44c98a1f0d03b21d777ae2c583732e44a5a890f6eacb79a5333545db9d5f3616091ba21ca17d916.css">
  <script src="/assets/application-79c555f6b25481fffac2cac30a7f3e54e608ca09e9e8e42bb1790095ba6d0fcace47d6bc624ddce952c70370892f2d46864f89e6943d4f7f7ff16c8a3231a91a.js" type="text/javascript"></script>
  <script src="/json/chef~12.js"></script>
  
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-R3WC07G3GB"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-R3WC07G3GB');
</script>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2572770204602497"
     crossorigin="anonymous"></script>
<script async custom-element="amp-auto-ads"
  src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
</script>


</head>

<body class="docs">
	<amp-auto-ads type="adsense"
              data-ad-client="ca-pub-2572770204602497">
	</amp-auto-ads>
	<div class="_app">
	<header class="_header">

  <a class="_home-link" href="/" ></a>
  <a class="_menu-link"></a>
  <h1 class="_logo">
    <a href="/" class="_nav-link" title="API Documentation Browser">W3cubDocs</a>
  </h1>
  
  <span class="_logo-sub-nav">/</span><span class="_logo-sub-nav"><a href="/chef~12/" class="_nav-link" title="" style="margin-left:0;">Chef 12</a></span>
  
  <nav class="_nav">
    <a href="https://tools.w3cub.com/?_sp=docs" target="_blank" class="_nav-link ">W3cubTools</a>
    <a href="/cheatsheets/" class="_nav-link ">Cheatsheets</a>
    <a href="/about/" class="_nav-link ">About</a>
  </nav>
</header>
	<section class="_sidebar">
		
		<form class="_search">
		  <input type="search" class="_search-input" placeholder="Search&hellip;" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" maxlength="20">
		  <a class="_search-clear"></a>
		  <div class="_search-tag"></div>
		</form>
		
		<div class="_list-wrap">
			<div class="_list">
			
			</div>
		</div>
	</section>
	<section class="_container ">
		<div class="_content">
			<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-2572770204602497"
     data-ad-slot="6861657091"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
			<div class="_page _sphinx_simple">
				
				
<h1 id="common-functionality">Common Functionality</h1> <p>All resources (including custom resources) share a set of common actions, properties, conditional executions, notifications, and relative path options.</p>  <h2>Actions</h2> <p>The following actions may be used with any resource:</p> <dl class="docutils"> <dt><code class="docutils literal">:nothing</code></dt> <dd>Define this resource block to do nothing until notified by another resource to take action. When this resource is notified, this resource block is either run immediately or it is queued up to be run at the end of the chef-client run.</dd> </dl>  <h3 id="examples">Examples</h3> <p>The following examples show how to use common actions in a recipe.</p> <p><strong>Use the :nothing action</strong></p> <pre class="highlight-ruby" data-language="ruby">service 'memcached' do
  action :nothing
  supports :status =&gt; true, :start =&gt; true, :stop =&gt; true, :restart =&gt; true
end</pre>    <h2>Properties</h2> <p>The following properties are common to every resource:</p> <dl class="docutils"> <dt><code class="docutils literal">ignore_failure</code></dt> <dd>
<p class="first"><strong>Ruby Types:</strong> TrueClass, FalseClass</p> <p class="last">Continue running a recipe if a resource fails for any reason. Default value: <code class="docutils literal">false</code>.</p> </dd> <dt><code class="docutils literal">provider</code></dt> <dd>
<p class="first"><strong>Ruby Type:</strong> Chef Class</p> <p class="last">Optional. The chef-client will attempt to determine the correct provider during the chef-client run, and then choose the best/correct provider based on configuration data collected at the start of the chef-client run. In general, a provider does not need to be specified.</p> </dd> <dt><code class="docutils literal">retries</code></dt> <dd>
<p class="first"><strong>Ruby Type:</strong> Integer</p> <p class="last">The number of times to catch exceptions and retry the resource. Default value: <code class="docutils literal">0</code>.</p> </dd> <dt><code class="docutils literal">retry_delay</code></dt> <dd>
<p class="first"><strong>Ruby Type:</strong> Integer</p> <p class="last">The retry delay (in seconds). Default value: <code class="docutils literal">2</code>.</p> </dd> <dt><code class="docutils literal">sensitive</code></dt> <dd>
<p class="first"><strong>Ruby Types:</strong> TrueClass, FalseClass</p> <p class="last">Ensure that sensitive resource data is not logged by the chef-client. Default value: <code class="docutils literal">false</code>. This property only applies to the <strong>execute</strong>, <strong>file</strong> and <strong>template</strong> resources.</p> </dd> <dt><code class="docutils literal">supports</code></dt> <dd>
<p class="first"><strong>Ruby Type:</strong> Hash</p> <p class="last">A hash of options that contains hints about the capabilities of a resource. The chef-client may use these hints to help identify the correct provider. This property is only used by a small number of providers, including <strong>user</strong> and <strong>service</strong>.</p> </dd> </dl>  <h3 id="id1">Examples</h3> <p>The following examples show how to use common properties in a recipe.</p> <p><strong>Use the ignore_failure common property</strong></p> <pre class="highlight-ruby" data-language="ruby">gem_package 'syntax' do
  action :install
  ignore_failure true
end</pre> <p><strong>Use the provider common property</strong></p> <pre class="highlight-ruby" data-language="ruby">package 'some_package' do
  provider Chef::Provider::Package::Rubygems
end</pre> <p><strong>Use the supports common property</strong></p> <pre class="highlight-ruby" data-language="ruby">service 'apache' do
  supports :restart =&gt; true, :reload =&gt; true
  action :enable
end</pre> <p><strong>Use the supports and providers common properties</strong></p> <pre class="highlight-ruby" data-language="ruby">service 'some_service' do
  provider Chef::Provider::Service::Upstart
  supports :status =&gt; true, :restart =&gt; true, :reload =&gt; true
  action [ :enable, :start ]
end</pre>    <h2>Guards</h2> <p>A guard property can be used to evaluate the state of a node during the execution phase of the chef-client run. Based on the results of this evaluation, a guard property is then used to tell the chef-client if it should continue executing a resource. A guard property accepts either a string value or a Ruby block value:</p> <ul class="simple"> <li>A string is executed as a shell command. If the command returns <code class="docutils literal">0</code>, the guard is applied. If the command returns any other value, then the guard property is not applied. String guards in a <strong>powershell_script</strong> run Windows PowerShell commands and may return <code class="docutils literal">true</code> in addition to <code class="docutils literal">0</code>.</li> <li>A block is executed as Ruby code that must return either <code class="docutils literal">true</code> or <code class="docutils literal">false</code>. If the block returns <code class="docutils literal">true</code>, the guard property is applied. If the block returns <code class="docutils literal">false</code>, the guard property is not applied.</li> </ul> <p>A guard property is useful for ensuring that a resource is idempotent by allowing that resource to test for the desired state as it is being executed, and then if the desired state is present, for the chef-client to do nothing.</p> <div class="admonition note"> <p class="first admonition-title">Note</p> <p>When using the <code class="docutils literal">not_if</code> and <code class="docutils literal">only_if</code> guards with the <strong>execute</strong> resource, the current working directory property (<code class="docutils literal">cwd</code>) is <strong>not</strong> inherited from the resource. For example:</p> <pre class="last highlight-ruby" data-language="ruby">execute 'bundle install' do
  cwd '/myapp'
  not_if 'bundle check' # This is not run inside /myapp
end</pre> </div>  <h3 id="attributes">Attributes</h3> <p>The following properties can be used to define a guard that is evaluated during the execution phase of the chef-client run:</p> <dl class="docutils"> <dt><code class="docutils literal">not_if</code></dt> <dd>Prevent a resource from executing when the condition returns <code class="docutils literal">true</code>.</dd> <dt><code class="docutils literal">only_if</code></dt> <dd>Allow a resource to execute only if the condition returns <code class="docutils literal">true</code>.</dd> </dl>   <h3 id="arguments">Arguments</h3> <p>The following arguments can be used with the <code class="docutils literal">not_if</code> or <code class="docutils literal">only_if</code> guard properties:</p> <dl class="docutils"> <dt><code class="docutils literal">:user</code></dt> <dd>
<p class="first">Specify the user that a command will run as. For example:</p> <pre class="last highlight-ruby" data-language="ruby">not_if 'grep adam /etc/passwd', :user =&gt; 'adam'</pre> </dd> <dt><code class="docutils literal">:group</code></dt> <dd>
<p class="first">Specify the group that a command will run as. For example:</p> <pre class="last highlight-ruby" data-language="ruby">not_if 'grep adam /etc/passwd', :group =&gt; 'adam'</pre> </dd> <dt><code class="docutils literal">:environment</code></dt> <dd>
<p class="first">Specify a Hash of environment variables to be set. For example:</p> <pre class="last highlight-ruby" data-language="ruby">not_if 'grep adam /etc/passwd', :environment =&gt; {
  'HOME' =&gt; '/home/adam'
}</pre> </dd> <dt><code class="docutils literal">:cwd</code></dt> <dd>
<p class="first">Set the current working directory before running a command. For example:</p> <pre class="last highlight-ruby" data-language="ruby">not_if 'grep adam passwd', :cwd =&gt; '/etc'</pre> </dd> <dt><code class="docutils literal">:timeout</code></dt> <dd>
<p class="first">Set a timeout for a command. For example:</p> <pre class="last highlight-ruby" data-language="ruby">not_if 'sleep 10000', :timeout =&gt; 10</pre> </dd> </dl>   <h3 id="not-if-examples">not_if Examples</h3> <p><strong>Update if not already updated</strong></p> <p>The following example shows how to use <code class="docutils literal">not_if</code> to guard against running the <code class="docutils literal">apt-get-update</code> command when a file already exists that is the same as the updated file:</p> <pre class="highlight-ruby" data-language="ruby">execute "apt-get-update" do
  command "apt-get update"
  ignore_failure true
  not_if do ::File.exist?('/var/lib/apt/periodic/update-success-stamp') end
end</pre> <p><strong>Ensure a node can resolve a host</strong></p> <p>The following example shows how to use a custom block of Ruby code to ensure that a node can resolve the host. If the node can resolve the host, the chef-client will do nothing. If the node cannot resolve the host, the chef-client will configure the host:</p> <pre class="highlight-ruby" data-language="ruby">ruby_block "ensure node can resolve API FQDN" do
  block do
    fe = Chef::Util::FileEdit.new("/etc/hosts")
    fe.insert_line_if_no_match(/#{node['chef-server']['api_fqdn']}/,
                               "127.0.0.1 #{node['chef-server']['api_fqdn']}")
    fe.write_file
  end
  not_if { Resolv.getaddress(node['chef-server']['api_fqdn']) rescue false }
end</pre> <p><strong>Prevent installs on older versions</strong></p> <p>The following example shows how to use <code class="docutils literal">not_if</code> to prevent ZeroMQ from being installed when the node on which the install is to occur has a version of Red Hat Enterprise Linux that is older than version 6.0:</p> <pre class="highlight-ruby" data-language="ruby">ark "test_autogen" do
  url 'https://github.com/zeromq/libzmq/tarball/master'
  extension "tar.gz"
  action :configure
  not_if { platform_family?('rhel') &amp;&amp; node['platform_version'].to_f &lt; 6.0 }
end</pre> <p><strong>Set the administrator if not already set</strong></p> <p>The following example shows how to set the administrator for Nagios on multiple nodes, except when the package already exists on a node:</p> <pre class="highlight-ruby" data-language="ruby">%w{adminpassword adminpassword-repeat}.each do |setting|
  execute "debconf-set-selections::#{node['nagios']['server']['vname']}-cgi::#{node['nagios']['server']['vname']}/#{setting}" do
    command "echo #{node['nagios']['server']['vname']}-cgi #{node['nagios']['server']['vname']}/#{setting} password #{random_initial_password} | debconf-set-selections"
    not_if "dpkg -l #{node['nagios']['server']['vname']}"
  end
end</pre>   <h3 id="only-if-examples">only_if Examples</h3> <p><strong>Install packages only when necessary</strong></p> <p>The following example shows how to use <code class="docutils literal">only_if</code> with one (or more) cookbook attributes to ensure that packages are only installed when necessary. In this case, three attributes exist in the <code class="docutils literal">/attributes/default.rb</code> file: <code class="docutils literal">use_openssl</code>, <code class="docutils literal">use_pcre</code>, and <code class="docutils literal">use_zlib</code>. Each of these attributes are defined as <code class="docutils literal">false</code> by default. The <code class="docutils literal">only_if</code> attributes are used to test for the presence of these packages on the target node before then asking the chef-client to complete the process of installing these packages. If the packages are already present, the chef-client will do nothing.</p> <pre class="highlight-ruby" data-language="ruby">package 'libpcre3-dev' do
  only_if { node['haproxy']['source']['use_pcre'] }
end

package 'libssl-dev' do
  only_if { node['haproxy']['source']['use_openssl'] }
end

package 'zlib1g-dev' do
  only_if { node['haproxy']['source']['use_zlib'] }
end</pre> <p><strong>Remove a recipe if it belongs to a specific run-list</strong></p> <p>The following example shows how to use <code class="docutils literal">only_if</code> to only remove a recipe named <code class="docutils literal">recipe[ntp::undo]</code>, but only when that recipe is part of the <code class="docutils literal">recipe[ntp::default]</code> run-list:</p> <pre class="highlight-ruby" data-language="ruby">ruby_block 'remove ntp::undo from run list' do
  block do
    node.run_list.remove('recipe[ntp::undo]')
  end
  only_if { node.run_list.include?('recipe[ntp::default]') }
end</pre> <p><strong>Re-register ASP.Net if it’s already installed</strong></p> <p>The following example shows how to use <code class="docutils literal">only_if</code> to ensure that the chef-client will attempt to register ASP.NET only if the executable is installed on the system, on both 32- and 64-bit systems:</p> <pre class="highlight-ruby" data-language="ruby">aspnet_regiis = "#{ENV['WinDir']}\\Microsoft.NET\\Framework\\v4.0.30319\\aspnet_regiis.exe"
execute 'Register ASP.NET v4' do
  command "#{aspnet_regiis} -i"
  only_if { File.exist?(aspnet_regiis) }
  action :nothing
end

aspnet_regiis64 = "#{ENV['WinDir']}\\Microsoft.NET\\Framework64\\v4.0.30319\\aspnet_regiis.exe"
execute 'Register ASP.NET v4 (x64)' do
  command "#{aspnet_regiis64} -i"
  only_if { File.exist?(aspnet_regiis64) }
  action :nothing
end</pre>    <h2>Guard Interpreters</h2> <p>Any resource that passes a string command may also specify the interpreter that will be used to evaluate that string command. This is done by using the <code class="docutils literal">guard_interpreter</code> property to specify a <strong>script</strong>-based resource.</p>  <h3 id="id2">Attributes</h3> <p>The <code class="docutils literal">guard_interpreter</code> property may be set to any of the following values:</p> <dl class="docutils"> <dt><code class="docutils literal">:bash</code></dt> <dd>Evaluates a string command using the <strong>bash</strong> resource.</dd> <dt><code class="docutils literal">:batch</code></dt> <dd>Evaluates a string command using the <strong>batch</strong> resource. Default value (within a <strong>batch</strong> resource block): <code class="docutils literal">:batch</code>.</dd> <dt><code class="docutils literal">:csh</code></dt> <dd>Evaluates a string command using the <strong>csh</strong> resource.</dd> <dt><code class="docutils literal">:default</code></dt> <dd>Default. Executes the default interpreter as identified by the chef-client.</dd> <dt><code class="docutils literal">:perl</code></dt> <dd>Evaluates a string command using the <strong>perl</strong> resource.</dd> <dt><code class="docutils literal">:powershell_script</code></dt> <dd>Evaluates a string command using the <strong>powershell_script</strong> resource. Default value (within a <strong>batch</strong> resource block): <code class="docutils literal">:powershell_script</code>.</dd> <dt><code class="docutils literal">:python</code></dt> <dd>Evaluates a string command using the <strong>python</strong> resource.</dd> <dt><code class="docutils literal">:ruby</code></dt> <dd>Evaluates a string command using the <strong>ruby</strong> resource.</dd> </dl>   <h3 id="inheritance">Inheritance</h3> <p>The <code class="docutils literal">guard_interpreter</code> property is set to <code class="docutils literal">:default</code> by default for the <strong>bash</strong>, <strong>csh</strong>, <strong>perl</strong>, <strong>python</strong>, and <strong>ruby</strong> resources. When the <code class="docutils literal">guard_interpreter</code> property is set to <code class="docutils literal">:default</code>, <code class="docutils literal">not_if</code> or <code class="docutils literal">only_if</code> guard statements <strong>do not inherit</strong> properties that are defined by the <strong>script</strong>-based resource.</p> <div class="admonition warning"> <p class="first admonition-title">Warning</p> <p class="last">The <strong>batch</strong> and <strong>powershell_script</strong> resources inherit properties by default. The <code class="docutils literal">guard_interpreter</code> property is set to <code class="docutils literal">:batch</code> or <code class="docutils literal">:powershell_script</code> automatically when using a <code class="docutils literal">not_if</code> or <code class="docutils literal">only_if</code> guard statement within a <strong>batch</strong> or <strong>powershell_script</strong> resource, respectively.</p> </div> <p>For example, the <code class="docutils literal">not_if</code> guard statement in the following resource example <strong>does not inherit</strong> the <code class="docutils literal">environment</code> property:</p> <pre class="highlight-ruby" data-language="ruby">bash 'javatooling' do
  environment 'JAVA_HOME' =&gt; '/usr/lib/java/jdk1.7/home'
  code 'java-based-daemon-ctl.sh -start'
  not_if 'java-based-daemon-ctl.sh -test-started'
end</pre> <p>and requires adding the <code class="docutils literal">environment</code> property to the <code class="docutils literal">not_if</code> guard statement so that it may use the <code class="docutils literal">JAVA_HOME</code> path as part of its evaluation:</p> <pre class="highlight-ruby" data-language="ruby">bash 'javatooling' do
  environment 'JAVA_HOME' =&gt; '/usr/lib/java/jdk1.7/home'
  code 'java-based-daemon-ctl.sh -start'
  not_if 'java-based-daemon-ctl.sh -test-started', :environment =&gt; 'JAVA_HOME' =&gt; '/usr/lib/java/jdk1.7/home'
end</pre> <p>To inherit properties, add the <code class="docutils literal">guard_interpreter</code> property to the resource block and set it to the appropriate value:</p> <ul class="simple"> <li>
<code class="docutils literal">:bash</code> for <strong>bash</strong>
</li> <li>
<code class="docutils literal">:csh</code> for <strong>csh</strong>
</li> <li>
<code class="docutils literal">:perl</code> for <strong>perl</strong>
</li> <li>
<code class="docutils literal">:python</code> for <strong>python</strong>
</li> <li>
<code class="docutils literal">:ruby</code> for <strong>ruby</strong>
</li> </ul> <p>For example, using the same example as from above, but this time adding the <code class="docutils literal">guard_interpreter</code> property and setting it to <code class="docutils literal">:bash</code>:</p> <pre class="highlight-ruby" data-language="ruby">bash 'javatooling' do
  guard_interpreter :bash
  environment 'JAVA_HOME' =&gt; '/usr/lib/java/jdk1.7/home'
  code 'java-based-daemon-ctl.sh -start'
  not_if 'java-based-daemon-ctl.sh -test-started'
end</pre> <p>The <code class="docutils literal">not_if</code> statement now inherits the <code class="docutils literal">environment</code> property and will use the <code class="docutils literal">JAVA_HOME</code> path as part of its evaluation.</p>   <h3 id="id3">Examples</h3> <p>For example, the following code block will ensure the command is evaluated using the default intepreter as identified by the chef-client:</p> <pre class="highlight-ruby" data-language="ruby">resource 'name' do
  guard_interpreter :default
  # code
end</pre>    <h2>Lazy Evaluation</h2> <p>In some cases, the value for a property cannot be known until the execution phase of a chef-client run. In this situation, using lazy evaluation of property values can be helpful. Instead of a property being assigned a value, it may instead be assigned a code block. The syntax for using lazy evaluation is as follows:</p> <pre class="highlight-ruby" data-language="ruby">attribute_name lazy { code_block }</pre> <p>where <code class="docutils literal">lazy</code> is used to tell the chef-client to evaluate the contents of the code block later on in the resource evaluation process (instead of immediately) and <code class="docutils literal">{ code_block }</code> is arbitrary Ruby code that provides the value.</p> <p>For example, a resource that is <strong>not</strong> doing lazy evaluation:</p> <pre class="highlight-ruby" data-language="ruby">template 'template_name' do
  # some attributes
  path '/foo/bar'
end</pre> <p>and a resource block that is doing lazy evaluation:</p> <pre class="highlight-ruby" data-language="ruby">template 'template_name' do
  # some attributes
  path lazy { ' some Ruby code ' }
end</pre> <p>In the previous examples, the first resource uses the value <code class="docutils literal">/foo/bar</code> and the second resource uses the value provided by the code block, as long as the contents of that code block are a valid resource property.</p> <p>The following example shows how to use lazy evaluation with template variables:</p> <pre class="highlight-ruby" data-language="ruby">template '/tmp/canvey_island.txt' do
  source 'canvey_island.txt.erb'
  variables(
    lazy {
      { :canvey_island =&gt; node.run_state['sea_power'] }
    }
  )
end</pre>   <h2>Notifications</h2> <p>A notification is a property on a resource that listens to other resources in the resource collection and then takes actions based on the notification type (<code class="docutils literal">notifies</code> or <code class="docutils literal">subscribes</code>).</p>  <h3 id="timers">Timers</h3> <p>A timer specifies the point during the chef-client run at which a notification is run. The following timers are available:</p> <dl class="docutils"> <dt><code class="docutils literal">:before</code></dt> <dd>Specifies that the action on a notified resource should be run before processing the resource block in which the notification is located.</dd> <dt><code class="docutils literal">:delayed</code></dt> <dd>Default. Specifies that a notification should be queued up, and then executed at the very end of the chef-client run.</dd> <dt>
<code class="docutils literal">:immediate</code>, <code class="docutils literal">:immediately</code>
</dt> <dd>Specifies that a notification should be run immediately, per resource notified.</dd> </dl>   <h3 id="notifies">Notifies</h3> <p>A resource may notify another resource to take action when its state changes. Specify a <code class="docutils literal">'resource[name]'</code>, the <code class="docutils literal">:action</code> that resource should take, and then the <code class="docutils literal">:timer</code> for that action. A resource may notifiy more than one resource; use a <code class="docutils literal">notifies</code> statement for each resource to be notified.</p> <p>The syntax for <code class="docutils literal">notifies</code> is:</p> <pre class="highlight-ruby" data-language="ruby">notifies :action, 'resource[name]', :timer</pre>  <h4 id="id4">Examples</h4> <p>The following examples show how to use the <code class="docutils literal">notifies</code> notification in a recipe.</p> <p><strong>Delay notifications</strong></p> <pre class="highlight-ruby" data-language="ruby">template '/etc/nagios3/configures-nagios.conf' do
  # other parameters
  notifies :run, 'execute[test-nagios-config]', :delayed
end</pre> <p><strong>Notify immediately</strong></p> <p>By default, notifications are <code class="docutils literal">:delayed</code>, that is they are queued up as they are triggered, and then executed at the very end of a chef-client run. To run an action immediately, use <code class="docutils literal">:immediately</code>:</p> <pre class="highlight-ruby" data-language="ruby">template '/etc/nagios3/configures-nagios.conf' do
  # other parameters
  notifies :run, 'execute[test-nagios-config]', :immediately
end</pre> <p>and then the chef-client would immediately run the following:</p> <pre class="highlight-ruby" data-language="ruby">execute 'test-nagios-config' do
  command 'nagios3 --verify-config'
  action :nothing
end</pre> <p><strong>Notify multiple resources</strong></p> <pre class="highlight-ruby" data-language="ruby">template '/etc/chef/server.rb' do
  source 'server.rb.erb'
  owner 'root'
  group 'root'
  mode '0755'
  notifies :restart, 'service[chef-solr]', :delayed
  notifies :restart, 'service[chef-solr-indexer]', :delayed
  notifies :restart, 'service[chef-server]', :delayed
end</pre> <p><strong>Notify in a specific order</strong></p> <p>To notify multiple resources, and then have these resources run in a certain order, do something like the following:</p> <pre class="highlight-ruby" data-language="ruby">execute 'foo' do
  command '...'
  notifies :create, 'template[baz]', :immediately
  notifies :install, 'package[bar]', :immediately
  notifies :run, 'execute[final]', :immediately
end

template 'baz' do
  ...
  notifies :run, 'execute[restart_baz]', :immediately
end

package 'bar'

execute 'restart_baz'

execute 'final' do
  command '...'
end</pre> <p>where the sequencing will be in the same order as the resources are listed in the recipe: <code class="docutils literal">execute 'foo'</code>, <code class="docutils literal">template 'baz'</code>, <code class="docutils literal">execute [restart_baz]</code>, <code class="docutils literal">package 'bar'</code>, and <code class="docutils literal">execute 'final'</code>.</p> <p><strong>Reload a service</strong></p> <pre class="highlight-ruby" data-language="ruby">template '/tmp/somefile' do
  mode '0755'
  source 'somefile.erb'
  notifies :reload, 'service[apache]', :immediately
end</pre> <p><strong>Restart a service when a template is modified</strong></p> <pre class="highlight-ruby" data-language="ruby">template '/etc/www/configures-apache.conf' do
  notifies :restart, 'service[apache]', :immediately
end</pre> <p><strong>Send notifications to multiple resources</strong></p> <p>To send notifications to multiple resources, just use multiple attributes. Multiple attributes will get sent to the notified resources in the order specified.</p> <pre class="highlight-ruby" data-language="ruby">template '/etc/netatalk/netatalk.conf' do
  notifies :restart, 'service[afpd]', :immediately
  notifies :restart, 'service[cnid]', :immediately
end

service 'afpd'
service 'cnid'</pre> <p><strong>Execute a command using a template</strong></p> <p>The following example shows how to set up IPv4 packet forwarding using the <strong>execute</strong> resource to run a command named <code class="docutils literal">forward_ipv4</code> that uses a template defined by the <strong>template</strong> resource:</p> <pre class="highlight-ruby" data-language="ruby">execute 'forward_ipv4' do
  command 'echo &gt; /proc/.../ipv4/ip_forward'
  action :nothing
end

template '/etc/file_name.conf' do
  source 'routing/file_name.conf.erb'
  notifies :run, 'execute[forward_ipv4]', :delayed
end</pre> <p>where the <code class="docutils literal">command</code> property for the <strong>execute</strong> resource contains the command that is to be run and the <code class="docutils literal">source</code> property for the <strong>template</strong> resource specifies which template to use. The <code class="docutils literal">notifies</code> property for the <strong>template</strong> specifies that the <code class="docutils literal">execute[forward_ipv4]</code> (which is defined by the <strong>execute</strong> resource) should be queued up and run at the end of the chef-client run.</p> <p><strong>Restart a service, and then notify a different service</strong></p> <p>The following example shows how start a service named <code class="docutils literal">example_service</code> and immediately notify the Nginx service to restart.</p> <pre class="highlight-ruby" data-language="ruby">service 'example_service' do
  action :start
  provider Chef::Provider::Service::Init
  notifies :restart, 'service[nginx]', :immediately
end</pre> <p>where by using the default <code class="docutils literal">provider</code> for the <strong>service</strong>, the recipe is telling the chef-client to determine the specific provider to be used during the chef-client run based on the platform of the node on which the recipe will run.</p> <p><strong>Notify when a remote source changes</strong></p> <pre class="highlight-ruby" data-language="ruby">remote_file '/tmp/couch.png' do
  source 'http://couchdb.apache.org/img/sketch.png'
  action :nothing
end

http_request 'HEAD http://couchdb.apache.org/img/sketch.png' do
  message ''
  url 'http://couchdb.apache.org/img/sketch.png'
  action :head
  if File.exist?('/tmp/couch.png')
    headers 'If-Modified-Since' =&gt; File.mtime('/tmp/couch.png').httpdate
  end
  notifies :create, 'remote_file[/tmp/couch.png]', :immediately
end</pre>    <h3 id="subscribes">Subscribes</h3> <p>A resource may listen to another resource, and then take action if the state of the resource being listened to changes. Specify a <code class="docutils literal">'resource[name]'</code>, the <code class="docutils literal">:action</code> to be taken, and then the <code class="docutils literal">:timer</code> for that action.</p> <p>The syntax for <code class="docutils literal">subscribes</code> is:</p> <pre class="highlight-ruby" data-language="ruby">subscribes :action, 'resource[name]', :timer</pre>  <h4 id="id5">Examples</h4> <p>The following examples show how to use the <code class="docutils literal">subscribes</code> notification in a recipe.</p> <p><strong>Prevent restart and reconfigure if configuration is broken</strong></p> <p>Use the <code class="docutils literal">:nothing</code> action (common to all resources) to prevent an application from restarting, and then use the <code class="docutils literal">subscribes</code> notification to ask the broken configuration to be reconfigured immediately:</p> <pre class="highlight-ruby" data-language="ruby">execute 'test-nagios-config' do
  command 'nagios3 --verify-config'
  action :nothing
  subscribes :run, 'template[/etc/nagios3/configures-nagios.conf]', :immediately
end</pre> <p><strong>Reload a service using a template</strong></p> <p>To reload a service based on a template, use the <strong>template</strong> and <strong>service</strong> resources together in the same recipe, similar to the following:</p> <pre class="highlight-ruby" data-language="ruby">template '/tmp/somefile' do
  mode '0755'
  source 'somefile.erb'
end

service 'apache' do
  supports :restart =&gt; true, :reload =&gt; true
  action :enable
  subscribes :reload, 'template[/tmp/somefile]', :immediately
end</pre> <p>where the <code class="docutils literal">subscribes</code> notification is used to reload the service using the template specified by the <strong>template</strong> resource.</p> <p><strong>Stash a file in a data bag</strong></p> <p>The following example shows how to use the <strong>ruby_block</strong> resource to stash a BitTorrent file in a data bag so that it can be distributed to nodes in the organization.</p> <pre class="highlight-ruby" data-language="ruby"># the following code sample comes from the ``seed`` recipe
# in the following cookbook: https://github.com/mattray/bittorrent-cookbook

ruby_block 'share the torrent file' do
  block do
    f = File.open(node['bittorrent']['torrent'],'rb')
    #read the .torrent file and base64 encode it
    enc = Base64.encode64(f.read)
    data = {
      'id'=&gt;bittorrent_item_id(node['bittorrent']['file']),
      'seed'=&gt;node.ipaddress,
      'torrent'=&gt;enc
    }
    item = Chef::DataBagItem.new
    item.data_bag('bittorrent')
    item.raw_data = data
    item.save
  end
  action :nothing
  subscribes :create, "bittorrent_torrent[#{node['bittorrent']['torrent']}]", :immediately
end</pre>     <h2>Relative Paths</h2> <p>The following relative paths can be used with any resource:</p> <dl class="docutils"> <dt><code class="docutils literal">#{ENV['HOME']}</code></dt> <dd>Use to return the <code class="docutils literal">~</code> path in Linux and Mac OS X or the <code class="docutils literal">%HOMEPATH%</code> in Microsoft Windows.</dd> </dl>  <h3 id="id6">Examples</h3> <pre class="highlight-ruby" data-language="ruby">template "#{ENV['HOME']}/chef-getting-started.txt" do
  source 'chef-getting-started.txt.erb'
  mode '0755'
end</pre>    <h2>Run in Compile Phase</h2> <p>The chef-client processes recipes in two phases:</p> <ol class="arabic simple"> <li>First, each resource in the node object is identified and a resource collection is built. All recipes are loaded in a specific order, and then the actions specified within each of them are identified. This is also referred to as the “compile phase”.</li> <li>Next, the chef-client configures the system based on the order of the resources in the resource collection. Each resource is mapped to a provider, which then examines the node and performs the necessary steps to complete the action. This is also referred to as the “execution phase”.</li> </ol> <p>Typically, actions are processed during the execution phase of the chef-client run. However, sometimes it is necessary to run an action during the compile phase. For example, a resource can be configured to install a package during the compile phase to ensure that application is available to other resources during the execution phase.</p> <div class="admonition note"> <p class="first admonition-title">Note</p> <p class="last">Use the <strong>chef_gem</strong> resource to install gems that are needed by the chef-client during the execution phase.</p> </div>  <h3 id="run-action">run_action</h3> <p>Use <code class="docutils literal">.run_action(:some_action)</code> at the end of a resource block to run the specified action during the compile phase. For example:</p> <pre class="highlight-ruby" data-language="ruby">resource_name 'foo' do
  action :nothing
end.run_action(:some_action)</pre> <p>where <code class="docutils literal">action</code> is set to <code class="docutils literal">:nothing</code> to ensure the <code class="docutils literal">run_action</code> is run during the compile phase and not later during the execution phase.</p> <p>The following examples show when (and when not) to use <code class="docutils literal">run_action</code>.</p> <p><strong>Update a package cache</strong></p> <p>Sometimes it is necessary to ensure that an operating system’s package cache is up to date before installing packages. For example, on Debian or Ubuntu systems, the Apt cache should be updated:</p> <pre class="highlight-ruby" data-language="ruby">if node['apt']['compile_time_update'] &amp;&amp; ( !::File.exist?('/var/lib/apt/periodic/update-success-stamp') || !::File.exist?(first_run_file) )
  e = bash 'apt-get-update at compile time' do
    code &lt;&lt;-EOH
      apt-get update
      touch #{first_run_file}
    EOH
    ignore_failure true
    only_if { apt_installed? }
    action :nothing
  end
  e.run_action(:run)
end</pre> <p>where <code class="docutils literal">e.run_action(:run)</code> tells the chef-client to run the <code class="docutils literal">apt-get update</code> command during the compile phase. This example can be found in the <code class="docutils literal">default.rb</code> recipe of the <a class="reference external" href="https://github.com/chef-cookbooks/apt">apt cookbook</a> that is maintained by Chef.</p> <p><strong>Use the chef_gem resource for Ruby gems</strong></p> <p>A very common use case us to install a gem during the compile phase so that it will be available to the chef-client during the execution phase. This is why the <strong>chef_gem</strong> resource exists. For example, this:</p> <pre class="highlight-ruby" data-language="ruby">chef_gem 'foo' do
  action :install
end</pre> <p>is effectively the same as</p> <pre class="highlight-ruby" data-language="ruby">gem_package 'foo' do
  action :nothing
end.run_action(:install)
Gem.clear_paths</pre> <p>but without needing to define a <code class="docutils literal">run_action</code>.</p> <p><strong>Notifications will not work</strong></p> <p>Resources that are executed during the compile phase cannot notify other resources. For example:</p> <pre class="highlight-ruby" data-language="ruby">execute 'ifconfig'

p = package 'vim-enhanced' do
  action :nothing
  notifies :run, 'execute[ifconfig]', :immediately
end
p.run_action(:install)</pre> <p>A better approach in this type of situation is to install the package before the resource collection is built to ensure that it is available to other resources later on.</p>    <h2>Windows File Security</h2> <p>To support Microsoft Windows security, the <strong>template</strong>, <strong>file</strong>, <strong>remote_file</strong>, <strong>cookbook_file</strong>, <strong>directory</strong>, and <strong>remote_directory</strong> resources support the use of inheritance and access control lists (ACLs) within recipes.</p>  <h3 id="access-control-lists-acls">Access Control Lists (ACLs)</h3> <p>The <code class="docutils literal">rights</code> property can be used in a recipe to manage access control lists (ACLs), which allow permissions to be given to multiple users and groups. Use the <code class="docutils literal">rights</code> property can be used as many times as necessary; the chef-client will apply them to the file or directory as required. The syntax for the <code class="docutils literal">rights</code> property is as follows:</p> <pre class="highlight-ruby" data-language="ruby">rights permission, principal, option_type =&gt; value</pre> <p>where</p> <dl class="docutils"> <dt><code class="docutils literal">permission</code></dt> <dd>
<p class="first">Use to specify which rights are granted to the <code class="docutils literal">principal</code>. The possible values are: <code class="docutils literal">:read</code>, <code class="docutils literal">:write</code>, <code class="docutils literal">read_execute</code>, <code class="docutils literal">:modify</code>, and <code class="docutils literal">:full_control</code>.</p> <p>These permissions are cumulative. If <code class="docutils literal">:write</code> is specified, then it includes <code class="docutils literal">:read</code>. If <code class="docutils literal">:full_control</code> is specified, then it includes both <code class="docutils literal">:write</code> and <code class="docutils literal">:read</code>.</p> <p class="last">(For those who know the Microsoft Windows API: <code class="docutils literal">:read</code> corresponds to <code class="docutils literal">GENERIC_READ</code>; <code class="docutils literal">:write</code> corresponds to <code class="docutils literal">GENERIC_WRITE</code>; <code class="docutils literal">:read_execute</code> corresponds to <code class="docutils literal">GENERIC_READ</code> and <code class="docutils literal">GENERIC_EXECUTE</code>; <code class="docutils literal">:modify</code> corresponds to <code class="docutils literal">GENERIC_WRITE</code>, <code class="docutils literal">GENERIC_READ</code>, <code class="docutils literal">GENERIC_EXECUTE</code>, and <code class="docutils literal">DELETE</code>; <code class="docutils literal">:full_control</code> corresponds to <code class="docutils literal">GENERIC_ALL</code>, which allows a user to change the owner and other metadata about a file.)</p> </dd> <dt><code class="docutils literal">principal</code></dt> <dd>Use to specify a group or user name. This is identical to what is entered in the login box for Microsoft Windows, such as <code class="docutils literal">user_name</code>, <code class="docutils literal">domain\user_name</code>, or <code class="docutils literal">user_name@fully_qualified_domain_name</code>. The chef-client does not need to know if a principal is a user or a group.</dd> <dt><code class="docutils literal">option_type</code></dt> <dd>
<p class="first">A hash that contains advanced rights options. For example, the rights to a directory that only applies to the first level of children might look something like: <code class="docutils literal">rights :write, 'domain\group_name', :one_level_deep =&gt; true</code>. Possible option types:</p> <table class="last docutils"> <colgroup> <col width="13%"> <col width="88%"> </colgroup> <thead valign="bottom"> <tr class="row-odd">
<th class="head">Option Type</th> <th class="head">Description</th> </tr> </thead> <tbody valign="top"> <tr class="row-even">
<td><code class="docutils literal">:applies_to_children</code></td> <td>Specify how permissions are applied to children. Possible values: <code class="docutils literal">true</code> to inherit both child directories and files; <code class="docutils literal">false</code> to not inherit any child directories or files; <code class="docutils literal">:containers_only</code> to inherit only child directories (and not files); <code class="docutils literal">:objects_only</code> to recursively inherit files (and not child directories).</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">:applies_to_self</code></td> <td>Indicates whether a permission is applied to the parent directory. Possible values: <code class="docutils literal">true</code> to apply to the parent directory or file and its children; <code class="docutils literal">false</code> to not apply only to child directories and files.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">:one_level_deep</code></td> <td>Indicates the depth to which permissions will be applied. Possible values: <code class="docutils literal">true</code> to apply only to the first level of children; <code class="docutils literal">false</code> to apply to all children.</td> </tr> </tbody> </table> </dd> </dl> <p>For example:</p> <pre class="highlight-ruby" data-language="ruby">resource 'x.txt' do
  rights :read, 'Everyone'
  rights :write, 'domain\group'
  rights :full_control, 'group_name_or_user_name'
  rights :full_control, 'user_name', :applies_to_children =&gt; true
end</pre> <p>or:</p> <pre class="highlight-ruby" data-language="ruby">rights :read, ['Administrators','Everyone']
rights :full_control, 'Users', :applies_to_children =&gt; true
rights :write, 'Sally', :applies_to_children =&gt; :containers_only, :applies_to_self =&gt; false, :one_level_deep =&gt; true</pre> <p>Some other important things to know when using the <code class="docutils literal">rights</code> attribute:</p> <ul class="simple"> <li>Only inherited rights remain. All existing explicit rights on the object are removed and replaced.</li> <li>If rights are not specified, nothing will be changed. The chef-client does not clear out the rights on a file or directory if rights are not specified.</li> <li>Changing inherited rights can be expensive. Microsoft Windows will propagate rights to all children recursively due to inheritance. This is a normal aspect of Microsoft Windows, so consider the frequency with which this type of action is necessary and take steps to control this type of action if performance is the primary consideration.</li> </ul> <p>Use the <code class="docutils literal">deny_rights</code> property to deny specific rights to specific users. The ordering is independent of using the <code class="docutils literal">rights</code> property. For example, it doesn’t matter if rights are granted to everyone is placed before or after <code class="docutils literal">deny_rights :read, ['Julian', 'Lewis']</code>, both Julian and Lewis will be unable to read the document. For example:</p> <pre class="highlight-ruby" data-language="ruby">resource 'x.txt' do
  rights :read, 'Everyone'
  rights :write, 'domain\group'
  rights :full_control, 'group_name_or_user_name'
  rights :full_control, 'user_name', :applies_to_children =&gt; true
  deny_rights :read, ['Julian', 'Lewis']
end</pre> <p>or:</p> <pre class="highlight-ruby" data-language="ruby">deny_rights :full_control, ['Sally']</pre>   <h3 id="id7">Inheritance</h3> <p>By default, a file or directory inherits rights from its parent directory. Most of the time this is the preferred behavior, but sometimes it may be necessary to take steps to more specifically control rights. The <code class="docutils literal">inherits</code> property can be used to specifically tell the chef-client to apply (or not apply) inherited rights from its parent directory.</p> <p>For example, the following example specifies the rights for a directory:</p> <pre class="highlight-ruby" data-language="ruby">directory 'C:\mordor' do
  rights :read, 'MORDOR\Minions'
  rights :full_control, 'MORDOR\Sauron'
end</pre> <p>and then the following example specifies how to use inheritance to deny access to the child directory:</p> <pre class="highlight-ruby" data-language="ruby">directory 'C:\mordor\mount_doom' do
  rights :full_control, 'MORDOR\Sauron'
  inherits false # Sauron is the only person who should have any sort of access
end</pre> <p>If the <code class="docutils literal">deny_rights</code> permission were to be used instead, something could slip through unless all users and groups were denied.</p> <p>Another example also shows how to specify rights for a directory:</p> <pre class="highlight-ruby" data-language="ruby">directory 'C:\mordor' do
  rights :read, 'MORDOR\Minions'
  rights :full_control, 'MORDOR\Sauron'
  rights :write, 'SHIRE\Frodo' # Who put that there I didn't put that there
end</pre> <p>but then not use the <code class="docutils literal">inherits</code> property to deny those rights on a child directory:</p> <pre class="highlight-ruby" data-language="ruby">directory 'C:\mordor\mount_doom' do
  deny_rights :read, 'MORDOR\Minions' # Oops, not specific enough
end</pre> <p>Because the <code class="docutils literal">inherits</code> property is not specified, the chef-client will default it to <code class="docutils literal">true</code>, which will ensure that security settings for existing files remain unchanged.</p>
<div class="_attribution">
  <p class="_attribution-p">
    © Chef Software, Inc.<br>Licensed under the Creative Commons Attribution 3.0 Unported License.<br>The Chef™ Mark and Chef Logo are either registered trademarks/service marks or trademarks/servicemarks of Chef, in the United States and other countries and are used with Chef Inc's permission.<br>We are not affiliated with, endorsed or sponsored by Chef Inc.<br>
    <a href="https://docs-archive.chef.io/release/12-13/resource_common.html" class="_attribution-link">https://docs-archive.chef.io/release/12-13/resource_common.html</a>
  </p>
</div>

				
			</div>
			<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-2572770204602497"
     data-ad-slot="1992473792"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
		</div>
	</section>

	</div>
	<svg style="display:none">
		<symbol id="icon-dir"><svg viewBox="0 0 20 20"><path d="M15 10c0 .3-.305.515-.305.515l-8.56 5.303c-.625.41-1.135.106-1.135-.67V4.853c0-.777.51-1.078 1.135-.67l8.56 5.305S15 9.702 15 10z"/></svg></symbol>
	  </svg>
</body>
</html>
