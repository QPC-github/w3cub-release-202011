
<!DOCTYPE HTML>

<html lang="en" class="_theme-default">

<head>
  <meta charset="utf-8">
  <title>Recipe DSL - Chef 12 - W3cubDocs</title>
  
  <meta name="description" content="The Recipe DSL is a Ruby DSL that is primarily used to declare resources from within a recipe. The Recipe DSL also helps ensure that recipes &hellip;">
  <meta name="keywords" content="about, recipe, dsl, chef, chef~12">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="mobile-web-app-capable" content="yes">
  
  <link rel="canonical" href="https://docs.w3cub.com/chef~12/12-13/dsl_recipe.html">
  <link href="/favicon.png" rel="icon">
  <link rel="stylesheet" type="text/css" href="/assets/application-e498cd0ebe8746846fec95b1a53ab3bb0fb7f47f794f0a38f44c98a1f0d03b21d777ae2c583732e44a5a890f6eacb79a5333545db9d5f3616091ba21ca17d916.css">
  <script src="/assets/application-79c555f6b25481fffac2cac30a7f3e54e608ca09e9e8e42bb1790095ba6d0fcace47d6bc624ddce952c70370892f2d46864f89e6943d4f7f7ff16c8a3231a91a.js" type="text/javascript"></script>
  <script src="/json/chef~12.js"></script>
  
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-R3WC07G3GB"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-R3WC07G3GB');
</script>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2572770204602497"
     crossorigin="anonymous"></script>
<script async custom-element="amp-auto-ads"
  src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
</script>


</head>

<body class="docs">
	<amp-auto-ads type="adsense"
              data-ad-client="ca-pub-2572770204602497">
	</amp-auto-ads>
	<div class="_app">
	<header class="_header">

  <a class="_home-link" href="/" ></a>
  <a class="_menu-link"></a>
  <h1 class="_logo">
    <a href="/" class="_nav-link" title="API Documentation Browser">W3cubDocs</a>
  </h1>
  
  <span class="_logo-sub-nav">/</span><span class="_logo-sub-nav"><a href="/chef~12/" class="_nav-link" title="" style="margin-left:0;">Chef 12</a></span>
  
  <nav class="_nav">
    <a href="https://tools.w3cub.com/?_sp=docs" target="_blank" class="_nav-link ">W3cubTools</a>
    <a href="/cheatsheets/" class="_nav-link ">Cheatsheets</a>
    <a href="/about/" class="_nav-link ">About</a>
  </nav>
</header>
	<section class="_sidebar">
		
		<form class="_search">
		  <input type="search" class="_search-input" placeholder="Search&hellip;" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" maxlength="20">
		  <a class="_search-clear"></a>
		  <div class="_search-tag"></div>
		</form>
		
		<div class="_list-wrap">
			<div class="_list">
			
			</div>
		</div>
	</section>
	<section class="_container ">
		<div class="_content">
			<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-2572770204602497"
     data-ad-slot="6861657091"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
			<div class="_page _sphinx_simple">
				
				
<h1 id="about-the-recipe-dsl">About the Recipe DSL</h1> <p>The Recipe DSL is a Ruby DSL that is primarily used to declare resources from within a recipe. The Recipe DSL also helps ensure that recipes interact with nodes (and node properties) in the desired manner. Most of the methods in the Recipe DSL are used to find a specific parameter and then tell the chef-client what action(s) to take, based on whether that parameter is present on a node.</p> <p>Because the Recipe DSL is a Ruby DSL, then anything that can be done using Ruby can also be done in a recipe, including <code class="docutils literal">if</code> and <code class="docutils literal">case</code> statements, using the <code class="docutils literal">include?</code> Ruby method, including recipes in recipes, and checking for dependencies.</p>  <h2 id="use-ruby">Use Ruby</h2> <p>Common Ruby techniques can be used with the Recipe DSL methods.</p>  <h3 id="if-statements">if Statements</h3> <p>An <code class="docutils literal">if</code> statement can be used to specify part of a recipe to be used when certain conditions are met. <code class="docutils literal">else</code> and <code class="docutils literal">elseif</code> statements can be used to handle situations where either the initial condition is not met or when there are other possible conditions that can be met. Since this behavior is 100% Ruby, do this in a recipe the same way here as anywhere else.</p> <p>For example, using an <code class="docutils literal">if</code> statement with the <code class="docutils literal">platform</code> node attribute:</p> <pre class="highlight-ruby" data-language="ruby">if node['platform'] == 'ubuntu'
  # do ubuntu things
end</pre>   <h3 id="case-statements">case Statements</h3> <p>A <code class="docutils literal">case</code> statement can be used to handle a situation where there are a lot of conditions. Use the <code class="docutils literal">when</code> statement for each condition, as many as are required.</p> <p>For example, using a <code class="docutils literal">case</code> statement with the <code class="docutils literal">platform</code> node attribute:</p> <pre class="highlight-ruby" data-language="ruby">case node['platform']
when 'debian', 'ubuntu'
  # do debian/ubuntu things
when 'redhat', 'centos', 'fedora'
  # do redhat/centos/fedora things
end</pre> <p>For example, using a <code class="docutils literal">case</code> statement with the <code class="docutils literal">platform_family</code> node attribute:</p> <pre class="highlight-ruby" data-language="ruby">case node['platform_family']
when 'debian'
  # do things on debian-ish platforms (debian, ubuntu, linuxmint)
when 'rhel'
  # do things on RHEL platforms (redhat, centos, scientific, etc)
end</pre>   <h3 id="include-method">include? Method</h3> <p>The <code class="docutils literal">include?</code> method can be used to ensure that a specific parameter is included before an action is taken. For example, using the <code class="docutils literal">include?</code> method to find a specific parameter:</p> <pre class="highlight-ruby" data-language="ruby">if ['debian', 'ubuntu'].include?(node['platform'])
  # do debian/ubuntu things
end</pre> <p>or:</p> <pre class="highlight-ruby" data-language="ruby">if %w{rhel}.include?(node['platform_family'])
  # do RHEL things
end</pre>   <h3 id="array-syntax-shortcut">Array Syntax Shortcut</h3> <p>The <code class="docutils literal">%w</code> syntax is a Ruby shortcut for creating an array without requiring quotes and commas around the elements.</p> <p>For example:</p> <pre class="highlight-ruby" data-language="ruby">if %w{debian ubuntu}.include?(node['platform'])
  # do debian/ubuntu things with the Ruby array %w{} shortcut
end</pre>    <h2 id="include-recipes">Include Recipes</h2> <p>A recipe can include one (or more) recipes located in external cookbooks by using the <code class="docutils literal">include_recipe</code> method. When a recipe is included, the resources found in that recipe will be inserted (in the same exact order) at the point where the <code class="docutils literal">include_recipe</code> keyword is located.</p> <p>The syntax for including a recipe is like this:</p> <pre class="highlight-ruby" data-language="ruby">include_recipe 'recipe'</pre> <p>For example:</p> <pre class="highlight-ruby" data-language="ruby">include_recipe 'apache2::mod_ssl'</pre> <p>If the <code class="docutils literal">include_recipe</code> method is used more than once to include a recipe, only the first inclusion is processed and any subsequent inclusions are ignored.</p>  <h3 id="reload-attributes">Reload Attributes</h3> <p>Attributes sometimes depend on actions taken from within recipes, so it may be necessary to reload a given attribute from within a recipe. For example:</p> <pre class="highlight-ruby" data-language="ruby">ruby_block 'some_code' do
  block do
    node.from_file(run_context.resolve_attribute('COOKBOOK_NAME', 'ATTR_FILE'))
  end
  action :nothing
end</pre>    <h2 id="recipe-dsl-methods">Recipe DSL Methods</h2> <p>The Recipe DSL provides support for using attributes, data bags (and encrypted data), and search results in a recipe, as well as four helper methods that can be used to check for a node’s platform from the recipe to ensure that specific actions are taken for specific platforms. The helper methods are:</p> <ul class="simple"> <li><code class="docutils literal">platform?</code></li> <li><code class="docutils literal">platform_family?</code></li> <li><code class="docutils literal">value_for_platform</code></li> <li><code class="docutils literal">value_for_platform_family</code></li> </ul>  <h3>attribute?</h3> <p>Use the <code class="docutils literal">attribute?</code> method to ensure that certain actions only execute in the presence of a particular node attribute. The <code class="docutils literal">attribute?</code> method will return true if one of the listed node attributes matches a node attribute that is detected by Ohai during every chef-client run.</p> <p>The syntax for the <code class="docutils literal">attribute?</code> method is as follows:</p> <pre class="highlight-ruby" data-language="ruby">attribute?('name_of_attribute')</pre> <p>For example:</p> <pre class="highlight-ruby" data-language="ruby">if node.attribute?('ipaddress')
  # the node has an ipaddress
end</pre>   <h3>control</h3> <p>Use the <code class="docutils literal">control</code> method to define a specific series of tests that comprise an individual audit. A <code class="docutils literal">control</code> method MUST be contained within a <code class="docutils literal">control_group</code> block. A <code class="docutils literal">control_group</code> block may contain multiple <code class="docutils literal">control</code> methods.</p> <p>The syntax for the <code class="docutils literal">control</code> method is as follows:</p> <pre class="highlight-ruby" data-language="ruby">control_group 'audit name' do
  control 'name' do
    it 'should do something' do
      expect(something).to/.to_not be_something
    end
  end
end</pre> <p>where:</p> <ul class="simple"> <li>
<code class="docutils literal">control_group</code> groups one (or more) <code class="docutils literal">control</code> blocks</li> <li>
<code class="docutils literal">control 'name' do</code> defines an individual audit</li> <li>Each <code class="docutils literal">control</code> block must define at least one validation</li> <li>Each <code class="docutils literal">it</code> statement defines a single validation. <code class="docutils literal">it</code> statements are processed individually when the chef-client is run in audit-mode</li> <li>An <code class="docutils literal">expect(something).to/.to_not be_something</code> is a statement that represents the individual test. In other words, this statement tests if something is expected to be (or not be) something. For example, a test that expects the PostgreSQL pacakge to not be installed would be similar to <code class="docutils literal">expect(package('postgresql')).to_not be_installed</code> and a test that ensures a service is enabled would be similar to <code class="docutils literal">expect(service('init')).to be_enabled</code>
</li> <li>An <code class="docutils literal">it</code> statement may contain multiple <code class="docutils literal">expect</code> statements</li> </ul>  <h4 id="directory-matcher">directory Matcher</h4> <p>Matchers are available for directories. Use this matcher to define audits for directories that test if the directory exists, is mounted, and if it is linked to. This matcher uses the same matching syntax—<code class="docutils literal">expect(file('foo'))</code>—as the files. The following matchers are available for directories:</p> <table class="docutils"> <colgroup> <col width="13%"> <col width="88%"> </colgroup> <thead valign="bottom"> <tr class="row-odd">
<th class="head">Matcher</th> <th class="head">Description, Example</th> </tr> </thead> <tbody valign="top"> <tr class="row-even">
<td><code class="docutils literal">be_directory</code></td> <td>
<p class="first">Use to test if directory exists. For example:</p> <pre class="last highlight-ruby" data-language="ruby">it 'should be a directory' do
  expect(file('/var/directory')).to be_directory
end</pre> </td> </tr> <tr class="row-odd">
<td><code class="docutils literal">be_linked_to</code></td> <td>
<p class="first">Use to test if a subject is linked to the named directory. For example:</p> <pre class="last highlight-ruby" data-language="ruby">it 'should be linked to the named directory' do
  expect(file('/etc/directory')).to be_linked_to('/etc/some/other/directory')
end</pre> </td> </tr> <tr class="row-even">
<td><code class="docutils literal">be_mounted</code></td> <td>
<p class="first">Use to test if a directory is mounted. For example:</p> <pre class="highlight-ruby" data-language="ruby">it 'should be mounted' do
  expect(file('/')).to be_mounted
end</pre> <p>For directories with a single attribute that requires testing:</p> <pre class="highlight-ruby" data-language="ruby">it 'should be mounted with an ext4 partition' do
  expect(file('/')).to be_mounted.with( :type =&gt; 'ext4' )
end</pre> <p>For directories with multiple attributes that require testing:</p> <pre class="last highlight-ruby" data-language="ruby">it 'should be mounted only with certain attributes' do
  expect(file('/')).to be_mounted.only_with(
    :attribute =&gt; 'value',
    :attribute =&gt; 'value',
)
end</pre> </td> </tr> </tbody> </table>   <h4 id="file-matcher">file Matcher</h4> <p>Matchers are available for files and directories. Use this matcher to define audits for files that test if the file exists, its version, if it is is executable, writable, or readable, who owns it, verify checksums (both MD5 and SHA-256) and so on. The following matchers are available for files:</p> <table class="docutils"> <colgroup> <col width="13%"> <col width="88%"> </colgroup> <thead valign="bottom"> <tr class="row-odd">
<th class="head">Matcher</th> <th class="head">Description, Example</th> </tr> </thead> <tbody valign="top"> <tr class="row-even">
<td><code class="docutils literal">be_executable</code></td> <td>
<p class="first">Use to test if a file is executable. For example:</p> <pre class="highlight-ruby" data-language="ruby">it 'should be executable' do
  expect(file('/etc/file')).to be_executable
end</pre> <p>For a file that is executable by its owner:</p> <pre class="highlight-ruby" data-language="ruby">it 'should be executable by owner' do
  expect(file('/etc/file')).to be_executable.by('owner')
end</pre> <p>For a file that is executable by a group:</p> <pre class="highlight-ruby" data-language="ruby">it 'should be executable by group members' do
  expect(file('/etc/file')).to be_executable.by('group')
end</pre> <p>For a file that is executable by a specific user:</p> <pre class="last highlight-ruby" data-language="ruby">it 'should be executable by user foo' do
  expect(file('/etc/file')).to be_executable.by_user('foo')
end</pre> </td> </tr> <tr class="row-odd">
<td><code class="docutils literal">be_file</code></td> <td>
<p class="first">Use to test if a file exists. For example:</p> <pre class="last highlight-ruby" data-language="ruby">it 'should be a file' do
  expect(file('/etc/file')).to be_file
end</pre> </td> </tr> <tr class="row-even">
<td><code class="docutils literal">be_grouped_into</code></td> <td>
<p class="first">Use to test if a file is grouped into the named group. For example:</p> <pre class="last highlight-ruby" data-language="ruby">it 'should be grouped into foo' do
  expect(file('/etc/file')).to be_grouped_into('foo')
end</pre> </td> </tr> <tr class="row-odd">
<td><code class="docutils literal">be_linked_to</code></td> <td>
<p class="first">Use to test if a subject is linked to the named file. For example:</p> <pre class="last highlight-ruby" data-language="ruby">it 'should be linked to the named file' do
  expect(file('/etc/file')).to be_linked_to('/etc/some/other/file')
end</pre> </td> </tr> <tr class="row-even">
<td><code class="docutils literal">be_mode</code></td> <td>
<p class="first">Use to test if a file is set to the specified mode. For example:</p> <pre class="last highlight-ruby" data-language="ruby">it 'should be mode 440' do
  expect(file('/etc/file')).to be_mode(440)
end</pre> </td> </tr> <tr class="row-odd">
<td><code class="docutils literal">be_owned_by</code></td> <td>
<p class="first">Use to test if a file is owned by the named owner. For example:</p> <pre class="last highlight-ruby" data-language="ruby">it 'should be owned by the root user' do
  expect(file('/etc/sudoers')).to be_owned_by('root')
end</pre> </td> </tr> <tr class="row-even">
<td><code class="docutils literal">be_readable</code></td> <td>
<p class="first">Use to test if a file is readable. For example:</p> <pre class="highlight-ruby" data-language="ruby">it 'should be readable' do
  expect(file('/etc/file')).to be_readable
end</pre> <p>For a file that is readable by its owner:</p> <pre class="highlight-ruby" data-language="ruby">it 'should be readable by owner' do
  expect(file('/etc/file')).to be_readable.by('owner')
end</pre> <p>For a file that is readable by a group:</p> <pre class="highlight-ruby" data-language="ruby">it 'should be readable by group members' do
  expect(file('/etc/file')).to be_readable.by('group')
end</pre> <p>For a file that is readable by a specific user:</p> <pre class="last highlight-ruby" data-language="ruby">it 'should be readable by user foo' do
  expect(file('/etc/file')).to be_readable.by_user('foo')
end</pre> </td> </tr> <tr class="row-odd">
<td><code class="docutils literal">be_socket</code></td> <td>
<p class="first">Use to test if a file exists as a socket. For example:</p> <pre class="last highlight-ruby" data-language="ruby">it 'should be a socket' do
  expect(file('/var/file.sock')).to be_socket
end</pre> </td> </tr> <tr class="row-even">
<td><code class="docutils literal">be_symlink</code></td> <td>
<p class="first">Use to test if a file exists as a symbolic link. For example:</p> <pre class="last highlight-ruby" data-language="ruby">it 'should be a symlink' do
  expect(file('/etc/file')).to be_symlink
end</pre> </td> </tr> <tr class="row-odd">
<td><code class="docutils literal">be_version</code></td> <td>
<p class="first">Microsoft Windows only. Use to test if a file is the specified version. For example:</p> <pre class="last highlight-ruby" data-language="ruby">it 'should be version 1.2' do
  expect(file('C:\\Windows\\path\\to\\file')).to be_version('1.2')
end</pre> </td> </tr> <tr class="row-even">
<td><code class="docutils literal">be_writable</code></td> <td>
<p class="first">Use to test if a file is writable. For example:</p> <pre class="highlight-ruby" data-language="ruby">it 'should be writable' do
  expect(file('/etc/file')).to be_writable
end</pre> <p>For a file that is writable by its owner:</p> <pre class="highlight-ruby" data-language="ruby">it 'should be writable by owner' do
  expect(file('/etc/file')).to be_writable.by('owner')
end</pre> <p>For a file that is writable by a group:</p> <pre class="highlight-ruby" data-language="ruby">it 'should be writable by group members' do
  expect(file('/etc/file')).to be_writable.by('group')
end</pre> <p>For a file that is writable by a specific user:</p> <pre class="last highlight-ruby" data-language="ruby">it 'should be writable by user foo' do
  expect(file('/etc/file')).to be_writable.by_user('foo')
end</pre> </td> </tr> <tr class="row-odd">
<td><code class="docutils literal">contain</code></td> <td>
<p class="first">Use to test if a file contains specific contents. For example:</p> <pre class="last highlight-ruby" data-language="ruby">it 'should contain docs.chef.io' do
  expect(file('/etc/file')).to contain('docs.chef.io')
end</pre> </td> </tr> </tbody> </table>   <h4 id="package-matcher">package Matcher</h4> <p>Matchers are available for packages and may be used to define audits that test if a package or a package version is installed. The following matchers are available:</p> <table class="docutils"> <colgroup> <col width="13%"> <col width="88%"> </colgroup> <thead valign="bottom"> <tr class="row-odd">
<th class="head">Matcher</th> <th class="head">Description, Example</th> </tr> </thead> <tbody valign="top"> <tr class="row-even">
<td><code class="docutils literal">be_installed</code></td> <td>
<p class="first">Use to test if the named package is installed. For example:</p> <pre class="highlight-ruby" data-language="ruby">it 'should be installed' do
  expect(package('httpd')).to be_installed
end</pre> <p>For a specific package version:</p> <pre class="last highlight-ruby" data-language="ruby">it 'should be installed' do
  expect(package('httpd')).to be_installed.with_version('0.1.2')
end</pre> </td> </tr> </tbody> </table>   <h4 id="port-matcher">port Matcher</h4> <p>Matchers are available for ports and may be used to define audits that test if a port is listening. The following matchers are available:</p> <table class="docutils"> <colgroup> <col width="13%"> <col width="88%"> </colgroup> <thead valign="bottom"> <tr class="row-odd">
<th class="head">Matcher</th> <th class="head">Description, Example</th> </tr> </thead> <tbody valign="top"> <tr class="row-even">
<td><code class="docutils literal">be_listening</code></td> <td>
<p class="first">Use to test if the named port is listening. For example:</p> <pre class="highlight-ruby" data-language="ruby">it 'should be listening' do
  expect(port(23)).to be_listening
end</pre> <p>For a named port that is not listening:</p> <pre class="highlight-ruby" data-language="ruby">it 'should not be listening' do
  expect(port(23)).to_not be_listening
end</pre> <p>For a specific port type use <code class="docutils literal">.with('port_type')</code>. For example, UDP:</p> <pre class="highlight-ruby" data-language="ruby">it 'should be listening with UDP' do
  expect(port(23)).to_not be_listening.with('udp')
end</pre> <p>For UDP, version 6:</p> <pre class="highlight-ruby" data-language="ruby">it 'should be listening with UDP6' do
  expect(port(23)).to_not be_listening.with('udp6')
end</pre> <p>For TCP/IP:</p> <pre class="highlight-ruby" data-language="ruby">it 'should be listening with TCP' do
  expect(port(23)).to_not be_listening.with('tcp')
end</pre> <p>For TCP/IP, version 6:</p> <pre class="last highlight-ruby" data-language="ruby">it 'should be listening with TCP6' do
  expect(port(23)).to_not be_listening.with('tcp6')
end</pre> </td> </tr> </tbody> </table>   <h4 id="service-matcher">service Matcher</h4> <p>Matchers are available for services and may be used to define audits that test for conditions related to services, such as if they are enabled, running, have the correct startup mode, and so on. The following matchers are available:</p> <table class="docutils"> <colgroup> <col width="13%"> <col width="88%"> </colgroup> <thead valign="bottom"> <tr class="row-odd">
<th class="head">Matcher</th> <th class="head">Description, Example</th> </tr> </thead> <tbody valign="top"> <tr class="row-even">
<td><code class="docutils literal">be_enabled</code></td> <td>
<p class="first">Use to test if the named service is enabled (i.e. will start up automatically). For example:</p> <pre class="highlight-ruby" data-language="ruby">it 'should be enabled' do
  expect(service('ntpd')).to be_enabled
end</pre> <p>For a service that is enabled at a given run level:</p> <pre class="last highlight-ruby" data-language="ruby">it 'should be enabled at the specified run level' do
  expect(service('ntpd')).to be_enabled.with_level(3)
end</pre> </td> </tr> <tr class="row-odd">
<td><code class="docutils literal">be_installed</code></td> <td>
<p class="first">Microsoft Windows only. Use to test if the named service is installed on the Microsoft Windows platform. For example:</p> <pre class="last highlight-ruby" data-language="ruby">it 'should be installed' do
  expect(service('DNS Client')).to be_installed
end</pre> </td> </tr> <tr class="row-even">
<td><code class="docutils literal">be_running</code></td> <td>
<p class="first">Use to test if the named service is running. For example:</p> <pre class="highlight-ruby" data-language="ruby">it 'should be running' do
  expect(service('ntpd')).to be_running
end</pre> <p>For a service that is running under supervisor:</p> <pre class="highlight-ruby" data-language="ruby">it 'should be running under supervisor' do
  expect(service('ntpd')).to be_running.under('supervisor')
end</pre> <p>or daemontools:</p> <pre class="highlight-ruby" data-language="ruby">it 'should be running under daemontools' do
  expect(service('ntpd')).to be_running.under('daemontools')
end</pre> <p>or Upstart:</p> <pre class="last highlight-ruby" data-language="ruby">it 'should be running under upstart' do
  expect(service('ntpd')).to be_running.under('upstart')
end</pre> </td> </tr> <tr class="row-odd">
<td><code class="docutils literal">be_monitored_by</code></td> <td>
<p class="first">Use to test if the named service is being monitored by the named monitoring application. For example:</p> <pre class="last highlight-ruby" data-language="ruby">it 'should be monitored by' do
  expect(service('ntpd')).to be_monitored_by('monit')
end</pre> </td> </tr> <tr class="row-even">
<td><code class="docutils literal">have_start_mode</code></td> <td>
<p class="first">Microsoft Windows only. Use to test if the named service’s startup mode is correct on the Microsoft Windows platform. For example:</p> <pre class="last highlight-ruby" data-language="ruby">it 'should start manually' do
  expect(service('DNS Client')).to have_start_mode.Manual
end</pre> </td> </tr> </tbody> </table>   <h4 id="examples">Examples</h4> <p><strong>A package is installed</strong></p> <p>For example, a package is installed:</p> <pre class="highlight-ruby" data-language="ruby">control_group 'audit name' do
  control 'mysql package' do
    it 'should be installed' do
      expect(package('mysql')).to be_installed
    end
  end
end</pre> <p>The <code class="docutils literal">control_group</code> block is processed when the chef-client run is run in audit-mode. If the audit was successful, the chef-client will return output similar to:</p> <pre class="highlight-bash" data-language="bash">Audit Mode
  mysql package
    should be installed</pre> <p>If an audit was unsuccessful, the chef-client will return output similar to:</p> <pre class="highlight-bash" data-language="bash">Starting audit phase

Audit Mode
  mysql package
  should be installed (FAILED - 1)

Failures:

1) Audit Mode mysql package should be installed
  Failure/Error: expect(package('mysql')).to be_installed.with_version('5.6')
    expected Package 'mysql' to be installed
  # /var/chef/cache/cookbooks/grantmc/recipes/default.rb:22:in 'block (3 levels) in from_file'

Finished in 0.5745 seconds (files took 0.46481 seconds to load)
1 examples, 1 failures

Failed examples:

rspec /var/chef/cache/cookbooks/grantmc/recipes/default.rb:21 # Audit Mode mysql package should be installed</pre> <p><strong>A package version is installed</strong></p> <p>A package that is installed with a specific version:</p> <pre class="highlight-ruby" data-language="ruby">control_group 'audit name' do
  control 'mysql package' do
    it 'should be installed' do
      expect(package('mysql')).to be_installed.with_version('5.6')
    end
  end
end</pre> <p><strong>A package is not installed</strong></p> <p>A package that is not installed:</p> <pre class="highlight-ruby" data-language="ruby">control_group 'audit name' do
  control 'postgres package' do
    it 'should not be installed' do
      expect(package('postgresql')).to_not be_installed
    end
  end
end</pre> <p>If the audit was successful, the chef-client will return output similar to:</p> <pre class="highlight-bash" data-language="bash">Audit Mode
  postgres audit
    postgres package
      is not installed</pre> <p><strong>A service is enabled</strong></p> <p>A service that is enabled and running:</p> <pre class="highlight-ruby" data-language="ruby">control_group 'audit name' do
  control 'mysql service' do
    let(:mysql_service) { service('mysql') }
    it 'should be enabled' do
      expect(mysql_service).to be_enabled
    end
    it 'should be running' do
      expect(mysql_service).to be_running
    end
  end
end</pre> <p>If the audit was successful, the chef-client will return output similar to:</p> <pre class="highlight-bash" data-language="bash">Audit Mode
  mysql service audit
    mysql service
      is enabled
      is running</pre> <p><strong>A configuration file contains specific settings</strong></p> <p>The following example shows how to verify <code class="docutils literal">sshd</code> configration, including whether it’s installed, what the permissions are, and how it can be accessed:</p> <pre class="highlight-ruby" data-language="ruby">control_group 'check sshd configuration' do

  control 'sshd package' do
    it 'should be installed' do
      expect(package('openssh-server')).to be_installed
    end
  end

  control 'sshd configuration' do
    let(:config_file) { file('/etc/ssh/sshd_config') }
    it 'should exist with the right permissions' do
      expect(config_file).to be_file
      expect(config_file).to be_mode(644)
      expect(config_file).to be_owned_by('root')
      expect(config_file).to be_grouped_into('root')
    end
    it 'should not permit RootLogin' do
      expect(config_file.content).to_not match(/^PermitRootLogin yes/)
    end
    it 'should explicitly not permit PasswordAuthentication' do
      expect(config_file.content).to match(/^PasswordAuthentication no/)
    end
    it 'should force privilege separation' do
      expect(config_file.content).to match(/^UsePrivilegeSeparation sandbox/)
    end
  end
end</pre> <p>where</p> <ul class="simple"> <li>
<code class="docutils literal">let(:config_file) { file('/etc/ssh/sshd_config') }</code> uses the <code class="docutils literal">file</code> matcher to test specific settings within the <code class="docutils literal">sshd</code> configuration file</li> </ul> <p><strong>A file contains desired permissions and contents</strong></p> <p>The following example shows how to verify that a file has the desired permissions and contents:</p> <pre class="highlight-ruby" data-language="ruby">controls 'mysql config' do
  control 'mysql config file' do
    let(:config_file) { file('/etc/mysql/my.cnf') }
    it 'exists with correct permissions' do
      expect(config_file).to be_file
      expect(config_file).to be_mode(0400)
    end
    it 'contains required configuration' do
      expect(its('contents')).to match(/default-time-zone='UTC'/)
    end
  end
end</pre> <p>If the audit was successful, the chef-client will return output similar to:</p> <pre class="highlight-bash" data-language="bash">Audit Mode
  mysql config
    mysql config file
      exists with correct permissions
      contains required configuration</pre> <p><strong>Test an attribute value</strong></p> <p>To audit attribute values in a <code class="docutils literal">control</code> block, first assign the attribute as a variable, and then use the variable within the <code class="docutils literal">control</code> block to specify the test:</p> <pre class="highlight-ruby" data-language="ruby">memory_mb = node['memory']['total'].gsub(/kB$/i, '').to_i / 1024
control 'minimum memory check' do
  it 'should be at least 400MB free' do
    expect(memory_mb).to be &gt;= 400
  end
end</pre>    <h3>control_group</h3> <p>Use the <code class="docutils literal">control_group</code> method to define a group of <code class="docutils literal">control</code> methods that comprise a single audit. The name of each <code class="docutils literal">control_group</code> must be unique within the organization.</p> <p>The syntax for the <code class="docutils literal">control_group</code> method is as follows:</p> <pre class="highlight-ruby" data-language="ruby">control_group 'name' do
  control 'name' do
    it 'should do something' do
      expect(something).to/.to_not be_something
    end
  end
  control 'name' do
    ...
  end
  ...
end</pre> <p>where:</p> <ul class="simple"> <li>
<code class="docutils literal">control_group</code> groups one (or more) <code class="docutils literal">control</code> blocks</li> <li>
<code class="docutils literal">'name'</code> is the unique name for the <code class="docutils literal">control_group</code>; the chef-client will raise an exception if duplicate <code class="docutils literal">control_group</code> names are present</li> <li>
<code class="docutils literal">control</code> defines each individual audit within the <code class="docutils literal">control_group</code> block. There is no limit to the number of <code class="docutils literal">control</code> blocks that may defined within a <code class="docutils literal">control_group</code> block</li> </ul>  <h4 id="id1">Examples</h4> <p><strong>control_group block with multiple control blocks</strong></p> <p>The following <code class="docutils literal">control_group</code> ensures that MySQL is installed, that PostgreSQL is not installed, and that the services and configuration files associated with MySQL are configured correctly:</p> <pre class="highlight-ruby" data-language="ruby">control_group 'Audit Mode' do

  control 'mysql package' do
    it 'should be installed' do
      expect(package('mysql')).to be_installed.with_version('5.6')
    end
  end

  control 'postgres package' do
    it 'should not be installed' do
      expect(package('postgresql')).to_not be_installed
    end
  end

  control 'mysql service' do
    let(:mysql_service) { service('mysql') }
    it 'should be enabled' do
      expect(mysql_service).to be_enabled
    end
    it 'should be running' do
      expect(mysql_service).to be_running
    end
  end

  control 'mysql config directory' do
    let(:config_dir) { file('/etc/mysql') }
    it 'should exist with correct permissions' do
      expect(config_dir).to be_directory
      expect(config_dir).to be_mode(0700)
    end
    it 'should be owned by the db user' do
      expect(config_dir).to be_owned_by('db_service_user')
    end
  end

  control 'mysql config file' do
    let(:config_file) { file('/etc/mysql/my.cnf') }
    it 'should exist with correct permissions' do
      expect(config_file).to be_file
      expect(config_file).to be_mode(0400)
    end
    it 'should contain required configuration' do
      expect(config_file.content).to match(/default-time-zone='UTC'/)
    end
  end

end</pre> <p>The <code class="docutils literal">control_group</code> block is processed when the chef-client is run in audit-mode. If the chef-client run was successful, the chef-client will return output similar to:</p> <pre class="highlight-bash" data-language="bash">Audit Mode
  mysql package
    should be installed
  postgres package
    should not be installed
  mysql service
    should be enabled
    should be running
  mysql config directory
    should exist with correct permissions
    should be owned by the db user
  mysql config file
    should exist with correct permissions
    should contain required configuration</pre> <p>If an audit was unsuccessful, the chef-client will return output similar to:</p> <pre class="highlight-bash" data-language="bash">Starting audit phase

Audit Mode
  mysql package
  should be installed (FAILED - 1)
postgres package
  should not be installed
mysql service
  should be enabled (FAILED - 2)
  should be running (FAILED - 3)
mysql config directory
  should exist with correct permissions (FAILED - 4)
  should be owned by the db user (FAILED - 5)
mysql config file
  should exist with correct permissions (FAILED - 6)
  should contain required configuration (FAILED - 7)

Failures:

1) Audit Mode mysql package should be installed
  Failure/Error: expect(package('mysql')).to be_installed.with_version('5.6')
    expected Package 'mysql' to be installed
  # /var/chef/cache/cookbooks/grantmc/recipes/default.rb:22:in 'block (3 levels) in from_file'

2) Audit Mode mysql service should be enabled
  Failure/Error: expect(mysql_service).to be_enabled
    expected Service 'mysql' to be enabled
  # /var/chef/cache/cookbooks/grantmc/recipes/default.rb:35:in 'block (3 levels) in from_file'

3) Audit Mode mysql service should be running
   Failure/Error: expect(mysql_service).to be_running
    expected Service 'mysql' to be running
  # /var/chef/cache/cookbooks/grantmc/recipes/default.rb:38:in 'block (3 levels) in from_file'

4) Audit Mode mysql config directory should exist with correct permissions
  Failure/Error: expect(config_dir).to be_directory
    expected `File '/etc/mysql'.directory?` to return true, got false
  # /var/chef/cache/cookbooks/grantmc/recipes/default.rb:45:in 'block (3 levels) in from_file'

5) Audit Mode mysql config directory should be owned by the db user
  Failure/Error: expect(config_dir).to be_owned_by('db_service_user')
    expected `File '/etc/mysql'.owned_by?('db_service_user')` to return true, got false
  # /var/chef/cache/cookbooks/grantmc/recipes/default.rb:49:in 'block (3 levels) in from_file'

6) Audit Mode mysql config file should exist with correct permissions
  Failure/Error: expect(config_file).to be_file
    expected `File '/etc/mysql/my.cnf'.file?` to return true, got false
  # /var/chef/cache/cookbooks/grantmc/recipes/default.rb:56:in 'block (3 levels) in from_file'

7) Audit Mode mysql config file should contain required configuration
  Failure/Error: expect(config_file.content).to match(/default-time-zone='UTC'/)
    expected '-n\n' to match /default-time-zone='UTC'/
    Diff:
    @@ -1,2 +1,2 @@
    -/default-time-zone='UTC'/
    +-n
  # /var/chef/cache/cookbooks/grantmc/recipes/default.rb:60:in 'block (3 levels) in from_file'

Finished in 0.5745 seconds (files took 0.46481 seconds to load)
8 examples, 7 failures

Failed examples:

rspec /var/chef/cache/cookbooks/grantmc/recipes/default.rb:21 # Audit Mode mysql package should be installed
rspec /var/chef/cache/cookbooks/grantmc/recipes/default.rb:34 # Audit Mode mysql service should be enabled
rspec /var/chef/cache/cookbooks/grantmc/recipes/default.rb:37 # Audit Mode mysql service should be running
rspec /var/chef/cache/cookbooks/grantmc/recipes/default.rb:44 # Audit Mode mysql config directory should exist with correct permissions
rspec /var/chef/cache/cookbooks/grantmc/recipes/default.rb:48 # Audit Mode mysql config directory should be owned by the db user
rspec /var/chef/cache/cookbooks/grantmc/recipes/default.rb:55 # Audit Mode mysql config file should exist with correct permissions
rspec /var/chef/cache/cookbooks/grantmc/recipes/default.rb:59 # Audit Mode mysql config file should contain required configuration
Auditing complete</pre> <p><strong>Duplicate control_group names</strong></p> <p>If two <code class="docutils literal">control_group</code> blocks have the same name, the chef-client will raise an exception. For example, the following <code class="docutils literal">control_group</code> blocks exist in different cookbooks:</p> <pre class="highlight-ruby" data-language="ruby">control_group 'basic control group' do
  it 'should pass' do
    expect(2 - 2).to eq(0)
  end
end</pre> <pre class="highlight-ruby" data-language="ruby">control_group 'basic control group' do
  it 'should pass' do
    expect(3 - 2).to eq(1)
  end
end</pre> <p>Because the two <code class="docutils literal">control_group</code> block names are identical, the chef-client will return an exception similar to:</p> <pre class="highlight-ruby" data-language="ruby">Synchronizing Cookbooks:
  - audit_test
Compiling Cookbooks...

================================================================================
Recipe Compile Error in /Users/grantmc/.cache/chef/cache/cookbooks
                        /audit_test/recipes/error_duplicate_control_groups.rb
================================================================================

Chef::Exceptions::AuditControlGroupDuplicate
--------------------------------------------
Audit control group with name 'basic control group' has already been defined

Cookbook Trace:
---------------
/Users/grantmc/.cache/chef/cache/cookbooks
/audit_test/recipes/error_duplicate_control_groups.rb:13:in 'from_file'

Relevant File Content:
----------------------
/Users/grantmc/.cache/chef/cache/cookbooks/audit_test/recipes/error_duplicate_control_groups.rb:

control_group 'basic control group' do
  it 'should pass' do
    expect(2 - 2).to eq(0)
  end
end

control_group 'basic control group' do
  it 'should pass' do
    expect(3 - 2).to eq(1)
  end
end

Running handlers:
[2015-01-15T09:36:14-08:00] ERROR: Running exception handlers
Running handlers complete</pre> <p><strong>Verify a package is installed</strong></p> <p>The following <code class="docutils literal">control_group</code> verifies that the <code class="docutils literal">git</code> package has been installed:</p> <pre class="highlight-ruby" data-language="ruby">package 'git' do
  action :install
end

execute 'list packages' do
  command 'dpkg -l'
end

execute 'list directory' do
  command 'ls -R ~'
end

control_group 'my audits' do
  control 'check git' do
    it 'should be installed' do
      expect(package('git')).to be_installed
    end
  end
end</pre>    <h3>cookbook_name</h3> <p>Use the <code class="docutils literal">cookbook_name</code> method to return the name of a cookbook.</p> <p>The syntax for the <code class="docutils literal">cookbook_name</code> method is as follows:</p> <pre class="highlight-ruby" data-language="ruby">cookbook_name</pre> <p>This method is often used as part of a log entry. For example:</p> <pre class="highlight-ruby" data-language="ruby">Chef::Log.info('I am a message from the #{recipe_name} recipe in the #{cookbook_name} cookbook.')</pre>   <h3>data_bag</h3> <p>A data bag is a global variable that is stored as JSON data and is accessible from a Chef server. A data bag is indexed for searching and can be loaded by a recipe or accessed during a search.</p> <p>Use the <code class="docutils literal">data_bag</code> method to get a list of the contents of a data bag.</p> <p>The syntax for the <code class="docutils literal">data_bag</code> method is as follows:</p> <pre class="highlight-ruby" data-language="ruby">data_bag(bag_name)</pre> <p><strong>Examples</strong></p> <p>The following example shows how the <code class="docutils literal">data_bag</code> method can be used in a recipe.</p> <p><strong>Get a data bag, and then iterate through each data bag item</strong></p> <pre class="highlight-ruby" data-language="ruby">data_bag('users') #=&gt; ['sandy', 'jill']</pre> <p>Iterate over the contents of the data bag to get the associated <code class="docutils literal">data_bag_item</code>:</p> <pre class="highlight-ruby" data-language="ruby">data_bag('users').each do |user|
  data_bag_item('users', user)
end</pre> <p>The <code class="docutils literal">id</code> for each data bag item will be returned as a string.</p>   <h3>data_bag_item</h3> <p>A data bag is a global variable that is stored as JSON data and is accessible from a Chef server. A data bag is indexed for searching and can be loaded by a recipe or accessed during a search.</p> <p>The <code class="docutils literal">data_bag_item</code> method can be used in a recipe to get the contents of a data bag item.</p> <p>The syntax for the <code class="docutils literal">data_bag_item</code> method is as follows:</p> <pre class="highlight-ruby" data-language="ruby">data_bag_item(bag_name, item, secret)</pre> <p>where <code class="docutils literal">secret</code> is the secret used to load an encrypted data bag. If <code class="docutils literal">secret</code> is not specified, the chef-client looks for a secret at the path specified by the <code class="docutils literal">encrypted_data_bag_secret</code> setting in the client.rb file.</p> <p><strong>Examples</strong></p> <p>The following examples show how the <code class="docutils literal">data_bag_item</code> method can be used in a recipe.</p> <p><strong>Get a data bag, and then iterate through each data bag item</strong></p> <pre class="highlight-ruby" data-language="ruby">data_bag('users') #=&gt; ['sandy', 'jill']</pre> <p>Iterate over the contents of the data bag to get the associated <code class="docutils literal">data_bag_item</code>:</p> <pre class="highlight-ruby" data-language="ruby">data_bag('users').each do |user|
  data_bag_item('users', user)
end</pre> <p>The <code class="docutils literal">id</code> for each data bag item will be returned as a string.</p> <p><strong>Use the contents of a data bag in a recipe</strong></p> <p>The following example shows how to use the <code class="docutils literal">data_bag</code> and <code class="docutils literal">data_bag_item</code> methods in a recipe, also using a data bag named <code class="docutils literal">sea-power</code>):</p> <pre class="highlight-ruby" data-language="ruby">package 'sea-power' do
  action :install
end

directory node['sea-power']['base_path'] do
  # attributes for owner, group, mode
end

gale_warnings = data_bag('sea-power').map do |viking_north|
  data_bag_item('sea-power', viking_north)['source']
end

template '/etc/seattle/power.list' do
  source 'seattle-power.erb'
  # attributes for owner, group, mode
  variables(
    :base_path =&gt; node['sea-power']['base_path'],
    # more variables
    :repo_location =&gt; gale_warnings
  )
end</pre> <p>For a more complete version of the previous example, see the default recipe in the <a class="reference external" href="https://github.com/hw-cookbooks/apt-mirror">https://github.com/hw-cookbooks/apt-mirror</a> community cookbook.</p>   <h3 id="declare-resource">declare_resource</h3> <p>Use the <code class="docutils literal">declare_resource</code> method to instantiate a resource and then add it to the resource collection.</p> <p>The syntax for the <code class="docutils literal">declare_resource</code> method is as follows:</p> <pre class="highlight-ruby" data-language="ruby">declare_resource(:resource_type, 'resource_name', resource_attrs_block)</pre> <p>where:</p> <ul class="simple"> <li>
<code class="docutils literal">:resource_type</code> is the resource type, such as <code class="docutils literal">:file ``(for the **file** resource), ``:template</code> (for the <strong>template</strong> resource), and so on. Any resource available to Chef may be declared.</li> <li>
<code class="docutils literal">resource_name</code> the property that is the default name of the resource, typically the string that appears in the <code class="docutils literal">resource 'name' do</code> block of a resource (but not always); see the Syntax section for the resource to be declared to verify the default name property.</li> <li>
<code class="docutils literal">resource_attrs_block</code> is a block in which properties of the instantiated resource are declared.</li> </ul> <p>For example:</p> <pre class="highlight-ruby" data-language="ruby">declare_resource(:file, '/x/y.txy', caller[0]) do
  action :delete
end</pre> <p>is equivalent to:</p> <pre class="highlight-ruby" data-language="ruby">file '/x/y.txt' do
  action :delete
end</pre>   <h3 id="delete-resource">delete_resource</h3> <p>Use the <code class="docutils literal">delete_resource</code> method to find a resource in the resource collection, and then delete it.</p> <p>The syntax for the <code class="docutils literal">delete_resource</code> method is as follows:</p> <pre class="highlight-ruby" data-language="ruby">delete_resource(:resource_type, 'resource_name')</pre> <p>where:</p> <ul class="simple"> <li>
<code class="docutils literal">:resource_type</code> is the resource type, such as <code class="docutils literal">:file ``(for the **file** resource), ``:template</code> (for the <strong>template</strong> resource), and so on. Any resource available to Chef may be declared.</li> <li>
<code class="docutils literal">resource_name</code> the property that is the default name of the resource, typically the string that appears in the <code class="docutils literal">resource 'name' do</code> block of a resource (but not always); see the Syntax section for the resource to be declared to verify the default name property.</li> </ul> <p>For example:</p> <pre class="highlight-ruby" data-language="ruby">delete_resource(:template, '/x/y.erb')</pre>   <h3 id="id2">delete_resource!</h3> <p>Use the <code class="docutils literal">delete_resource!</code> method to find a resource in the resource collection, and then delete it. If the resource is not found, an exception is returned.</p> <p>The syntax for the <code class="docutils literal">delete_resource!</code> method is as follows:</p> <pre class="highlight-ruby" data-language="ruby">delete_resource!(:resource_type, 'resource_name')</pre> <p>where:</p> <ul class="simple"> <li>
<code class="docutils literal">:resource_type</code> is the resource type, such as <code class="docutils literal">:file ``(for the **file** resource), ``:template</code> (for the <strong>template</strong> resource), and so on. Any resource available to Chef may be declared.</li> <li>
<code class="docutils literal">resource_name</code> the property that is the default name of the resource, typically the string that appears in the <code class="docutils literal">resource 'name' do</code> block of a resource (but not always); see the Syntax section for the resource to be declared to verify the default name property.</li> </ul> <p>For example:</p> <pre class="highlight-ruby" data-language="ruby">delete_resource!(:file, '/x/file.txt')</pre>   <h3 id="edit-resource">edit_resource</h3> <p>Use the <code class="docutils literal">edit_resource</code> method to:</p> <ul class="simple"> <li>Find a resource in the resource collection, and then edit it.</li> <li>Define a resource block. If a resource block with the same name exists in the resource collection, it will be updated with the contents of the resource block defined by the <code class="docutils literal">edit_resource</code> method. If a resource block does not exist in the resource collection, it will be created.</li> </ul> <p>The syntax for the <code class="docutils literal">edit_resource</code> method is as follows:</p> <pre class="highlight-ruby" data-language="ruby">edit_resource(:resource_type, 'resource_name', resource_attrs_block)</pre> <p>where:</p> <ul class="simple"> <li>
<code class="docutils literal">:resource_type</code> is the resource type, such as <code class="docutils literal">:file ``(for the **file** resource), ``:template</code> (for the <strong>template</strong> resource), and so on. Any resource available to Chef may be declared.</li> <li>
<code class="docutils literal">resource_name</code> the property that is the default name of the resource, typically the string that appears in the <code class="docutils literal">resource 'name' do</code> block of a resource (but not always); see the Syntax section for the resource to be declared to verify the default name property.</li> <li>
<code class="docutils literal">resource_attrs_block</code> is a block in which properties of the instantiated resource are declared.</li> </ul> <p>For example:</p> <pre class="highlight-ruby" data-language="ruby">edit_resource(:template, '/x/y.txy') do
  cookbook_name: cookbook_name
end</pre> <p>and a resource block:</p> <pre class="highlight-ruby" data-language="ruby">edit_resource(template: '/etc/aliases') do
  source 'aliases.erb'
  cookbook 'aliases'
  variables({:aliases =&gt; {} })
  notifies :run, 'execute[newaliases]'
end</pre>   <h3 id="id3">edit_resource!</h3> <p>Use the <code class="docutils literal">edit_resource!</code> method to:</p> <ul class="simple"> <li>Find a resource in the resource collection, and then edit it.</li> <li>Define a resource block. If a resource with the same name exists in the resource collection, its properties will be updated with the contents of the resource block defined by the <code class="docutils literal">edit_resource</code> method.</li> </ul> <p>In both cases, if the resource is not found, an exception is returned.</p> <p>The syntax for the <code class="docutils literal">edit_resource!</code> method is as follows:</p> <pre class="highlight-ruby" data-language="ruby">edit_resource!(:resource_type, 'resource_name')</pre> <p>where:</p> <ul class="simple"> <li>
<code class="docutils literal">:resource_type</code> is the resource type, such as <code class="docutils literal">:file ``(for the **file** resource), ``:template</code> (for the <strong>template</strong> resource), and so on. Any resource available to Chef may be declared.</li> <li>
<code class="docutils literal">resource_name</code> the property that is the default name of the resource, typically the string that appears in the <code class="docutils literal">resource 'name' do</code> block of a resource (but not always); see the Syntax section for the resource to be declared to verify the default name property.</li> <li>
<code class="docutils literal">resource_attrs_block</code> is a block in which properties of the instantiated resource are declared.</li> </ul> <p>For example:</p> <pre class="highlight-ruby" data-language="ruby">edit_resource!(:file, '/x/y.rst')</pre>   <h3 id="find-resource">find_resource</h3> <p>Use the <code class="docutils literal">find_resource</code> method to:</p> <ul class="simple"> <li>Find a resource in the resource collection.</li> <li>Define a resource block. If a resource block with the same name exists in the resource collection, it will be returned. If a resource block does not exist in the resource collection, it will be created.</li> </ul> <p>The syntax for the <code class="docutils literal">find_resource</code> method is as follows:</p> <pre class="highlight-ruby" data-language="ruby">find_resource(:resource_type, 'resource_name')</pre> <p>where:</p> <ul class="simple"> <li>
<code class="docutils literal">:resource_type</code> is the resource type, such as <code class="docutils literal">:file ``(for the **file** resource), ``:template</code> (for the <strong>template</strong> resource), and so on. Any resource available to Chef may be declared.</li> <li>
<code class="docutils literal">resource_name</code> the property that is the default name of the resource, typically the string that appears in the <code class="docutils literal">resource 'name' do</code> block of a resource (but not always); see the Syntax section for the resource to be declared to verify the default name property.</li> </ul> <p>For example:</p> <pre class="highlight-ruby" data-language="ruby">find_resource(:template, '/x/y.txy')</pre> <p>and a resource block:</p> <pre class="highlight-ruby" data-language="ruby">find_resource(template: '/etc/seapower') do
  source 'seapower.erb'
  cookbook 'seapower'
  variables({:seapower =&gt; {} })
  notifies :run, 'execute[newseapower]'
end</pre>   <h3 id="id4">find_resource!</h3> <p>Use the <code class="docutils literal">find_resource!</code> method to find a resource in the resource collection. If the resource is not found, an exception is returned.</p> <p>The syntax for the <code class="docutils literal">find_resource!</code> method is as follows:</p> <pre class="highlight-ruby" data-language="ruby">find_resource!(:resource_type, 'resource_name')</pre> <p>where:</p> <ul class="simple"> <li>
<code class="docutils literal">:resource_type</code> is the resource type, such as <code class="docutils literal">:file ``(for the **file** resource), ``:template</code> (for the <strong>template</strong> resource), and so on. Any resource available to Chef may be declared.</li> <li>
<code class="docutils literal">resource_name</code> the property that is the default name of the resource, typically the string that appears in the <code class="docutils literal">resource 'name' do</code> block of a resource (but not always); see the Syntax section for the resource to be declared to verify the default name property.</li> </ul> <p>For example:</p> <pre class="highlight-ruby" data-language="ruby">find_resource!(:template, '/x/y.erb')</pre>   <h3>platform?</h3> <p>Use the <code class="docutils literal">platform?</code> method to ensure that certain actions are run for specific platform. The <code class="docutils literal">platform?</code> method will return true if one of the listed parameters matches the <code class="docutils literal">node['platform']</code> attribute that is detected by Ohai during every chef-client run.</p> <p>The syntax for the <code class="docutils literal">platform?</code> method is as follows:</p> <pre class="highlight-ruby" data-language="ruby">platform?('parameter', 'parameter')</pre> <p>where:</p> <ul class="simple"> <li>
<code class="docutils literal">parameter</code> is a comma-separated list, each specifying a platform, such as Red Hat, CentOS, or Fedora</li> <li>
<code class="docutils literal">platform?</code> method is typically used with an <code class="docutils literal">if</code>, <code class="docutils literal">elseif</code>, or <code class="docutils literal">case</code> statement that contains Ruby code that is specific for the platform, if detected</li> </ul>  <h4 id="parameters">Parameters</h4> <p>The following parameters can be used with this method:</p> <table class="docutils"> <colgroup> <col width="17%"> <col width="83%"> </colgroup> <thead valign="bottom"> <tr class="row-odd">
<th class="head">Parameter</th> <th class="head">Platforms</th> </tr> </thead> <tbody valign="top"> <tr class="row-even">
<td><code class="docutils literal">aix</code></td> <td>AIX. All platform variants of AIX return <code class="docutils literal">aix</code>.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">arch</code></td> <td>Arch Linux</td> </tr> <tr class="row-even">
<td><code class="docutils literal">debian</code></td> <td>Debian, Linux Mint, Ubuntu</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">fedora</code></td> <td>Fedora</td> </tr> <tr class="row-even">
<td><code class="docutils literal">freebsd</code></td> <td>FreeBSD. All platform variants of FreeBSD return <code class="docutils literal">freebsd</code>.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">gentoo</code></td> <td>Gentoo</td> </tr> <tr class="row-even">
<td><code class="docutils literal">hpux</code></td> <td>HP-UX. All platform variants of HP-UX return <code class="docutils literal">hpux</code>.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">mac_os_x</code></td> <td>Mac OS X</td> </tr> <tr class="row-even">
<td><code class="docutils literal">netbsd</code></td> <td>NetBSD. All platform variants of NetBSD return <code class="docutils literal">netbsd</code>.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">openbsd</code></td> <td>OpenBSD. All platform variants of OpenBSD return <code class="docutils literal">openbsd</code>.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">slackware</code></td> <td>Slackware</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">solaris</code></td> <td>Solaris. For Solaris-related platforms, the <code class="docutils literal">platform_family</code> method does not support the Solaris platform family and will default back to <code class="docutils literal">platform_family = platform</code>. For example, if the platform is OmniOS, the <code class="docutils literal">platform_family</code> is <code class="docutils literal">omnios</code>, if the platform is SmartOS, the <code class="docutils literal">platform_family</code> is <code class="docutils literal">smartos</code>, and so on. All platform variants of Solaris return <code class="docutils literal">solaris</code>.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">suse</code></td> <td>openSUSE, SUSE Enterprise Linux Server.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">windows</code></td> <td>Microsoft Windows. All platform variants of Microsoft Windows return <code class="docutils literal">windows</code>.</td> </tr> </tbody> </table> <div class="admonition note"> <p class="first admonition-title">Note</p> <p class="last">Ohai collects platform information at the start of the chef-client run and stores that information in the <code class="docutils literal">node['platform']</code> attribute.</p> </div> <p>For example:</p> <pre class="highlight-ruby" data-language="ruby">platform?('debian')</pre> <p>or:</p> <pre class="highlight-ruby" data-language="ruby">platform?('rhel', 'debian')</pre>   <h4 id="id5">Examples</h4> <p>The following example shows how the <code class="docutils literal">platform?</code> method can be used in a recipe.</p> <p><strong>Use an if statement with the platform recipe DSL method</strong></p> <p>The following example shows how an if statement can be used with the <code class="docutils literal">platform?</code> method in the Recipe DSL to run code specific to Microsoft Windows. The code is defined using the <strong>ruby_block</strong> resource:</p> <pre class="highlight-ruby" data-language="ruby"># the following code sample comes from the ``client`` recipe
# in the following cookbook: https://github.com/chef-cookbooks/mysql

if platform?('windows')
  ruby_block 'copy libmysql.dll into ruby path' do
    block do
      require 'fileutils'
      FileUtils.cp "#{node['mysql']['client']['lib_dir']}\\libmysql.dll",
        node['mysql']['client']['ruby_dir']
    end
    not_if { File.exist?("#{node['mysql']['client']['ruby_dir']}\\libmysql.dll") }
  end
end</pre>    <h3>platform_family?</h3> <p>Use the <code class="docutils literal">platform_family?</code> method to ensure that certain actions are run for specific platform family. The <code class="docutils literal">platform_family?</code> method will return true if one of the listed parameters matches the <code class="docutils literal">node['platform_family']</code> attribute that is detected by Ohai during every chef-client run.</p> <p>The syntax for the <code class="docutils literal">platform_family?</code> method is as follows:</p> <pre class="highlight-ruby" data-language="ruby">platform_family?('parameter', 'parameter')</pre> <p>where:</p> <ul class="simple"> <li>
<code class="docutils literal">'parameter'</code> is a comma-separated list, each specifying a platform family, such as Debian, or Red Hat Enterprise Linux</li> <li>
<code class="docutils literal">platform_family?</code> method is typically used with an <code class="docutils literal">if</code>, <code class="docutils literal">elseif</code>, or <code class="docutils literal">case</code> statement that contains Ruby code that is specific for the platform family, if detected</li> </ul> <p>For example:</p> <pre class="highlight-ruby" data-language="ruby">if platform_family?('rhel')
  # do RHEL things
end</pre> <p>or:</p> <pre class="highlight-ruby" data-language="ruby">if platform_family?('debian', 'rhel')
  # do things on debian and rhel families
end</pre> <p>For example:</p> <pre class="highlight-ruby" data-language="ruby">platform_family?('gentoo')</pre> <p>or:</p> <pre class="highlight-ruby" data-language="ruby">platform_family?('slackware', 'suse', 'arch')</pre> <div class="admonition note"> <p class="first admonition-title">Note</p> <p class="last"><code class="docutils literal">platform_family?</code> will default to <code class="docutils literal">platform?</code> when <code class="docutils literal">platform_family?</code> is not explicitly defined.</p> </div>  <h4 id="id6">Examples</h4> <p>The following examples show how the <code class="docutils literal">platform_family?</code> method can be used in a recipe.</p> <p><strong>Use a specific binary for a specific platform</strong></p> <p>The following is an example of using the <code class="docutils literal">platform_family?</code> method in the Recipe DSL to create a variable that can be used with other resources in the same recipe. In this example, <code class="docutils literal">platform_family?</code> is being used to ensure that a specific binary is used for a specific platform before using the <strong>remote_file</strong> resource to download a file from a remote location, and then using the <strong>execute</strong> resource to install that file by running a command.</p> <pre class="highlight-ruby" data-language="ruby">if platform_family?('rhel')
  pip_binary = '/usr/bin/pip'
else
  pip_binary = '/usr/local/bin/pip'
end

remote_file "#{Chef::Config[:file_cache_path]}/distribute_setup.py" do
  source 'http://python-distribute.org/distribute_setup.py'
  mode '0755'
  not_if { File.exist?(pip_binary) }
end

execute 'install-pip' do
  cwd Chef::Config[:file_cache_path]
  command &lt;&lt;-EOF
    # command for installing Python goes here
    EOF
  not_if { File.exist?(pip_binary) }
end</pre> <p>where a command for installing Python might look something like:</p> <pre class="highlight-ruby" data-language="ruby">#{node['python']['binary']} distribute_setup.py
#{::File.dirname(pip_binary)}/easy_install pip</pre>    <h3>reboot_pending?</h3> <p>Use the <code class="docutils literal">reboot_pending?</code> method to test if a node needs a reboot, or is expected to reboot. <code class="docutils literal">reboot_pending?</code> returns <code class="docutils literal">true</code> when the node needs a reboot.</p> <p>The syntax for the <code class="docutils literal">reboot_pending?</code> method is as follows:</p> <pre class="highlight-ruby" data-language="ruby">reboot_pending?</pre>   <h3>recipe_name</h3> <p>Use the <code class="docutils literal">recipe_name</code> method to return the name of a recipe.</p> <p>The syntax for the <code class="docutils literal">recipe_name</code> method is as follows:</p> <pre class="highlight-ruby" data-language="ruby">recipe_name</pre> <p>This method is often used as part of a log entry. For example:</p> <pre class="highlight-ruby" data-language="ruby">Chef::Log.info('I am a message from the #{recipe_name} recipe in the #{cookbook_name} cookbook.')</pre>   <h3>resources</h3> <p>Use the <code class="docutils literal">resources</code> method to look up a resource in the resource collection. The <code class="docutils literal">resources</code> method returns the value for the resource that it finds in the resource collection. The preferred syntax for the <code class="docutils literal">resources</code> method is as follows:</p> <pre class="highlight-ruby" data-language="ruby">resources('resource_type[resource_name]')</pre> <p>but the following syntax can also be used:</p> <pre class="highlight-ruby" data-language="ruby">resources(:resource_type =&gt; 'resource_name')</pre> <p>where in either approach <code class="docutils literal">resource_type</code> is the name of a resource and <code class="docutils literal">resource_name</code> is the name of a resource that can be configured by the chef-client.</p> <p>The <code class="docutils literal">resources</code> method can be used to modify a resource later on in a recipe. For example:</p> <pre class="highlight-ruby" data-language="ruby">file '/etc/hosts' do
  content '127.0.0.1 localhost.localdomain localhost'
end</pre> <p>and then later in the same recipe, or elsewhere:</p> <pre class="highlight-ruby" data-language="ruby">f = resources('file[/etc/hosts]')
f.mode '0644'</pre> <p>where <code class="docutils literal">file</code> is the type of resource, <code class="docutils literal">/etc/hosts</code> is the name, and <code class="docutils literal">f.mode</code> is used to set the <code class="docutils literal">mode</code> property on the <strong>file</strong> resource.</p>   <h3>search</h3> <p>Search indexes allow queries to be made for any type of data that is indexed by the Chef server, including data bags (and data bag items), environments, nodes, and roles. A defined query syntax is used to support search patterns like exact, wildcard, range, and fuzzy. A search is a full-text query that can be done from several locations, including from within a recipe, by using the <code class="docutils literal">search</code> subcommand in knife, the <code class="docutils literal">search</code> method in the Recipe DSL, the search box in the Chef management console, and by using the <code class="docutils literal">/search</code> or <code class="docutils literal">/search/INDEX</code> endpoints in the Chef server API. The search engine is based on Apache Solr and is run from the Chef server.</p> <p>Use the <code class="docutils literal">search</code> method to perform a search query against the Chef server from within a recipe.</p> <p>The syntax for the <code class="docutils literal">search</code> method is as follows:</p> <pre class="highlight-ruby" data-language="ruby">search(:index, 'query')</pre> <p>where:</p> <ul class="simple"> <li>
<code class="docutils literal">:index</code> is of name of the index on the Chef server against which the search query will run: <code class="docutils literal">:client</code>, <code class="docutils literal">:data_bag_name</code>, <code class="docutils literal">:environment</code>, <code class="docutils literal">:node</code>, and <code class="docutils literal">:role</code>
</li> <li>
<code class="docutils literal">'query'</code> is a valid search query against an object on the Chef server (see below for more information about how to build the query)</li> </ul> <p>For example, using the results of a search query within a variable:</p> <pre class="highlight-ruby" data-language="ruby">webservers = search(:node, 'role:webserver')</pre> <p>and then using the results of that query to populate a template:</p> <pre class="highlight-ruby" data-language="ruby">template '/tmp/list_of_webservers' do
  source 'list_of_webservers.erb'
  variables(:webservers =&gt; webservers)
end</pre>  <h4 id="filter-result">:filter_result</h4> <p>Use <code class="docutils literal">:filter_result</code> as part of a search query to filter the search output based on the pattern specified by a Hash. Only attributes in the Hash will be returned.</p> <div class="admonition note"> <p class="first admonition-title">Note</p> <p class="last">Prior to chef-client 12.0, this functionality was available from the <code class="docutils literal">partial_search</code> cookbook and was referred to as “partial search”.</p> </div> <p>The syntax for the <code class="docutils literal">search</code> method that uses <code class="docutils literal">:filter_result</code> is as follows:</p> <pre class="highlight-ruby" data-language="ruby">search(:index, 'query',
  :filter_result =&gt; { 'foo' =&gt; [ 'abc' ],
                      'bar' =&gt; [ '123' ],
                      'baz' =&gt; [ 'sea', 'power' ]
                    }
      ).each do |result|
  puts result['foo']
  puts result['bar']
  puts result['baz']
end</pre> <p>where:</p> <ul class="simple"> <li>
<code class="docutils literal">:index</code> is of name of the index on the Chef server against which the search query will run: <code class="docutils literal">:client</code>, <code class="docutils literal">:data_bag_name</code>, <code class="docutils literal">:environment</code>, <code class="docutils literal">:node</code>, and <code class="docutils literal">:role</code>
</li> <li>
<code class="docutils literal">'query'</code> is a valid search query against an object on the Chef server</li> <li>
<code class="docutils literal">:filter_result</code> defines a Hash of values to be returned</li> </ul> <p>For example:</p> <pre class="highlight-ruby" data-language="ruby">search(:node, 'role:web',
  :filter_result =&gt; { 'name' =&gt; [ 'name' ],
                      'ip' =&gt; [ 'ipaddress' ],
                      'kernel_version' =&gt; [ 'kernel', 'version' ]
                    }
      ).each do |result|
  puts result['name']
  puts result['ip']
  puts result['kernel_version']
end</pre>   <h4 id="query-syntax">Query Syntax</h4> <p>A search query is comprised of two parts: the key and the search pattern. A search query has the following syntax:</p> <pre class="highlight-ruby" data-language="ruby">key:search_pattern</pre> <p>where <code class="docutils literal">key</code> is a field name that is found in the JSON description of an indexable object on the Chef server (a role, node, client, environment, or data bag) and <code class="docutils literal">search_pattern</code> defines what will be searched for, using one of the following search patterns: exact, wildcard, range, or fuzzy matching. Both <code class="docutils literal">key</code> and <code class="docutils literal">search_pattern</code> are case-sensitive; <code class="docutils literal">key</code> has limited support for multiple character wildcard matching using an asterisk (“*”) (and as long as it is not the first character).</p>  <h5 id="keys">Keys</h5> <p>A field name/description pair is available in the JSON object. Use the field name when searching for this information in the JSON object. Any field that exists in any JSON description for any role, node, chef-client, environment, or data bag can be searched.</p> <p><strong>Nested Fields</strong></p> <p>A nested field appears deeper in the JSON data structure. For example, information about a network interface might be several layers deep: <code class="docutils literal">node[:network][:interfaces][:en1]</code>. When nested fields are present in a JSON structure, the chef-client will extract those nested fields to the top-level, flattening them into compound fields that support wildcard search patterns.</p> <p>By combining wildcards with range-matching patterns and wildcard queries, it is possible to perform very powerful searches, such as using the vendor part of the MAC address to find every node that has a network card made by the specified vendor.</p> <p>Consider the following snippet of JSON data:</p> <pre class="highlight-javascript" data-language="javascript">{"network":
  [
  //snipped...
    "interfaces",
      {"en1": {
        "number": "1",
        "flags": [
          "UP",
          "BROADCAST",
          "SMART",
          "RUNNING",
          "SIMPLEX",
          "MULTICAST"
        ],
        "addresses": {
          "fe80::fa1e:dfff:fed8:63a2": {
            "scope": "Link",
            "prefixlen": "64",
            "family": "inet6"
          },
          "f8:1e:df:d8:63:a2": {
            "family": "lladdr"
          },
          "192.168.0.195": {
            "netmask": "255.255.255.0",
            "broadcast": "192.168.0.255",
            "family": "inet"
          }
        },
        "mtu": "1500",
        "media": {
          "supported": {
            "autoselect": {
              "options": [

              ]
            }
          },
          "selected": {
            "autoselect": {
              "options": [

              ]
            }
          }
        },
        "type": "en",
        "status": "active",
        "encapsulation": "Ethernet"
      },
  //snipped...</pre> <p>Before this data is indexed on the Chef server, the nested fields are extracted into the top level, similar to:</p> <pre class="highlight-none" data-language="none">"broadcast" =&gt; "192.168.0.255",
"flags"     =&gt; ["UP", "BROADCAST", "SMART", "RUNNING", "SIMPLEX", "MULTICAST"]
"mtu"       =&gt; "1500"</pre> <p>which allows searches like the following to find data that is present in this node:</p> <pre class="highlight-ruby" data-language="ruby">node "broadcast:192.168.0.*"</pre> <p>or:</p> <pre class="highlight-ruby" data-language="ruby">node "mtu:1500"</pre> <p>or:</p> <pre class="highlight-ruby" data-language="ruby">node "flags:UP"</pre> <p>This data is also flattened into various compound fields, which follow the same pattern as the JSON hierarchy and use underscores (<code class="docutils literal">_</code>) to separate the levels of data, similar to:</p> <pre class="highlight-none" data-language="none"># ...snip...
"network_interfaces_en1_addresses_192.168.0.195_broadcast" =&gt; "192.168.0.255",
"network_interfaces_en1_addresses_fe80::fa1e:tldr_family"  =&gt; "inet6",
"network_interfaces_en1_addresses"                         =&gt; ["fe80::fa1e:tldr","f8:1e:df:tldr","192.168.0.195"]
# ...snip...</pre> <p>which allows searches like the following to find data that is present in this node:</p> <pre class="highlight-ruby" data-language="ruby">node "network_interfaces_en1_addresses:192.168.0.195"</pre> <p>This flattened data structure also supports using wildcard compound fields, which allow searches to omit levels within the JSON data structure that are not important to the search query. In the following example, an asterisk (<code class="docutils literal">*</code>) is used to show where the wildcard can exist when searching for a nested field:</p> <pre class="highlight-ruby" data-language="ruby">"network_interfaces_*_flags"     =&gt; ["UP", "BROADCAST", "SMART", "RUNNING", "SIMPLEX", "MULTICAST"]
"network_interfaces_*_addresses" =&gt; ["fe80::fa1e:dfff:fed8:63a2", "192.168.0.195", "f8:1e:df:d8:63:a2"]
"network_interfaces_en0_media_*" =&gt; ["autoselect", "none", "1000baseT", "10baseT/UTP", "100baseTX"]
"network_interfaces_en1_*"       =&gt; ["1", "UP", "BROADCAST", "SMART", "RUNNING", "SIMPLEX", "MULTICAST",
                                     "fe80::fa1e:dfff:fed8:63a2", "f8:1e:df:d8:63:a2", "192.168.0.195",
                                     "1500", "supported", "selected", "en", "active", "Ethernet"]</pre> <p>For each of the wildcard examples above, the possible values are shown contained within the brackets. When running a search query, the query syntax for wildcards is to simply omit the name of the node (while preserving the underscores), similar to:</p> <pre class="highlight-ruby" data-language="ruby">network_interfaces__flags</pre> <p>This query will search within the <code class="docutils literal">flags</code> node, within the JSON structure, for each of <code class="docutils literal">UP</code>, <code class="docutils literal">BROADCAST</code>, <code class="docutils literal">SMART</code>, <code class="docutils literal">RUNNING</code>, <code class="docutils literal">SIMPLEX</code>, and <code class="docutils literal">MULTICAST</code>.</p>   <h5 id="patterns">Patterns</h5> <p>A search pattern is a way to fine-tune search results by returning anything that matches some type of incomplete search query. There are four types of search patterns that can be used when searching the search indexes on the Chef server: exact, wildcard, range, and fuzzy.</p> <p><strong>Exact Match</strong></p> <p>An exact matching search pattern is used to search for a key with a name that exactly matches a search query. If the name of the key contains spaces, quotes must be used in the search pattern to ensure the search query finds the key. The entire query must also be contained within quotes, so as to prevent it from being interpreted by Ruby or a command shell. The best way to ensure that quotes are used consistently is to quote the entire query using single quotes (‘ ‘) and a search pattern with double quotes (” ”).</p> <p><strong>Wildcard Match</strong></p> <p>A wildcard matching search pattern is used to query for substring matches that replace zero (or more) characters in the search pattern with anything that could match the replaced character. There are two types of wildcard searches:</p> <ul class="simple"> <li>A question mark (<code class="docutils literal">?</code>) can be used to replace exactly one character (as long as that character is not the first character in the search pattern)</li> <li>An asterisk (<code class="docutils literal">*</code>) can be used to replace any number of characters (including zero)</li> </ul> <p><strong>Range Match</strong></p> <p>A range matching search pattern is used to query for values that are within a range defined by upper and lower boundaries. A range matching search pattern can be inclusive or exclusive of the boundaries. Use square brackets (“[ ]”) to denote inclusive boundaries and curly braces (“{ }”) to denote exclusive boundaries and with the following syntax:</p> <pre class="highlight-ruby" data-language="ruby">boundary TO boundary</pre> <p>where <code class="docutils literal">TO</code> is required (and must be capitalized).</p> <p><strong>Fuzzy Match</strong></p> <p>A fuzzy matching search pattern is used to search based on the proximity of two strings of characters. An (optional) integer may be used as part of the search query to more closely define the proximity. A fuzzy matching search pattern has the following syntax:</p> <pre class="highlight-ruby" data-language="ruby">"search_query"~edit_distance</pre> <p>where <code class="docutils literal">search_query</code> is the string that will be used during the search and <code class="docutils literal">edit_distance</code> is the proximity. A tilde (“~”) is used to separate the edit distance from the search query.</p>   <h5 id="operators">Operators</h5> <p>An operator can be used to ensure that certain terms are included in the results, are excluded from the results, or are not included even when other aspects of the query match. Searches can use the following operators:</p> <table class="docutils"> <colgroup> <col width="40%"> <col width="60%"> </colgroup> <thead valign="bottom"> <tr class="row-odd">
<th class="head">Operator</th> <th class="head">Description</th> </tr> </thead> <tbody valign="top"> <tr class="row-even">
<td><code class="docutils literal">AND</code></td> <td>Use to find a match when both terms exist.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">OR</code></td> <td>Use to find a match if either term exists.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">NOT</code></td> <td>Use to exclude the term after <code class="docutils literal">NOT</code> from the search results.</td> </tr> </tbody> </table>   <h5 id="special-characters">Special Characters</h5> <p>A special character can be used to fine-tune a search query and to increase the accuracy of the search results. The following characters can be included within the search query syntax, but each occurrence of a special character must be escaped with a backslash (<code class="docutils literal">\</code>):</p> <pre class="highlight-ruby" data-language="ruby">+  -  &amp;&amp;  | |  !  ( )  { }  [ ]  ^  "  ~  *  ?  :  \</pre> <p>For example:</p> <pre class="highlight-ruby" data-language="ruby">\(1\+1\)\:2</pre>    <h4 id="id7">Examples</h4> <p>The following examples show how the <code class="docutils literal">search</code> method can be used in a recipe.</p> <p><strong>Use the search recipe DSL method to find users</strong></p> <p>The following example shows how to use the <code class="docutils literal">search</code> method in the Recipe DSL to search for users:</p> <pre class="highlight-ruby" data-language="ruby">#  the following code sample comes from the openvpn cookbook: https://github.com/chef-cookbooks/openvpn

search("users", "*:*") do |u|
  execute "generate-openvpn-#{u['id']}" do
    command "./pkitool #{u['id']}"
    cwd '/etc/openvpn/easy-rsa'
    environment(
      'EASY_RSA' =&gt; '/etc/openvpn/easy-rsa',
      'KEY_CONFIG' =&gt; '/etc/openvpn/easy-rsa/openssl.cnf',
      'KEY_DIR' =&gt; node['openvpn']['key_dir'],
      'CA_EXPIRE' =&gt; node['openvpn']['key']['ca_expire'].to_s,
      'KEY_EXPIRE' =&gt; node['openvpn']['key']['expire'].to_s,
      'KEY_SIZE' =&gt; node['openvpn']['key']['size'].to_s,
      'KEY_COUNTRY' =&gt; node['openvpn']['key']['country'],
      'KEY_PROVINCE' =&gt; node['openvpn']['key']['province'],
      'KEY_CITY' =&gt; node['openvpn']['key']['city'],
      'KEY_ORG' =&gt; node['openvpn']['key']['org'],
      'KEY_EMAIL' =&gt; node['openvpn']['key']['email']
    )
    not_if { File.exist?("#{node['openvpn']['key_dir']}/#{u['id']}.crt") }
  end

  %w{ conf ovpn }.each do |ext|
    template "#{node['openvpn']['key_dir']}/#{u['id']}.#{ext}" do
      source 'client.conf.erb'
      variables :username =&gt; u['id']
    end
  end

  execute "create-openvpn-tar-#{u['id']}" do
    cwd node['openvpn']['key_dir']
    command &lt;&lt;-EOH
      tar zcf #{u['id']}.tar.gz \
      ca.crt #{u['id']}.crt #{u['id']}.key \
      #{u['id']}.conf #{u['id']}.ovpn \
    EOH
    not_if { File.exist?("#{node['openvpn']['key_dir']}/#{u['id']}.tar.gz") }
  end
end</pre> <p>where</p> <ul class="simple"> <li>the search will use both of the <strong>execute</strong> resources, unless the condition specified by the <code class="docutils literal">not_if</code> commands are met</li> <li>the <code class="docutils literal">environments</code> property in the first <strong>execute</strong> resource is being used to define values that appear as variables in the OpenVPN configuration</li> <li>the <strong>template</strong> resource tells the chef-client which template to use</li> </ul>    <h3>shell_out</h3> <p>The <code class="docutils literal">shell_out</code> method can be used to run a command against the node, and then display the output to the console when the log level is set to <code class="docutils literal">debug</code>.</p> <p>The syntax for the <code class="docutils literal">shell_out</code> method is as follows:</p> <pre class="highlight-ruby" data-language="ruby">shell_out(command_args)</pre> <p>where <code class="docutils literal">command_args</code> is the command that is run against the node.</p>   <h3>shell_out!</h3> <p>The <code class="docutils literal">shell_out!</code> method can be used to run a command against the node, display the output to the console when the log level is set to <code class="docutils literal">debug</code>, and then raise an error when the method returns <code class="docutils literal">false</code>.</p> <p>The syntax for the <code class="docutils literal">shell_out!</code> method is as follows:</p> <pre class="highlight-ruby" data-language="ruby">shell_out!(command_args)</pre> <p>where <code class="docutils literal">command_args</code> is the command that is run against the node. This method will return <code class="docutils literal">true</code> or <code class="docutils literal">false</code>.</p>   <h3>shell_out_with_systems_locale</h3> <p>The <code class="docutils literal">shell_out_with_systems_locale</code> method can be used to run a command against the node (via the <code class="docutils literal">shell_out</code> method), but using the <code class="docutils literal">LC_ALL</code> environment variable.</p> <p>The syntax for the <code class="docutils literal">shell_out_with_systems_locale</code> method is as follows:</p> <pre class="highlight-ruby" data-language="ruby">shell_out_with_systems_locale(command_args)</pre> <p>where <code class="docutils literal">command_args</code> is the command that is run against the node.</p>   <h3>tag, tagged?, untag</h3> <p>A tag is a custom description that is applied to a node. A tag, once applied, can be helpful when managing nodes using knife or when building recipes by providing alternate methods of grouping similar types of information.</p> <p>Tags can be added and removed. Machines can be checked to see if they already have a specific tag. To use tags in your recipe simply add the following:</p> <pre class="highlight-ruby" data-language="ruby">tag('mytag')</pre> <p>To test if a machine is tagged, add the following:</p> <pre class="highlight-ruby" data-language="ruby">tagged?('mytag')</pre> <p>to return <code class="docutils literal">true</code> or <code class="docutils literal">false</code>. <code class="docutils literal">tagged?</code> can also use an array as an argument.</p> <p>To remove a tag:</p> <pre class="highlight-ruby" data-language="ruby">untag('mytag')</pre> <p>For example:</p> <pre class="highlight-ruby" data-language="ruby">tag('machine')

if tagged?('machine')
   Chef::Log.info('Hey I'm #{node[:tags]}')
end

untag('machine')

if not tagged?('machine')
   Chef::Log.info('I has no tagz')
end</pre> <p>Will return something like this:</p> <pre class="highlight-none" data-language="none">[Thu, 22 Jul 2010 18:01:45 +0000] INFO: Hey I'm machine
[Thu, 22 Jul 2010 18:01:45 +0000] INFO: I has no tagz</pre>   <h3>value_for_platform</h3> <p>Use the <code class="docutils literal">value_for_platform</code> method in a recipe to select a value based on the <code class="docutils literal">node['platform']</code> and <code class="docutils literal">node['platform_version']</code> attributes. These values are detected by Ohai during every chef-client run.</p> <p>The syntax for the <code class="docutils literal">value_for_platform</code> method is as follows:</p> <pre class="highlight-ruby" data-language="ruby">value_for_platform( ['platform', ...] =&gt; { 'version' =&gt; 'value' } )</pre> <p>where:</p> <ul class="simple"> <li>
<code class="docutils literal">'platform', ...</code> is a comma-separated list of platforms, such as Red Hat, openSUSE, or Fedora</li> <li>
<code class="docutils literal">version</code> specifies the version of that platform</li> <li>Version constraints—<code class="docutils literal">&gt;</code>, <code class="docutils literal">&lt;</code>, <code class="docutils literal">&gt;=</code>, <code class="docutils literal">&lt;=</code>, <code class="docutils literal">~&gt;</code>—may be used with <code class="docutils literal">version</code>; an exception is raised if two version constraints match; an exact match will always take precedence over a match made from a version constraint</li> <li>
<code class="docutils literal">value</code> specifies the value that will be used if the node’s platform matches the <code class="docutils literal">value_for_platform</code> method</li> </ul> <p>When each value only has a single platform, use the following syntax:</p> <pre class="highlight-ruby" data-language="ruby">value_for_platform(
  'platform' =&gt; { 'version' =&gt; 'value' },
  'platform' =&gt; { 'version' =&gt; 'value' },
  'platform' =&gt; 'value'
)</pre> <p>When each value has more than one platform, the syntax changes to:</p> <pre class="highlight-ruby" data-language="ruby">value_for_platform(
  ['platform', 'platform', ... ] =&gt; {
    'version' =&gt; 'value'
  },
)</pre>  <h4 id="id9">Operators</h4> <p>The following operators may be used:</p> <table class="docutils"> <colgroup> <col width="40%"> <col width="60%"> </colgroup> <thead valign="bottom"> <tr class="row-odd">
<th class="head">Operator</th> <th class="head">Description</th> </tr> </thead> <tbody valign="top"> <tr class="row-even">
<td><code class="docutils literal">=</code></td> <td>equal to</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">&gt;</code></td> <td>greater than</td> </tr> <tr class="row-even">
<td><code class="docutils literal">&lt;</code></td> <td>less than</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">&gt;=</code></td> <td>greater than or equal to; also known as “optimistically greater than”, or “optimistic”</td> </tr> <tr class="row-even">
<td><code class="docutils literal">&lt;=</code></td> <td>less than or equal to</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">~&gt;</code></td> <td>approximately greater than; also known as “pessimistically greater than”, or “pessimistic”</td> </tr> </tbody> </table>   <h4 id="id10">Examples</h4> <p>The following example will set <code class="docutils literal">package_name</code> to <code class="docutils literal">httpd</code> for the Red Hat platform and to <code class="docutils literal">apache2</code> for the Debian platform:</p> <pre class="highlight-ruby" data-language="ruby">package_name = value_for_platform(
  ['centos', 'redhat', 'suse', 'fedora' ] =&gt; {
    'default' =&gt; 'httpd'
  },
  ['ubuntu', 'debian'] =&gt; {
    'default' =&gt; 'apache2'
  }
)</pre> <p>The following example will set <code class="docutils literal">package</code> to <code class="docutils literal">apache-couchdb</code> for OpenBSD platforms, <code class="docutils literal">dev-db/couchdb</code> for Gentoo platforms, and <code class="docutils literal">couchdb</code> for all other platforms:</p> <pre class="highlight-ruby" data-language="ruby">package = value_for_platform(
  'openbsd' =&gt; { 'default' =&gt; 'apache-couchdb' },
  'gentoo' =&gt; { 'default' =&gt; 'dev-db/couchdb' },
  'default' =&gt; 'couchdb'
)</pre> <p>The following example shows using version constraints to specify a value based on the version:</p> <pre class="highlight-ruby" data-language="ruby">value_for_platform(
  'os1' =&gt; { '&lt; 1.0' =&gt; 'less than 1.0',
             '~&gt; 2.0' =&gt; 'version 2.x',
             '&gt;= 3.0' =&gt; 'version 3.0',
             '3.0.1' =&gt; '3.0.1 will always use this value' }
)</pre>    <h3>value_for_platform_family</h3> <p>Use the <code class="docutils literal">value_for_platform_family</code> method in a recipe to select a value based on the <code class="docutils literal">node['platform_family']</code> attribute. This value is detected by Ohai during every chef-client run.</p> <p>The syntax for the <code class="docutils literal">value_for_platform_family</code> method is as follows:</p> <pre class="highlight-ruby" data-language="ruby">value_for_platform_family( 'platform_family' =&gt; { 'version' =&gt; 'value' }, ... )</pre> <p>where:</p> <ul class="simple"> <li>
<code class="docutils literal">'platform_family' =&gt; { 'version' =&gt; 'value' }, ...</code> is a comma-separated list of platforms, such as Fedora, openSUSE, or Red Hat Enterprise Linux</li> <li>
<code class="docutils literal">value</code> specifies the value that will be used if the node’s platform family matches the <code class="docutils literal">value_for_platform_family</code> method</li> </ul> <p>When each value only has a single platform, use the following syntax:</p> <pre class="highlight-ruby" data-language="ruby">value_for_platform_family(
  'platform_family' =&gt; { 'version' =&gt; 'value' },
  'platform_family' =&gt; { 'version' =&gt; 'value' },
  'platform_family' =&gt; 'value'
)</pre> <p>When each value has more than one platform, the syntax changes to:</p> <pre class="highlight-ruby" data-language="ruby">value_for_platform_family(
  ['platform_family', 'platform_family', 'platform_family', 'platform_family' ] =&gt; 'value',
  ['platform_family', 'platform_family'] =&gt; 'value',
  'default' =&gt; 'value'
)</pre> <p>The following example will set <code class="docutils literal">package</code> to <code class="docutils literal">httpd-devel</code> for the Red Hat Enterprise Linux, Fedora, and openSUSE platforms and to <code class="docutils literal">apache2-dev</code> for the Debian platform:</p> <pre class="highlight-ruby" data-language="ruby">package = value_for_platform_family(
  ['rhel', 'fedora', 'suse'] =&gt; 'httpd-devel',
    'debian' =&gt; 'apache2-dev'
)</pre>   <h3 id="with-run-context">with_run_context</h3> <p>Use the <code class="docutils literal">with_run_context</code> method to define a block that has a pointer to a location in the <code class="docutils literal">run_context</code> hierarchy. Resources in recipes always run at the root of the <code class="docutils literal">run_context</code> hierarchy, whereas custom resources and notification blocks always build a child <code class="docutils literal">run_context</code> which contains their sub-resources.</p> <p>The syntax for the <code class="docutils literal">with_run_context</code> method is as follows:</p> <pre class="highlight-ruby" data-language="ruby">with_run_context :type do
  # some arbitrary pure Ruby stuff goes here
end</pre> <p>where <code class="docutils literal">:type</code> may be one of the following:</p> <ul class="simple"> <li>
<code class="docutils literal">:root</code> runs the block as part of the root <code class="docutils literal">run_context</code> hierarchy</li> <li>
<code class="docutils literal">:parent</code> runs the block as part of the parent process in the <code class="docutils literal">run_context</code> hierarchy</li> </ul> <p>For example:</p> <pre class="highlight-ruby" data-language="ruby">action :run do
  with_run_context :root do
    edit_resource(:my_thing, "accumulated state") do
      action :nothing
      my_array_property &lt;&lt; accumulate_some_stuff
    end
  end
  log "kick it off" do
    notifies :run, "my_thing[accumulated state], :delayed
  end
end</pre>    <h2 id="event-handlers">Event Handlers</h2> <div class="admonition note"> <p class="first admonition-title">Note</p> <p class="last">Event handlers are not specifically part of the Recipe DSL. An event handler is declared using the <code class="docutils literal">Chef.event_hander</code> method, which declares the event handler within recipes in a similar manner to other Recipe DSL methods.</p> </div> <p>Use the Handler DSL to attach a callback to an event. If the event occurs during the chef-client run, the associated callback is executed. For example:</p> <ul class="simple"> <li>Sending email if a chef-client run fails</li> <li>Sending a notification to chat application if an audit run fails</li> <li>Aggregating statistics about resources updated during a chef-client runs to StatsD</li> </ul>  <h3 id="on-method">on Method</h3> <p>Use the <code class="docutils literal">on</code> method to associate an event type with a callback. The callback defines what steps are taken if the event occurs during the chef-client run and is defined using arbitrary Ruby code. The syntax is as follows:</p> <pre class="highlight-ruby" data-language="ruby">Chef.event_handler do
  on :event_type do
    # some Ruby
  end
end</pre> <p>where</p> <ul class="simple"> <li>
<code class="docutils literal">Chef.event_handler</code> declares a block of code within a recipe that is processed when the named event occurs during a chef-client run</li> <li>
<code class="docutils literal">on</code> defines the block of code that will tell the chef-client how to handle the event</li> <li>
<code class="docutils literal">:event_type</code> is a valid exception event type, such as <code class="docutils literal">:run_start</code>, <code class="docutils literal">:run_failed</code>, <code class="docutils literal">:converge_failed</code>, <code class="docutils literal">:resource_failed</code>, or <code class="docutils literal">:recipe_not_found</code>
</li> </ul> <p>For example:</p> <pre class="highlight-bash" data-language="bash">Chef.event_handler do
  on :converge_start do
    puts "Ohai! I have started a converge."
  end
end</pre>   <h3 id="event-types">Event Types</h3> <p>The following table describes the events that may occur during a chef-client run. Each of these events may be referenced in an <code class="docutils literal">on</code> method block by declaring it as the event type.</p> <table class="docutils"> <colgroup> <col width="19%"> <col width="81%"> </colgroup> <thead valign="bottom"> <tr class="row-odd">
<th class="head">Event</th> <th class="head">Description</th> </tr> </thead> <tbody valign="top"> <tr class="row-even">
<td><code class="docutils literal">:run_start</code></td> <td>The start of the chef-client run.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">:run_started</code></td> <td>The chef-client run has started.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">:ohai_completed</code></td> <td>The Ohai run has completed.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">:skipping_registration</code></td> <td>The chef-client is not registering with the Chef server because it already has a private key or because it does not need one.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">:registration_start</code></td> <td>The chef-client is attempting to create a private key with which to register to the Chef server.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">:registration_completed</code></td> <td>The chef-client created its private key successfully.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">:registration_failed</code></td> <td>The chef-client encountered an error and was unable to register with the Chef server.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">:node_load_start</code></td> <td>The chef-client is attempting to load node data from the Chef server.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">:node_load_failed</code></td> <td>The chef-client encountered an error and was unable to load node data from the Chef server.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">:run_list_expand_failed</code></td> <td>The chef-client failed to expand the run-list.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">:node_load_completed</code></td> <td>The chef-client successfully loaded node data from the Chef server. Default and override attributes for roles have been computed, but are not yet applied.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">:policyfile_loaded</code></td> <td>The policy file was loaded.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">:cookbook_resolution_start</code></td> <td>The chef-client is attempting to pull down the cookbook collection from the Chef server.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">:cookbook_resolution_failed</code></td> <td>The chef-client failed to pull down the cookbook collection from the Chef server.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">:cookbook_resolution_complete</code></td> <td>The chef-client successfully pulled down the cookbook collection from the Chef server.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">:cookbook_clean_start</code></td> <td>The chef-client is attempting to remove unneeded cookbooks.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">:removed_cookbook_file</code></td> <td>The chef-client removed a file from a cookbook.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">:cookbook_clean_complete</code></td> <td>The chef-client is done removing cookbooks and/or cookbook files.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">:cookbook_sync_start</code></td> <td>The chef-client is attempting to synchronize cookbooks.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">:synchronized_cookbook</code></td> <td>The chef-client is attempting to synchronize the named cookbook.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">:updated_cookbook_file</code></td> <td>The chef-client updated the named file in the named cookbook.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">:cookbook_sync_failed</code></td> <td>The chef-client was unable to synchronize cookbooks.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">:cookbook_sync_complete</code></td> <td>The chef-client is finished synchronizing cookbooks.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">:library_load_start</code></td> <td>The chef-client is loading library files.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">:library_file_loaded</code></td> <td>The chef-client successfully loaded the named library file.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">:library_file_load_failed</code></td> <td>The chef-client was unable to load the named library file.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">:library_load_complete</code></td> <td>The chef-client is finished loading library files.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">:lwrp_load_start</code></td> <td>The chef-client is loading custom resources.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">:lwrp_file_loaded</code></td> <td>The chef-client successfully loaded the named custom resource.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">:lwrp_file_load_failed</code></td> <td>The chef-client was unable to load the named custom resource.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">:lwrp_load_complete</code></td> <td>The chef-client is finished loading custom resources.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">:attribute_load_start</code></td> <td>The chef-client is loading attribute files.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">:attribute_file_loaded</code></td> <td>The chef-client successfully loaded the named attribute file.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">:attribute_file_load_failed</code></td> <td>The chef-client was unable to load the named attribute file.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">:attribute_load_complete</code></td> <td>The chef-client is finished loading attribute files.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">:definition_load_start</code></td> <td>The chef-client is loading definitions.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">:definition_file_loaded</code></td> <td>The chef-client successfully loaded the named definition.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">:definition_file_load_failed</code></td> <td>The chef-client was unable to load the named definition.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">:definition_load_complete</code></td> <td>The chef-client is finished loading definitions.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">:recipe_load_start</code></td> <td>The chef-client is loading recipes.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">:recipe_file_loaded</code></td> <td>The chef-client successfully loaded the named recipe.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">:recipe_file_load_failed</code></td> <td>The chef-client was unable to load the named recipe.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">:recipe_not_found</code></td> <td>The chef-client was unable to find the named recipe.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">:recipe_load_complete</code></td> <td>The chef-client is finished loading recipes.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">:converge_start</code></td> <td>The chef-client run converge phase has started.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">:converge_complete</code></td> <td>The chef-client run converge phase is complete.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">:converge_failed</code></td> <td>The chef-client run converge phase has failed.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">:audit_phase_start</code></td> <td>The chef-client run audit phase has started.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">:audit_phase_complete</code></td> <td>The chef-client run audit phase is finished.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">:audit_phase_failed</code></td> <td>The chef-client run audit phase has failed.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">:control_group_started</code></td> <td>The named control group is being processed.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">:control_example_success</code></td> <td>The named control group has been processed.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">:control_example_failure</code></td> <td>The named control group’s processing has failed.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">:resource_action_start</code></td> <td>A resource action is starting.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">:resource_skipped</code></td> <td>A resource action was skipped.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">:resource_current_state_loaded</code></td> <td>A resource’s current state was loaded.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">:resource_current_state_load_bypassed</code></td> <td>A resource’s current state was not loaded because the resource does not support why-run mode.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">:resource_bypassed</code></td> <td>A resource action was skipped because the resource does not support why-run mode.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">:resource_update_applied</code></td> <td>A change has been made to a resource. (This event occurs for each change made to a resource.)</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">:resource_failed_retriable</code></td> <td>A resource action has failed and will be retried.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">:resource_failed</code></td> <td>A resource action has failed and will not be retried.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">:resource_updated</code></td> <td>A resource requires modification.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">:resource_up_to_date</code></td> <td>A resource is already correct.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">:resource_completed</code></td> <td>All actions for the resource are complete.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">:stream_opened</code></td> <td>A stream has opened.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">:stream_closed</code></td> <td>A stream has closed.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">:stream_output</code></td> <td>A chunk of data from a single named stream.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">:handlers_start</code></td> <td>The handler processing phase of the chef-client run has started.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">:handler_executed</code></td> <td>The named handler was processed.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">:handlers_completed</code></td> <td>The handler processing phase of the chef-client run is complete.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">:provider_requirement_failed</code></td> <td>An assertion declared by a provider has failed.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">:whyrun_assumption</code></td> <td>An assertion declared by a provider has failed, but execution is allowed to continue because the chef-client is running in why-run mode.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">:run_completed</code></td> <td>The chef-client run has completed.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">:run_failed</code></td> <td>The chef-client run has failed.</td> </tr> </tbody> </table>   <h3 id="id11">Examples</h3> <p>The following examples show ways to use the Handler DSL.</p>  <h4 id="send-email">Send Email</h4> <p>Use the <code class="docutils literal">on</code> method to create an event handler that sends email when the chef-client run fails. This will require:</p> <ul class="simple"> <li>A way to tell the chef-client how to send email</li> <li>An event handler that describes what to do when the <code class="docutils literal">:run_failed</code> event is triggered</li> <li>A way to trigger the exception and test the behavior of the event handler</li> </ul> <p><strong>Define How Email is Sent</strong></p> <p>Use a library to define the code that sends email when a chef-client run fails. Name the file <code class="docutils literal">helper.rb</code> and add it to a cookbook’s <code class="docutils literal">/libraries</code> directory:</p> <pre class="highlight-ruby" data-language="ruby">require 'net/smtp'

module HandlerSendEmail
  class Helper

    def send_email_on_run_failure(node_name)

      message = "From: Chef &lt;chef@chef.io&gt;\n"
      message &lt;&lt; "To: Grant &lt;grantmc@chef.io&gt;\n"
      message &lt;&lt; "Subject: Chef run failed\n"
      message &lt;&lt; "Date: #{Time.now.rfc2822}\n\n"
      message &lt;&lt; "Chef run failed on #{node_name}\n"
      Net::SMTP.start('localhost', 25) do |smtp|
        smtp.send_message message, 'chef@chef.io', 'grantmc@chef.io'
      end
    end
  end
end</pre> <p><strong>Add the Handler</strong></p> <p>Invoke the library helper in a recipe:</p> <pre class="highlight-ruby" data-language="ruby">Chef.event_handler do
  on :run_failed do
    HandlerSendEmail::Helper.new.send_email_on_run_failure(
      Chef.run_context.node.name
    )
  end
end</pre> <ul class="simple"> <li>Use <code class="docutils literal">Chef.event_handler</code> to define the event handler</li> <li>Use the <code class="docutils literal">on</code> method to specify the event type</li> </ul> <p>Within the <code class="docutils literal">on</code> block, tell the chef-client how to handle the event when it’s triggered.</p> <p><strong>Test the Handler</strong></p> <p>Use the following code block to trigger the exception and have the chef-client send email to the specified email address:</p> <pre class="highlight-ruby" data-language="ruby">ruby_block 'fail the run' do
  block do
    fail 'deliberately fail the run'
  end
end</pre>   <h4 id="etcd-locks">etcd Locks</h4> <p>The following example shows how to prevent concurrent chef-client runs from both holding a lock on etcd:</p> <pre class="highlight-ruby" data-language="ruby">lock_key = "#{node.chef_environment}/#{node.name}"

Chef.event_handler do
  on :converge_start do |run_context|
    Etcd.lock_acquire(lock_key)
  end
end

Chef.event_handler do
  on :converge_complete do
    Etcd.lock_release(lock_key)
  end
end</pre>   <h4 id="hipchat-notifications">HipChat Notifications</h4> <p>Event messages can be sent to a team communication tool like HipChat. For example, if a chef-client run fails:</p> <pre class="highlight-ruby" data-language="ruby">Chef.event_handler do
  on :run_failed do |exception|
    hipchat_notify exception.message
  end
end</pre> <p>or send an alert on a configuration change:</p> <pre class="highlight-ruby" data-language="ruby">Chef.event_handler do
  on :resource_updated do |resource, action|
    if resource.to_s == 'template[/etc/nginx/nginx.conf]'
      Helper.hipchat_message("#{resource} was updated by chef")
    end
  end
end</pre>     <h2 id="windows-platform">Windows Platform</h2> <p>Six methods are present in the Recipe DSL to help verify the registry during a chef-client run on the Microsoft Windows platform—<code class="docutils literal">registry_data_exists?</code>, <code class="docutils literal">registry_get_subkeys</code>, <code class="docutils literal">registry_get_values</code>, <code class="docutils literal">registry_has_subkeys?</code>, <code class="docutils literal">registry_key_exists?</code>, and <code class="docutils literal">registry_value_exists?</code>—these helpers ensure the <strong>powershell_script</strong> resource is idempotent.</p> <div class="admonition note"> <p class="first admonition-title">Note</p> <p class="last">The recommended order in which registry key-specific methods should be used within a recipe is: <code class="docutils literal">key_exists?</code>, <code class="docutils literal">value_exists?</code>, <code class="docutils literal">data_exists?</code>, <code class="docutils literal">get_values</code>, <code class="docutils literal">has_subkeys?</code>, and then <code class="docutils literal">get_subkeys</code>.</p> </div>  <h3>registry_data_exists?</h3> <p>Use the <code class="docutils literal">registry_data_exists?</code> method to find out if a Microsoft Windows registry key contains the specified data of the specified type under the value.</p> <div class="admonition note"> <p class="first admonition-title">Note</p> <p class="last">This method can be used in recipes and from within the <code class="docutils literal">not_if</code> and <code class="docutils literal">only_if</code> blocks in resources. This method is not designed to create or modify a registry key. If a registry key needs to be modified, use the <strong>registry_key</strong> resource.</p> </div> <p>The syntax for the <code class="docutils literal">registry_data_exists?</code> method is as follows:</p> <pre class="highlight-ruby" data-language="ruby">registry_data_exists?(
  KEY_PATH,
  { :name =&gt; 'NAME', :type =&gt; TYPE, :data =&gt; DATA },
  ARCHITECTURE
)</pre> <p>where:</p> <ul class="simple"> <li>
<code class="docutils literal">KEY_PATH</code> is the path to the registry key value. The path must include the registry hive, which can be specified either as its full name or as the 3- or 4-letter abbreviation. For example, both <code class="docutils literal">HKLM\SECURITY</code> and <code class="docutils literal">HKEY_LOCAL_MACHINE\SECURITY</code> are both valid and equivalent. The following hives are valid: <code class="docutils literal">HKEY_LOCAL_MACHINE</code>, <code class="docutils literal">HKLM</code>, <code class="docutils literal">HKEY_CURRENT_CONFIG</code>, <code class="docutils literal">HKCC</code>, <code class="docutils literal">HKEY_CLASSES_ROOT</code>, <code class="docutils literal">HKCR</code>, <code class="docutils literal">HKEY_USERS</code>, <code class="docutils literal">HKU</code>, <code class="docutils literal">HKEY_CURRENT_USER</code>, and <code class="docutils literal">HKCU</code>.</li> <li>
<code class="docutils literal">{ :name =&gt; 'NAME', :type =&gt; TYPE, :data =&gt; DATA }</code> is a hash that contains the expected name, type, and data of the registry key value</li> <li>
<code class="docutils literal">:type</code> represents the values available for registry keys in Microsoft Windows. Use <code class="docutils literal">:binary</code> for REG_BINARY, <code class="docutils literal">:string</code> for REG_SZ, <code class="docutils literal">:multi_string</code> for REG_MULTI_SZ, <code class="docutils literal">:expand_string</code> for REG_EXPAND_SZ, <code class="docutils literal">:dword</code> for REG_DWORD, <code class="docutils literal">:dword_big_endian</code> for REG_DWORD_BIG_ENDIAN, or <code class="docutils literal">:qword</code> for REG_QWORD.</li> <li>
<code class="docutils literal">ARCHITECTURE</code> is one of the following values: <code class="docutils literal">:x86_64</code>, <code class="docutils literal">:i386</code>, or <code class="docutils literal">:machine</code>. In order to read or write 32-bit registry keys on 64-bit machines running Microsoft Windows, the <code class="docutils literal">architecture</code> property must be set to <code class="docutils literal">:i386</code>. The <code class="docutils literal">:x86_64</code> value can be used to force writing to a 64-bit registry location, but this value is less useful than the default (<code class="docutils literal">:machine</code>) because the chef-client returns an exception if <code class="docutils literal">:x86_64</code> is used and the machine turns out to be a 32-bit machine (whereas with <code class="docutils literal">:machine</code>, the chef-client is able to access the registry key on the 32-bit machine).</li> </ul> <p>This method will return <code class="docutils literal">true</code> or <code class="docutils literal">false</code>.</p> <div class="admonition note"> <p class="first admonition-title">Note</p> <p class="last">The <code class="docutils literal">ARCHITECTURE</code> attribute should only specify <code class="docutils literal">:x86_64</code> or <code class="docutils literal">:i386</code> when it is necessary to write 32-bit (<code class="docutils literal">:i386</code>) or 64-bit (<code class="docutils literal">:x86_64</code>) values on a 64-bit machine. <code class="docutils literal">ARCHITECTURE</code> will default to <code class="docutils literal">:machine</code> unless a specific value is given.</p> </div>   <h3>registry_get_subkeys</h3> <p>Use the <code class="docutils literal">registry_get_subkeys</code> method to get a list of registry key values that are present for a Microsoft Windows registry key.</p> <div class="admonition note"> <p class="first admonition-title">Note</p> <p class="last">This method can be used in recipes and from within the <code class="docutils literal">not_if</code> and <code class="docutils literal">only_if</code> blocks in resources. This method is not designed to create or modify a registry key. If a registry key needs to be modified, use the <strong>registry_key</strong> resource.</p> </div> <p>The syntax for the <code class="docutils literal">registry_get_subkeys</code> method is as follows:</p> <pre class="highlight-ruby" data-language="ruby">subkey_array = registry_get_subkeys(KEY_PATH, ARCHITECTURE)</pre> <p>where:</p> <ul class="simple"> <li>
<code class="docutils literal">KEY_PATH</code> is the path to the registry key. The path must include the registry hive, which can be specified either as its full name or as the 3- or 4-letter abbreviation. For example, both <code class="docutils literal">HKLM\SECURITY</code> and <code class="docutils literal">HKEY_LOCAL_MACHINE\SECURITY</code> are both valid and equivalent. The following hives are valid: <code class="docutils literal">HKEY_LOCAL_MACHINE</code>, <code class="docutils literal">HKLM</code>, <code class="docutils literal">HKEY_CURRENT_CONFIG</code>, <code class="docutils literal">HKCC</code>, <code class="docutils literal">HKEY_CLASSES_ROOT</code>, <code class="docutils literal">HKCR</code>, <code class="docutils literal">HKEY_USERS</code>, <code class="docutils literal">HKU</code>, <code class="docutils literal">HKEY_CURRENT_USER</code>, and <code class="docutils literal">HKCU</code>.</li> <li>
<code class="docutils literal">ARCHITECTURE</code> is one of the following values: <code class="docutils literal">:x86_64</code>, <code class="docutils literal">:i386</code>, or <code class="docutils literal">:machine</code>. In order to read or write 32-bit registry keys on 64-bit machines running Microsoft Windows, the <code class="docutils literal">architecture</code> property must be set to <code class="docutils literal">:i386</code>. The <code class="docutils literal">:x86_64</code> value can be used to force writing to a 64-bit registry location, but this value is less useful than the default (<code class="docutils literal">:machine</code>) because the chef-client returns an exception if <code class="docutils literal">:x86_64</code> is used and the machine turns out to be a 32-bit machine (whereas with <code class="docutils literal">:machine</code>, the chef-client is able to access the registry key on the 32-bit machine).</li> </ul> <p>This returns an array of registry key values.</p> <div class="admonition note"> <p class="first admonition-title">Note</p> <p class="last">The <code class="docutils literal">ARCHITECTURE</code> attribute should only specify <code class="docutils literal">:x86_64</code> or <code class="docutils literal">:i386</code> when it is necessary to write 32-bit (<code class="docutils literal">:i386</code>) or 64-bit (<code class="docutils literal">:x86_64</code>) values on a 64-bit machine. <code class="docutils literal">ARCHITECTURE</code> will default to <code class="docutils literal">:machine</code> unless a specific value is given.</p> </div>   <h3>registry_get_values</h3> <p>Use the <code class="docutils literal">registry_get_values</code> method to get the registry key values (name, type, and data) for a Microsoft Windows registry key.</p> <div class="admonition note"> <p class="first admonition-title">Note</p> <p class="last">This method can be used in recipes and from within the <code class="docutils literal">not_if</code> and <code class="docutils literal">only_if</code> blocks in resources. This method is not designed to create or modify a registry key. If a registry key needs to be modified, use the <strong>registry_key</strong> resource.</p> </div> <p>The syntax for the <code class="docutils literal">registry_get_values</code> method is as follows:</p> <pre class="highlight-ruby" data-language="ruby">subkey_array = registry_get_values(KEY_PATH, ARCHITECTURE)</pre> <p>where:</p> <ul class="simple"> <li>
<code class="docutils literal">KEY_PATH</code> is the path to the registry key. The path must include the registry hive, which can be specified either as its full name or as the 3- or 4-letter abbreviation. For example, both <code class="docutils literal">HKLM\SECURITY</code> and <code class="docutils literal">HKEY_LOCAL_MACHINE\SECURITY</code> are both valid and equivalent. The following hives are valid: <code class="docutils literal">HKEY_LOCAL_MACHINE</code>, <code class="docutils literal">HKLM</code>, <code class="docutils literal">HKEY_CURRENT_CONFIG</code>, <code class="docutils literal">HKCC</code>, <code class="docutils literal">HKEY_CLASSES_ROOT</code>, <code class="docutils literal">HKCR</code>, <code class="docutils literal">HKEY_USERS</code>, <code class="docutils literal">HKU</code>, <code class="docutils literal">HKEY_CURRENT_USER</code>, and <code class="docutils literal">HKCU</code>.</li> <li>
<code class="docutils literal">ARCHITECTURE</code> is one of the following values: <code class="docutils literal">:x86_64</code>, <code class="docutils literal">:i386</code>, or <code class="docutils literal">:machine</code>. In order to read or write 32-bit registry keys on 64-bit machines running Microsoft Windows, the <code class="docutils literal">architecture</code> property must be set to <code class="docutils literal">:i386</code>. The <code class="docutils literal">:x86_64</code> value can be used to force writing to a 64-bit registry location, but this value is less useful than the default (<code class="docutils literal">:machine</code>) because the chef-client returns an exception if <code class="docutils literal">:x86_64</code> is used and the machine turns out to be a 32-bit machine (whereas with <code class="docutils literal">:machine</code>, the chef-client is able to access the registry key on the 32-bit machine).</li> </ul> <p>This returns an array of registry key values.</p> <div class="admonition note"> <p class="first admonition-title">Note</p> <p class="last">The <code class="docutils literal">ARCHITECTURE</code> attribute should only specify <code class="docutils literal">:x86_64</code> or <code class="docutils literal">:i386</code> when it is necessary to write 32-bit (<code class="docutils literal">:i386</code>) or 64-bit (<code class="docutils literal">:x86_64</code>) values on a 64-bit machine. <code class="docutils literal">ARCHITECTURE</code> will default to <code class="docutils literal">:machine</code> unless a specific value is given.</p> </div>   <h3>registry_has_subkeys?</h3> <p>Use the <code class="docutils literal">registry_has_subkeys?</code> method to find out if a Microsoft Windows registry key has one (or more) values.</p> <div class="admonition note"> <p class="first admonition-title">Note</p> <p class="last">This method can be used in recipes and from within the <code class="docutils literal">not_if</code> and <code class="docutils literal">only_if</code> blocks in resources. This method is not designed to create or modify a registry key. If a registry key needs to be modified, use the <strong>registry_key</strong> resource.</p> </div> <p>The syntax for the <code class="docutils literal">registry_has_subkeys?</code> method is as follows:</p> <pre class="highlight-ruby" data-language="ruby">registry_has_subkeys?(KEY_PATH, ARCHITECTURE)</pre> <p>where:</p> <ul class="simple"> <li>
<code class="docutils literal">KEY_PATH</code> is the path to the registry key. The path must include the registry hive, which can be specified either as its full name or as the 3- or 4-letter abbreviation. For example, both <code class="docutils literal">HKLM\SECURITY</code> and <code class="docutils literal">HKEY_LOCAL_MACHINE\SECURITY</code> are both valid and equivalent. The following hives are valid: <code class="docutils literal">HKEY_LOCAL_MACHINE</code>, <code class="docutils literal">HKLM</code>, <code class="docutils literal">HKEY_CURRENT_CONFIG</code>, <code class="docutils literal">HKCC</code>, <code class="docutils literal">HKEY_CLASSES_ROOT</code>, <code class="docutils literal">HKCR</code>, <code class="docutils literal">HKEY_USERS</code>, <code class="docutils literal">HKU</code>, <code class="docutils literal">HKEY_CURRENT_USER</code>, and <code class="docutils literal">HKCU</code>.</li> <li>
<code class="docutils literal">ARCHITECTURE</code> is one of the following values: <code class="docutils literal">:x86_64</code>, <code class="docutils literal">:i386</code>, or <code class="docutils literal">:machine</code>. In order to read or write 32-bit registry keys on 64-bit machines running Microsoft Windows, the <code class="docutils literal">architecture</code> property must be set to <code class="docutils literal">:i386</code>. The <code class="docutils literal">:x86_64</code> value can be used to force writing to a 64-bit registry location, but this value is less useful than the default (<code class="docutils literal">:machine</code>) because the chef-client returns an exception if <code class="docutils literal">:x86_64</code> is used and the machine turns out to be a 32-bit machine (whereas with <code class="docutils literal">:machine</code>, the chef-client is able to access the registry key on the 32-bit machine).</li> </ul> <p>This method will return <code class="docutils literal">true</code> or <code class="docutils literal">false</code>.</p> <div class="admonition note"> <p class="first admonition-title">Note</p> <p class="last">The <code class="docutils literal">ARCHITECTURE</code> attribute should only specify <code class="docutils literal">:x86_64</code> or <code class="docutils literal">:i386</code> when it is necessary to write 32-bit (<code class="docutils literal">:i386</code>) or 64-bit (<code class="docutils literal">:x86_64</code>) values on a 64-bit machine. <code class="docutils literal">ARCHITECTURE</code> will default to <code class="docutils literal">:machine</code> unless a specific value is given.</p> </div>   <h3>registry_key_exists?</h3> <p>Use the <code class="docutils literal">registry_key_exists?</code> method to find out if a Microsoft Windows registry key exists at the specified path.</p> <div class="admonition note"> <p class="first admonition-title">Note</p> <p class="last">This method can be used in recipes and from within the <code class="docutils literal">not_if</code> and <code class="docutils literal">only_if</code> blocks in resources. This method is not designed to create or modify a registry key. If a registry key needs to be modified, use the <strong>registry_key</strong> resource.</p> </div> <p>The syntax for the <code class="docutils literal">registry_key_exists?</code> method is as follows:</p> <pre class="highlight-ruby" data-language="ruby">registry_key_exists?(KEY_PATH, ARCHITECTURE)</pre> <p>where:</p> <ul class="simple"> <li>
<code class="docutils literal">KEY_PATH</code> is the path to the registry key. The path must include the registry hive, which can be specified either as its full name or as the 3- or 4-letter abbreviation. For example, both <code class="docutils literal">HKLM\SECURITY</code> and <code class="docutils literal">HKEY_LOCAL_MACHINE\SECURITY</code> are both valid and equivalent. The following hives are valid: <code class="docutils literal">HKEY_LOCAL_MACHINE</code>, <code class="docutils literal">HKLM</code>, <code class="docutils literal">HKEY_CURRENT_CONFIG</code>, <code class="docutils literal">HKCC</code>, <code class="docutils literal">HKEY_CLASSES_ROOT</code>, <code class="docutils literal">HKCR</code>, <code class="docutils literal">HKEY_USERS</code>, <code class="docutils literal">HKU</code>, <code class="docutils literal">HKEY_CURRENT_USER</code>, and <code class="docutils literal">HKCU</code>.</li> <li>
<code class="docutils literal">ARCHITECTURE</code> is one of the following values: <code class="docutils literal">:x86_64</code>, <code class="docutils literal">:i386</code>, or <code class="docutils literal">:machine</code>. In order to read or write 32-bit registry keys on 64-bit machines running Microsoft Windows, the <code class="docutils literal">architecture</code> property must be set to <code class="docutils literal">:i386</code>. The <code class="docutils literal">:x86_64</code> value can be used to force writing to a 64-bit registry location, but this value is less useful than the default (<code class="docutils literal">:machine</code>) because the chef-client returns an exception if <code class="docutils literal">:x86_64</code> is used and the machine turns out to be a 32-bit machine (whereas with <code class="docutils literal">:machine</code>, the chef-client is able to access the registry key on the 32-bit machine).</li> </ul> <p>This method will return <code class="docutils literal">true</code> or <code class="docutils literal">false</code>. (Any registry key values that are associated with this registry key are ignored.)</p> <div class="admonition note"> <p class="first admonition-title">Note</p> <p class="last">The <code class="docutils literal">ARCHITECTURE</code> attribute should only specify <code class="docutils literal">:x86_64</code> or <code class="docutils literal">:i386</code> when it is necessary to write 32-bit (<code class="docutils literal">:i386</code>) or 64-bit (<code class="docutils literal">:x86_64</code>) values on a 64-bit machine. <code class="docutils literal">ARCHITECTURE</code> will default to <code class="docutils literal">:machine</code> unless a specific value is given.</p> </div>   <h3>registry_value_exists?</h3> <p>Use the <code class="docutils literal">registry_value_exists?</code> method to find out if a registry key value exists. Use <code class="docutils literal">registry_data_exists?</code> to test for the type and data of a registry key value.</p> <div class="admonition note"> <p class="first admonition-title">Note</p> <p class="last">This method can be used in recipes and from within the <code class="docutils literal">not_if</code> and <code class="docutils literal">only_if</code> blocks in resources. This method is not designed to create or modify a registry key. If a registry key needs to be modified, use the <strong>registry_key</strong> resource.</p> </div> <p>The syntax for the <code class="docutils literal">registry_value_exists?</code> method is as follows:</p> <pre class="highlight-ruby" data-language="ruby">registry_value_exists?(
  KEY_PATH,
  { :name =&gt; 'NAME' },
  ARCHITECTURE
)</pre> <p>where:</p> <ul class="simple"> <li>
<code class="docutils literal">KEY_PATH</code> is the path to the registry key. The path must include the registry hive, which can be specified either as its full name or as the 3- or 4-letter abbreviation. For example, both <code class="docutils literal">HKLM\SECURITY</code> and <code class="docutils literal">HKEY_LOCAL_MACHINE\SECURITY</code> are both valid and equivalent. The following hives are valid: <code class="docutils literal">HKEY_LOCAL_MACHINE</code>, <code class="docutils literal">HKLM</code>, <code class="docutils literal">HKEY_CURRENT_CONFIG</code>, <code class="docutils literal">HKCC</code>, <code class="docutils literal">HKEY_CLASSES_ROOT</code>, <code class="docutils literal">HKCR</code>, <code class="docutils literal">HKEY_USERS</code>, <code class="docutils literal">HKU</code>, <code class="docutils literal">HKEY_CURRENT_USER</code>, and <code class="docutils literal">HKCU</code>.</li> <li>
<code class="docutils literal">{ :name =&gt; 'NAME' }</code> is a hash that contains the name of the registry key value; if either <code class="docutils literal">:type</code> or <code class="docutils literal">:value</code> are specified in the hash, they are ignored</li> <li>
<code class="docutils literal">:type</code> represents the values available for registry keys in Microsoft Windows. Use <code class="docutils literal">:binary</code> for REG_BINARY, <code class="docutils literal">:string</code> for REG_SZ, <code class="docutils literal">:multi_string</code> for REG_MULTI_SZ, <code class="docutils literal">:expand_string</code> for REG_EXPAND_SZ, <code class="docutils literal">:dword</code> for REG_DWORD, <code class="docutils literal">:dword_big_endian</code> for REG_DWORD_BIG_ENDIAN, or <code class="docutils literal">:qword</code> for REG_QWORD.</li> <li>
<code class="docutils literal">ARCHITECTURE</code> is one of the following values: <code class="docutils literal">:x86_64</code>, <code class="docutils literal">:i386</code>, or <code class="docutils literal">:machine</code>. In order to read or write 32-bit registry keys on 64-bit machines running Microsoft Windows, the <code class="docutils literal">architecture</code> property must be set to <code class="docutils literal">:i386</code>. The <code class="docutils literal">:x86_64</code> value can be used to force writing to a 64-bit registry location, but this value is less useful than the default (<code class="docutils literal">:machine</code>) because the chef-client returns an exception if <code class="docutils literal">:x86_64</code> is used and the machine turns out to be a 32-bit machine (whereas with <code class="docutils literal">:machine</code>, the chef-client is able to access the registry key on the 32-bit machine).</li> </ul> <p>This method will return <code class="docutils literal">true</code> or <code class="docutils literal">false</code>.</p> <div class="admonition note"> <p class="first admonition-title">Note</p> <p class="last">The <code class="docutils literal">ARCHITECTURE</code> attribute should only specify <code class="docutils literal">:x86_64</code> or <code class="docutils literal">:i386</code> when it is necessary to write 32-bit (<code class="docutils literal">:i386</code>) or 64-bit (<code class="docutils literal">:x86_64</code>) values on a 64-bit machine. <code class="docutils literal">ARCHITECTURE</code> will default to <code class="docutils literal">:machine</code> unless a specific value is given.</p> </div>   <h3>Helpers</h3> <p>A recipe can define specific behaviors for specific Microsoft Windows platform versions by using a series of helper methods. To enable these helper methods, add the following to a recipe:</p> <pre class="highlight-ruby" data-language="ruby">require 'chef/win32/version'</pre> <p>Then declare a variable using the <code class="docutils literal">Chef::ReservedNames::Win32::Version</code> class:</p> <pre class="highlight-ruby" data-language="ruby">variable_name = Chef::ReservedNames::Win32::Version.new</pre> <p>And then use this variable to define specific behaviors for specific Microsoft Windows platform versions. For example:</p> <pre class="highlight-ruby" data-language="ruby">if variable_name.helper_name?
  # Ruby code goes here, such as
  resource_name do
    # resource block
  end

elsif variable_name.helper_name?
  # Ruby code goes here
  resource_name do
    # resource block for something else
  end

else variable_name.helper_name?
  # Ruby code goes here, such as
  log 'log entry' do
    level :level
  end

end</pre> <p>The following Microsoft Windows platform-specific helpers can be used in recipes:</p> <table class="docutils"> <colgroup> <col width="40%"> <col width="60%"> </colgroup> <thead valign="bottom"> <tr class="row-odd">
<th class="head">Helper</th> <th class="head">Description</th> </tr> </thead> <tbody valign="top"> <tr class="row-even">
<td><code class="docutils literal">cluster?</code></td> <td>Use to test for a Cluster SKU (Windows Server 2003 and later).</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">core?</code></td> <td>Use to test for a Core SKU (Windows Server 2003 and later).</td> </tr> <tr class="row-even">
<td><code class="docutils literal">datacenter?</code></td> <td>Use to test for a Datacenter SKU.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">marketing_name</code></td> <td>Use to display the marketing name for a Microsoft Windows platform.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">windows_7?</code></td> <td>Use to test for Windows 7.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">windows_8?</code></td> <td>Use to test for Windows 8.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">windows_8_1?</code></td> <td>Use to test for Windows 8.1.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">windows_2000?</code></td> <td>Use to test for Windows 2000.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">windows_home_server?</code></td> <td>Use to test for Windows Home Server.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">windows_server_2003?</code></td> <td>Use to test for Windows Server 2003.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">windows_server_2003_r2?</code></td> <td>Use to test for Windows Server 2003 R2.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">windows_server_2008?</code></td> <td>Use to test for Windows Server 2008.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">windows_server_2008_r2?</code></td> <td>Use to test for Windows Server 2008 R2.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">windows_server_2012?</code></td> <td>Use to test for Windows Server 2012.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">windows_server_2012_r2?</code></td> <td>Use to test for Windows Server 2012 R2.</td> </tr> <tr class="row-odd">
<td><code class="docutils literal">windows_vista?</code></td> <td>Use to test for Windows Vista.</td> </tr> <tr class="row-even">
<td><code class="docutils literal">windows_xp?</code></td> <td>Use to test for Windows XP.</td> </tr> </tbody> </table> <p>The following example installs Windows PowerShell 2.0 on systems that do not already have it installed. Microsoft Windows platform helper methods are used to define specific behaviors for specific platform versions:</p> <pre class="highlight-ruby" data-language="ruby">case node['platform']
when 'windows'

  require 'chef/win32/version'
  windows_version = Chef::ReservedNames::Win32::Version.new

  if (windows_version.windows_server_2008_r2? || windows_version.windows_7?) &amp;&amp; windows_version.core?

    windows_feature 'NetFx2-ServerCore' do
      action :install
    end
    windows_feature 'NetFx2-ServerCore-WOW64' do
      action :install
      only_if { node['kernel']['machine'] == 'x86_64' }
    end

  elsif windows_version.windows_server_2008? || windows_version.windows_server_2003_r2? ||
      windows_version.windows_server_2003? || windows_version.windows_xp?

    if windows_version.windows_server_2008?
      windows_feature 'NET-Framework-Core' do
        action :install
      end

    else
      windows_package 'Microsoft .NET Framework 2.0 Service Pack 2' do
        source node['ms_dotnet2']['url']
        checksum node['ms_dotnet2']['checksum']
        installer_type :custom
        options '/quiet /norestart'
        action :install
      end
    end
  else
    log '.NET Framework 2.0 is already enabled on this version of Windows' do
      level :warn
    end
  end
else
  log '.NET Framework 2.0 cannot be installed on platforms other than Windows' do
    level :warn
  end
end</pre> <p>The previous example is from the <a class="reference external" href="https://github.com/juliandunn/ms_dotnet2">ms_dotnet2 cookbook</a>, created by community member <code class="docutils literal">juliandunn</code>.</p>
<div class="_attribution">
  <p class="_attribution-p">
    © Chef Software, Inc.<br>Licensed under the Creative Commons Attribution 3.0 Unported License.<br>The Chef™ Mark and Chef Logo are either registered trademarks/service marks or trademarks/servicemarks of Chef, in the United States and other countries and are used with Chef Inc's permission.<br>We are not affiliated with, endorsed or sponsored by Chef Inc.<br>
    <a href="https://docs-archive.chef.io/release/12-13/dsl_recipe.html" class="_attribution-link">https://docs-archive.chef.io/release/12-13/dsl_recipe.html</a>
  </p>
</div>

				
			</div>
			<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-2572770204602497"
     data-ad-slot="1992473792"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
		</div>
	</section>

	</div>
	<svg style="display:none">
		<symbol id="icon-dir"><svg viewBox="0 0 20 20"><path d="M15 10c0 .3-.305.515-.305.515l-8.56 5.303c-.625.41-1.135.106-1.135-.67V4.853c0-.777.51-1.078 1.135-.67l8.56 5.305S15 9.702 15 10z"/></svg></symbol>
	  </svg>
</body>
</html>
