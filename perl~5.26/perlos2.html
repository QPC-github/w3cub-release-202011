
<!DOCTYPE HTML>

<html lang="en" class="_theme-default">

<head>
  <meta charset="utf-8">
  <title>Perlos2 - Perl 5.26 - W3cubDocs</title>
  
  <meta name="description" content=" perlos2 - Perl under OS&#47;2, DOS, Win0.3&#42;, Win0.95 and WinNT. ">
  <meta name="keywords" content="perlos, perl, perl~5.26">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="mobile-web-app-capable" content="yes">
  
  <link rel="canonical" href="https://docs.w3cub.com/perl~5.26/perlos2.html">
  <link href="/favicon.png" rel="icon">
  <link rel="stylesheet" type="text/css" href="/assets/application-e4ebd3a2a5652ff55173659804c4390a004917f3bdd17b5bb3ba78ea5c9c46fe181cadaac34517ccd815f5bdc982bbfe67179d6f4ac2f084ef2265e2a3dc8dc5.css" integrity="sha512-5OvToqVlL/VRc2WYBMQ5CgBJF/O90Xtbs7p46lycRv4YHK2qw0UXzNgV9b3Jgrv+Zxedb0rC8ITvImXio9yNxQ==" crossorigin="anonymous">
  <script type="text/javascript" integrity="sha512-EpkDeu98lN/jPKijllzVWdRg/dUSSMCaldYZNFz6bcNoBvpWRNz0HSTRQJ3ENmQc5Cuj1zDW1vHd7b0DzpOgyA==" crossorigin="anonymous" src="/assets/application-1299037aef7c94dfe33ca8a3965cd559d460fdd51248c09a95d619345cfa6dc36806fa5644dcf41d24d1409dc436641ce42ba3d730d6d6f1ddedbd03ce93a0c8.js"></script>
  <script src="/json/perl~5.26.js"></script>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-71174418-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>
  <script data-ad-client="ca-pub-2572770204602497" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script async custom-element="amp-auto-ads"
  src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
</script>


</head>

<body>
	<amp-auto-ads type="adsense"
              data-ad-client="ca-pub-2572770204602497">
	</amp-auto-ads>
	<div class="_app">
	<header class="_header">
  
  <form class="_search">
    <input type="search" class="_search-input" placeholder="Search&hellip;" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" maxlength="20">
    <a class="_search-clear"></a>
    <div class="_search-tag"></div>
  </form>
  
  <a class="_home-link" href="/" ></a>
  <a class="_menu-link"></a>
  <h1 class="_logo">
    <a href="/" class="_nav-link" title="API Documentation Browser">W3cubDocs</a>
  </h1>
  
  <span class="_logo-sub-nav">/</span><span class="_logo-sub-nav"><a href="/perl~5.26/" class="_nav-link" title="" style="margin-left:0;">Perl 5.26</a></span>
  
  <nav class="_nav">
    <a href="https://tools.w3cub.com/?_sp=docs" target="_blank" class="_nav-link ">W3cubTools</a>
    <a href="/cheatsheets/" class="_nav-link ">Cheatsheets</a>
    <a href="/about/" class="_nav-link ">About</a>
  </nav>
</header>
	<section class="_sidebar">
		<div class="_list-wrap">
			<div class="_list">
			
			</div>
		</div>
	</section>
	<section class="_container ">
		<div class="_content">
			<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-2572770204602497"
     data-ad-slot="6861657091"
     data-ad-format="link"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
			<div class="_page _perl">
				
				
<h1>perlos2</h1>  <ul>
<li><a href="#NAME">NAME</a></li>
<li><a href="#SYNOPSIS">SYNOPSIS</a></li>
<li>
<a href="#DESCRIPTION">DESCRIPTION</a><ul>
<li><a href="#Target">Target</a></li>
<li><a href="#Other-OSes">Other OSes</a></li>
<li><a href="#Prerequisites">Prerequisites</a></li>
<li><a href="#Starting-Perl-programs-under-OS%2f2-(and-DOS-and...)">Starting Perl programs under OS/2 (and DOS and...)</a></li>
<li><a href="#Starting-OS%2f2-(and-DOS)-programs-under-Perl">Starting OS/2 (and DOS) programs under Perl</a></li>
</ul>
</li>
<li>
<a href="#Frequently-asked-questions">Frequently asked questions</a><ul>
<li><a href="#%22It-does-not-work%22">"It does not work"</a></li>
<li><a href="#I-cannot-run-external-programs">I cannot run external programs</a></li>
<li><a href="#I-cannot-embed-perl-into-my-program%2c-or-use-_perl.dll_-from-my-program.">I cannot embed perl into my program, or use _perl.dll_ from my program.</a></li>
<li><a href="#%60%60-and-pipe-open-do-not-work-under-DOS.">`` and pipe-open do not work under DOS.</a></li>
<li><a href="#Cannot-start-find.exe-%22pattern%22-file">Cannot start find.exe "pattern" file</a></li>
</ul>
</li>
<li>
<a href="#INSTALLATION">INSTALLATION</a><ul>
<li><a href="#Automatic-binary-installation">Automatic binary installation</a></li>
<li><a href="#Manual-binary-installation">Manual binary installation</a></li>
<li><a href="#*Warning*">*Warning*</a></li>
</ul>
</li>
<li>
<a href="#Accessing-documentation">Accessing documentation</a><ul>
<li><a href="#OS%2f2-_.INF_-file">OS/2 _.INF_ file</a></li>
<li><a href="#Plain-text">Plain text</a></li>
<li><a href="#Manpages">Manpages</a></li>
<li><a href="#HTML">HTML</a></li>
<li><a href="#GNU-info-files">GNU info files</a></li>
<li><a href="#_PDF_-files">_PDF_ files</a></li>
<li><a href="#LaTeX-docs">LaTeX docs</a></li>
</ul>
</li>
<li>
<a href="#BUILD">BUILD</a><ul>
<li><a href="#The-short-story">The short story</a></li>
<li><a href="#Prerequisites">Prerequisites</a></li>
<li><a href="#Getting-perl-source">Getting perl source</a></li>
<li><a href="#Application-of-the-patches">Application of the patches</a></li>
<li><a href="#Hand-editing">Hand-editing</a></li>
<li><a href="#Making">Making</a></li>
<li><a href="#Testing">Testing</a></li>
<li><a href="#Installing-the-built-perl">Installing the built perl</a></li>
<li><a href="#a.out-style-build">a.out-style build</a></li>
</ul>
</li>
<li><a href="#Building-a-binary-distribution">Building a binary distribution</a></li>
<li>
<a href="#Building-custom-_.EXE_-files">Building custom _.EXE_ files</a><ul>
<li><a href="#Making-executables-with-a-custom-collection-of-statically-loaded-extensions">Making executables with a custom collection of statically loaded extensions</a></li>
<li><a href="#Making-executables-with-a-custom-search-paths">Making executables with a custom search-paths</a></li>
</ul>
</li>
<li>
<a href="#Build-FAQ">Build FAQ</a><ul>
<li><a href="#Some-%2f-became-%5c-in-pdksh.">Some / became \ in pdksh.</a></li>
<li><a href="#'errno'---unresolved-external">'errno' - unresolved external</a></li>
<li><a href="#Problems-with-tr-or-sed">Problems with tr or sed</a></li>
<li><a href="#Some-problem-(forget-which-%3b-)">Some problem (forget which ;-)</a></li>
<li><a href="#Library-...-not-found">Library ... not found</a></li>
<li><a href="#Segfault-in-make">Segfault in make</a></li>
<li><a href="#op%2fsprintf-test-failure">op/sprintf test failure</a></li>
</ul>
</li>
<li>
<a href="#Specific-(mis)features-of-OS%2f2-port">Specific (mis)features of OS/2 port</a><ul>
<li><a href="#setpriority%2c-getpriority">setpriority, getpriority</a></li>
<li><a href="#system()">system()</a></li>
<li><a href="#extproc-on-the-first-line">extproc on the first line</a></li>
<li><a href="#Additional-modules%3a">Additional modules:</a></li>
<li><a href="#Prebuilt-methods%3a">Prebuilt methods:</a></li>
<li><a href="#Prebuilt-variables%3a">Prebuilt variables:</a></li>
<li><a href="#Misfeatures">Misfeatures</a></li>
<li><a href="#Modifications">Modifications</a></li>
<li><a href="#Identifying-DLLs">Identifying DLLs</a></li>
<li><a href="#Centralized-management-of-resources">Centralized management of resources</a></li>
</ul>
</li>
<li>
<a href="#Perl-flavors">Perl flavors</a><ul>
<li><a href="#_perl.exe_">_perl.exe_</a></li>
<li><a href="#_perl_.exe_">_perl_.exe_</a></li>
<li><a href="#_perl__.exe_">_perl__.exe_</a></li>
<li><a href="#_perl___.exe_">_perl___.exe_</a></li>
<li><a href="#Why-strange-names%3f">Why strange names?</a></li>
<li><a href="#Why-dynamic-linking%3f">Why dynamic linking?</a></li>
<li><a href="#Why-chimera-build%3f">Why chimera build?</a></li>
</ul>
</li>
<li>
<a href="#ENVIRONMENT">ENVIRONMENT</a><ul>
<li><a href="#PERLLIB_PREFIX">PERLLIB_PREFIX</a></li>
<li><a href="#PERL_BADLANG">PERL_BADLANG</a></li>
<li><a href="#PERL_BADFREE">PERL_BADFREE</a></li>
<li><a href="#PERL_SH_DIR">PERL_SH_DIR</a></li>
<li><a href="#USE_PERL_FLOCK">USE_PERL_FLOCK</a></li>
<li><a href="#TMP-or-TEMP">TMP or TEMP</a></li>
</ul>
</li>
<li>
<a href="#Evolution">Evolution</a><ul>
<li><a href="#Text-mode-filehandles">Text-mode filehandles</a></li>
<li><a href="#Priorities">Priorities</a></li>
<li><a href="#DLL-name-mangling%3a-pre-5.6.2">DLL name mangling: pre 5.6.2</a></li>
<li><a href="#DLL-name-mangling%3a-5.6.2-and-beyond">DLL name mangling: 5.6.2 and beyond</a></li>
<li><a href="#DLL-forwarder-generation">DLL forwarder generation</a></li>
<li><a href="#Threading">Threading</a></li>
<li><a href="#Calls-to-external-programs">Calls to external programs</a></li>
<li><a href="#Memory-allocation">Memory allocation</a></li>
<li><a href="#Threads">Threads</a></li>
</ul>
</li>
<li><a href="#BUGS">BUGS</a></li>
<li><a href="#AUTHOR">AUTHOR</a></li>
<li><a href="#SEE-ALSO">SEE ALSO</a></li>
</ul>
<h2 id="NAME">NAME</h2> <p>perlos2 - Perl under OS/2, DOS, Win0.3*, Win0.95 and WinNT.</p> <h2 id="SYNOPSIS">SYNOPSIS</h2> <p>One can read this document in the following formats:</p> <pre class="verbatim" data-language="perl">man perlos2
view perl perlos2
explorer perlos2.html
info perlos2
</pre>
<p>to list some (not all may be available simultaneously), or it may be read <i>as is</i>: either as <i>README.os2</i>, or <i>pod/perlos2.pod</i>.</p> <p>To read the <i>.INF</i> version of documentation (<b>very</b> recommended) outside of OS/2, one needs an IBM's reader (may be available on IBM ftp sites (?) (URL anyone?)) or shipped with PC DOS 7.0 and IBM's Visual Age C++ 3.5.</p> <p>A copy of a Win* viewer is contained in the "Just add OS/2 Warp" package</p> <pre class="verbatim" data-language="perl">ftp://ftp.software.ibm.com/ps/products/os2/tools/jaow/jaow.zip
</pre>
<p>in <i>?:\JUST_ADD\view.exe</i>. This gives one an access to EMX's <i>.INF</i> docs as well (text form is available in <i>/emx/doc</i> in EMX's distribution). There is also a different viewer named xview.</p> <p>Note that if you have <i>lynx.exe</i> or <i>netscape.exe</i> installed, you can follow WWW links from this document in <i>.INF</i> format. If you have EMX docs installed correctly, you can follow library links (you need to have <code class="inline"><span class="w">view</span> <span class="w">emxbook</span></code> working by setting <code class="inline"><span class="w">EMXBOOK</span></code> environment variable as it is described in EMX docs).</p> <h2 id="DESCRIPTION">DESCRIPTION</h2> <h3 id="Target">Target</h3> <p>The target is to make OS/2 one of the best supported platform for using/building/developing Perl and <i>Perl applications</i>, as well as make Perl the best language to use under OS/2. The secondary target is to try to make this work under DOS and Win* as well (but not <b>too</b> hard).</p> <p>The current state is quite close to this target. Known limitations:</p> <ul> <li> <p>Some *nix programs use fork() a lot; with the mostly useful flavors of perl for OS/2 (there are several built simultaneously) this is supported; but some flavors do not support this (e.g., when Perl is called from inside REXX). Using fork() after <i>use</i>ing dynamically loading extensions would not work with <i>very</i> old versions of EMX.</p> </li> <li> <p>You need a separate perl executable <i>perl__.exe</i> (see <a href="#perl__.exe">perl__.exe</a>) if you want to use PM code in your application (as Perl/Tk or OpenGL Perl modules do) without having a text-mode window present.</p> <p>While using the standard <i>perl.exe</i> from a text-mode window is possible too, I have seen cases when this causes degradation of the system stability. Using <i>perl__.exe</i> avoids such a degradation.</p> </li> <li> <p>There is no simple way to access WPS objects. The only way I know is via <code class="inline"><span class="w">OS2::REXX</span></code> and <code class="inline"><span class="w">SOM</span></code> extensions (see <a href="http://search.cpan.org/perldoc/OS2::REXX">OS2::REXX</a>, <a href="http://search.cpan.org/perldoc/SOM">SOM</a>). However, we do not have access to convenience methods of Object-REXX. (Is it possible at all? I know of no Object-REXX API.) The <code class="inline"><span class="w">SOM</span></code> extension (currently in alpha-text) may eventually remove this shortcoming; however, due to the fact that DII is not supported by the <code class="inline"><span class="w">SOM</span></code> module, using <code class="inline"><span class="w">SOM</span></code> is not as convenient as one would like it.</p> </li> </ul> <p>Please keep this list up-to-date by informing me about other items.</p> <h3 id="Other-OSes">Other OSes</h3> <p>Since OS/2 port of perl uses a remarkable EMX environment, it can run (and build extensions, and - possibly - be built itself) under any environment which can run EMX. The current list is DOS, DOS-inside-OS/2, Win0.3*, Win0.95 and WinNT. Out of many perl flavors, only one works, see <a href="#perl_.exe">perl_.exe</a>.</p> <p>Note that not all features of Perl are available under these environments. This depends on the features the <i>extender</i> - most probably RSX - decided to implement.</p> <p>Cf. <a href="#Prerequisites">Prerequisites</a>.</p> <h3 id="Prerequisites">Prerequisites</h3> <ul> <li id="EMX">
<b>EMX</b> <p>EMX runtime is required (may be substituted by RSX). Note that it is possible to make <i>perl_.exe</i> to run under DOS without any external support by binding <i>emx.exe</i>/<i>rsx.exe</i> to it, see <code class="inline"><span class="w">emxbind</span></code> . Note that under DOS for best results one should use RSX runtime, which has much more functions working (like <code class="inline"><a class="l_k" href="functions/fork">fork</a></code>, <code class="inline"><span class="w">popen</span></code> and so on). In fact RSX is required if there is no VCPI present. Note the RSX requires DPMI. Many implementations of DPMI are known to be very buggy, beware!</p> <p>Only the latest runtime is supported, currently <code class="inline">0.9d fix 03</code>. Perl may run under earlier versions of EMX, but this is not tested.</p> <p>One can get different parts of EMX from, say</p> <pre class="verbatim" data-language="perl">ftp://crydee.sai.msu.ru/pub/comp/os/os2/leo/gnu/emx+gcc/
http://hobbes.nmsu.edu/h-browse.php?dir=/pub/os2/dev/emx/v0.9d/
</pre>
<p>The runtime component should have the name <i>emxrt.zip</i>.</p> <p><b>NOTE</b>. When using <i>emx.exe</i>/<i>rsx.exe</i>, it is enough to have them on your path. One does not need to specify them explicitly (though this</p> <pre class="verbatim" data-language="perl">emx perl_.exe -de 0
</pre>
<p>will work as well.)</p> </li> <li id="RSX">
<b>RSX</b> <p>To run Perl on DPMI platforms one needs RSX runtime. This is needed under DOS-inside-OS/2, Win0.3*, Win0.95 and WinNT (see <a href="#Other-OSes">Other OSes</a>). RSX would not work with VCPI only, as EMX would, it requires DMPI.</p> <p>Having RSX and the latest <i>sh.exe</i> one gets a fully functional <b>*nix</b>-ish environment under DOS, say, <code class="inline"><a class="l_k" href="functions/fork">fork</a></code>, <code class="inline"><span class="q">``</span></code> and pipe-<code class="inline"><a class="l_k" href="functions/open">open</a></code> work. In fact, MakeMaker works (for static build), so one can have Perl development environment under DOS.</p> <p>One can get RSX from, say</p> <pre class="verbatim" data-language="perl">http://cd.textfiles.com/hobbesos29804/disk1/EMX09C/
ftp://crydee.sai.msu.ru/pub/comp/os/os2/leo/gnu/emx+gcc/contrib/
</pre>
<p>Contact the author on <code class="inline"><span class="w">rainer</span><span class="i">@mathematik</span>.<span class="w">uni</span>-<span class="w">bielefeld</span>.<span class="w">de</span></code> .</p> <p>The latest <i>sh.exe</i> with DOS hooks is available in</p> <pre class="verbatim" data-language="perl">http://www.ilyaz.org/software/os2/
</pre>
<p>as <i>sh_dos.zip</i> or under similar names starting with <code class="inline"><span class="w">sh</span></code> , <code class="inline"><span class="w">pdksh</span></code> etc.</p> </li> <li id="HPFS">
<b>HPFS</b> <p>Perl does not care about file systems, but the perl library contains many files with long names, so to install it intact one needs a file system which supports long file names.</p> <p>Note that if you do not plan to build the perl itself, it may be possible to fool EMX to truncate file names. This is not supported, read EMX docs to see how to do it.</p> </li> <li id="pdksh">
<b>pdksh</b> <p>To start external programs with complicated command lines (like with pipes in between, and/or quoting of arguments), Perl uses an external shell. With EMX port such shell should be named <i>sh.exe</i>, and located either in the wired-in-during-compile locations (usually <i>F:/bin</i>), or in configurable location (see <a href="#PERL_SH_DIR">PERL_SH_DIR</a>).</p> <p>For best results use EMX pdksh. The standard binary (5.2.14 or later) runs under DOS (with <a href="#RSX">RSX</a>) as well, see</p> <pre class="verbatim" data-language="perl">http://www.ilyaz.org/software/os2/
</pre>
</li> </ul> <h3 id="Starting-Perl-programs-under-OS%2f2-(and-DOS-and...)">Starting Perl programs under OS/2 (and DOS and...)</h3> <p>Start your Perl program <i>foo.pl</i> with arguments <code class="inline"><span class="w">arg1</span> <span class="w">arg2</span> <span class="w">arg3</span></code> the same way as on any other platform, by</p> <pre class="verbatim" data-language="perl">perl foo.pl arg1 arg2 arg3
</pre>
<p>If you want to specify perl options <code class="inline">-<span class="w">my_opts</span></code> to the perl itself (as opposed to your program), use</p> <pre class="verbatim" data-language="perl">perl -my_opts foo.pl arg1 arg2 arg3
</pre>
<p>Alternately, if you use OS/2-ish shell, like CMD or 4os2, put the following at the start of your perl script:</p> <pre class="verbatim" data-language="perl">extproc perl -S -my_opts
</pre>
<p>rename your program to <i>foo.cmd</i>, and start it by typing</p> <pre class="verbatim" data-language="perl">foo arg1 arg2 arg3
</pre>
<p>Note that because of stupid OS/2 limitations the full path of the perl script is not available when you use <code class="inline"><span class="w">extproc</span></code> , thus you are forced to use <code class="inline">-S</code> perl switch, and your script should be on the <code class="inline"><span class="w">PATH</span></code> . As a plus side, if you know a full path to your script, you may still start it with</p> <pre class="verbatim" data-language="perl">perl ../../blah/foo.cmd arg1 arg2 arg3
</pre>
<p>(note that the argument <code class="inline">-<span class="w">my_opts</span></code> is taken care of by the <code class="inline"><span class="w">extproc</span></code> line in your script, see <a href="#extproc-on-the-first-line">extproc on the first line</a>).</p> <p>To understand what the above <i>magic</i> does, read perl docs about <code class="inline">-S</code> switch - see <a href="perlrun">perlrun</a>, and cmdref about <code class="inline"><span class="w">extproc</span></code> :</p> <pre class="verbatim" data-language="perl">view perl perlrun
man perlrun
view cmdref extproc
help extproc
</pre>
<p>or whatever method you prefer.</p> <p>There are also endless possibilities to use <i>executable extensions</i> of 4os2, <i>associations</i> of WPS and so on... However, if you use *nixish shell (like <i>sh.exe</i> supplied in the binary distribution), you need to follow the syntax specified in <a href="perlrun#Command-Switches">Command Switches in perlrun</a>.</p> <p>Note that <b>-S</b> switch supports scripts with additional extensions <i>.cmd</i>, <i>.btm</i>, <i>.bat</i>, <i>.pl</i> as well.</p> <h3 id="Starting-OS%2f2-(and-DOS)-programs-under-Perl">Starting OS/2 (and DOS) programs under Perl</h3> <p>This is what system() (see <a href="functions/system">system</a>), <code class="inline"><span class="q">``</span></code> (see <a href="perlop#I%2fO-Operators">I/O Operators in perlop</a>), and <i>open pipe</i> (see <a href="functions/open">open</a>) are for. (Avoid exec() (see <a href="functions/exec">exec</a>) unless you know what you do).</p> <p>Note however that to use some of these operators you need to have a sh-syntax shell installed (see <a href="#Pdksh">Pdksh</a>, <a href="#Frequently-asked-questions">Frequently asked questions</a>), and perl should be able to find it (see <a href="#PERL_SH_DIR">PERL_SH_DIR</a>).</p> <p>The cases when the shell is used are:</p> <dl> <dt>1</dt>
<dd> <p>One-argument system() (see <a href="functions/system">system</a>), exec() (see <a href="functions/exec">exec</a>) with redirection or shell meta-characters;</p> </dd> <dt>2</dt>
<dd> <p>Pipe-open (see <a href="functions/open">open</a>) with the command which contains redirection or shell meta-characters;</p> </dd> <dt>3</dt>
<dd> <p>Backticks <code class="inline"><span class="q">``</span></code> (see <a href="perlop#I%2fO-Operators">I/O Operators in perlop</a>) with the command which contains redirection or shell meta-characters;</p> </dd> <dt>4</dt>
<dd> <p>If the executable called by system()/exec()/pipe-open()/<code class="inline"><span class="q">``</span></code> is a script with the "magic" <code class="inline"><span class="c">#!</span></code> line or <code class="inline"><span class="w">extproc</span></code> line which specifies shell;</p> </dd> <dt>5</dt>
<dd> <p>If the executable called by system()/exec()/pipe-open()/<code class="inline"><span class="q">``</span></code> is a script without "magic" line, and <code class="inline"><span class="i">$ENV</span>{<span class="w">EXECSHELL</span>}</code> is set to shell;</p> </dd> <dt>6</dt>
<dd> <p>If the executable called by system()/exec()/pipe-open()/<code class="inline"><span class="q">``</span></code> is not found (is not this remark obsolete?);</p> </dd> <dt>7</dt>
<dd> <p>For globbing (see <a href="functions/glob">glob</a>, <a href="perlop#I%2fO-Operators">I/O Operators in perlop</a>) (obsolete? Perl uses builtin globbing nowadays...).</p> </dd> </dl> <p>For the sake of speed for a common case, in the above algorithms backslashes in the command name are not considered as shell metacharacters.</p> <p>Perl starts scripts which begin with cookies <code class="inline"><span class="w">extproc</span></code> or <code class="inline"><span class="c">#!</span></code> directly, without an intervention of shell. Perl uses the same algorithm to find the executable as <i>pdksh</i>: if the path on <code class="inline"><span class="c">#!</span></code> line does not work, and contains <code class="inline">/</code>, then the directory part of the executable is ignored, and the executable is searched in <i>.</i> and on <code class="inline"><span class="w">PATH</span></code> . To find arguments for these scripts Perl uses a different algorithm than <i>pdksh</i>: up to 3 arguments are recognized, and trailing whitespace is stripped.</p> <p>If a script does not contain such a cooky, then to avoid calling <i>sh.exe</i>, Perl uses the same algorithm as <i>pdksh</i>: if <code class="inline"><span class="i">$ENV</span>{<span class="w">EXECSHELL</span>}</code> is set, the script is given as the first argument to this command, if not set, then <code class="inline"><span class="i">$ENV</span>{<span class="w">COMSPEC</span>} /<span class="w">c</span></code> is used (or a hardwired guess if <code class="inline"><span class="i">$ENV</span>{<span class="w">COMSPEC</span>}</code> is not set).</p> <p>When starting scripts directly, Perl uses exactly the same algorithm as for the search of script given by <b>-S</b> command-line option: it will look in the current directory, then on components of <code class="inline"><span class="i">$ENV</span>{<span class="w">PATH</span>}</code> using the following order of appended extensions: no extension, <i>.cmd</i>, <i>.btm</i>, <i>.bat</i>, <i>.pl</i>.</p> <p>Note that Perl will start to look for scripts only if OS/2 cannot start the specified application, thus <code class="inline"><a class="l_k" href="functions/system">system</a> <span class="q">'blah'</span></code> will not look for a script if there is an executable file <i>blah.exe</i> <i>anywhere</i> on <code class="inline"><span class="w">PATH</span></code> . In other words, <code class="inline"><span class="w">PATH</span></code> is essentially searched twice: once by the OS for an executable, then by Perl for scripts.</p> <p>Note also that executable files on OS/2 can have an arbitrary extension, but <i>.exe</i> will be automatically appended if no dot is present in the name. The workaround is as simple as that: since <i>blah.</i> and <i>blah</i> denote the same file (at list on FAT and HPFS file systems), to start an executable residing in file <i>n:/bin/blah</i> (no extension) give an argument <code class="inline">n:/bin/blah.</code> (dot appended) to system().</p> <p>Perl will start PM programs from VIO (=text-mode) Perl process in a separate PM session; the opposite is not true: when you start a non-PM program from a PM Perl process, Perl would not run it in a separate session. If a separate session is desired, either ensure that shell will be used, as in <code class="inline"><a class="l_k" href="functions/system">system</a> <span class="q">'cmd /c myprog'</span></code> , or start it using optional arguments to system() documented in <code class="inline"><span class="w">OS2::Process</span></code> module. This is considered to be a feature.</p> <h2 id="Frequently-asked-questions">Frequently asked questions</h2> <h3 id="%22It-does-not-work%22">"It does not work"</h3> <p>Perl binary distributions come with a <i>testperl.cmd</i> script which tries to detect common problems with misconfigured installations. There is a pretty large chance it will discover which step of the installation you managed to goof. <code class="inline">;-)</code></p> <h3 id="I-cannot-run-external-programs">I cannot run external programs</h3> <ul> <li> <p>Did you run your programs with <code class="inline">-w</code> switch? See <a href="http://search.cpan.org/perldoc/Starting%20OS#2-(and-DOS)-programs-under-Perl">2 (and DOS) programs under Perl in Starting OS</a>.</p> </li> <li> <p>Do you try to run <i>internal</i> shell commands, like <code class="inline"><span class="q">`copy a b`</span></code> (internal for <i>cmd.exe</i>), or <code class="inline"><span class="q">`glob a*b`</span></code> (internal for ksh)? You need to specify your shell explicitly, like <code class="inline"><span class="q">`cmd /c copy a b`</span></code> , since Perl cannot deduce which commands are internal to your shell.</p> </li> </ul> <h3 id="I-cannot-embed-perl-into-my-program%2c-or-use-_perl.dll_-from-my-program.">I cannot embed perl into my program, or use <i>perl.dll</i> from my program.</h3> <ul> <li id="Is-your-program-EMX-compiled-with--Zmt--Zcrtdll%3f">
<b>Is your program EMX-compiled with <code class="inline">-<span class="w">Zmt</span> -<span class="w">Zcrtdll</span></code> ?</b> <p>Well, nowadays Perl DLL should be usable from a differently compiled program too... If you can run Perl code from REXX scripts (see <a href="http://search.cpan.org/perldoc/OS2::REXX">OS2::REXX</a>), then there are some other aspect of interaction which are overlooked by the current hackish code to support differently-compiled principal programs.</p> <p>If everything else fails, you need to build a stand-alone DLL for perl. Contact me, I did it once. Sockets would not work, as a lot of other stuff.</p> </li> <li id="Did-you-use-the-ExtUtils%3a%3aEmbed-manpage%3f">
<b>Did you use <a href="extutils/embed">ExtUtils::Embed</a>?</b> <p>Some time ago I had reports it does not work. Nowadays it is checked in the Perl test suite, so grep <i>./t</i> subdirectory of the build tree (as well as <i>*.t</i> files in the <i>./lib</i> subdirectory) to find how it should be done "correctly".</p> </li> </ul> <h3 id="%60%60-and-pipe-open-do-not-work-under-DOS.">
<code class="inline"><span class="q">``</span></code> and pipe-<code class="inline"><a class="l_k" href="functions/open">open</a></code> do not work under DOS.</h3> <p>This may a variant of just <a href="#I-cannot-run-external-programs">I cannot run external programs</a>, or a deeper problem. Basically: you <i>need</i> RSX (see <a href="#Prerequisites">Prerequisites</a>) for these commands to work, and you may need a port of <i>sh.exe</i> which understands command arguments. One of such ports is listed in <a href="#Prerequisites">Prerequisites</a> under RSX. Do not forget to set variable <code class="inline"><a href="#PERL_SH_DIR">PERL_SH_DIR</a></code> as well.</p> <p>DPMI is required for RSX.</p> <h3 id="Cannot-start-find.exe-%22pattern%22-file">Cannot start <code class="inline">find.exe "pattern" file</code>
</h3> <p>The whole idea of the "standard C API to start applications" is that the forms <code class="inline"><span class="w">foo</span></code> and <code class="inline"><span class="q">"foo"</span></code> of program arguments are completely interchangeable. <i>find</i> breaks this paradigm;</p> <pre class="verbatim" data-language="perl">find "pattern" file
find pattern file
</pre>
<p>are not equivalent; <i>find</i> cannot be started directly using the above API. One needs a way to surround the doublequotes in some other quoting construction, necessarily having an extra non-Unixish shell in between.</p> <p>Use one of</p> <pre class="verbatim" data-language="perl">system 'cmd', '/c', 'find "pattern" file';
`cmd /c 'find "pattern" file'`
</pre>
<p>This would start <i>find.exe</i> via <i>cmd.exe</i> via <code class="inline"><span class="w">sh</span>.<span class="w">exe</span></code> via <code class="inline"><span class="w">perl</span>.<span class="w">exe</span></code> , but this is a price to pay if you want to use non-conforming program.</p> <h2 id="INSTALLATION">INSTALLATION</h2> <h3 id="Automatic-binary-installation">Automatic binary installation</h3> <p>The most convenient way of installing a binary distribution of perl is via perl installer <i>install.exe</i>. Just follow the instructions, and 99% of the installation blues would go away.</p> <p>Note however, that you need to have <i>unzip.exe</i> on your path, and EMX environment <i>running</i>. The latter means that if you just installed EMX, and made all the needed changes to <i>Config.sys</i>, you may need to reboot in between. Check EMX runtime by running</p> <pre class="verbatim" data-language="perl">emxrev
</pre>
<p>Binary installer also creates a folder on your desktop with some useful objects. If you need to change some aspects of the work of the binary installer, feel free to edit the file <i>Perl.pkg</i>. This may be useful e.g., if you need to run the installer many times and do not want to make many interactive changes in the GUI.</p> <p><b>Things not taken care of by automatic binary installation:</b></p> <ul> <li id="PERL_BADLANG">
<b><code class="inline"><span class="w">PERL_BADLANG</span></code> </b> <p>may be needed if you change your codepage <i>after</i> perl installation, and the new value is not supported by EMX. See <a href="#PERL_BADLANG">PERL_BADLANG</a>.</p> </li> <li id="PERL_BADFREE">
<b><code class="inline"><span class="w">PERL_BADFREE</span></code> </b> <p>see <a href="#PERL_BADFREE">PERL_BADFREE</a>.</p> </li> <li id="_Config.pm_">
<b><i>Config.pm</i></b> <p>This file resides somewhere deep in the location you installed your perl library, find it out by</p> <pre class="verbatim" data-language="perl">perl -MConfig -le "print $INC{'Config.pm'}"
</pre>
<p>While most important values in this file <i>are</i> updated by the binary installer, some of them may need to be hand-edited. I know no such data, please keep me informed if you find one. Moreover, manual changes to the installed version may need to be accompanied by an edit of this file.</p> </li> </ul> <p><b>NOTE</b>. Because of a typo the binary installer of 5.00305 would install a variable <code class="inline"><span class="w">PERL_SHPATH</span></code> into <i>Config.sys</i>. Please remove this variable and put <code class="inline"><a href="#PERL_SH_DIR">PERL_SH_DIR</a></code> instead.</p> <h3 id="Manual-binary-installation">Manual binary installation</h3> <p>As of version 5.00305, OS/2 perl binary distribution comes split into 11 components. Unfortunately, to enable configurable binary installation, the file paths in the zip files are not absolute, but relative to some directory.</p> <p>Note that the extraction with the stored paths is still necessary (default with unzip, specify <code class="inline">-d</code> to pkunzip). However, you need to know where to extract the files. You need also to manually change entries in <i>Config.sys</i> to reflect where did you put the files. Note that if you have some primitive unzipper (like <code class="inline"><span class="w">pkunzip</span></code> ), you may get a lot of warnings/errors during unzipping. Upgrade to <code class="inline">(w)unzip</code>.</p> <p>Below is the sample of what to do to reproduce the configuration on my machine. In <i>VIEW.EXE</i> you can press <code class="inline"><span class="w">Ctrl</span>-<span class="w">Insert</span></code> now, and cut-and-paste from the resulting file - created in the directory you started <i>VIEW.EXE</i> from.</p> <p>For each component, we mention environment variables related to each installation directory. Either choose directories to match your values of the variables, or create/append-to variables to take into account the directories.</p> <ul> <li id="Perl-VIO-and-PM-executables-(dynamically-linked)">
<b>Perl VIO and PM executables (dynamically linked)</b> <pre class="verbatim" data-language="perl">unzip perl_exc.zip *.exe *.ico -d f:/emx.add/bin
unzip perl_exc.zip *.dll -d f:/emx.add/dll
</pre>
<p>(have the directories with <code class="inline">*.exe</code> on PATH, and <code class="inline">*.dll</code> on LIBPATH);</p> </li> <li id="Perl_-VIO-executable-(statically-linked)">
<b>Perl_ VIO executable (statically linked)</b> <pre class="verbatim" data-language="perl">unzip perl_aou.zip -d f:/emx.add/bin
</pre>
<p>(have the directory on PATH);</p> </li> <li id="Executables-for-Perl-utilities">
<b>Executables for Perl utilities</b> <pre class="verbatim" data-language="perl">unzip perl_utl.zip -d f:/emx.add/bin
</pre>
<p>(have the directory on PATH);</p> </li> <li id="Main-Perl-library">
<b>Main Perl library</b> <pre class="verbatim" data-language="perl">unzip perl_mlb.zip -d f:/perllib/lib
</pre>
<p>If this directory is exactly the same as the prefix which was compiled into <i>perl.exe</i>, you do not need to change anything. However, for perl to find the library if you use a different path, you need to <code class="inline"><span class="w">set</span> <span class="w">PERLLIB_PREFIX</span></code> in <i>Config.sys</i>, see <a href="#PERLLIB_PREFIX">PERLLIB_PREFIX</a>.</p> </li> <li id="Additional-Perl-modules">
<b>Additional Perl modules</b> <pre class="verbatim" data-language="perl">unzip perl_ste.zip -d f:/perllib/lib/site_perl/5.22.0/
</pre>
<p>Same remark as above applies. Additionally, if this directory is not one of directories on @INC (and @INC is influenced by <code class="inline"><span class="w">PERLLIB_PREFIX</span></code> ), you need to put this directory and subdirectory <i>./os2</i> in <code class="inline"><span class="w">PERLLIB</span></code> or <code class="inline"><span class="w">PERL5LIB</span></code> variable. Do not use <code class="inline"><span class="w">PERL5LIB</span></code> unless you have it set already. See <a href="perl#ENVIRONMENT">ENVIRONMENT in perl</a>.</p> <p><b>[Check whether this extraction directory is still applicable with the new directory structure layout!]</b></p> </li> <li id="Tools-to-compile-Perl-modules">
<b>Tools to compile Perl modules</b> <pre class="verbatim" data-language="perl">unzip perl_blb.zip -d f:/perllib/lib
</pre>
<p>Same remark as for <i>perl_ste.zip</i>.</p> </li> <li id="Manpages-for-Perl-and-utilities">
<b>Manpages for Perl and utilities</b> <pre class="verbatim" data-language="perl">unzip perl_man.zip -d f:/perllib/man
</pre>
<p>This directory should better be on <code class="inline"><span class="w">MANPATH</span></code> . You need to have a working <i>man</i> to access these files.</p> </li> <li id="Manpages-for-Perl-modules">
<b>Manpages for Perl modules</b> <pre class="verbatim" data-language="perl">unzip perl_mam.zip -d f:/perllib/man
</pre>
<p>This directory should better be on <code class="inline"><span class="w">MANPATH</span></code> . You need to have a working man to access these files.</p> </li> <li id="Source-for-Perl-documentation">
<b>Source for Perl documentation</b> <pre class="verbatim" data-language="perl">unzip perl_pod.zip -d f:/perllib/lib
</pre>
<p>This is used by the <code class="inline"><span class="w">perldoc</span></code> program (see <a href="perldoc">perldoc</a>), and may be used to generate HTML documentation usable by WWW browsers, and documentation in zillions of other formats: <code class="inline"><span class="w">info</span></code> , <code class="inline"><span class="w">LaTeX</span></code> , <code class="inline"><span class="w">Acrobat</span></code> , <code class="inline"><span class="w">FrameMaker</span></code> and so on. [Use programs such as <i>pod2latex</i> etc.]</p> </li> <li id="Perl-manual-in-_.INF_-format">
<b>Perl manual in <i>.INF</i> format</b> <pre class="verbatim" data-language="perl">unzip perl_inf.zip -d d:/os2/book
</pre>
<p>This directory should better be on <code class="inline"><span class="w">BOOKSHELF</span></code> .</p> </li> <li id="Pdksh">
<b>Pdksh</b> <pre class="verbatim" data-language="perl">unzip perl_sh.zip -d f:/bin
</pre>
<p>This is used by perl to run external commands which explicitly require shell, like the commands using <i>redirection</i> and <i>shell metacharacters</i>. It is also used instead of explicit <i>/bin/sh</i>.</p> <p>Set <code class="inline"><span class="w">PERL_SH_DIR</span></code> (see <a href="#PERL_SH_DIR">PERL_SH_DIR</a>) if you move <i>sh.exe</i> from the above location.</p> <p><b>Note.</b> It may be possible to use some other sh-compatible shell (untested).</p> </li> </ul> <p>After you installed the components you needed and updated the <i>Config.sys</i> correspondingly, you need to hand-edit <i>Config.pm</i>. This file resides somewhere deep in the location you installed your perl library, find it out by</p> <pre class="verbatim" data-language="perl">perl -MConfig -le "print $INC{'Config.pm'}"
</pre>
<p>You need to correct all the entries which look like file paths (they currently start with <code class="inline">f:/</code>).</p> <h3 id="*Warning*"><b>Warning</b></h3> <p>The automatic and manual perl installation leave precompiled paths inside perl executables. While these paths are overwriteable (see <a href="#PERLLIB_PREFIX">PERLLIB_PREFIX</a>, <a href="#PERL_SH_DIR">PERL_SH_DIR</a>), some people may prefer binary editing of paths inside the executables/DLLs.</p> <h2 id="Accessing-documentation">Accessing documentation</h2> <p>Depending on how you built/installed perl you may have (otherwise identical) Perl documentation in the following formats:</p> <h3 id="OS%2f2-_.INF_-file">OS/2 <i>.INF</i> file</h3> <p>Most probably the most convenient form. Under OS/2 view it as</p> <pre class="verbatim" data-language="perl">view perl
view perl perlfunc
view perl less
view perl ExtUtils::MakeMaker
</pre>
<p>(currently the last two may hit a wrong location, but this may improve soon). Under Win* see <a href="#SYNOPSIS">SYNOPSIS</a>.</p> <p>If you want to build the docs yourself, and have <i>OS/2 toolkit</i>, run</p> <pre class="verbatim" data-language="perl">pod2ipf &gt; perl.ipf
</pre>
<p>in <i>/perllib/lib/pod</i> directory, then</p> <pre class="verbatim" data-language="perl">ipfc /inf perl.ipf
</pre>
<p>(Expect a lot of errors during the both steps.) Now move it on your BOOKSHELF path.</p> <h3 id="Plain-text">Plain text</h3> <p>If you have perl documentation in the source form, perl utilities installed, and GNU groff installed, you may use</p> <pre class="verbatim" data-language="perl">perldoc perlfunc
perldoc less
perldoc ExtUtils::MakeMaker
</pre>
<p>to access the perl documentation in the text form (note that you may get better results using perl manpages).</p> <p>Alternately, try running pod2text on <i>.pod</i> files.</p> <h3 id="Manpages">Manpages</h3> <p>If you have <i>man</i> installed on your system, and you installed perl manpages, use something like this:</p> <pre class="verbatim" data-language="perl">man perlfunc
man 3 less
man ExtUtils.MakeMaker
</pre>
<p>to access documentation for different components of Perl. Start with</p> <pre class="verbatim" data-language="perl">man perl
</pre>
<p>Note that dot (<i>.</i>) is used as a package separator for documentation for packages, and as usual, sometimes you need to give the section - <code class="inline"><span class="n">3</span></code> above - to avoid shadowing by the <i>less(1) manpage</i>.</p> <p>Make sure that the directory <b>above</b> the directory with manpages is on our <code class="inline"><span class="w">MANPATH</span></code> , like this</p> <pre class="verbatim" data-language="perl">set MANPATH=c:/man;f:/perllib/man
</pre>
<p>for Perl manpages in <code class="inline">f:/perllib/man/man1/</code> etc.</p> <h3 id="HTML">HTML</h3> <p>If you have some WWW browser available, installed the Perl documentation in the source form, and Perl utilities, you can build HTML docs. Cd to directory with <i>.pod</i> files, and do like this</p> <pre class="verbatim" data-language="perl">cd f:/perllib/lib/pod
pod2html
</pre>
<p>After this you can direct your browser the file <i>perl.html</i> in this directory, and go ahead with reading docs, like this:</p> <pre class="verbatim" data-language="perl">explore file:///f:/perllib/lib/pod/perl.html
</pre>
<p>Alternatively you may be able to get these docs prebuilt from CPAN.</p> <h3 id="GNU-info-files">GNU <code class="inline"><span class="w">info</span></code> files</h3> <p>Users of Emacs would appreciate it very much, especially with <code class="inline"><span class="w">CPerl</span></code> mode loaded. You need to get latest <code class="inline"><span class="w">pod2texi</span></code> from <code class="inline"><span class="w">CPAN</span></code> , or, alternately, the prebuilt info pages.</p> <h3 id="_PDF_-files">
<i>PDF</i> files</h3> <p>for <code class="inline"><span class="w">Acrobat</span></code> are available on CPAN (may be for slightly older version of perl).</p> <h3 id="LaTeX-docs">
<code class="inline"><span class="w">LaTeX</span></code> docs</h3> <p>can be constructed using <code class="inline"><span class="w">pod2latex</span></code> .</p> <h2 id="BUILD">BUILD</h2> <p>Here we discuss how to build Perl under OS/2.</p> <h3 id="The-short-story">The short story</h3> <p>Assume that you are a seasoned porter, so are sure that all the necessary tools are already present on your system, and you know how to get the Perl source distribution. Untar it, change to the extract directory, and</p> <pre class="verbatim" data-language="perl">gnupatch -p0 &lt; os2\diff.configure
sh Configure -des -D prefix=f:/perllib
make
make test
make install
make aout_test
make aout_install
</pre>
<p>This puts the executables in f:/perllib/bin. Manually move them to the <code class="inline"><span class="w">PATH</span></code> , manually move the built <i>perl*.dll</i> to <code class="inline"><span class="w">LIBPATH</span></code> (here for Perl DLL <i>*</i> is a not-very-meaningful hex checksum), and run</p> <pre class="verbatim" data-language="perl">make installcmd INSTALLCMDDIR=d:/ir/on/path
</pre>
<p>Assuming that the <code class="inline"><span class="w">man</span></code> -files were put on an appropriate location, this completes the installation of minimal Perl system. (The binary distribution contains also a lot of additional modules, and the documentation in INF format.)</p> <p>What follows is a detailed guide through these steps.</p> <h3 id="Prerequisites">Prerequisites</h3> <p>You need to have the latest EMX development environment, the full GNU tool suite (gawk renamed to awk, and GNU <i>find.exe</i> earlier on path than the OS/2 <i>find.exe</i>, same with <i>sort.exe</i>, to check use</p> <pre class="verbatim" data-language="perl">find --version
sort --version
</pre>
<p>). You need the latest version of <i>pdksh</i> installed as <i>sh.exe</i>.</p> <p>Check that you have <b>BSD</b> libraries and headers installed, and - optionally - Berkeley DB headers and libraries, and crypt.</p> <p>Possible locations to get the files:</p> <pre class="verbatim" data-language="perl">ftp://ftp.uni-heidelberg.de/pub/os2/unix/
http://hobbes.nmsu.edu/h-browse.php?dir=/pub/os2
http://cd.textfiles.com/hobbesos29804/disk1/DEV32/
http://cd.textfiles.com/hobbesos29804/disk1/EMX09C/
</pre>
<p>It is reported that the following archives contain enough utils to build perl: <i>gnufutil.zip</i>, <i>gnusutil.zip</i>, <i>gnututil.zip</i>, <i>gnused.zip</i>, <i>gnupatch.zip</i>, <i>gnuawk.zip</i>, <i>gnumake.zip</i>, <i>gnugrep.zip</i>, <i>bsddev.zip</i> and <i>ksh527rt.zip</i> (or a later version). Note that all these utilities are known to be available from LEO:</p> <pre class="verbatim" data-language="perl">ftp://crydee.sai.msu.ru/pub/comp/os/os2/leo/gnu/
</pre>
<p>Note also that the <i>db.lib</i> and <i>db.a</i> from the EMX distribution are not suitable for multi-threaded compile (even single-threaded flavor of Perl uses multi-threaded C RTL, for compatibility with XFree86-OS/2). Get a corrected one from</p> <pre class="verbatim" data-language="perl">http://www.ilyaz.org/software/os2/db_mt.zip
</pre>
<p>If you have <i>exactly the same version of Perl</i> installed already, make sure that no copies or perl are currently running. Later steps of the build may fail since an older version of <i>perl.dll</i> loaded into memory may be found. Running <code class="inline"><span class="w">make</span> <span class="w">test</span></code> becomes meaningless, since the test are checking a previous build of perl (this situation is detected and reported by <i>lib/os2_base.t</i> test). Do not forget to unset <code class="inline"><span class="w">PERL_EMXLOAD_SEC</span></code> in environment.</p> <p>Also make sure that you have <i>/tmp</i> directory on the current drive, and <i>.</i> directory in your <code class="inline"><span class="w">LIBPATH</span></code> . One may try to correct the latter condition by</p> <pre class="verbatim" data-language="perl">set BEGINLIBPATH .\.
</pre>
<p>if you use something like <i>CMD.EXE</i> or latest versions of <i>4os2.exe</i>. (Setting BEGINLIBPATH to just <code class="inline">.</code> is ignored by the OS/2 kernel.)</p> <p>Make sure your gcc is good for <code class="inline">-<span class="w">Zomf</span></code> linking: run <code class="inline"><span class="w">omflibs</span></code> script in <i>/emx/lib</i> directory.</p> <p>Check that you have link386 installed. It comes standard with OS/2, but may be not installed due to customization. If typing</p> <pre class="verbatim" data-language="perl">link386
</pre>
<p>shows you do not have it, do <i>Selective install</i>, and choose <code class="inline"><span class="w">Link</span>
<span class="w">object</span> <span class="w">modules</span></code> in <i>Optional system utilities/More</i>. If you get into link386 prompts, press <code class="inline"><span class="w">Ctrl</span>-C</code> to exit.</p> <h3 id="Getting-perl-source">Getting perl source</h3> <p>You need to fetch the latest perl source (including developers releases). With some probability it is located in</p> <pre class="verbatim" data-language="perl">http://www.cpan.org/src/
http://www.cpan.org/src/unsupported
</pre>
<p>If not, you may need to dig in the indices to find it in the directory of the current maintainer.</p> <p>Quick cycle of developers release may break the OS/2 build time to time, looking into</p> <pre class="verbatim" data-language="perl">http://www.cpan.org/ports/os2/
</pre>
<p>may indicate the latest release which was publicly released by the maintainer. Note that the release may include some additional patches to apply to the current source of perl.</p> <p>Extract it like this</p> <pre class="verbatim" data-language="perl">tar vzxf perl5.00409.tar.gz
</pre>
<p>You may see a message about errors while extracting <i>Configure</i>. This is because there is a conflict with a similarly-named file <i>configure</i>.</p> <p>Change to the directory of extraction.</p> <h3 id="Application-of-the-patches">Application of the patches</h3> <p>You need to apply the patches in <i>./os2/diff.*</i> like this:</p> <pre class="verbatim" data-language="perl">gnupatch -p0 &lt; os2\diff.configure
</pre>
<p>You may also need to apply the patches supplied with the binary distribution of perl. It also makes sense to look on the perl5-porters mailing list for the latest OS/2-related patches (see <a href="http://www.xray.mpe.mpg.de/mailing-lists/perl5-porters/">http://www.xray.mpe.mpg.de/mailing-lists/perl5-porters/</a>). Such patches usually contain strings <code class="inline"><span class="q">/os2/</span></code> and <code class="inline"><span class="w">patch</span></code> , so it makes sense looking for these strings.</p> <h3 id="Hand-editing">Hand-editing</h3> <p>You may look into the file <i>./hints/os2.sh</i> and correct anything wrong you find there. I do not expect it is needed anywhere.</p> <h3 id="Making">Making</h3> <pre class="verbatim" data-language="perl">sh Configure -des -D prefix=f:/perllib
</pre>
<p><code class="inline"><span class="w">prefix</span></code> means: where to install the resulting perl library. Giving correct prefix you may avoid the need to specify <code class="inline"><span class="w">PERLLIB_PREFIX</span></code> , see <a href="#PERLLIB_PREFIX">PERLLIB_PREFIX</a>.</p> <p><i>Ignore the message about missing <code class="inline"><span class="w">ln</span></code> , and about <code class="inline">-c</code> option to tr</i>. The latter is most probably already fixed, if you see it and can trace where the latter spurious warning comes from, please inform me.</p> <p>Now</p> <pre class="verbatim" data-language="perl">make
</pre>
<p>At some moment the built may die, reporting a <i>version mismatch</i> or <i>unable to run <i>perl</i></i>. This means that you do not have <i>.</i> in your LIBPATH, so <i>perl.exe</i> cannot find the needed <i>perl67B2.dll</i> (treat these hex digits as line noise). After this is fixed the build should finish without a lot of fuss.</p> <h3 id="Testing">Testing</h3> <p>Now run</p> <pre class="verbatim" data-language="perl">make test
</pre>
<p>All tests should succeed (with some of them skipped). If you have the same version of Perl installed, it is crucial that you have <code class="inline">.</code> early in your LIBPATH (or in BEGINLIBPATH), otherwise your tests will most probably test the wrong version of Perl.</p> <p>Some tests may generate extra messages similar to</p> <ul> <li id="A-lot-of-bad-free">
<b>A lot of <code class="inline"><span class="w">bad</span> <span class="w">free</span></code> </b> <p>in database tests related to Berkeley DB. <i>This should be fixed already.</i> If it persists, you may disable this warnings, see <a href="#PERL_BADFREE">PERL_BADFREE</a>.</p> </li> <li id="Process-terminated-by-SIGTERM%2fSIGINT">
<b>Process terminated by SIGTERM/SIGINT</b> <p>This is a standard message issued by OS/2 applications. *nix applications die in silence. It is considered to be a feature. One can easily disable this by appropriate sighandlers.</p> <p>However the test engine bleeds these message to screen in unexpected moments. Two messages of this kind <i>should</i> be present during testing.</p> </li> </ul> <p>To get finer test reports, call</p> <pre class="verbatim" data-language="perl">perl t/harness
</pre>
<p>The report with <i>io/pipe.t</i> failing may look like this:</p> <pre class="verbatim" data-language="perl">Failed Test  Status Wstat Total Fail  Failed  List of failed
------------------------------------------------------------
io/pipe.t                    12    1   8.33%  9
7 tests skipped, plus 56 subtests skipped.
Failed 1/195 test scripts, 99.49% okay. 1/6542 subtests failed, 99.98% okay.
</pre>
<p>The reasons for most important skipped tests are:</p> <ul> <li id="_op%2ffs.t_">
<b><i>op/fs.t</i></b> <ul> <li id="18">
<b>18</b> <p>Checks <code class="inline"><span class="w">atime</span></code> and <code class="inline"><span class="w">mtime</span></code> of <code class="inline"><a class="l_k" href="functions/stat">stat()</a></code> - unfortunately, HPFS provides only 2sec time granularity (for compatibility with FAT?).</p> </li> <li id="25">
<b>25</b> <p>Checks <code class="inline"><a class="l_k" href="functions/truncate">truncate()</a></code> on a filehandle just opened for write - I do not know why this should or should not work.</p> </li> </ul> </li> <li id="_op%2fstat.t_">
<b><i>op/stat.t</i></b> <p>Checks <code class="inline"><a class="l_k" href="functions/stat">stat()</a></code>. Tests:</p> <dl> <dt>4</dt>
<dd> <p>Checks <code class="inline"><span class="w">atime</span></code> and <code class="inline"><span class="w">mtime</span></code> of <code class="inline"><a class="l_k" href="functions/stat">stat()</a></code> - unfortunately, HPFS provides only 2sec time granularity (for compatibility with FAT?).</p> </dd> </dl> </li> </ul> <h3 id="Installing-the-built-perl">Installing the built perl</h3> <p>If you haven't yet moved <code class="inline">perl*.dll</code> onto LIBPATH, do it now.</p> <p>Run</p> <pre class="verbatim" data-language="perl">make install
</pre>
<p>It would put the generated files into needed locations. Manually put <i>perl.exe</i>, <i>perl__.exe</i> and <i>perl___.exe</i> to a location on your PATH, <i>perl.dll</i> to a location on your LIBPATH.</p> <p>Run</p> <pre class="verbatim" data-language="perl">make installcmd INSTALLCMDDIR=d:/ir/on/path
</pre>
<p>to convert perl utilities to <i>.cmd</i> files and put them on PATH. You need to put <i>.EXE</i>-utilities on path manually. They are installed in <code class="inline"><span class="i">$prefix</span>/<span class="w">bin</span></code> , here <code class="inline"><span class="i">$prefix</span></code> is what you gave to <i>Configure</i>, see <a href="#Making">Making</a>.</p> <p>If you use <code class="inline"><span class="w">man</span></code> , either move the installed <i>*/man/</i> directories to your <code class="inline"><span class="w">MANPATH</span></code> , or modify <code class="inline"><span class="w">MANPATH</span></code> to match the location. (One could have avoided this by providing a correct <code class="inline"><span class="w">manpath</span></code> option to <i>./Configure</i>, or editing <i>./config.sh</i> between configuring and making steps.)</p> <h3 id="a.out-style-build">
<code class="inline"><span class="w">a</span>.<span class="w">out</span></code> -style build</h3> <p>Proceed as above, but make <i>perl_.exe</i> (see <a href="#perl_.exe">perl_.exe</a>) by</p> <pre class="verbatim" data-language="perl">make perl_
</pre>
<p>test and install by</p> <pre class="verbatim" data-language="perl">make aout_test
make aout_install
</pre>
<p>Manually put <i>perl_.exe</i> to a location on your PATH.</p> <p><b>Note.</b> The build process for <code class="inline"><span class="w">perl_</span></code> <i>does not know</i> about all the dependencies, so you should make sure that anything is up-to-date, say, by doing</p> <pre class="verbatim" data-language="perl">make perl_dll
</pre>
<p>first.</p> <h2 id="Building-a-binary-distribution">Building a binary distribution</h2> <p>[This section provides a short overview only...]</p> <p>Building should proceed differently depending on whether the version of perl you install is already present and used on your system, or is a new version not yet used. The description below assumes that the version is new, so installing its DLLs and <i>.pm</i> files will not disrupt the operation of your system even if some intermediate steps are not yet fully working.</p> <p>The other cases require a little bit more convoluted procedures. Below I suppose that the current version of Perl is <code class="inline"><span class="v">5.8.2</span></code> , so the executables are named accordingly.</p> <dl> <dt>1.</dt>
<dd> <p>Fully build and test the Perl distribution. Make sure that no tests are failing with <code class="inline"><span class="w">test</span></code> and <code class="inline"><span class="w">aout_test</span></code> targets; fix the bugs in Perl and the Perl test suite detected by these tests. Make sure that <code class="inline"><span class="w">all_test</span></code> make target runs as clean as possible. Check that <i>os2/perlrexx.cmd</i> runs fine.</p> </dd> <dt>2.</dt>
<dd> <p>Fully install Perl, including <code class="inline"><span class="w">installcmd</span></code> target. Copy the generated DLLs to <code class="inline"><span class="w">LIBPATH</span></code> ; copy the numbered Perl executables (as in <i>perl5.8.2.exe</i>) to <code class="inline"><span class="w">PATH</span></code> ; copy <code class="inline"><span class="w">perl_</span>.<span class="w">exe</span></code> to <code class="inline"><span class="w">PATH</span></code> as <code class="inline"><span class="w">perl_5</span><span class="v">.8.2</span>.<span class="w">exe</span></code> . Think whether you need backward-compatibility DLLs. In most cases you do not need to install them yet; but sometime this may simplify the following steps.</p> </dd> <dt>3.</dt>
<dd> <p>Make sure that <code class="inline"><span class="w">CPAN</span>.<span class="w">pm</span></code> can download files from CPAN. If not, you may need to manually install <code class="inline"><span class="w">Net::FTP</span></code> .</p> </dd> <dt>4.</dt>
<dd> <p>Install the bundle <code class="inline"><span class="w">Bundle::OS2_default</span></code> </p> <pre class="verbatim" data-language="perl">perl5.8.2 -MCPAN -e "install Bundle::OS2_default" &lt; nul |&amp; tee 00cpan_i_1
</pre>
<p>This may take a couple of hours on 1GHz processor (when run the first time). And this should not be necessarily a smooth procedure. Some modules may not specify required dependencies, so one may need to repeat this procedure several times until the results stabilize.</p> <pre class="verbatim" data-language="perl">perl5.8.2 -MCPAN -e "install Bundle::OS2_default" &lt; nul |&amp; tee 00cpan_i_2
perl5.8.2 -MCPAN -e "install Bundle::OS2_default" &lt; nul |&amp; tee 00cpan_i_3
</pre>
<p>Even after they stabilize, some tests may fail.</p> <p>Fix as many discovered bugs as possible. Document all the bugs which are not fixed, and all the failures with unknown reasons. Inspect the produced logs <i>00cpan_i_1</i> to find suspiciously skipped tests, and other fishy events.</p> <p>Keep in mind that <i>installation</i> of some modules may fail too: for example, the DLLs to update may be already loaded by <i>CPAN.pm</i>. Inspect the <code class="inline"><span class="w">install</span></code> logs (in the example above <i>00cpan_i_1</i> etc) for errors, and install things manually, as in</p> <pre class="verbatim" data-language="perl">cd $CPANHOME/.cpan/build/Digest-MD5-2.31
make install
</pre>
<p>Some distributions may fail some tests, but you may want to install them anyway (as above, or via <code class="inline"><span class="w">force</span> <span class="w">install</span></code> command of <code class="inline"><span class="w">CPAN</span>.<span class="w">pm</span></code> shell-mode).</p> <p>Since this procedure may take quite a long time to complete, it makes sense to "freeze" your CPAN configuration by disabling periodic updates of the local copy of CPAN index: set <code class="inline"><span class="w">index_expire</span></code> to some big value (I use 365), then save the settings</p> <pre class="verbatim" data-language="perl">CPAN&gt; o conf index_expire 365
CPAN&gt; o conf commit
</pre>
<p>Reset back to the default value <code class="inline"><span class="n">1</span></code> when you are finished.</p> </dd> <dt>5.</dt>
<dd> <p>When satisfied with the results, rerun the <code class="inline"><span class="w">installcmd</span></code> target. Now you can copy <code class="inline"><span class="w">perl5</span><span class="v">.8.2</span>.<span class="w">exe</span></code> to <code class="inline"><span class="w">perl</span>.<span class="w">exe</span></code> , and install the other OMF-build executables: <code class="inline"><span class="w">perl__</span>.<span class="w">exe</span></code> etc. They are ready to be used.</p> </dd> <dt>6.</dt>
<dd> <p>Change to the <code class="inline">./pod</code> directory of the build tree, download the Perl logo <i>CamelGrayBig.BMP</i>, and run</p> <pre class="verbatim" data-language="perl">( perl2ipf &gt; perl.ipf ) |&amp; tee 00ipf
ipfc /INF perl.ipf |&amp; tee 00inf
</pre>
<p>This produces the Perl docs online book <code class="inline"><span class="w">perl</span>.<span class="w">INF</span></code> . Install in on <code class="inline"><span class="w">BOOKSHELF</span></code> path.</p> </dd> <dt>7.</dt>
<dd> <p>Now is the time to build statically linked executable <i>perl_.exe</i> which includes newly-installed via <code class="inline"><span class="w">Bundle::OS2_default</span></code> modules. Doing testing via <code class="inline"><span class="w">CPAN</span>.<span class="w">pm</span></code> is going to be painfully slow, since it statically links a new executable per XS extension.</p> <p>Here is a possible workaround: create a toplevel <i>Makefile.PL</i> in <i>$CPANHOME/.cpan/build/</i> with contents being (compare with <a href="#Making-executables-with-a-custom-collection-of-statically-loaded-extensions">Making executables with a custom collection of statically loaded extensions</a>)</p> <pre class="verbatim" data-language="perl">use ExtUtils::MakeMaker;
WriteMakefile NAME =&gt; 'dummy';
</pre>
<p>execute this as</p> <pre class="verbatim" data-language="perl">perl_5.8.2.exe Makefile.PL &lt;nul |&amp; tee 00aout_c1
make -k all test &lt;nul |&amp; 00aout_t1
</pre>
<p>Again, this procedure should not be absolutely smooth. Some <code class="inline"><span class="w">Makefile</span>.<span class="w">PL</span></code> 's in subdirectories may be buggy, and would not run as "child" scripts. The interdependency of modules can strike you; however, since non-XS modules are already installed, the prerequisites of most modules have a very good chance to be present.</p> <p>If you discover some glitches, move directories of problematic modules to a different location; if these modules are non-XS modules, you may just ignore them - they are already installed; the remaining, XS, modules you need to install manually one by one.</p> <p>After each such removal you need to rerun the <code class="inline"><span class="w">Makefile</span>.<span class="w">PL</span></code> /<code class="inline"><span class="w">make</span></code> process; usually this procedure converges soon. (But be sure to convert all the necessary external C libraries from <i>.lib</i> format to <i>.a</i> format: run one of</p> <pre class="verbatim" data-language="perl">emxaout foo.lib
emximp -o foo.a foo.lib
</pre>
<p>whichever is appropriate.) Also, make sure that the DLLs for external libraries are usable with with executables compiled without <code class="inline">-<span class="w">Zmtd</span></code> options.</p> <p>When you are sure that only a few subdirectories lead to failures, you may want to add <code class="inline">-<span class="w">j4</span></code> option to <code class="inline"><span class="w">make</span></code> to speed up skipping subdirectories with already finished build.</p> <p>When you are satisfied with the results of tests, install the build C libraries for extensions:</p> <pre class="verbatim" data-language="perl">make install |&amp; tee 00aout_i
</pre>
<p>Now you can rename the file <i>./perl.exe</i> generated during the last phase to <i>perl_5.8.2.exe</i>; place it on <code class="inline"><span class="w">PATH</span></code> ; if there is an inter-dependency between some XS modules, you may need to repeat the <code class="inline"><span class="w">test</span></code> /<code class="inline"><span class="w">install</span></code> loop with this new executable and some excluded modules - until the procedure converges.</p> <p>Now you have all the necessary <i>.a</i> libraries for these Perl modules in the places where Perl builder can find it. Use the perl builder: change to an empty directory, create a "dummy" <i>Makefile.PL</i> again, and run</p> <pre class="verbatim" data-language="perl">perl_5.8.2.exe Makefile.PL |&amp; tee 00c
make perl		     |&amp; tee 00p
</pre>
<p>This should create an executable <i>./perl.exe</i> with all the statically loaded extensions built in. Compare the generated <i>perlmain.c</i> files to make sure that during the iterations the number of loaded extensions only increases. Rename <i>./perl.exe</i> to <i>perl_5.8.2.exe</i> on <code class="inline"><span class="w">PATH</span></code> .</p> <p>When it converges, you got a functional variant of <i>perl_5.8.2.exe</i>; copy it to <code class="inline"><span class="w">perl_</span>.<span class="w">exe</span></code> . You are done with generation of the local Perl installation.</p> </dd> <dt>8.</dt>
<dd> <p>Make sure that the installed modules are actually installed in the location of the new Perl, and are not inherited from entries of @INC given for inheritance from the older versions of Perl: set <code class="inline"><span class="w">PERLLIB_582_PREFIX</span></code> to redirect the new version of Perl to a new location, and copy the installed files to this new location. Redo the tests to make sure that the versions of modules inherited from older versions of Perl are not needed.</p> <p>Actually, the log output of <i>pod2ipf(1)</i> during the step 6 gives a very detailed info about which modules are loaded from which place; so you may use it as an additional verification tool.</p> <p>Check that some temporary files did not make into the perl install tree. Run something like this</p> <pre class="verbatim" data-language="perl">pfind . -f "!(/\.(pm|pl|ix|al|h|a|lib|txt|pod|imp|bs|dll|ld|bs|inc|xbm|yml|cgi|uu|e2x|skip|packlist|eg|cfg|html|pub|enc|all|ini|po|pot)$/i or /^\w+$/") | less
</pre>
<p>in the install tree (both top one and <i>sitelib</i> one).</p> <p>Compress all the DLLs with <i>lxlite</i>. The tiny <i>.exe</i> can be compressed with <code class="inline">/c:max</code> (the bug only appears when there is a fixup in the last 6 bytes of a page (?); since the tiny executables are much smaller than a page, the bug will not hit). Do not compress <code class="inline"><span class="w">perl_</span>.<span class="w">exe</span></code> - it would not work under DOS.</p> </dd> <dt>9.</dt>
<dd> <p>Now you can generate the binary distribution. This is done by running the test of the CPAN distribution <code class="inline"><span class="w">OS2::SoftInstaller</span></code> . Tune up the file <i>test.pl</i> to suit the layout of current version of Perl first. Do not forget to pack the necessary external DLLs accordingly. Include the description of the bugs and test suite failures you could not fix. Include the small-stack versions of Perl executables from Perl build directory.</p> <p>Include <i>perl5.def</i> so that people can relink the perl DLL preserving the binary compatibility, or can create compatibility DLLs. Include the diff files (<code class="inline"><span class="w">diff</span> -<span class="w">pu</span> <span class="w">old</span> <span class="w">new</span></code> ) of fixes you did so that people can rebuild your version. Include <i>perl5.map</i> so that one can use remote debugging.</p> </dd> <dt>10.</dt>
<dd> <p>Share what you did with the other people. Relax. Enjoy fruits of your work.</p> </dd> <dt>11.</dt>
<dd> <p>Brace yourself for thanks, bug reports, hate mail and spam coming as result of the previous step. No good deed should remain unpunished!</p> </dd> </dl> <h2 id="Building-custom-_.EXE_-files">Building custom <i>.EXE</i> files</h2> <p>The Perl executables can be easily rebuilt at any moment. Moreover, one can use the <i>embedding</i> interface (see <a href="perlembed">perlembed</a>) to make very customized executables.</p> <h3 id="Making-executables-with-a-custom-collection-of-statically-loaded-extensions">Making executables with a custom collection of statically loaded extensions</h3> <p>It is a little bit easier to do so while <i>decreasing</i> the list of statically loaded extensions. We discuss this case only here.</p> <dl> <dt>1.</dt>
<dd> <p>Change to an empty directory, and create a placeholder &lt;Makefile.PL&gt;:</p> <pre class="verbatim" data-language="perl">use ExtUtils::MakeMaker;
WriteMakefile NAME =&gt; 'dummy';
</pre>
</dd> <dt>2.</dt>
<dd> <p>Run it with the flavor of Perl (<i>perl.exe</i> or <i>perl_.exe</i>) you want to rebuild.</p> <pre class="verbatim" data-language="perl">perl_ Makefile.PL
</pre>
</dd> <dt>3.</dt>
<dd> <p>Ask it to create new Perl executable:</p> <pre class="verbatim" data-language="perl">make perl
</pre>
<p>(you may need to manually add <code class="inline"><span class="w">PERLTYPE</span>=-<span class="w">DPERL_CORE</span></code> to this commandline on some versions of Perl; the symptom is that the command-line globbing does not work from OS/2 shells with the newly-compiled executable; check with</p> <pre class="verbatim" data-language="perl">.\perl.exe -wle "print for @ARGV" *
</pre>
<p>).</p> </dd> <dt>4.</dt>
<dd> <p>The previous step created <i>perlmain.c</i> which contains a list of newXS() calls near the end. Removing unnecessary calls, and rerunning</p> <pre class="verbatim" data-language="perl">make perl
</pre>
<p>will produce a customized executable.</p> </dd> </dl> <h3 id="Making-executables-with-a-custom-search-paths">Making executables with a custom search-paths</h3> <p>The default perl executable is flexible enough to support most usages. However, one may want something yet more flexible; for example, one may want to find Perl DLL relatively to the location of the EXE file; or one may want to ignore the environment when setting the Perl-library search patch, etc.</p> <p>If you fill comfortable with <i>embedding</i> interface (see <a href="perlembed">perlembed</a>), such things are easy to do repeating the steps outlined in <a href="#Making-executables-with-a-custom-collection-of-statically-loaded-extensions">Making executables with a custom collection of statically loaded extensions</a>, and doing more comprehensive edits to main() of <i>perlmain.c</i>. The people with little desire to understand Perl can just rename main(), and do necessary modification in a custom main() which calls the renamed function in appropriate time.</p> <p>However, there is a third way: perl DLL exports the main() function and several callbacks to customize the search path. Below is a complete example of a "Perl loader" which</p> <dl> <dt>1.</dt>
<dd> <p>Looks for Perl DLL in the directory <code class="inline">$exedir/../dll</code>;</p> </dd> <dt>2.</dt>
<dd> <p>Prepends the above directory to <code class="inline"><span class="w">BEGINLIBPATH</span></code> ;</p> </dd> <dt>3.</dt>
<dd> <p>Fails if the Perl DLL found via <code class="inline"><span class="w">BEGINLIBPATH</span></code> is different from what was loaded on step 1; e.g., another process could have loaded it from <code class="inline"><span class="w">LIBPATH</span></code> or from a different value of <code class="inline"><span class="w">BEGINLIBPATH</span></code> . In these cases one needs to modify the setting of the system so that this other process either does not run, or loads the DLL from <code class="inline"><span class="w">BEGINLIBPATH</span></code> with <code class="inline"><span class="w">LIBPATHSTRICT</span>=<span class="w">T</span></code> (available with kernels after September 2000).</p> </dd> <dt>4.</dt>
<dd> <p>Loads Perl library from <code class="inline">$exedir/../dll/lib/</code>.</p> </dd> <dt>5.</dt>
<dd> <p>Uses Bourne shell from <code class="inline">$exedir/../dll/sh/ksh.exe</code>.</p> </dd> </dl> <p>For best results compile the C file below with the same options as the Perl DLL. However, a lot of functionality will work even if the executable is not an EMX applications, e.g., if compiled with</p> <pre class="verbatim" data-language="perl">gcc -Wall -DDOSISH -DOS2=1 -O2 -s -Zomf -Zsys perl-starter.c \
  -DPERL_DLL_BASENAME=\"perl312F\" -Zstack 8192 -Zlinker /PM:VIO
</pre>
<p>Here is the sample C file:</p> <pre class="verbatim" data-language="perl">#define INCL_DOS
#define INCL_NOPM
/* These are needed for compile if os2.h includes os2tk.h, not os2emx.h */
#define INCL_DOSPROCESS
#include &lt;os2.h&gt;

#include "EXTERN.h"
#define PERL_IN_MINIPERLMAIN_C
#include "perl.h"

static char *me;
HMODULE handle;

static void
die_with(char *msg1, char *msg2, char *msg3, char *msg4)
{
   ULONG c;
   char *s = " error: ";

        DosWrite(2, me, strlen(me), &amp;c);
        DosWrite(2, s, strlen(s), &amp;c);
        DosWrite(2, msg1, strlen(msg1), &amp;c);
        DosWrite(2, msg2, strlen(msg2), &amp;c);
        DosWrite(2, msg3, strlen(msg3), &amp;c);
        DosWrite(2, msg4, strlen(msg4), &amp;c);
        DosWrite(2, "\r\n", 2, &amp;c);
        exit(255);
  }

  typedef ULONG (*fill_extLibpath_t)(int type, char *pre, char *post, int replace, char *msg);
  typedef int (*main_t)(int type, char *argv[], char *env[]);
  typedef int (*handler_t)(void* data, int which);

  #ifndef PERL_DLL_BASENAME
  #  define PERL_DLL_BASENAME "perl"
  #endif

  static HMODULE
  load_perl_dll(char *basename)
  {
          char buf[300], fail[260];
          STRLEN l, dirl;
          fill_extLibpath_t f;
          ULONG rc_fullname;
          HMODULE handle, handle1;

          if (_execname(buf, sizeof(buf) - 13) != 0)
                  die_with("Can't find full path: ", strerror(errno), "", "");
          /* XXXX Fill 'me' with new value */
          l = strlen(buf);
    while (l &amp;&amp; buf[l-1] != '/' &amp;&amp; buf[l-1] != '\\')
        l--;
    dirl = l - 1;
    strcpy(buf + l, basename);
    l += strlen(basename);
    strcpy(buf + l, ".dll");
    if ( (rc_fullname = DosLoadModule(fail, sizeof fail, buf, &amp;handle)) != 0
         &amp;&amp; DosLoadModule(fail, sizeof fail, basename, &amp;handle) != 0 )
        die_with("Can't load DLL ", buf, "", "");
    if (rc_fullname)
        return handle;		/* was loaded with short name; all is fine */
    if (DosQueryProcAddr(handle, 0, "fill_extLibpath", (PFN*)&amp;f))
        die_with(buf, ": DLL exports no symbol ", "fill_extLibpath", "");
    buf[dirl] = 0;
    if (f(0 /*BEGINLIBPATH*/, buf /* prepend */, NULL /* append */,
                      0 /* keep old value */, me))
                  die_with(me, ": prepending BEGINLIBPATH", "", "");
          if (DosLoadModule(fail, sizeof fail, basename, &amp;handle1) != 0)
                  die_with(me, ": finding perl DLL again via BEGINLIBPATH", "", "");
          buf[dirl] = '\\';     
          if (handle1 != handle) {
                  if (DosQueryModuleName(handle1, sizeof(fail), fail))
                          strcpy(fail, "???");
                  die_with(buf, ":\n\tperl DLL via BEGINLIBPATH is different: \n\t",
                                    fail,
                                    "\n\tYou may need to manipulate global BEGINLIBPATH and LIBPATHSTRICT"
                                    "\n\tso that the other copy is loaded via BEGINLIBPATH.");
          }
          return handle;
  }

  int
  main(int argc, char **argv, char **env)
  {
          main_t f;
          handler_t h;

          me = argv[0];
          /**/
          handle = load_perl_dll(PERL_DLL_BASENAME);

          if (DosQueryProcAddr(handle, 0, "Perl_OS2_handler_install", (PFN*)&amp;h))
                  die_with(PERL_DLL_BASENAME, ": DLL exports no symbol ", "Perl_OS2_handler_install", "");
          if ( !h((void *)"~installprefix", Perlos2_handler_perllib_from)
                    || !h((void *)"~dll", Perlos2_handler_perllib_to)
                    || !h((void *)"~dll/sh/ksh.exe", Perlos2_handler_perl_sh) )
                  die_with(PERL_DLL_BASENAME, ": Can't install @INC manglers", "", "");

          if (DosQueryProcAddr(handle, 0, "dll_perlmain", (PFN*)&amp;f))
                  die_with(PERL_DLL_BASENAME, ": DLL exports no symbol ", "dll_perlmain", "");
          return f(argc, argv, env);
  }
</pre>
<h2 id="Build-FAQ">Build FAQ</h2> <h3 id="Some-%2f-became-%5c-in-pdksh.">Some <code class="inline">/</code> became <code class="inline">\</code> in pdksh.</h3> <p>You have a very old pdksh. See <a href="#Prerequisites">Prerequisites</a>.</p> <h3 id="'errno'---unresolved-external">
<code class="inline"><span class="q">'errno'</span></code> - unresolved external</h3> <p>You do not have MT-safe <i>db.lib</i>. See <a href="#Prerequisites">Prerequisites</a>.</p> <h3 id="Problems-with-tr-or-sed">Problems with tr or sed</h3> <p>reported with very old version of tr and sed.</p> <h3 id="Some-problem-(forget-which-%3b-)">Some problem (forget which ;-)</h3> <p>You have an older version of <i>perl.dll</i> on your LIBPATH, which broke the build of extensions.</p> <h3 id="Library-...-not-found">Library ... not found</h3> <p>You did not run <code class="inline"><span class="w">omflibs</span></code> . See <a href="#Prerequisites">Prerequisites</a>.</p> <h3 id="Segfault-in-make">Segfault in make</h3> <p>You use an old version of GNU make. See <a href="#Prerequisites">Prerequisites</a>.</p> <h3 id="op%2fsprintf-test-failure">op/sprintf test failure</h3> <p>This can result from a bug in emx sprintf which was fixed in 0.9d fix 03.</p> <h2 id="Specific-(mis)features-of-OS%2f2-port">Specific (mis)features of OS/2 port</h2> <h3 id="setpriority%2c-getpriority">
<code class="inline"><a class="l_k" href="functions/setpriority">setpriority</a></code>, <code class="inline"><a class="l_k" href="functions/getpriority">getpriority</a></code>
</h3> <p>Note that these functions are compatible with *nix, not with the older ports of '94 - 95. The priorities are absolute, go from 32 to -95, lower is quicker. 0 is the default priority.</p> <p><b>WARNING</b>. Calling <code class="inline"><a class="l_k" href="functions/getpriority">getpriority</a></code> on a non-existing process could lock the system before Warp3 fixpak22. Starting with Warp3, Perl will use a workaround: it aborts getpriority() if the process is not present. This is not possible on older versions <code class="inline"><span class="n">2.</span>*</code> , and has a race condition anyway.</p> <h3 id="system()"><code class="inline"><a class="l_k" href="functions/system">system()</a></code></h3> <p>Multi-argument form of <code class="inline"><a class="l_k" href="functions/system">system()</a></code> allows an additional numeric argument. The meaning of this argument is described in <a href="http://search.cpan.org/perldoc/OS2::Process">OS2::Process</a>.</p> <p>When finding a program to run, Perl first asks the OS to look for executables on <code class="inline"><span class="w">PATH</span></code> (OS/2 adds extension <i>.exe</i> if no extension is present). If not found, it looks for a script with possible extensions added in this order: no extension, <i>.cmd</i>, <i>.btm</i>, <i>.bat</i>, <i>.pl</i>. If found, Perl checks the start of the file for magic strings <code class="inline"><span class="q">"#!"</span></code> and <code class="inline"><span class="q">"extproc "</span></code> . If found, Perl uses the rest of the first line as the beginning of the command line to run this script. The only mangling done to the first line is extraction of arguments (currently up to 3), and ignoring of the path-part of the "interpreter" name if it can't be found using the full path.</p> <p>E.g., <code class="inline"><a class="l_k" href="functions/system">system</a> <span class="q">'foo'</span><span class="cm">,</span> <span class="q">'bar'</span><span class="cm">,</span> <span class="q">'baz'</span></code> may lead Perl to finding <i>C:/emx/bin/foo.cmd</i> with the first line being</p> <pre class="verbatim" data-language="perl">extproc /bin/bash    -x   -c
</pre>
<p>If <i>/bin/bash.exe</i> is not found, then Perl looks for an executable <i>bash.exe</i> on <code class="inline"><span class="w">PATH</span></code> . If found in <i>C:/emx.add/bin/bash.exe</i>, then the above system() is translated to</p> <pre class="verbatim" data-language="perl">system qw(C:/emx.add/bin/bash.exe -x -c C:/emx/bin/foo.cmd bar baz)
</pre>
<p>One additional translation is performed: instead of <i>/bin/sh</i> Perl uses the hardwired-or-customized shell (see <code class="inline"><a href="#PERL_SH_DIR">PERL_SH_DIR</a></code>).</p> <p>The above search for "interpreter" is recursive: if <i>bash</i> executable is not found, but <i>bash.btm</i> is found, Perl will investigate its first line etc. The only hardwired limit on the recursion depth is implicit: there is a limit 4 on the number of additional arguments inserted before the actual arguments given to system(). In particular, if no additional arguments are specified on the "magic" first lines, then the limit on the depth is 4.</p> <p>If Perl finds that the found executable is of PM type when the current session is not, it will start the new process in a separate session of necessary type. Call via <code class="inline"><span class="w">OS2::Process</span></code> to disable this magic.</p> <p><b>WARNING</b>. Due to the described logic, you need to explicitly specify <i>.com</i> extension if needed. Moreover, if the executable <i>perl5.6.1</i> is requested, Perl will not look for <i>perl5.6.1.exe</i>. [This may change in the future.]</p> <h3 id="extproc-on-the-first-line">
<code class="inline"><span class="w">extproc</span></code> on the first line</h3> <p>If the first chars of a Perl script are <code class="inline"><span class="q">"extproc "</span></code> , this line is treated as <code class="inline"><span class="c">#!</span></code> -line, thus all the switches on this line are processed (twice if script was started via cmd.exe). See <a href="perlrun#DESCRIPTION">DESCRIPTION in perlrun</a>.</p> <h3 id="Additional-modules%3a">Additional modules:</h3> <p><a href="http://search.cpan.org/perldoc/OS2::Process">OS2::Process</a>, <a href="http://search.cpan.org/perldoc/OS2::DLL">OS2::DLL</a>, <a href="http://search.cpan.org/perldoc/OS2::REXX">OS2::REXX</a>, <a href="http://search.cpan.org/perldoc/OS2::PrfDB">OS2::PrfDB</a>, <a href="http://search.cpan.org/perldoc/OS2::ExtAttr">OS2::ExtAttr</a>. These modules provide access to additional numeric argument for <code class="inline"><a class="l_k" href="functions/system">system</a></code> and to the information about the running process, to DLLs having functions with REXX signature and to the REXX runtime, to OS/2 databases in the <i>.INI</i> format, and to Extended Attributes.</p> <p>Two additional extensions by Andreas Kaiser, <code class="inline"><span class="w">OS2::UPM</span></code> , and <code class="inline"><span class="w">OS2::FTP</span></code> , are included into <code class="inline"><span class="w">ILYAZ</span></code> directory, mirrored on CPAN. Other OS/2-related extensions are available too.</p> <h3 id="Prebuilt-methods%3a">Prebuilt methods:</h3> <ul> <li id="File%3a%3aCopy%3a%3asyscopy">
<b><code class="inline"><span class="w">File::Copy::syscopy</span></code> </b> <p>used by <code class="inline"><span class="w">File::Copy::copy</span></code> , see <a href="file/copy">File::Copy</a>.</p> </li> <li id="DynaLoader%3a%3amod2fname">
<b><code class="inline"><span class="w">DynaLoader::mod2fname</span></code> </b> <p>used by <code class="inline"><span class="w">DynaLoader</span></code> for DLL name mangling.</p> </li> <li id="Cwd%3a%3acurrent_drive()">
<b><code class="inline"><span class="i">Cwd::current_drive</span><span class="s">(</span><span class="s">)</span></code> </b> <p>Self explanatory.</p> </li> <li id="Cwd%3a%3asys_chdir(name)">
<b><code class="inline"><span class="i">Cwd::sys_chdir</span><span class="s">(</span><span class="w">name</span><span class="s">)</span></code> </b> <p>leaves drive as it is.</p> </li> <li id="Cwd%3a%3achange_drive(name)">
<b><code class="inline"><span class="i">Cwd::change_drive</span><span class="s">(</span><span class="w">name</span><span class="s">)</span></code> </b> <p>changes the "current" drive.</p> </li> <li id="Cwd%3a%3asys_is_absolute(name)">
<b><code class="inline"><span class="i">Cwd::sys_is_absolute</span><span class="s">(</span><span class="w">name</span><span class="s">)</span></code> </b> <p>means has drive letter and is_rooted.</p> </li> <li id="Cwd%3a%3asys_is_rooted(name)">
<b><code class="inline"><span class="i">Cwd::sys_is_rooted</span><span class="s">(</span><span class="w">name</span><span class="s">)</span></code> </b> <p>means has leading <code class="inline">[/\\]</code> (maybe after a drive-letter:).</p> </li> <li id="Cwd%3a%3asys_is_relative(name)">
<b><code class="inline"><span class="i">Cwd::sys_is_relative</span><span class="s">(</span><span class="w">name</span><span class="s">)</span></code> </b> <p>means changes with current dir.</p> </li> <li id="Cwd%3a%3asys_cwd(name)">
<b><code class="inline"><span class="i">Cwd::sys_cwd</span><span class="s">(</span><span class="w">name</span><span class="s">)</span></code> </b> <p>Interface to cwd from EMX. Used by <code class="inline"><span class="w">Cwd::cwd</span></code> .</p> </li> <li id="Cwd%3a%3asys_abspath(name%2c-dir)">
<b><code class="inline"><span class="i">Cwd::sys_abspath</span><span class="s">(</span><span class="w">name</span><span class="cm">,</span> <span class="w">dir</span><span class="s">)</span></code> </b> <p>Really really odious function to implement. Returns absolute name of file which would have <code class="inline"><span class="w">name</span></code> if CWD were <code class="inline"><span class="w">dir</span></code> . <code class="inline"><span class="w">Dir</span></code> defaults to the current dir.</p> </li> <li id="Cwd%3a%3aextLibpath(%5btype%5d)">
<b><code class="inline"><span class="i">Cwd::extLibpath</span><span class="s">(</span><span class="s">[</span><span class="w">type</span><span class="s">]</span><span class="s">)</span></code> </b> <p>Get current value of extended library search path. If <code class="inline"><span class="w">type</span></code> is present and positive, works with <code class="inline"><span class="w">END_LIBPATH</span></code> , if negative, works with <code class="inline"><span class="w">LIBPATHSTRICT</span></code> , otherwise with <code class="inline"><span class="w">BEGIN_LIBPATH</span></code> .</p> </li> <li id="Cwd%3a%3aextLibpath_set(-path-%5b%2c-type-%5d-)">
<b><code class="inline"><span class="i">Cwd::extLibpath_set</span><span class="s">(</span> <span class="w">path</span> <span class="s">[</span><span class="cm">,</span> <span class="w">type</span> <span class="s">]</span> <span class="s">)</span></code> </b> <p>Set current value of extended library search path. If <code class="inline"><span class="w">type</span></code> is present and positive, works with &lt;END_LIBPATH&gt;, if negative, works with <code class="inline"><span class="w">LIBPATHSTRICT</span></code> , otherwise with <code class="inline"><span class="w">BEGIN_LIBPATH</span></code> .</p> </li> <li id="OS2%3a%3aError(do_harderror%2cdo_exception)">
<b><code class="inline"><span class="i">OS2::Error</span><span class="s">(</span><span class="w">do_harderror</span><span class="cm">,</span><span class="w">do_exception</span><span class="s">)</span></code> </b> <p>Returns <code class="inline"><a class="l_k" href="functions/undef">undef</a></code> if it was not called yet, otherwise bit 1 is set if on the previous call do_harderror was enabled, bit 2 is set if on previous call do_exception was enabled.</p> <p>This function enables/disables error popups associated with hardware errors (Disk not ready etc.) and software exceptions.</p> <p>I know of no way to find out the state of popups <i>before</i> the first call to this function.</p> </li> <li id="OS2%3a%3aErrors2Drive(drive)">
<b><code class="inline"><span class="i">OS2::Errors2Drive</span><span class="s">(</span><span class="w">drive</span><span class="s">)</span></code> </b> <p>Returns <code class="inline"><a class="l_k" href="functions/undef">undef</a></code> if it was not called yet, otherwise return false if errors were not requested to be written to a hard drive, or the drive letter if this was requested.</p> <p>This function may redirect error popups associated with hardware errors (Disk not ready etc.) and software exceptions to the file POPUPLOG.OS2 at the root directory of the specified drive. Overrides OS2::Error() specified by individual programs. Given argument undef will disable redirection.</p> <p>Has global effect, persists after the application exits.</p> <p>I know of no way to find out the state of redirection of popups to the disk <i>before</i> the first call to this function.</p> </li> <li id="OS2%3a%3aSysInfo()">
<b>OS2::SysInfo()</b> <p>Returns a hash with system information. The keys of the hash are</p> <pre class="verbatim" data-language="perl">MAX_PATH_LENGTH, MAX_TEXT_SESSIONS, MAX_PM_SESSIONS,
MAX_VDM_SESSIONS, BOOT_DRIVE, DYN_PRI_VARIATION,
MAX_WAIT, MIN_SLICE, MAX_SLICE, PAGE_SIZE,
VERSION_MAJOR, VERSION_MINOR, VERSION_REVISION,
MS_COUNT, TIME_LOW, TIME_HIGH, TOTPHYSMEM, TOTRESMEM,
TOTAVAILMEM, MAXPRMEM, MAXSHMEM, TIMER_INTERVAL,
MAX_COMP_LENGTH, FOREGROUND_FS_SESSION,
FOREGROUND_PROCESS
</pre>
</li> <li id="OS2%3a%3aBootDrive()">
<b>OS2::BootDrive()</b> <p>Returns a letter without colon.</p> </li> <li id="OS2%3a%3aMorphPM(serve)%2c-OS2%3a%3aUnMorphPM(serve)">
<b><code class="inline"><span class="i">OS2::MorphPM</span><span class="s">(</span><span class="w">serve</span><span class="s">)</span></code> , <code class="inline"><span class="i">OS2::UnMorphPM</span><span class="s">(</span><span class="w">serve</span><span class="s">)</span></code> </b> <p>Transforms the current application into a PM application and back. The argument true means that a real message loop is going to be served. OS2::MorphPM() returns the PM message queue handle as an integer.</p> <p>See <a href="#Centralized-management-of-resources">Centralized management of resources</a> for additional details.</p> </li> <li id="OS2%3a%3aServe_Messages(force)">
<b><code class="inline"><span class="i">OS2::Serve_Messages</span><span class="s">(</span><span class="w">force</span><span class="s">)</span></code> </b> <p>Fake on-demand retrieval of outstanding PM messages. If <code class="inline"><span class="w">force</span></code> is false, will not dispatch messages if a real message loop is known to be present. Returns number of messages retrieved.</p> <p>Dies with "QUITing..." if WM_QUIT message is obtained.</p> </li> <li id="OS2%3a%3aProcess_Messages(force-%5b%2c-cnt%5d)">
<b><code class="inline"><span class="i">OS2::Process_Messages</span><span class="s">(</span><span class="w">force</span> <span class="s">[</span><span class="cm">,</span> <span class="w">cnt</span><span class="s">]</span><span class="s">)</span></code> </b> <p>Retrieval of PM messages until window creation/destruction. If <code class="inline"><span class="w">force</span></code> is false, will not dispatch messages if a real message loop is known to be present.</p> <p>Returns change in number of windows. If <code class="inline"><span class="w">cnt</span></code> is given, it is incremented by the number of messages retrieved.</p> <p>Dies with "QUITing..." if WM_QUIT message is obtained.</p> </li> <li id="OS2%3a%3a_control87(new%2cmask)">
<b><code class="inline"><span class="i">OS2::_control87</span><span class="s">(</span><span class="w">new</span><span class="cm">,</span><span class="w">mask</span><span class="s">)</span></code> </b> <p>the same as <i>_control87(3)</i> of EMX. Takes integers as arguments, returns the previous coprocessor control word as an integer. Only bits in <code class="inline"><span class="w">new</span></code> which are present in <code class="inline"><span class="w">mask</span></code> are changed in the control word.</p> </li> <li id="OS2%3a%3aget_control87()">
<b>OS2::get_control87()</b> <p>gets the coprocessor control word as an integer.</p> </li> <li id="OS2%3a%3aset_control87_em(new%3dMCW_EM%2cmask%3dMCW_EM)">
<b><code class="inline"><span class="i">OS2::set_control87_em</span><span class="s">(</span><span class="w">new</span>=<span class="w">MCW_EM</span><span class="cm">,</span><span class="w">mask</span>=<span class="w">MCW_EM</span><span class="s">)</span></code> </b> <p>The variant of OS2::_control87() with default values good for handling exception mask: if no <code class="inline"><span class="w">mask</span></code> , uses exception mask part of <code class="inline"><span class="w">new</span></code> only. If no <code class="inline"><span class="w">new</span></code> , disables all the floating point exceptions.</p> <p>See <a href="#Misfeatures">Misfeatures</a> for details.</p> </li> <li id="OS2%3a%3aDLLname(%5bhow-%5b%2c-%5c%26xsub%5d%5d)">
<b><code class="inline"><span class="i">OS2::DLLname</span><span class="s">(</span><span class="s">[</span><span class="w">how</span> <span class="s">[</span><span class="cm">,</span> \<span class="i">&amp;xsub</span><span class="s">]</span><span class="s">]</span><span class="s">)</span></code> </b> <p>Gives the information about the Perl DLL or the DLL containing the C function bound to by <code class="inline"><span class="i">&amp;xsub</span></code> . The meaning of <code class="inline"><span class="w">how</span></code> is: default (2): full name; 0: handle; 1: module name.</p> </li> </ul> <p>(Note that some of these may be moved to different libraries - eventually).</p> <h3 id="Prebuilt-variables%3a">Prebuilt variables:</h3> <ul> <li id="%24OS2%3a%3aemx_rev">
<b>$OS2::emx_rev</b> <p>numeric value is the same as _emx_rev of EMX, a string value the same as _emx_vprt (similar to <code class="inline">0.9c</code>).</p> </li> <li id="%24OS2%3a%3aemx_env">
<b>$OS2::emx_env</b> <p>same as _emx_env of EMX, a number similar to 0x8001.</p> </li> <li id="%24OS2%3a%3aos_ver">
<b>$OS2::os_ver</b> <p>a number <code class="inline"><span class="w">OS_MAJOR</span> + <span class="n">0.001</span> * <span class="w">OS_MINOR</span></code> .</p> </li> <li id="%24OS2%3a%3ais_aout">
<b>$OS2::is_aout</b> <p>true if the Perl library was compiled in AOUT format.</p> </li> <li id="%24OS2%3a%3acan_fork">
<b>$OS2::can_fork</b> <p>true if the current executable is an AOUT EMX executable, so Perl can fork. Do not use this, use the portable check for $Config::Config{dfork}.</p> </li> <li id="%24OS2%3a%3ansyserror">
<b>$OS2::nsyserror</b> <p>This variable (default is 1) controls whether to enforce the contents of $^E to start with <code class="inline"><span class="w">SYS0003</span></code> -like id. If set to 0, then the string value of $^E is what is available from the OS/2 message file. (Some messages in this file have an <code class="inline"><span class="w">SYS0003</span></code> -like id prepended, some not.)</p> </li> </ul> <h3 id="Misfeatures">Misfeatures</h3> <ul> <li> <p>Since <i>flock(3)</i> is present in EMX, but is not functional, it is emulated by perl. To disable the emulations, set environment variable <code class="inline"><span class="w">USE_PERL_FLOCK</span>=<span class="n">0</span></code> .</p> </li> <li> <p>Here is the list of things which may be "broken" on EMX (from EMX docs):</p> <ul> <li> <p>The functions <i>recvmsg(3)</i>, <i>sendmsg(3)</i>, and <i>socketpair(3)</i> are not implemented.</p> </li> <li> <p><i>sock_init(3)</i> is not required and not implemented.</p> </li> <li> <p><i>flock(3)</i> is not yet implemented (dummy function). (Perl has a workaround.)</p> </li> <li> <p><i>kill(3)</i>: Special treatment of PID=0, PID=1 and PID=-1 is not implemented.</p> </li> <li> <p><i>waitpid(3)</i>:</p> <pre class="verbatim" data-language="perl">      WUNTRACED
Not implemented.
      waitpid() is not implemented for negative values of PID.
</pre>
</li> </ul> <p>Note that <code class="inline"><a class="l_k" href="functions/kill">kill</a> <span class="n">-9</span></code> does not work with the current version of EMX.</p> </li> <li> <p>See <a href="#Text-mode-filehandles">Text-mode filehandles</a>.</p> </li> <li> <p>Unix-domain sockets on OS/2 live in a pseudo-file-system <code class="inline"><span class="q">/sockets/</span>...</code> . To avoid a failure to create a socket with a name of a different form, <code class="inline"><span class="q">"/socket/"</span></code> is prepended to the socket name (unless it starts with this already).</p> <p>This may lead to problems later in case the socket is accessed via the "usual" file-system calls using the "initial" name.</p> </li> <li> <p>Apparently, IBM used a compiler (for some period of time around '95?) which changes FP mask right and left. This is not <i>that</i> bad for IBM's programs, but the same compiler was used for DLLs which are used with general-purpose applications. When these DLLs are used, the state of floating-point flags in the application is not predictable.</p> <p>What is much worse, some DLLs change the floating point flags when in _DLLInitTerm() (e.g., <i>TCP32IP</i>). This means that even if you do not <i>call</i> any function in the DLL, just the act of loading this DLL will reset your flags. What is worse, the same compiler was used to compile some HOOK DLLs. Given that HOOK dlls are executed in the context of <i>all</i> the applications in the system, this means a complete unpredictability of floating point flags on systems using such HOOK DLLs. E.g., <i>GAMESRVR.DLL</i> of <b>DIVE</b> origin changes the floating point flags on each write to the TTY of a VIO (windowed text-mode) applications.</p> <p>Some other (not completely debugged) situations when FP flags change include some video drivers (?), and some operations related to creation of the windows. People who code <b>OpenGL</b> may have more experience on this.</p> <p>Perl is generally used in the situation when all the floating-point exceptions are ignored, as is the default under EMX. If they are not ignored, some benign Perl programs would get a <code class="inline"><span class="w">SIGFPE</span></code> and would die a horrible death.</p> <p>To circumvent this, Perl uses two hacks. They help against <i>one</i> type of damage only: FP flags changed when loading a DLL.</p> <p>One of the hacks is to disable floating point exceptions on Perl startup (as is the default with EMX). This helps only with compile-time-linked DLLs changing the flags before main() had a chance to be called.</p> <p>The other hack is to restore FP flags after a call to dlopen(). This helps against similar damage done by DLLs _DLLInitTerm() at runtime. Currently no way to switch these hacks off is provided.</p> </li> </ul> <h3 id="Modifications">Modifications</h3> <p>Perl modifies some standard C library calls in the following ways:</p> <ul> <li id="popen">
<b><code class="inline"><span class="w">popen</span></code> </b> <p><code class="inline"><span class="w">my_popen</span></code> uses <i>sh.exe</i> if shell is required, cf. <a href="#PERL_SH_DIR">PERL_SH_DIR</a>.</p> </li> <li id="tmpnam">
<b><code class="inline"><span class="w">tmpnam</span></code> </b> <p>is created using <code class="inline"><span class="w">TMP</span></code> or <code class="inline"><span class="w">TEMP</span></code> environment variable, via <code class="inline"><span class="w">tempnam</span></code> .</p> </li> <li id="tmpfile">
<b><code class="inline"><span class="w">tmpfile</span></code> </b> <p>If the current directory is not writable, file is created using modified <code class="inline"><span class="w">tmpnam</span></code> , so there may be a race condition.</p> </li> <li id="ctermid">
<b><code class="inline"><span class="w">ctermid</span></code> </b> <p>a dummy implementation.</p> </li> <li id="stat">
<b><code class="inline"><a class="l_k" href="functions/stat">stat</a></code></b> <p><code class="inline"><span class="w">os2_stat</span></code> special-cases <i>/dev/tty</i> and <i>/dev/con</i>.</p> </li> <li id="mkdir%2c-rmdir">
<b><code class="inline"><a class="l_k" href="functions/mkdir">mkdir</a></code>, <code class="inline"><a class="l_k" href="functions/rmdir">rmdir</a></code></b> <p>these EMX functions do not work if the path contains a trailing <code class="inline">/</code>. Perl contains a workaround for this.</p> </li> <li id="flock">
<b><code class="inline"><a class="l_k" href="functions/flock">flock</a></code></b> <p>Since <i>flock(3)</i> is present in EMX, but is not functional, it is emulated by perl. To disable the emulations, set environment variable <code class="inline"><span class="w">USE_PERL_FLOCK</span>=<span class="n">0</span></code> .</p> </li> </ul> <h3 id="Identifying-DLLs">Identifying DLLs</h3> <p>All the DLLs built with the current versions of Perl have ID strings identifying the name of the extension, its version, and the version of Perl required for this DLL. Run <code class="inline"><span class="w">bldlevel</span> <span class="w">DLL</span>-<span class="w">name</span></code> to find this info.</p> <h3 id="Centralized-management-of-resources">Centralized management of resources</h3> <p>Since to call certain OS/2 API one needs to have a correctly initialized <code class="inline"><span class="w">Win</span></code> subsystem, OS/2-specific extensions may require getting <code class="inline"><span class="w">HAB</span></code> s and <code class="inline"><span class="w">HMQ</span></code> s. If an extension would do it on its own, another extension could fail to initialize.</p> <p>Perl provides a centralized management of these resources:</p> <ul> <li id="HAB">
<b><code class="inline"><span class="w">HAB</span></code> </b> <p>To get the HAB, the extension should call <code class="inline"><span class="w">hab</span> = <span class="i">perl_hab_GET</span><span class="s">(</span><span class="s">)</span></code> in C. After this call is performed, <code class="inline"><span class="w">hab</span></code> may be accessed as <code class="inline"><span class="w">Perl_hab</span></code> . There is no need to release the HAB after it is used.</p> <p>If by some reasons <i>perl.h</i> cannot be included, use</p> <pre class="verbatim" data-language="perl">extern int Perl_hab_GET(void);
</pre>
<p>instead.</p> </li> <li id="HMQ">
<b><code class="inline"><span class="w">HMQ</span></code> </b> <p>There are two cases:</p> <ul> <li> <p>the extension needs an <code class="inline"><span class="w">HMQ</span></code> only because some API will not work otherwise. Use <code class="inline"><span class="w">serve</span> = <span class="n">0</span></code> below.</p> </li> <li> <p>the extension needs an <code class="inline"><span class="w">HMQ</span></code> since it wants to engage in a PM event loop. Use <code class="inline"><span class="w">serve</span> = <span class="n">1</span></code> below.</p> </li> </ul> <p>To get an <code class="inline"><span class="w">HMQ</span></code> , the extension should call <code class="inline"><span class="w">hmq</span> = <span class="i">perl_hmq_GET</span><span class="s">(</span><span class="w">serve</span><span class="s">)</span></code> in C. After this call is performed, <code class="inline"><span class="w">hmq</span></code> may be accessed as <code class="inline"><span class="w">Perl_hmq</span></code> .</p> <p>To signal to Perl that HMQ is not needed any more, call <code class="inline"><span class="i">perl_hmq_UNSET</span><span class="s">(</span><span class="w">serve</span><span class="s">)</span></code> . Perl process will automatically morph/unmorph itself into/from a PM process if HMQ is needed/not-needed. Perl will automatically enable/disable <code class="inline"><span class="w">WM_QUIT</span></code> message during shutdown if the message queue is served/not-served.</p> <p><b>NOTE</b>. If during a shutdown there is a message queue which did not disable WM_QUIT, and which did not process the received WM_QUIT message, the shutdown will be automatically cancelled. Do not call <code class="inline"><span class="i">perl_hmq_GET</span><span class="s">(</span><span class="n">1</span><span class="s">)</span></code> unless you are going to process messages on an orderly basis.</p> </li> <li id="Treating-errors-reported-by-OS%2f2-API">
<b>Treating errors reported by OS/2 API</b> <p>There are two principal conventions (it is useful to call them <code class="inline"><span class="w">Dos</span>*</code> and <code class="inline"><span class="w">Win</span>*</code> - though this part of the function signature is not always determined by the name of the API) of reporting the error conditions of OS/2 API. Most of <code class="inline"><span class="w">Dos</span>*</code> APIs report the error code as the result of the call (so 0 means success, and there are many types of errors). Most of <code class="inline"><span class="w">Win</span>*</code> API report success/fail via the result being <code class="inline"><span class="w">TRUE</span></code> /<code class="inline"><span class="w">FALSE</span></code> ; to find the reason for the failure one should call WinGetLastError() API.</p> <p>Some <code class="inline"><span class="w">Win</span>*</code> entry points also overload a "meaningful" return value with the error indicator; having a 0 return value indicates an error. Yet some other <code class="inline"><span class="w">Win</span>*</code> entry points overload things even more, and 0 return value may mean a successful call returning a valid value 0, as well as an error condition; in the case of a 0 return value one should call WinGetLastError() API to distinguish a successful call from a failing one.</p> <p>By convention, all the calls to OS/2 API should indicate their failures by resetting $^E. All the Perl-accessible functions which call OS/2 API may be broken into two classes: some die()s when an API error is encountered, the other report the error via a false return value (of course, this does not concern Perl-accessible functions which <i>expect</i> a failure of the OS/2 API call, having some workarounds coded).</p> <p>Obviously, in the situation of the last type of the signature of an OS/2 API, it is must more convenient for the users if the failure is indicated by die()ing: one does not need to check $^E to know that something went wrong. If, however, this solution is not desirable by some reason, the code in question should reset $^E to 0 before making this OS/2 API call, so that the caller of this Perl-accessible function has a chance to distinguish a success-but-0-return value from a failure. (One may return undef as an alternative way of reporting an error.)</p> <p>The macros to simplify this type of error propagation are</p> <ul> <li id="CheckOSError(expr)">
<b><code class="inline"><span class="i">CheckOSError</span><span class="s">(</span><span class="w">expr</span><span class="s">)</span></code> </b> <p>Returns true on error, sets $^E. Expects expr() be a call of <code class="inline"><span class="w">Dos</span>*</code> -style API.</p> </li> <li id="CheckWinError(expr)">
<b><code class="inline"><span class="i">CheckWinError</span><span class="s">(</span><span class="w">expr</span><span class="s">)</span></code> </b> <p>Returns true on error, sets $^E. Expects expr() be a call of <code class="inline"><span class="w">Win</span>*</code> -style API.</p> </li> <li id="SaveWinError(expr)">
<b><code class="inline"><span class="i">SaveWinError</span><span class="s">(</span><span class="w">expr</span><span class="s">)</span></code> </b> <p>Returns <code class="inline"><span class="w">expr</span></code> , sets $^E from WinGetLastError() if <code class="inline"><span class="w">expr</span></code> is false.</p> </li> <li id="SaveCroakWinError(expr%2cdie%2cname1%2cname2)">
<b><code class="inline"><span class="i">SaveCroakWinError</span><span class="s">(</span><span class="w">expr</span><span class="cm">,</span><a class="l_k" href="functions/die">die</a><span class="cm">,</span><span class="w">name1</span><span class="cm">,</span><span class="w">name2</span><span class="s">)</span></code> </b> <p>Returns <code class="inline"><span class="w">expr</span></code> , sets $^E from WinGetLastError() if <code class="inline"><span class="w">expr</span></code> is false, and die()s if <code class="inline"><a class="l_k" href="functions/die">die</a></code> and $^E are true. The message to die is the concatenated strings <code class="inline"><span class="w">name1</span></code> and <code class="inline"><span class="w">name2</span></code> , separated by <code class="inline"><span class="q">": "</span></code> from the contents of $^E.</p> </li> <li id="WinError_2_Perl_rc">
<b><code class="inline"><span class="w">WinError_2_Perl_rc</span></code> </b> <p>Sets <code class="inline"><span class="w">Perl_rc</span></code> to the return value of WinGetLastError().</p> </li> <li id="FillWinError">
<b><code class="inline"><span class="w">FillWinError</span></code> </b> <p>Sets <code class="inline"><span class="w">Perl_rc</span></code> to the return value of WinGetLastError(), and sets $^E to the corresponding value.</p> </li> <li id="FillOSError(rc)">
<b><code class="inline"><span class="i">FillOSError</span><span class="s">(</span><span class="w">rc</span><span class="s">)</span></code> </b> <p>Sets <code class="inline"><span class="w">Perl_rc</span></code> to <code class="inline"><span class="w">rc</span></code> , and sets $^E to the corresponding value.</p> </li> </ul> </li> <li id="Loading-DLLs-and-ordinals-in-DLLs">
<b>Loading DLLs and ordinals in DLLs</b> <p>Some DLLs are only present in some versions of OS/2, or in some configurations of OS/2. Some exported entry points are present only in DLLs shipped with some versions of OS/2. If these DLLs and entry points were linked directly for a Perl executable/DLL or from a Perl extensions, this binary would work only with the specified versions/setups. Even if these entry points were not needed, the <i>load</i> of the executable (or DLL) would fail.</p> <p>For example, many newer useful APIs are not present in OS/2 v2; many PM-related APIs require DLLs not available on floppy-boot setup.</p> <p>To make these calls fail <i>only when the calls are executed</i>, one should call these API via a dynamic linking API. There is a subsystem in Perl to simplify such type of calls. A large number of entry points available for such linking is provided (see <code class="inline"><span class="w">entries_ordinals</span></code> - and also <code class="inline"><span class="w">PMWIN_entries</span></code> - in <i>os2ish.h</i>). These ordinals can be accessed via the APIs:</p> <pre class="verbatim" data-language="perl">CallORD(), DeclFuncByORD(), DeclVoidFuncByORD(),
DeclOSFuncByORD(), DeclWinFuncByORD(), AssignFuncPByORD(),
DeclWinFuncByORD_CACHE(), DeclWinFuncByORD_CACHE_survive(),
DeclWinFuncByORD_CACHE_resetError_survive(),
DeclWinFunc_CACHE(), DeclWinFunc_CACHE_resetError(),
DeclWinFunc_CACHE_survive(), DeclWinFunc_CACHE_resetError_survive()
</pre>
<p>See the header files and the C code in the supplied OS/2-related modules for the details on usage of these functions.</p> <p>Some of these functions also combine dynaloading semantic with the error-propagation semantic discussed above.</p> </li> </ul> <h2 id="Perl-flavors">Perl flavors</h2> <p>Because of idiosyncrasies of OS/2 one cannot have all the eggs in the same basket (though EMX environment tries hard to overcome this limitations, so the situation may somehow improve). There are 4 executables for Perl provided by the distribution:</p> <h3 id="_perl.exe_"><i>perl.exe</i></h3> <p>The main workhorse. This is a chimera executable: it is compiled as an <code class="inline"><span class="w">a</span>.<span class="w">out</span></code> -style executable, but is linked with <code class="inline"><span class="w">omf</span></code> -style dynamic library <i>perl.dll</i>, and with dynamic CRT DLL. This executable is a VIO application.</p> <p>It can load perl dynamic extensions, and it can fork().</p> <p><b>Note.</b> Keep in mind that fork() is needed to open a pipe to yourself.</p> <h3 id="_perl_.exe_"><i>perl_.exe</i></h3> <p>This is a statically linked <code class="inline"><span class="w">a</span>.<span class="w">out</span></code> -style executable. It cannot load dynamic Perl extensions. The executable supplied in binary distributions has a lot of extensions prebuilt, thus the above restriction is important only if you use custom-built extensions. This executable is a VIO application.</p> <p><i>This is the only executable with does not require OS/2.</i> The friends locked into <code class="inline"><span class="w">M</span><span class="i">$</span></code> world would appreciate the fact that this executable runs under DOS, Win0.3*, Win0.95 and WinNT with an appropriate extender. See <a href="#Other-OSes">Other OSes</a>.</p> <h3 id="_perl__.exe_"><i>perl__.exe</i></h3> <p>This is the same executable as <i>perl___.exe</i>, but it is a PM application.</p> <p><b>Note.</b> Usually (unless explicitly redirected during the startup) STDIN, STDERR, and STDOUT of a PM application are redirected to <i>nul</i>. However, it is possible to <i>see</i> them if you start <code class="inline"><span class="w">perl__</span>.<span class="w">exe</span></code> from a PM program which emulates a console window, like <i>Shell mode</i> of Emacs or EPM. Thus it <i>is possible</i> to use Perl debugger (see <a href="perldebug">perldebug</a>) to debug your PM application (but beware of the message loop lockups - this will not work if you have a message queue to serve, unless you hook the serving into the getc() function of the debugger).</p> <p>Another way to see the output of a PM program is to run it as</p> <pre class="verbatim" data-language="perl">pm_prog args 2&gt;&amp;1 | cat -
</pre>
<p>with a shell <i>different</i> from <i>cmd.exe</i>, so that it does not create a link between a VIO session and the session of <code class="inline"><span class="w">pm_porg</span></code> . (Such a link closes the VIO window.) E.g., this works with <i>sh.exe</i> - or with Perl!</p> <pre class="verbatim" data-language="perl">open P, 'pm_prog args 2&gt;&amp;1 |' or die;
print while &lt;P&gt;;
</pre>
<p>The flavor <i>perl__.exe</i> is required if you want to start your program without a VIO window present, but not <code class="inline"><span class="w">detach</span></code> ed (run <code class="inline"><span class="w">help</span> <span class="w">detach</span></code> for more info). Very useful for extensions which use PM, like <code class="inline"><span class="w">Perl</span>/<span class="w">Tk</span></code> or <code class="inline"><span class="w">OpenGL</span></code> .</p> <p>Note also that the differences between PM and VIO executables are only in the <i>default</i> behaviour. One can start <i>any</i> executable in <i>any</i> kind of session by using the arguments <code class="inline">/fs</code>, <code class="inline">/pm</code> or <code class="inline">/win</code> switches of the command <code class="inline"><span class="w">start</span></code> (of <i>CMD.EXE</i> or a similar shell). Alternatively, one can use the numeric first argument of the <code class="inline"><a class="l_k" href="functions/system">system</a></code> Perl function (see <a href="http://search.cpan.org/perldoc/OS2::Process">OS2::Process</a>).</p> <h3 id="_perl___.exe_"><i>perl___.exe</i></h3> <p>This is an <code class="inline"><span class="w">omf</span></code> -style executable which is dynamically linked to <i>perl.dll</i> and CRT DLL. I know no advantages of this executable over <code class="inline"><span class="w">perl</span>.<span class="w">exe</span></code> , but it cannot fork() at all. Well, one advantage is that the build process is not so convoluted as with <code class="inline"><span class="w">perl</span>.<span class="w">exe</span></code> .</p> <p>It is a VIO application.</p> <h3 id="Why-strange-names%3f">Why strange names?</h3> <p>Since Perl processes the <code class="inline"><span class="c">#!</span></code> -line (cf. <a href="perlrun#DESCRIPTION">DESCRIPTION in perlrun</a>, <a href="perlrun#Command-Switches">Command Switches in perlrun</a>, <a href="perldiag#No-Perl-script-found-in-input">No Perl script found in input in perldiag</a>), it should know when a program <i>is a Perl</i>. There is some naming convention which allows Perl to distinguish correct lines from wrong ones. The above names are almost the only names allowed by this convention which do not contain digits (which have absolutely different semantics).</p> <h3 id="Why-dynamic-linking%3f">Why dynamic linking?</h3> <p>Well, having several executables dynamically linked to the same huge library has its advantages, but this would not substantiate the additional work to make it compile. The reason is the complicated-to-developers but very quick and convenient-to-users "hard" dynamic linking used by OS/2.</p> <p>There are two distinctive features of the dyna-linking model of OS/2: first, all the references to external functions are resolved at the compile time; second, there is no runtime fixup of the DLLs after they are loaded into memory. The first feature is an enormous advantage over other models: it avoids conflicts when several DLLs used by an application export entries with the same name. In such cases "other" models of dyna-linking just choose between these two entry points using some random criterion - with predictable disasters as results. But it is the second feature which requires the build of <i>perl.dll</i>.</p> <p>The address tables of DLLs are patched only once, when they are loaded. The addresses of the entry points into DLLs are guaranteed to be the same for all the programs which use the same DLL. This removes the runtime fixup - once DLL is loaded, its code is read-only.</p> <p>While this allows some (significant?) performance advantages, this makes life much harder for developers, since the above scheme makes it impossible for a DLL to be "linked" to a symbol in the <i>.EXE</i> file. Indeed, this would need a DLL to have different relocations tables for the (different) executables which use this DLL.</p> <p>However, a dynamically loaded Perl extension is forced to use some symbols from the perl executable, e.g., to know how to find the arguments to the functions: the arguments live on the perl internal evaluation stack. The solution is to put the main code of the interpreter into a DLL, and make the <i>.EXE</i> file which just loads this DLL into memory and supplies command-arguments. The extension DLL cannot link to symbols in <i>.EXE</i>, but it has no problem linking to symbols in the <i>.DLL</i>.</p> <p>This <i>greatly</i> increases the load time for the application (as well as complexity of the compilation). Since interpreter is in a DLL, the C RTL is basically forced to reside in a DLL as well (otherwise extensions would not be able to use CRT). There are some advantages if you use different flavors of perl, such as running <i>perl.exe</i> and <i>perl__.exe</i> simultaneously: they share the memory of <i>perl.dll</i>.</p> <p><b>NOTE</b>. There is one additional effect which makes DLLs more wasteful: DLLs are loaded in the shared memory region, which is a scarse resource given the 512M barrier of the "standard" OS/2 virtual memory. The code of <i>.EXE</i> files is also shared by all the processes which use the particular <i>.EXE</i>, but they are "shared in the private address space of the process"; this is possible because the address at which different sections of the <i>.EXE</i> file are loaded is decided at compile-time, thus all the processes have these sections loaded at same addresses, and no fixup of internal links inside the <i>.EXE</i> is needed.</p> <p>Since DLLs may be loaded at run time, to have the same mechanism for DLLs one needs to have the address range of <i>any of the loaded</i> DLLs in the system to be available <i>in all the processes</i> which did not load a particular DLL yet. This is why the DLLs are mapped to the shared memory region.</p> <h3 id="Why-chimera-build%3f">Why chimera build?</h3> <p>Current EMX environment does not allow DLLs compiled using Unixish <code class="inline"><span class="w">a</span>.<span class="w">out</span></code> format to export symbols for data (or at least some types of data). This forces <code class="inline"><span class="w">omf</span></code> -style compile of <i>perl.dll</i>.</p> <p>Current EMX environment does not allow <i>.EXE</i> files compiled in <code class="inline"><span class="w">omf</span></code> format to fork(). fork() is needed for exactly three Perl operations:</p> <ul> <li> <p>explicit fork() in the script,</p> </li> <li> <p><code class="inline"><a class="l_k" href="functions/open">open</a> <span class="w">FH</span><span class="cm">,</span> <span class="q">"|-"</span></code> </p> </li> <li> <p><code class="inline"><a class="l_k" href="functions/open">open</a> <span class="w">FH</span><span class="cm">,</span> <span class="q">"-|"</span></code> , in other words, opening pipes to itself.</p> </li> </ul> <p>While these operations are not questions of life and death, they are needed for a lot of useful scripts. This forces <code class="inline"><span class="w">a</span>.<span class="w">out</span></code> -style compile of <i>perl.exe</i>.</p> <h2 id="ENVIRONMENT">ENVIRONMENT</h2> <p>Here we list environment variables with are either OS/2- and DOS- and Win*-specific, or are more important under OS/2 than under other OSes.</p> <h3 id="PERLLIB_PREFIX">
<code class="inline"><span class="w">PERLLIB_PREFIX</span></code> </h3> <p>Specific for EMX port. Should have the form</p> <pre class="verbatim" data-language="perl">path1;path2
</pre>
<p>or</p> <pre class="verbatim" data-language="perl">path1 path2
</pre>
<p>If the beginning of some prebuilt path matches <i>path1</i>, it is substituted with <i>path2</i>.</p> <p>Should be used if the perl library is moved from the default location in preference to <code class="inline">PERL(5)LIB</code>, since this would not leave wrong entries in @INC. For example, if the compiled version of perl looks for @INC in <i>f:/perllib/lib</i>, and you want to install the library in <i>h:/opt/gnu</i>, do</p> <pre class="verbatim" data-language="perl">set PERLLIB_PREFIX=f:/perllib/lib;h:/opt/gnu
</pre>
<p>This will cause Perl with the prebuilt @INC of</p> <pre class="verbatim" data-language="perl">f:/perllib/lib/5.00553/os2
f:/perllib/lib/5.00553
f:/perllib/lib/site_perl/5.00553/os2
f:/perllib/lib/site_perl/5.00553
.
</pre>
<p>to use the following @INC:</p> <pre class="verbatim" data-language="perl">h:/opt/gnu/5.00553/os2
h:/opt/gnu/5.00553
h:/opt/gnu/site_perl/5.00553/os2
h:/opt/gnu/site_perl/5.00553
.
</pre>
<h3 id="PERL_BADLANG">
<code class="inline"><span class="w">PERL_BADLANG</span></code> </h3> <p>If 0, perl ignores setlocale() failing. May be useful with some strange <i>locale</i>s.</p> <h3 id="PERL_BADFREE">
<code class="inline"><span class="w">PERL_BADFREE</span></code> </h3> <p>If 0, perl would not warn of in case of unwarranted free(). With older perls this might be useful in conjunction with the module DB_File, which was buggy when dynamically linked and OMF-built.</p> <p>Should not be set with newer Perls, since this may hide some <i>real</i> problems.</p> <h3 id="PERL_SH_DIR">
<code class="inline"><span class="w">PERL_SH_DIR</span></code> </h3> <p>Specific for EMX port. Gives the directory part of the location for <i>sh.exe</i>.</p> <h3 id="USE_PERL_FLOCK">
<code class="inline"><span class="w">USE_PERL_FLOCK</span></code> </h3> <p>Specific for EMX port. Since <i>flock(3)</i> is present in EMX, but is not functional, it is emulated by perl. To disable the emulations, set environment variable <code class="inline"><span class="w">USE_PERL_FLOCK</span>=<span class="n">0</span></code> .</p> <h3 id="TMP-or-TEMP">
<code class="inline"><span class="w">TMP</span></code> or <code class="inline"><span class="w">TEMP</span></code> </h3> <p>Specific for EMX port. Used as storage place for temporary files.</p> <h2 id="Evolution">Evolution</h2> <p>Here we list major changes which could make you by surprise.</p> <h3 id="Text-mode-filehandles">Text-mode filehandles</h3> <p>Starting from version 5.8, Perl uses a builtin translation layer for text-mode files. This replaces the efficient well-tested EMX layer by some code which should be best characterized as a "quick hack".</p> <p>In addition to possible bugs and an inability to follow changes to the translation policy with off/on switches of TERMIO translation, this introduces a serious incompatible change: before sysread() on text-mode filehandles would go through the translation layer, now it would not.</p> <h3 id="Priorities">Priorities</h3> <p><code class="inline"><a class="l_k" href="functions/setpriority">setpriority</a></code> and <code class="inline"><a class="l_k" href="functions/getpriority">getpriority</a></code> are not compatible with earlier ports by Andreas Kaiser. See <code class="inline"><span class="q">"setpriority, getpriority"</span></code> .</p> <h3 id="DLL-name-mangling%3a-pre-5.6.2">DLL name mangling: pre 5.6.2</h3> <p>With the release 5.003_01 the dynamically loadable libraries should be rebuilt when a different version of Perl is compiled. In particular, DLLs (including <i>perl.dll</i>) are now created with the names which contain a checksum, thus allowing workaround for OS/2 scheme of caching DLLs.</p> <p>It may be possible to code a simple workaround which would</p> <ul> <li> <p>find the old DLLs looking through the old @INC;</p> </li> <li> <p>mangle the names according to the scheme of new perl and copy the DLLs to these names;</p> </li> <li> <p>edit the internal <code class="inline"><span class="w">LX</span></code> tables of DLL to reflect the change of the name (probably not needed for Perl extension DLLs, since the internally coded names are not used for "specific" DLLs, they used only for "global" DLLs).</p> </li> <li> <p>edit the internal <code class="inline"><span class="w">IMPORT</span></code> tables and change the name of the "old" <i>perl????.dll</i> to the "new" <i>perl????.dll</i>.</p> </li> </ul> <h3 id="DLL-name-mangling%3a-5.6.2-and-beyond">DLL name mangling: 5.6.2 and beyond</h3> <p>In fact mangling of <i>extension</i> DLLs was done due to misunderstanding of the OS/2 dynaloading model. OS/2 (effectively) maintains two different tables of loaded DLL:</p> <ul> <li id="Global-DLLs">
<b>Global DLLs</b> <p>those loaded by the base name from <code class="inline"><span class="w">LIBPATH</span></code> ; including those associated at link time;</p> </li> <li id="specific-DLLs">
<b>specific DLLs</b> <p>loaded by the full name.</p> </li> </ul> <p>When resolving a request for a global DLL, the table of already-loaded specific DLLs is (effectively) ignored; moreover, specific DLLs are <i>always</i> loaded from the prescribed path.</p> <p>There is/was a minor twist which makes this scheme fragile: what to do with DLLs loaded from</p> <ul> <li id="BEGINLIBPATH-and-ENDLIBPATH">
<b><code class="inline"><span class="w">BEGINLIBPATH</span></code> and <code class="inline"><span class="w">ENDLIBPATH</span></code> </b> <p>(which depend on the process)</p> </li> <li id="_._-from-LIBPATH">
<b><i>.</i> from <code class="inline"><span class="w">LIBPATH</span></code> </b> <p>which <i>effectively</i> depends on the process (although <code class="inline"><span class="w">LIBPATH</span></code> is the same for all the processes).</p> </li> </ul> <p>Unless <code class="inline"><span class="w">LIBPATHSTRICT</span></code> is set to <code class="inline"><span class="w">T</span></code> (and the kernel is after 2000/09/01), such DLLs are considered to be global. When loading a global DLL it is first looked in the table of already-loaded global DLLs. Because of this the fact that one executable loaded a DLL from <code class="inline"><span class="w">BEGINLIBPATH</span></code> and <code class="inline"><span class="w">ENDLIBPATH</span></code> , or <i>.</i> from <code class="inline"><span class="w">LIBPATH</span></code> may affect <i>which</i> DLL is loaded when <i>another</i> executable requests a DLL with the same name. <i>This</i> is the reason for version-specific mangling of the DLL name for perl DLL.</p> <p>Since the Perl extension DLLs are always loaded with the full path, there is no need to mangle their names in a version-specific ways: their directory already reflects the corresponding version of perl, and @INC takes into account binary compatibility with older version. Starting from <code class="inline"><span class="v">5.6.2</span></code> the name mangling scheme is fixed to be the same as for Perl 5.005_53 (same as in a popular binary release). Thus new Perls will be able to <i>resolve the names</i> of old extension DLLs if @INC allows finding their directories.</p> <p>However, this still does not guarantee that these DLL may be loaded. The reason is the mangling of the name of the <i>Perl DLL</i>. And since the extension DLLs link with the Perl DLL, extension DLLs for older versions would load an older Perl DLL, and would most probably segfault (since the data in this DLL is not properly initialized).</p> <p>There is a partial workaround (which can be made complete with newer OS/2 kernels): create a forwarder DLL with the same name as the DLL of the older version of Perl, which forwards the entry points to the newer Perl's DLL. Make this DLL accessible on (say) the <code class="inline"><span class="w">BEGINLIBPATH</span></code> of the new Perl executable. When the new executable accesses old Perl's extension DLLs, they would request the old Perl's DLL by name, get the forwarder instead, so effectively will link with the currently running (new) Perl DLL.</p> <p>This may break in two ways:</p> <ul> <li> <p>Old perl executable is started when a new executable is running has loaded an extension compiled for the old executable (ouph!). In this case the old executable will get a forwarder DLL instead of the old perl DLL, so would link with the new perl DLL. While not directly fatal, it will behave the same as new executable. This beats the whole purpose of explicitly starting an old executable.</p> </li> <li> <p>A new executable loads an extension compiled for the old executable when an old perl executable is running. In this case the extension will not pick up the forwarder - with fatal results.</p> </li> </ul> <p>With support for <code class="inline"><span class="w">LIBPATHSTRICT</span></code> this may be circumvented - unless one of DLLs is started from <i>.</i> from <code class="inline"><span class="w">LIBPATH</span></code> (I do not know whether <code class="inline"><span class="w">LIBPATHSTRICT</span></code> affects this case).</p> <p><b>REMARK</b>. Unless newer kernels allow <i>.</i> in <code class="inline"><span class="w">BEGINLIBPATH</span></code> (older do not), this mess cannot be completely cleaned. (It turns out that as of the beginning of 2002, <i>.</i> is not allowed, but <i>.\.</i> is - and it has the same effect.)</p> <p><b>REMARK</b>. <code class="inline"><span class="w">LIBPATHSTRICT</span></code> , <code class="inline"><span class="w">BEGINLIBPATH</span></code> and <code class="inline"><span class="w">ENDLIBPATH</span></code> are not environment variables, although <i>cmd.exe</i> emulates them on <code class="inline"><span class="w">SET</span>
...</code> lines. From Perl they may be accessed by <a href="#Cwd%3a%3aextLibpath(%5btype%5d)">Cwd::extLibpath</a> and <a href="#Cwd%3a%3aextLibpath_set(-path-%5b%2c-type-%5d-)">Cwd::extLibpath_set</a>.</p> <h3 id="DLL-forwarder-generation">DLL forwarder generation</h3> <p>Assume that the old DLL is named <i>perlE0AC.dll</i> (as is one for 5.005_53), and the new version is 5.6.1. Create a file <i>perl5shim.def-leader</i> with</p> <pre class="verbatim" data-language="perl">LIBRARY 'perlE0AC' INITINSTANCE TERMINSTANCE
DESCRIPTION '@#perl5-porters@perl.org:5.006001#@ Perl module for 5.00553 -&gt; Perl 5.6.1 forwarder'
CODE LOADONCALL
DATA LOADONCALL NONSHARED MULTIPLE
EXPORTS
</pre>
<p>modifying the versions/names as needed. Run</p> <pre class="verbatim" data-language="perl">perl -wnle "next if 0../EXPORTS/; print qq(  \"$1\") if /\"(\w+)\"/" perl5.def &gt;lst
</pre>
<p>in the Perl build directory (to make the DLL smaller replace perl5.def with the definition file for the older version of Perl if present).</p> <pre class="verbatim" data-language="perl">cat perl5shim.def-leader lst &gt;perl5shim.def
gcc -Zomf -Zdll -o perlE0AC.dll perl5shim.def -s -llibperl
</pre>
<p>(ignore multiple <code class="inline"><span class="w">warning</span> <span class="w">L4085</span></code> ).</p> <h3 id="Threading">Threading</h3> <p>As of release 5.003_01 perl is linked to multithreaded C RTL DLL. If perl itself is not compiled multithread-enabled, so will not be perl's malloc(). However, extensions may use multiple thread on their own risk.</p> <p>This was needed to compile <code class="inline"><span class="w">Perl</span>/<span class="w">Tk</span></code> for XFree86-OS/2 out-of-the-box, and link with DLLs for other useful libraries, which typically are compiled with <code class="inline">-<span class="w">Zmt</span> -<span class="w">Zcrtdll</span></code> .</p> <h3 id="Calls-to-external-programs">Calls to external programs</h3> <p>Due to a popular demand the perl external program calling has been changed wrt Andreas Kaiser's port. <i>If</i> perl needs to call an external program <i>via shell</i>, the <i>f:/bin/sh.exe</i> will be called, or whatever is the override, see <a href="#PERL_SH_DIR">PERL_SH_DIR</a>.</p> <p>Thus means that you need to get some copy of a <i>sh.exe</i> as well (I use one from pdksh). The path <i>F:/bin</i> above is set up automatically during the build to a correct value on the builder machine, but is overridable at runtime,</p> <p><b>Reasons:</b> a consensus on <code class="inline"><span class="w">perl5</span>-<span class="w">porters</span></code> was that perl should use one non-overridable shell per platform. The obvious choices for OS/2 are <i>cmd.exe</i> and <i>sh.exe</i>. Having perl build itself would be impossible with <i>cmd.exe</i> as a shell, thus I picked up <code class="inline"><span class="w">sh</span>.<span class="w">exe</span></code> . This assures almost 100% compatibility with the scripts coming from *nix. As an added benefit this works as well under DOS if you use DOS-enabled port of pdksh (see <a href="#Prerequisites">Prerequisites</a>).</p> <p><b>Disadvantages:</b> currently <i>sh.exe</i> of pdksh calls external programs via fork()/exec(), and there is <i>no</i> functioning exec() on OS/2. exec() is emulated by EMX by an asynchronous call while the caller waits for child completion (to pretend that the <code class="inline"><span class="w">pid</span></code> did not change). This means that 1 <i>extra</i> copy of <i>sh.exe</i> is made active via fork()/exec(), which may lead to some resources taken from the system (even if we do not count extra work needed for fork()ing).</p> <p>Note that this a lesser issue now when we do not spawn <i>sh.exe</i> unless needed (metachars found).</p> <p>One can always start <i>cmd.exe</i> explicitly via</p> <pre class="verbatim" data-language="perl">system 'cmd', '/c', 'mycmd', 'arg1', 'arg2', ...
</pre>
<p>If you need to use <i>cmd.exe</i>, and do not want to hand-edit thousands of your scripts, the long-term solution proposed on p5-p is to have a directive</p> <pre class="verbatim" data-language="perl">use OS2::Cmd;
</pre>
<p>which will override system(), exec(), <code class="inline"><span class="q">``</span></code> , and <code class="inline"><a class="l_k" href="functions/open">open(,'...|')</a></code>. With current perl you may override only system(), readpipe() - the explicit version of <code class="inline"><span class="q">``</span></code> , and maybe exec(). The code will substitute the one-argument call to system() by <code class="inline"><span class="i">CORE::system</span><span class="s">(</span><span class="q">'cmd.exe'</span><span class="cm">,</span> <span class="q">'/c'</span><span class="cm">,</span> <a class="l_k" href="functions/shift">shift</a><span class="s">)</span></code> .</p> <p>If you have some working code for <code class="inline"><span class="w">OS2::Cmd</span></code> , please send it to me, I will include it into distribution. I have no need for such a module, so cannot test it.</p> <p>For the details of the current situation with calling external programs, see <a href="http://search.cpan.org/perldoc/Starting%20OS#2-(and-DOS)-programs-under-Perl">2 (and DOS) programs under Perl in Starting OS</a>. Set us mention a couple of features:</p> <ul> <li> <p>External scripts may be called by their basename. Perl will try the same extensions as when processing <b>-S</b> command-line switch.</p> </li> <li> <p>External scripts starting with <code class="inline"><span class="c">#!</span></code> or <code class="inline"><span class="w">extproc</span> </code> will be executed directly, without calling the shell, by calling the program specified on the rest of the first line.</p> </li> </ul> <h3 id="Memory-allocation">Memory allocation</h3> <p>Perl uses its own malloc() under OS/2 - interpreters are usually malloc-bound for speed, but perl is not, since its malloc is lightning-fast. Perl-memory-usage-tuned benchmarks show that Perl's malloc is 5 times quicker than EMX one. I do not have convincing data about memory footprint, but a (pretty random) benchmark showed that Perl's one is 5% better.</p> <p>Combination of perl's malloc() and rigid DLL name resolution creates a special problem with library functions which expect their return value to be free()d by system's free(). To facilitate extensions which need to call such functions, system memory-allocation functions are still available with the prefix <code class="inline"><span class="w">emx_</span></code> added. (Currently only DLL perl has this, it should propagate to <i>perl_.exe</i> shortly.)</p> <h3 id="Threads">Threads</h3> <p>One can build perl with thread support enabled by providing <code class="inline">-<span class="w">D</span> <span class="w">usethreads</span></code> option to <i>Configure</i>. Currently OS/2 support of threads is very preliminary.</p> <p>Most notable problems:</p> <ul> <li id="COND_WAIT">
<b><code class="inline"><span class="w">COND_WAIT</span></code> </b> <p>may have a race condition (but probably does not due to edge-triggered nature of OS/2 Event semaphores). (Needs a reimplementation (in terms of chaining waiting threads, with the linked list stored in per-thread structure?)?)</p> </li> <li id="_os2.c_">
<b><i>os2.c</i></b> <p>has a couple of static variables used in OS/2-specific functions. (Need to be moved to per-thread structure, or serialized?)</p> </li> </ul> <p>Note that these problems should not discourage experimenting, since they have a low probability of affecting small programs.</p> <h2 id="BUGS">BUGS</h2> <p>This description is not updated often (since 5.6.1?), see <i>./os2/Changes</i> for more info.</p> <h2 id="AUTHOR">AUTHOR</h2> <p>Ilya Zakharevich, cpan@ilyaz.org</p> <h2 id="SEE-ALSO">SEE ALSO</h2> <p>perl(1).</p>
<div class="_attribution">
  <p class="_attribution-p">
    © 1993–2016 Larry Wall and others<br>Licensed under the GNU General Public License version 1 or later, or the Artistic License.<br>The Perl logo is a trademark of the Perl Foundation.<br>
    <a href="https://perldoc.perl.org/5.26.0/perlos2.html" class="_attribution-link">https://perldoc.perl.org/5.26.0/perlos2.html</a>
  </p>
</div>

				
			</div>
			<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-2572770204602497"
     data-ad-slot="1992473792"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
		</div>
	</section>

	</div>
	<svg style="display:none">
		<symbol id="icon-dir"><svg viewBox="0 0 20 20"><path d="M15 10c0 .3-.305.515-.305.515l-8.56 5.303c-.625.41-1.135.106-1.135-.67V4.853c0-.777.51-1.078 1.135-.67l8.56 5.305S15 9.702 15 10z"/></svg></symbol>
	  </svg>
</body>
</html>
