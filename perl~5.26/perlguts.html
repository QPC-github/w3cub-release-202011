
<!DOCTYPE HTML>

<html lang="en" class="_theme-default">

<head>
  <meta charset="utf-8">
  <title>Perlguts - Perl 5.26 - W3cubDocs</title>
  
  <meta name="description" content=" perlguts - Introduction to the Perl API ">
  <meta name="keywords" content="perlguts, perl, perl~5.26">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="mobile-web-app-capable" content="yes">
  
  <link rel="canonical" href="https://docs.w3cub.com/perl~5.26/perlguts.html">
  <link href="/favicon.png" rel="icon">
  <link rel="stylesheet" type="text/css" href="/assets/application-e498cd0ebe8746846fec95b1a53ab3bb0fb7f47f794f0a38f44c98a1f0d03b21d777ae2c583732e44a5a890f6eacb79a5333545db9d5f3616091ba21ca17d916.css">
  <script src="/assets/application-79c555f6b25481fffac2cac30a7f3e54e608ca09e9e8e42bb1790095ba6d0fcace47d6bc624ddce952c70370892f2d46864f89e6943d4f7f7ff16c8a3231a91a.js" type="text/javascript"></script>
  <script src="/json/perl~5.26.js"></script>
  
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-R3WC07G3GB"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-R3WC07G3GB');
</script>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2572770204602497"
     crossorigin="anonymous"></script>
<script async custom-element="amp-auto-ads"
  src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
</script>


</head>

<body class="docs">
	<amp-auto-ads type="adsense"
              data-ad-client="ca-pub-2572770204602497">
	</amp-auto-ads>
	<div class="_app">
	<header class="_header">

  <a class="_home-link" href="/" ></a>
  <a class="_menu-link"></a>
  <h1 class="_logo">
    <a href="/" class="_nav-link" title="API Documentation Browser">W3cubDocs</a>
  </h1>
  
  <span class="_logo-sub-nav">/</span><span class="_logo-sub-nav"><a href="/perl~5.26/" class="_nav-link" title="" style="margin-left:0;">Perl 5.26</a></span>
  
  <nav class="_nav">
    <a href="https://tools.w3cub.com/?_sp=docs" target="_blank" class="_nav-link ">W3cubTools</a>
    <a href="/cheatsheets/" class="_nav-link ">Cheatsheets</a>
    <a href="/about/" class="_nav-link ">About</a>
  </nav>
</header>
	<section class="_sidebar">
		
		<form class="_search">
		  <input type="search" class="_search-input" placeholder="Search&hellip;" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" maxlength="20">
		  <a class="_search-clear"></a>
		  <div class="_search-tag"></div>
		</form>
		
		<div class="_list-wrap">
			<div class="_list">
			
			</div>
		</div>
	</section>
	<section class="_container ">
		<div class="_content">
			<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-2572770204602497"
     data-ad-slot="6861657091"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
			<div class="_page _perl">
				
				
<h1>perlguts</h1>  <ul>
<li><a href="#NAME">NAME</a></li>
<li><a href="#DESCRIPTION">DESCRIPTION</a></li>
<li>
<a href="#Variables">Variables</a><ul>
<li><a href="#Datatypes">Datatypes</a></li>
<li><a href="#What-is-an-%22IV%22%3f">What is an "IV"?</a></li>
<li><a href="#Working-with-SVs">Working with SVs</a></li>
<li><a href="#Offsets">Offsets</a></li>
<li><a href="#What's-Really-Stored-in-an-SV%3f">What's Really Stored in an SV?</a></li>
<li><a href="#Working-with-AVs">Working with AVs</a></li>
<li><a href="#Working-with-HVs">Working with HVs</a></li>
<li><a href="#Hash-API-Extensions">Hash API Extensions</a></li>
<li><a href="#AVs%2c-HVs-and-undefined-values">AVs, HVs and undefined values</a></li>
<li><a href="#References">References</a></li>
<li><a href="#Blessed-References-and-Class-Objects">Blessed References and Class Objects</a></li>
<li><a href="#Creating-New-Variables">Creating New Variables</a></li>
<li><a href="#Reference-Counts-and-Mortality">Reference Counts and Mortality</a></li>
<li><a href="#Stashes-and-Globs">Stashes and Globs</a></li>
<li><a href="#Double-Typed-SVs">Double-Typed SVs</a></li>
<li><a href="#Read-Only-Values">Read-Only Values</a></li>
<li><a href="#Copy-on-Write">Copy on Write</a></li>
<li><a href="#Magic-Variables">Magic Variables</a></li>
<li><a href="#Assigning-Magic">Assigning Magic</a></li>
<li><a href="#Magic-Virtual-Tables">Magic Virtual Tables</a></li>
<li><a href="#Finding-Magic">Finding Magic</a></li>
<li><a href="#Understanding-the-Magic-of-Tied-Hashes-and-Arrays">Understanding the Magic of Tied Hashes and Arrays</a></li>
<li><a href="#Localizing-changes">Localizing changes</a></li>
</ul>
</li>
<li>
<a href="#Subroutines">Subroutines</a><ul>
<li><a href="#XSUBs-and-the-Argument-Stack">XSUBs and the Argument Stack</a></li>
<li><a href="#Autoloading-with-XSUBs">Autoloading with XSUBs</a></li>
<li><a href="#Calling-Perl-Routines-from-within-C-Programs">Calling Perl Routines from within C Programs</a></li>
<li><a href="#Putting-a-C-value-on-Perl-stack">Putting a C value on Perl stack</a></li>
<li><a href="#Scratchpads">Scratchpads</a></li>
<li><a href="#Scratchpads-and-recursion">Scratchpads and recursion</a></li>
</ul>
</li>
<li>
<a href="#Memory-Allocation">Memory Allocation</a><ul>
<li><a href="#Allocation">Allocation</a></li>
<li><a href="#Reallocation">Reallocation</a></li>
<li><a href="#Moving">Moving</a></li>
</ul>
</li>
<li><a href="#PerlIO">PerlIO</a></li>
<li>
<a href="#Compiled-code">Compiled code</a><ul>
<li><a href="#Code-tree">Code tree</a></li>
<li><a href="#Examining-the-tree">Examining the tree</a></li>
<li><a href="#Compile-pass-1%3a-check-routines">Compile pass 1: check routines</a></li>
<li><a href="#Compile-pass-1a%3a-constant-folding">Compile pass 1a: constant folding</a></li>
<li><a href="#Compile-pass-2%3a-context-propagation">Compile pass 2: context propagation</a></li>
<li><a href="#Compile-pass-3%3a-peephole-optimization">Compile pass 3: peephole optimization</a></li>
<li><a href="#Pluggable-runops">Pluggable runops</a></li>
<li><a href="#Compile-time-scope-hooks">Compile-time scope hooks</a></li>
</ul>
</li>
<li><a href="#Examining-internal-data-structures-with-the-dump-functions">Examining internal data structures with the dump functions</a></li>
<li>
<a href="#How-multiple-interpreters-and-concurrency-are-supported">How multiple interpreters and concurrency are supported</a><ul>
<li><a href="#Background-and-PERL_IMPLICIT_CONTEXT">Background and PERL_IMPLICIT_CONTEXT</a></li>
<li><a href="#So-what-happened-to-dTHR%3f">So what happened to dTHR?</a></li>
<li><a href="#How-do-I-use-all-this-in-extensions%3f">How do I use all this in extensions?</a></li>
<li><a href="#Should-I-do-anything-special-if-I-call-perl-from-multiple-threads%3f">Should I do anything special if I call perl from multiple threads?</a></li>
<li><a href="#Future-Plans-and-PERL_IMPLICIT_SYS">Future Plans and PERL_IMPLICIT_SYS</a></li>
</ul>
</li>
<li>
<a href="#Internal-Functions">Internal Functions</a><ul>
<li><a href="#Formatted-Printing-of-IVs%2c-UVs%2c-and-NVs">Formatted Printing of IVs, UVs, and NVs</a></li>
<li><a href="#Pointer-To-Integer-and-Integer-To-Pointer">Pointer-To-Integer and Integer-To-Pointer</a></li>
<li><a href="#Exception-Handling">Exception Handling</a></li>
<li><a href="#Source-Documentation">Source Documentation</a></li>
<li><a href="#Backwards-compatibility">Backwards compatibility</a></li>
</ul>
</li>
<li>
<a href="#Unicode-Support">Unicode Support</a><ul>
<li><a href="#What-*is*-Unicode%2c-anyway%3f">What *is* Unicode, anyway?</a></li>
<li><a href="#How-can-I-recognise-a-UTF-8-string%3f">How can I recognise a UTF-8 string?</a></li>
<li><a href="#How-does-UTF-8-represent-Unicode-characters%3f">How does UTF-8 represent Unicode characters?</a></li>
<li><a href="#How-does-Perl-store-UTF-8-strings%3f">How does Perl store UTF-8 strings?</a></li>
<li><a href="#How-do-I-convert-a-string-to-UTF-8%3f">How do I convert a string to UTF-8?</a></li>
<li><a href="#How-do-I-compare-strings%3f">How do I compare strings?</a></li>
<li><a href="#Is-there-anything-else-I-need-to-know%3f">Is there anything else I need to know?</a></li>
</ul>
</li>
<li><a href="#Custom-Operators">Custom Operators</a></li>
<li><a href="#AUTHORS">AUTHORS</a></li>
<li><a href="#SEE-ALSO">SEE ALSO</a></li>
</ul>
<h2 id="NAME">NAME</h2> <p>perlguts - Introduction to the Perl API</p> <h2 id="DESCRIPTION">DESCRIPTION</h2> <p>This document attempts to describe how to use the Perl API, as well as to provide some info on the basic workings of the Perl core. It is far from complete and probably contains many errors. Please refer any questions or comments to the author below.</p> <h2 id="Variables">Variables</h2> <h3 id="Datatypes">Datatypes</h3> <p>Perl has three typedefs that handle Perl's three main data types:</p> <pre class="verbatim" data-language="perl">SV  Scalar Value
AV  Array Value
HV  Hash Value
</pre>
<p>Each typedef has specific routines that manipulate the various data types.</p> <h3 id="What-is-an-%22IV%22%3f">What is an "IV"?</h3> <p>Perl uses a special typedef IV which is a simple signed integer type that is guaranteed to be large enough to hold a pointer (as well as an integer). Additionally, there is the UV, which is simply an unsigned IV.</p> <p>Perl also uses two special typedefs, I32 and I16, which will always be at least 32-bits and 16-bits long, respectively. (Again, there are U32 and U16, as well.) They will usually be exactly 32 and 16 bits long, but on Crays they will both be 64 bits.</p> <h3 id="Working-with-SVs">Working with SVs</h3> <p>An SV can be created and loaded with one command. There are five types of values that can be loaded: an integer value (IV), an unsigned integer value (UV), a double (NV), a string (PV), and another scalar (SV). ("PV" stands for "Pointer Value". You might think that it is misnamed because it is described as pointing only to strings. However, it is possible to have it point to other things. For example, it could point to an array of UVs. But, using it for non-strings requires care, as the underlying assumption of much of the internals is that PVs are just for strings. Often, for example, a trailing <code class="inline"><span class="w">NUL</span></code> is tacked on automatically. The non-string use is documented only in this paragraph.)</p> <p>The seven routines are:</p> <pre class="verbatim" data-language="perl">SV*  newSViv(IV);
SV*  newSVuv(UV);
SV*  newSVnv(double);
SV*  newSVpv(const char*, STRLEN);
SV*  newSVpvn(const char*, STRLEN);
SV*  newSVpvf(const char*, ...);
SV*  newSVsv(SV*);
</pre>
<p><code class="inline"><span class="w">STRLEN</span></code> is an integer type (Size_t, usually defined as size_t in <i>config.h</i>) guaranteed to be large enough to represent the size of any string that perl can handle.</p> <p>In the unlikely case of a SV requiring more complex initialization, you can create an empty SV with newSV(len). If <code class="inline"><span class="w">len</span></code> is 0 an empty SV of type NULL is returned, else an SV of type PV is returned with len + 1 (for the <code class="inline"><span class="w">NUL</span></code> ) bytes of storage allocated, accessible via SvPVX. In both cases the SV has the undef value.</p> <pre class="verbatim" data-language="perl">SV *sv = newSV(0);   /* no storage allocated  */
SV *sv = newSV(10);  /* 10 (+1) bytes of uninitialised storage
                                                * allocated */
</pre>
<p>To change the value of an <i>already-existing</i> SV, there are eight routines:</p> <pre class="verbatim" data-language="perl">void  sv_setiv(SV*, IV);
void  sv_setuv(SV*, UV);
void  sv_setnv(SV*, double);
void  sv_setpv(SV*, const char*);
void  sv_setpvn(SV*, const char*, STRLEN)
void  sv_setpvf(SV*, const char*, ...);
void  sv_vsetpvfn(SV*, const char*, STRLEN, va_list *,
                                                SV **, I32, bool *);
void  sv_setsv(SV*, SV*);
</pre>
<p>Notice that you can choose to specify the length of the string to be assigned by using <code class="inline"><span class="w">sv_setpvn</span></code> , <code class="inline"><span class="w">newSVpvn</span></code> , or <code class="inline"><span class="w">newSVpv</span></code> , or you may allow Perl to calculate the length by using <code class="inline"><span class="w">sv_setpv</span></code> or by specifying 0 as the second argument to <code class="inline"><span class="w">newSVpv</span></code> . Be warned, though, that Perl will determine the string's length by using <code class="inline"><span class="w">strlen</span></code> , which depends on the string terminating with a <code class="inline"><span class="w">NUL</span></code> character, and not otherwise containing NULs.</p> <p>The arguments of <code class="inline"><span class="w">sv_setpvf</span></code> are processed like <code class="inline"><a class="l_k" href="functions/sprintf">sprintf</a></code>, and the formatted output becomes the value.</p> <p><code class="inline"><span class="w">sv_vsetpvfn</span></code> is an analogue of <code class="inline"><span class="w">vsprintf</span></code> , but it allows you to specify either a pointer to a variable argument list or the address and length of an array of SVs. The last argument points to a boolean; on return, if that boolean is true, then locale-specific information has been used to format the string, and the string's contents are therefore untrustworthy (see <a href="perlsec">perlsec</a>). This pointer may be NULL if that information is not important. Note that this function requires you to specify the length of the format.</p> <p>The <code class="inline"><span class="w">sv_set</span>*<span class="s">(</span><span class="s">)</span></code> functions are not generic enough to operate on values that have "magic". See <a href="#Magic-Virtual-Tables">Magic Virtual Tables</a> later in this document.</p> <p>All SVs that contain strings should be terminated with a <code class="inline"><span class="w">NUL</span></code> character. If it is not <code class="inline"><span class="w">NUL</span></code> -terminated there is a risk of core dumps and corruptions from code which passes the string to C functions or system calls which expect a <code class="inline"><span class="w">NUL</span></code> -terminated string. Perl's own functions typically add a trailing <code class="inline"><span class="w">NUL</span></code> for this reason. Nevertheless, you should be very careful when you pass a string stored in an SV to a C function or system call.</p> <p>To access the actual value that an SV points to, you can use the macros:</p> <pre class="verbatim" data-language="perl">SvIV(SV*)
SvUV(SV*)
SvNV(SV*)
SvPV(SV*, STRLEN len)
SvPV_nolen(SV*)
</pre>
<p>which will automatically coerce the actual scalar type into an IV, UV, double, or string.</p> <p>In the <code class="inline"><span class="w">SvPV</span></code> macro, the length of the string returned is placed into the variable <code class="inline"><span class="w">len</span></code> (this is a macro, so you do <i>not</i> use <code class="inline"><span class="i">&amp;len</span></code> ). If you do not care what the length of the data is, use the <code class="inline"><span class="w">SvPV_nolen</span></code> macro. Historically the <code class="inline"><span class="w">SvPV</span></code> macro with the global variable <code class="inline"><span class="w">PL_na</span></code> has been used in this case. But that can be quite inefficient because <code class="inline"><span class="w">PL_na</span></code> must be accessed in thread-local storage in threaded Perl. In any case, remember that Perl allows arbitrary strings of data that may both contain NULs and might not be terminated by a <code class="inline"><span class="w">NUL</span></code> .</p> <p>Also remember that C doesn't allow you to safely say <code class="inline">foo(SvPV(s, len),
len);</code>. It might work with your compiler, but it won't work for everyone. Break this sort of statement up into separate assignments:</p> <pre class="verbatim" data-language="perl">SV *s;
    STRLEN len;
    char *ptr;
ptr = SvPV(s, len);
    foo(ptr, len);
</pre>
<p>If you want to know if the scalar value is TRUE, you can use:</p> <pre class="verbatim" data-language="perl">SvTRUE(SV*)
</pre>
<p>Although Perl will automatically grow strings for you, if you need to force Perl to allocate more memory for your SV, you can use the macro</p> <pre class="verbatim" data-language="perl">SvGROW(SV*, STRLEN newlen)
</pre>
<p>which will determine if more memory needs to be allocated. If so, it will call the function <code class="inline"><span class="w">sv_grow</span></code> . Note that <code class="inline"><span class="w">SvGROW</span></code> can only increase, not decrease, the allocated memory of an SV and that it does not automatically add space for the trailing <code class="inline"><span class="w">NUL</span></code> byte (perl's own string functions typically do <code class="inline"><span class="i">SvGROW</span><span class="s">(</span><span class="w">sv</span><span class="cm">,</span> <span class="w">len</span> + <span class="n">1</span><span class="s">)</span></code> ).</p> <p>If you want to write to an existing SV's buffer and set its value to a string, use SvPV_force() or one of its variants to force the SV to be a PV. This will remove any of various types of non-stringness from the SV while preserving the content of the SV in the PV. This can be used, for example, to append data from an API function to a buffer without extra copying:</p> <pre class="verbatim" data-language="perl">(void)SvPVbyte_force(sv, len);
s = SvGROW(sv, len + needlen + 1);
    /* something that modifies up to needlen bytes at s+len, but
          modifies newlen bytes
              eg. newlen = read(fd, s + len, needlen);
          ignoring errors for these examples
      */
    s[len + newlen] = '\0';
SvCUR_set(sv, len + newlen);
SvUTF8_off(sv);
SvSETMAGIC(sv);
</pre>
<p>If you already have the data in memory or if you want to keep your code simple, you can use one of the sv_cat*() variants, such as sv_catpvn(). If you want to insert anywhere in the string you can use sv_insert() or sv_insert_flags().</p> <p>If you don't need the existing content of the SV, you can avoid some copying with:</p> <pre class="verbatim" data-language="perl">sv_setpvn(sv, "", 0);
s = SvGROW(sv, needlen + 1);
    /* something that modifies up to needlen bytes at s, but modifies
          newlen bytes
              eg. newlen = read(fd, s. needlen);
      */
    s[newlen] = '\0';
SvCUR_set(sv, newlen);
SvPOK_only(sv); /* also clears SVf_UTF8 */
SvSETMAGIC(sv);
</pre>
<p>Again, if you already have the data in memory or want to avoid the complexity of the above, you can use sv_setpvn().</p> <p>If you have a buffer allocated with Newx() and want to set that as the SV's value, you can use sv_usepvn_flags(). That has some requirements if you want to avoid perl re-allocating the buffer to fit the trailing NUL:</p> <pre class="verbatim" data-language="perl">Newx(buf, somesize+1, char);
/* ... fill in buf ... */
buf[somesize] = '\0';
sv_usepvn_flags(sv, buf, somesize, SV_SMAGIC | SV_HAS_TRAILING_NUL);
/* buf now belongs to perl, don't release it */
</pre>
<p>If you have an SV and want to know what kind of data Perl thinks is stored in it, you can use the following macros to check the type of SV you have.</p> <pre class="verbatim" data-language="perl">SvIOK(SV*)
SvNOK(SV*)
SvPOK(SV*)
</pre>
<p>You can get and set the current length of the string stored in an SV with the following macros:</p> <pre class="verbatim" data-language="perl">SvCUR(SV*)
SvCUR_set(SV*, I32 val)
</pre>
<p>You can also get a pointer to the end of the string stored in the SV with the macro:</p> <pre class="verbatim" data-language="perl">SvEND(SV*)
</pre>
<p>But note that these last three macros are valid only if <code class="inline"><span class="i">SvPOK</span><span class="s">(</span><span class="s">)</span></code> is true.</p> <p>If you want to append something to the end of string stored in an <code class="inline"><span class="w">SV</span>*</code> , you can use the following functions:</p> <pre class="verbatim" data-language="perl">void  sv_catpv(SV*, const char*);
void  sv_catpvn(SV*, const char*, STRLEN);
void  sv_catpvf(SV*, const char*, ...);
void  sv_vcatpvfn(SV*, const char*, STRLEN, va_list *, SV **,
                                                         I32, bool);
void  sv_catsv(SV*, SV*);
</pre>
<p>The first function calculates the length of the string to be appended by using <code class="inline"><span class="w">strlen</span></code> . In the second, you specify the length of the string yourself. The third function processes its arguments like <code class="inline"><a class="l_k" href="functions/sprintf">sprintf</a></code> and appends the formatted output. The fourth function works like <code class="inline"><span class="w">vsprintf</span></code> . You can specify the address and length of an array of SVs instead of the va_list argument. The fifth function extends the string stored in the first SV with the string stored in the second SV. It also forces the second SV to be interpreted as a string.</p> <p>The <code class="inline"><span class="w">sv_cat</span>*<span class="s">(</span><span class="s">)</span></code> functions are not generic enough to operate on values that have "magic". See <a href="#Magic-Virtual-Tables">Magic Virtual Tables</a> later in this document.</p> <p>If you know the name of a scalar variable, you can get a pointer to its SV by using the following:</p> <pre class="verbatim" data-language="perl">SV*  get_sv("package::varname", 0);
</pre>
<p>This returns NULL if the variable does not exist.</p> <p>If you want to know if this variable (or any other SV) is actually <code class="inline"><a class="l_k" href="functions/defined">defined</a></code>, you can call:</p> <pre class="verbatim" data-language="perl">SvOK(SV*)
</pre>
<p>The scalar <code class="inline"><a class="l_k" href="functions/undef">undef</a></code> value is stored in an SV instance called <code class="inline"><span class="w">PL_sv_undef</span></code> .</p> <p>Its address can be used whenever an <code class="inline"><span class="w">SV</span>*</code> is needed. Make sure that you don't try to compare a random sv with <code class="inline"><span class="i">&amp;PL_sv_undef</span></code> . For example when interfacing Perl code, it'll work correctly for:</p> <pre class="verbatim" data-language="perl">foo(undef);
</pre>
<p>But won't work when called as:</p> <pre class="verbatim" data-language="perl">$x = undef;
foo($x);
</pre>
<p>So to repeat always use SvOK() to check whether an sv is defined.</p> <p>Also you have to be careful when using <code class="inline"><span class="i">&amp;PL_sv_undef</span></code> as a value in AVs or HVs (see <a href="#AVs%2c-HVs-and-undefined-values">AVs, HVs and undefined values</a>).</p> <p>There are also the two values <code class="inline"><span class="w">PL_sv_yes</span></code> and <code class="inline"><span class="w">PL_sv_no</span></code> , which contain boolean TRUE and FALSE values, respectively. Like <code class="inline"><span class="w">PL_sv_undef</span></code> , their addresses can be used whenever an <code class="inline"><span class="w">SV</span>*</code> is needed.</p> <p>Do not be fooled into thinking that <code class="inline">(SV *) 0</code> is the same as <code class="inline"><span class="i">&amp;PL_sv_undef</span></code> . Take this code:</p> <pre class="verbatim" data-language="perl">SV* sv = (SV*) 0;
if (I-am-to-return-a-real-value) {
        sv = sv_2mortal(newSViv(42));
}
sv_setsv(ST(0), sv);
</pre>
<p>This code tries to return a new SV (which contains the value 42) if it should return a real value, or undef otherwise. Instead it has returned a NULL pointer which, somewhere down the line, will cause a segmentation violation, bus error, or just weird results. Change the zero to <code class="inline"><span class="i">&amp;PL_sv_undef</span></code> in the first line and all will be well.</p> <p>To free an SV that you've created, call <code class="inline"><span class="i">SvREFCNT_dec</span><span class="s">(</span><span class="w">SV</span>*<span class="s">)</span></code> . Normally this call is not necessary (see <a href="#Reference-Counts-and-Mortality">Reference Counts and Mortality</a>).</p> <h3 id="Offsets">Offsets</h3> <p>Perl provides the function <code class="inline"><span class="w">sv_chop</span></code> to efficiently remove characters from the beginning of a string; you give it an SV and a pointer to somewhere inside the PV, and it discards everything before the pointer. The efficiency comes by means of a little hack: instead of actually removing the characters, <code class="inline"><span class="w">sv_chop</span></code> sets the flag <code class="inline"><span class="w">OOK</span></code> (offset OK) to signal to other functions that the offset hack is in effect, and it moves the PV pointer (called <code class="inline"><span class="w">SvPVX</span></code> ) forward by the number of bytes chopped off, and adjusts <code class="inline"><span class="w">SvCUR</span></code> and <code class="inline"><span class="w">SvLEN</span></code> accordingly. (A portion of the space between the old and new PV pointers is used to store the count of chopped bytes.)</p> <p>Hence, at this point, the start of the buffer that we allocated lives at <code class="inline"><span class="i">SvPVX</span><span class="s">(</span><span class="w">sv</span><span class="s">)</span> - <span class="i">SvIV</span><span class="s">(</span><span class="w">sv</span><span class="s">)</span></code> in memory and the PV pointer is pointing into the middle of this allocated storage.</p> <p>This is best demonstrated by example. Normally copy-on-write will prevent the substitution from operator from using this hack, but if you can craft a string for which copy-on-write is not possible, you can see it in play. In the current implementation, the final byte of a string buffer is used as a copy-on-write reference count. If the buffer is not big enough, then copy-on-write is skipped. First have a look at an empty string:</p> <pre class="verbatim" data-language="perl">% ./perl -Ilib -MDevel::Peek -le '$a=""; $a .= ""; Dump $a'
SV = PV(0x7ffb7c008a70) at 0x7ffb7c030390
  REFCNT = 1
  FLAGS = (POK,pPOK)
  PV = 0x7ffb7bc05b50 ""\0
  CUR = 0
  LEN = 10
</pre>
<p>Notice here the LEN is 10. (It may differ on your platform.) Extend the length of the string to one less than 10, and do a substitution:</p> <pre class="verbatim" data-language="perl">% ./perl -Ilib -MDevel::Peek -le '$a=""; $a.="123456789"; $a=~s/.//; Dump($a)'
SV = PV(0x7ffa04008a70) at 0x7ffa04030390
  REFCNT = 1
  FLAGS = (POK,OOK,pPOK)
  OFFSET = 1
  PV = 0x7ffa03c05b61 ( "\1" . ) "23456789"\0
  CUR = 8
  LEN = 9
</pre>
<p>Here the number of bytes chopped off (1) is shown next as the OFFSET. The portion of the string between the "real" and the "fake" beginnings is shown in parentheses, and the values of <code class="inline"><span class="w">SvCUR</span></code> and <code class="inline"><span class="w">SvLEN</span></code> reflect the fake beginning, not the real one. (The first character of the string buffer happens to have changed to "\1" here, not "1", because the current implementation stores the offset count in the string buffer. This is subject to change.)</p> <p>Something similar to the offset hack is performed on AVs to enable efficient shifting and splicing off the beginning of the array; while <code class="inline"><span class="w">AvARRAY</span></code> points to the first element in the array that is visible from Perl, <code class="inline"><span class="w">AvALLOC</span></code> points to the real start of the C array. These are usually the same, but a <code class="inline"><a class="l_k" href="functions/shift">shift</a></code> operation can be carried out by increasing <code class="inline"><span class="w">AvARRAY</span></code> by one and decreasing <code class="inline"><span class="w">AvFILL</span></code> and <code class="inline"><span class="w">AvMAX</span></code> . Again, the location of the real start of the C array only comes into play when freeing the array. See <code class="inline"><span class="w">av_shift</span></code> in <i>av.c</i>.</p> <h3 id="What's-Really-Stored-in-an-SV%3f">What's Really Stored in an SV?</h3> <p>Recall that the usual method of determining the type of scalar you have is to use <code class="inline"><span class="w">Sv</span>*<span class="w">OK</span></code> macros. Because a scalar can be both a number and a string, usually these macros will always return TRUE and calling the <code class="inline"><span class="w">Sv</span>*<span class="w">V</span></code> macros will do the appropriate conversion of string to integer/double or integer/double to string.</p> <p>If you <i>really</i> need to know if you have an integer, double, or string pointer in an SV, you can use the following three macros instead:</p> <pre class="verbatim" data-language="perl">SvIOKp(SV*)
SvNOKp(SV*)
SvPOKp(SV*)
</pre>
<p>These will tell you if you truly have an integer, double, or string pointer stored in your SV. The "p" stands for private.</p> <p>There are various ways in which the private and public flags may differ. For example, in perl 5.16 and earlier a tied SV may have a valid underlying value in the IV slot (so SvIOKp is true), but the data should be accessed via the FETCH routine rather than directly, so SvIOK is false. (In perl 5.18 onwards, tied scalars use the flags the same way as untied scalars.) Another is when numeric conversion has occurred and precision has been lost: only the private flag is set on 'lossy' values. So when an NV is converted to an IV with loss, SvIOKp, SvNOKp and SvNOK will be set, while SvIOK wont be.</p> <p>In general, though, it's best to use the <code class="inline"><span class="w">Sv</span>*<span class="w">V</span></code> macros.</p> <h3 id="Working-with-AVs">Working with AVs</h3> <p>There are two ways to create and load an AV. The first method creates an empty AV:</p> <pre class="verbatim" data-language="perl">AV*  newAV();
</pre>
<p>The second method both creates the AV and initially populates it with SVs:</p> <pre class="verbatim" data-language="perl">AV*  av_make(SSize_t num, SV **ptr);
</pre>
<p>The second argument points to an array containing <code class="inline"><span class="w">num</span></code> <code class="inline"><span class="w">SV</span>*</code> 's. Once the AV has been created, the SVs can be destroyed, if so desired.</p> <p>Once the AV has been created, the following operations are possible on it:</p> <pre class="verbatim" data-language="perl">void  av_push(AV*, SV*);
SV*   av_pop(AV*);
SV*   av_shift(AV*);
void  av_unshift(AV*, SSize_t num);
</pre>
<p>These should be familiar operations, with the exception of <code class="inline"><span class="w">av_unshift</span></code> . This routine adds <code class="inline"><span class="w">num</span></code> elements at the front of the array with the <code class="inline"><a class="l_k" href="functions/undef">undef</a></code> value. You must then use <code class="inline"><span class="w">av_store</span></code> (described below) to assign values to these new elements.</p> <p>Here are some other functions:</p> <pre class="verbatim" data-language="perl">SSize_t av_top_index(AV*);
SV**    av_fetch(AV*, SSize_t key, I32 lval);
SV**    av_store(AV*, SSize_t key, SV* val);
</pre>
<p>The <code class="inline"><span class="w">av_top_index</span></code> function returns the highest index value in an array (just like $#array in Perl). If the array is empty, -1 is returned. The <code class="inline"><span class="w">av_fetch</span></code> function returns the value at index <code class="inline"><span class="w">key</span></code> , but if <code class="inline"><span class="w">lval</span></code> is non-zero, then <code class="inline"><span class="w">av_fetch</span></code> will store an undef value at that index. The <code class="inline"><span class="w">av_store</span></code> function stores the value <code class="inline"><span class="w">val</span></code> at index <code class="inline"><span class="w">key</span></code> , and does not increment the reference count of <code class="inline"><span class="w">val</span></code> . Thus the caller is responsible for taking care of that, and if <code class="inline"><span class="w">av_store</span></code> returns NULL, the caller will have to decrement the reference count to avoid a memory leak. Note that <code class="inline"><span class="w">av_fetch</span></code> and <code class="inline"><span class="w">av_store</span></code> both return <code class="inline"><span class="w">SV</span>**</code> 's, not <code class="inline"><span class="w">SV</span>*</code> 's as their return value.</p> <p>A few more:</p> <pre class="verbatim" data-language="perl">void  av_clear(AV*);
void  av_undef(AV*);
void  av_extend(AV*, SSize_t key);
</pre>
<p>The <code class="inline"><span class="w">av_clear</span></code> function deletes all the elements in the AV* array, but does not actually delete the array itself. The <code class="inline"><span class="w">av_undef</span></code> function will delete all the elements in the array plus the array itself. The <code class="inline"><span class="w">av_extend</span></code> function extends the array so that it contains at least <code class="inline"><span class="w">key</span>+<span class="n">1</span></code> elements. If <code class="inline"><span class="w">key</span>+<span class="n">1</span></code> is less than the currently allocated length of the array, then nothing is done.</p> <p>If you know the name of an array variable, you can get a pointer to its AV by using the following:</p> <pre class="verbatim" data-language="perl">AV*  get_av("package::varname", 0);
</pre>
<p>This returns NULL if the variable does not exist.</p> <p>See <a href="#Understanding-the-Magic-of-Tied-Hashes-and-Arrays">Understanding the Magic of Tied Hashes and Arrays</a> for more information on how to use the array access functions on tied arrays.</p> <h3 id="Working-with-HVs">Working with HVs</h3> <p>To create an HV, you use the following routine:</p> <pre class="verbatim" data-language="perl">HV*  newHV();
</pre>
<p>Once the HV has been created, the following operations are possible on it:</p> <pre class="verbatim" data-language="perl">SV**  hv_store(HV*, const char* key, U32 klen, SV* val, U32 hash);
SV**  hv_fetch(HV*, const char* key, U32 klen, I32 lval);
</pre>
<p>The <code class="inline"><span class="w">klen</span></code> parameter is the length of the key being passed in (Note that you cannot pass 0 in as a value of <code class="inline"><span class="w">klen</span></code> to tell Perl to measure the length of the key). The <code class="inline"><span class="w">val</span></code> argument contains the SV pointer to the scalar being stored, and <code class="inline"><span class="w">hash</span></code> is the precomputed hash value (zero if you want <code class="inline"><span class="w">hv_store</span></code> to calculate it for you). The <code class="inline"><span class="w">lval</span></code> parameter indicates whether this fetch is actually a part of a store operation, in which case a new undefined value will be added to the HV with the supplied key and <code class="inline"><span class="w">hv_fetch</span></code> will return as if the value had already existed.</p> <p>Remember that <code class="inline"><span class="w">hv_store</span></code> and <code class="inline"><span class="w">hv_fetch</span></code> return <code class="inline"><span class="w">SV</span>**</code> 's and not just <code class="inline"><span class="w">SV</span>*</code> . To access the scalar value, you must first dereference the return value. However, you should check to make sure that the return value is not NULL before dereferencing it.</p> <p>The first of these two functions checks if a hash table entry exists, and the second deletes it.</p> <pre class="verbatim" data-language="perl">bool  hv_exists(HV*, const char* key, U32 klen);
SV*   hv_delete(HV*, const char* key, U32 klen, I32 flags);
</pre>
<p>If <code class="inline"><span class="w">flags</span></code> does not include the <code class="inline"><span class="w">G_DISCARD</span></code> flag then <code class="inline"><span class="w">hv_delete</span></code> will create and return a mortal copy of the deleted value.</p> <p>And more miscellaneous functions:</p> <pre class="verbatim" data-language="perl">void   hv_clear(HV*);
void   hv_undef(HV*);
</pre>
<p>Like their AV counterparts, <code class="inline"><span class="w">hv_clear</span></code> deletes all the entries in the hash table but does not actually delete the hash table. The <code class="inline"><span class="w">hv_undef</span></code> deletes both the entries and the hash table itself.</p> <p>Perl keeps the actual data in a linked list of structures with a typedef of HE. These contain the actual key and value pointers (plus extra administrative overhead). The key is a string pointer; the value is an <code class="inline"><span class="w">SV</span>*</code> . However, once you have an <code class="inline"><span class="w">HE</span>*</code> , to get the actual key and value, use the routines specified below.</p> <pre class="verbatim" data-language="perl">    I32    hv_iterinit(HV*);
            /* Prepares starting point to traverse hash table */
    HE*    hv_iternext(HV*);
            /* Get the next entry, and return a pointer to a
               structure that has both the key and value */
    char*  hv_iterkey(HE* entry, I32* retlen);
            /* Get the key from an HE structure and also return
               the length of the key string */
    SV*    hv_iterval(HV*, HE* entry);
            /* Return an SV pointer to the value of the HE
               structure */
    SV*    hv_iternextsv(HV*, char** key, I32* retlen);
            /* This convenience routine combines hv_iternext,
hv_iterkey, and hv_iterval.  The key and retlen
arguments are return values for the key and its
length.  The value is returned in the SV* argument */
</pre>
<p>If you know the name of a hash variable, you can get a pointer to its HV by using the following:</p> <pre class="verbatim" data-language="perl">HV*  get_hv("package::varname", 0);
</pre>
<p>This returns NULL if the variable does not exist.</p> <p>The hash algorithm is defined in the <code class="inline"><span class="w">PERL_HASH</span></code> macro:</p> <pre class="verbatim" data-language="perl">PERL_HASH(hash, key, klen)
</pre>
<p>The exact implementation of this macro varies by architecture and version of perl, and the return value may change per invocation, so the value is only valid for the duration of a single perl process.</p> <p>See <a href="#Understanding-the-Magic-of-Tied-Hashes-and-Arrays">Understanding the Magic of Tied Hashes and Arrays</a> for more information on how to use the hash access functions on tied hashes.</p> <h3 id="Hash-API-Extensions">Hash API Extensions</h3> <p>Beginning with version 5.004, the following functions are also supported:</p> <pre class="verbatim" data-language="perl">HE*     hv_fetch_ent  (HV* tb, SV* key, I32 lval, U32 hash);
HE*     hv_store_ent  (HV* tb, SV* key, SV* val, U32 hash);

bool    hv_exists_ent (HV* tb, SV* key, U32 hash);
SV*     hv_delete_ent (HV* tb, SV* key, I32 flags, U32 hash);

SV*     hv_iterkeysv  (HE* entry);
</pre>
<p>Note that these functions take <code class="inline"><span class="w">SV</span>*</code> keys, which simplifies writing of extension code that deals with hash structures. These functions also allow passing of <code class="inline"><span class="w">SV</span>*</code> keys to <code class="inline"><a class="l_k" href="functions/tie">tie</a></code> functions without forcing you to stringify the keys (unlike the previous set of functions).</p> <p>They also return and accept whole hash entries (<code class="inline"><span class="w">HE</span>*</code> ), making their use more efficient (since the hash number for a particular string doesn't have to be recomputed every time). See <a href="perlapi">perlapi</a> for detailed descriptions.</p> <p>The following macros must always be used to access the contents of hash entries. Note that the arguments to these macros must be simple variables, since they may get evaluated more than once. See <a href="perlapi">perlapi</a> for detailed descriptions of these macros.</p> <pre class="verbatim" data-language="perl">HePV(HE* he, STRLEN len)
HeVAL(HE* he)
HeHASH(HE* he)
HeSVKEY(HE* he)
HeSVKEY_force(HE* he)
HeSVKEY_set(HE* he, SV* sv)
</pre>
<p>These two lower level macros are defined, but must only be used when dealing with keys that are not <code class="inline"><span class="w">SV</span>*</code> s:</p> <pre class="verbatim" data-language="perl">HeKEY(HE* he)
HeKLEN(HE* he)
</pre>
<p>Note that both <code class="inline"><span class="w">hv_store</span></code> and <code class="inline"><span class="w">hv_store_ent</span></code> do not increment the reference count of the stored <code class="inline"><span class="w">val</span></code> , which is the caller's responsibility. If these functions return a NULL value, the caller will usually have to decrement the reference count of <code class="inline"><span class="w">val</span></code> to avoid a memory leak.</p> <h3 id="AVs%2c-HVs-and-undefined-values">AVs, HVs and undefined values</h3> <p>Sometimes you have to store undefined values in AVs or HVs. Although this may be a rare case, it can be tricky. That's because you're used to using <code class="inline"><span class="i">&amp;PL_sv_undef</span></code> if you need an undefined SV.</p> <p>For example, intuition tells you that this XS code:</p> <pre class="verbatim" data-language="perl">AV *av = newAV();
av_store( av, 0, &amp;PL_sv_undef );
</pre>
<p>is equivalent to this Perl code:</p> <pre class="verbatim" data-language="perl">my @av;
$av[0] = undef;
</pre>
<p>Unfortunately, this isn't true. In perl 5.18 and earlier, AVs use <code class="inline"><span class="i">&amp;PL_sv_undef</span></code> as a marker for indicating that an array element has not yet been initialized. Thus, <code class="inline"><a class="l_k" href="functions/exists">exists</a> <span class="i">$av</span>[<span class="n">0</span>]</code> would be true for the above Perl code, but false for the array generated by the XS code. In perl 5.20, storing &amp;PL_sv_undef will create a read-only element, because the scalar &amp;PL_sv_undef itself is stored, not a copy.</p> <p>Similar problems can occur when storing <code class="inline"><span class="i">&amp;PL_sv_undef</span></code> in HVs:</p> <pre class="verbatim" data-language="perl">hv_store( hv, "key", 3, &amp;PL_sv_undef, 0 );
</pre>
<p>This will indeed make the value <code class="inline"><a class="l_k" href="functions/undef">undef</a></code>, but if you try to modify the value of <code class="inline"><span class="w">key</span></code> , you'll get the following error:</p> <pre class="verbatim" data-language="perl">Modification of non-creatable hash value attempted
</pre>
<p>In perl 5.8.0, <code class="inline"><span class="i">&amp;PL_sv_undef</span></code> was also used to mark placeholders in restricted hashes. This caused such hash entries not to appear when iterating over the hash or when checking for the keys with the <code class="inline"><span class="w">hv_exists</span></code> function.</p> <p>You can run into similar problems when you store <code class="inline"><span class="i">&amp;PL_sv_yes</span></code> or <code class="inline"><span class="i">&amp;PL_sv_no</span></code> into AVs or HVs. Trying to modify such elements will give you the following error:</p> <pre class="verbatim" data-language="perl">Modification of a read-only value attempted
</pre>
<p>To make a long story short, you can use the special variables <code class="inline"><span class="i">&amp;PL_sv_undef</span></code> , <code class="inline"><span class="i">&amp;PL_sv_yes</span></code> and <code class="inline"><span class="i">&amp;PL_sv_no</span></code> with AVs and HVs, but you have to make sure you know what you're doing.</p> <p>Generally, if you want to store an undefined value in an AV or HV, you should not use <code class="inline"><span class="i">&amp;PL_sv_undef</span></code> , but rather create a new undefined value using the <code class="inline"><span class="w">newSV</span></code> function, for example:</p> <pre class="verbatim" data-language="perl">av_store( av, 42, newSV(0) );
hv_store( hv, "foo", 3, newSV(0), 0 );
</pre>
<h3 id="References">References</h3> <p>References are a special type of scalar that point to other data types (including other references).</p> <p>To create a reference, use either of the following functions:</p> <pre class="verbatim" data-language="perl">SV* newRV_inc((SV*) thing);
SV* newRV_noinc((SV*) thing);
</pre>
<p>The <code class="inline"><span class="w">thing</span></code> argument can be any of an <code class="inline"><span class="w">SV</span>*</code> , <code class="inline"><span class="w">AV</span>*</code> , or <code class="inline"><span class="w">HV</span>*</code> . The functions are identical except that <code class="inline"><span class="w">newRV_inc</span></code> increments the reference count of the <code class="inline"><span class="w">thing</span></code> , while <code class="inline"><span class="w">newRV_noinc</span></code> does not. For historical reasons, <code class="inline"><span class="w">newRV</span></code> is a synonym for <code class="inline"><span class="w">newRV_inc</span></code> .</p> <p>Once you have a reference, you can use the following macro to dereference the reference:</p> <pre class="verbatim" data-language="perl">SvRV(SV*)
</pre>
<p>then call the appropriate routines, casting the returned <code class="inline"><span class="w">SV</span>*</code> to either an <code class="inline"><span class="w">AV</span>*</code> or <code class="inline"><span class="w">HV</span>*</code> , if required.</p> <p>To determine if an SV is a reference, you can use the following macro:</p> <pre class="verbatim" data-language="perl">SvROK(SV*)
</pre>
<p>To discover what type of value the reference refers to, use the following macro and then check the return value.</p> <pre class="verbatim" data-language="perl">SvTYPE(SvRV(SV*))
</pre>
<p>The most useful types that will be returned are:</p> <pre class="verbatim" data-language="perl">&lt; SVt_PVAV  Scalar
SVt_PVAV    Array
SVt_PVHV    Hash
SVt_PVCV    Code
SVt_PVGV    Glob (possibly a file handle)
</pre>
<p>See <a href="perlapi#svtype">svtype in perlapi</a> for more details.</p> <h3 id="Blessed-References-and-Class-Objects">Blessed References and Class Objects</h3> <p>References are also used to support object-oriented programming. In perl's OO lexicon, an object is simply a reference that has been blessed into a package (or class). Once blessed, the programmer may now use the reference to access the various methods in the class.</p> <p>A reference can be blessed into a package with the following function:</p> <pre class="verbatim" data-language="perl">SV* sv_bless(SV* sv, HV* stash);
</pre>
<p>The <code class="inline"><span class="w">sv</span></code> argument must be a reference value. The <code class="inline"><span class="w">stash</span></code> argument specifies which class the reference will belong to. See <a href="#Stashes-and-Globs">Stashes and Globs</a> for information on converting class names into stashes.</p> <p>/* Still under construction */</p> <p>The following function upgrades rv to reference if not already one. Creates a new SV for rv to point to. If <code class="inline"><span class="w">classname</span></code> is non-null, the SV is blessed into the specified class. SV is returned.</p> <pre class="verbatim" data-language="perl">SV* newSVrv(SV* rv, const char* classname);
</pre>
<p>The following three functions copy integer, unsigned integer or double into an SV whose reference is <code class="inline"><span class="w">rv</span></code> . SV is blessed if <code class="inline"><span class="w">classname</span></code> is non-null.</p> <pre class="verbatim" data-language="perl">SV* sv_setref_iv(SV* rv, const char* classname, IV iv);
SV* sv_setref_uv(SV* rv, const char* classname, UV uv);
SV* sv_setref_nv(SV* rv, const char* classname, NV iv);
</pre>
<p>The following function copies the pointer value (<i>the address, not the string!</i>) into an SV whose reference is rv. SV is blessed if <code class="inline"><span class="w">classname</span></code> is non-null.</p> <pre class="verbatim" data-language="perl">SV* sv_setref_pv(SV* rv, const char* classname, void* pv);
</pre>
<p>The following function copies a string into an SV whose reference is <code class="inline"><span class="w">rv</span></code> . Set length to 0 to let Perl calculate the string length. SV is blessed if <code class="inline"><span class="w">classname</span></code> is non-null.</p> <pre class="verbatim" data-language="perl">SV* sv_setref_pvn(SV* rv, const char* classname, char* pv,
                                                     STRLEN length);
</pre>
<p>The following function tests whether the SV is blessed into the specified class. It does not check inheritance relationships.</p> <pre class="verbatim" data-language="perl">int  sv_isa(SV* sv, const char* name);
</pre>
<p>The following function tests whether the SV is a reference to a blessed object.</p> <pre class="verbatim" data-language="perl">int  sv_isobject(SV* sv);
</pre>
<p>The following function tests whether the SV is derived from the specified class. SV can be either a reference to a blessed object or a string containing a class name. This is the function implementing the <code class="inline"><span class="w">UNIVERSAL::isa</span></code> functionality.</p> <pre class="verbatim" data-language="perl">bool sv_derived_from(SV* sv, const char* name);
</pre>
<p>To check if you've got an object derived from a specific class you have to write:</p> <pre class="verbatim" data-language="perl">if (sv_isobject(sv) &amp;&amp; sv_derived_from(sv, class)) { ... }
</pre>
<h3 id="Creating-New-Variables">Creating New Variables</h3> <p>To create a new Perl variable with an undef value which can be accessed from your Perl script, use the following routines, depending on the variable type.</p> <pre class="verbatim" data-language="perl">SV*  get_sv("package::varname", GV_ADD);
AV*  get_av("package::varname", GV_ADD);
HV*  get_hv("package::varname", GV_ADD);
</pre>
<p>Notice the use of GV_ADD as the second parameter. The new variable can now be set, using the routines appropriate to the data type.</p> <p>There are additional macros whose values may be bitwise OR'ed with the <code class="inline"><span class="w">GV_ADD</span></code> argument to enable certain extra features. Those bits are:</p> <ul> <li id="GV_ADDMULTI">
<b>GV_ADDMULTI</b> <p>Marks the variable as multiply defined, thus preventing the:</p> <pre class="verbatim" data-language="perl">Name &lt;varname&gt; used only once: possible typo
</pre>
<p>warning.</p> </li> <li id="GV_ADDWARN">
<b>GV_ADDWARN</b> <p>Issues the warning:</p> <pre class="verbatim" data-language="perl">Had to create &lt;varname&gt; unexpectedly
</pre>
<p>if the variable did not exist before the function was called.</p> </li> </ul> <p>If you do not specify a package name, the variable is created in the current package.</p> <h3 id="Reference-Counts-and-Mortality">Reference Counts and Mortality</h3> <p>Perl uses a reference count-driven garbage collection mechanism. SVs, AVs, or HVs (xV for short in the following) start their life with a reference count of 1. If the reference count of an xV ever drops to 0, then it will be destroyed and its memory made available for reuse.</p> <p>This normally doesn't happen at the Perl level unless a variable is undef'ed or the last variable holding a reference to it is changed or overwritten. At the internal level, however, reference counts can be manipulated with the following macros:</p> <pre class="verbatim" data-language="perl">int SvREFCNT(SV* sv);
SV* SvREFCNT_inc(SV* sv);
void SvREFCNT_dec(SV* sv);
</pre>
<p>However, there is one other function which manipulates the reference count of its argument. The <code class="inline"><span class="w">newRV_inc</span></code> function, you will recall, creates a reference to the specified argument. As a side effect, it increments the argument's reference count. If this is not what you want, use <code class="inline"><span class="w">newRV_noinc</span></code> instead.</p> <p>For example, imagine you want to return a reference from an XSUB function. Inside the XSUB routine, you create an SV which initially has a reference count of one. Then you call <code class="inline"><span class="w">newRV_inc</span></code> , passing it the just-created SV. This returns the reference as a new SV, but the reference count of the SV you passed to <code class="inline"><span class="w">newRV_inc</span></code> has been incremented to two. Now you return the reference from the XSUB routine and forget about the SV. But Perl hasn't! Whenever the returned reference is destroyed, the reference count of the original SV is decreased to one and nothing happens. The SV will hang around without any way to access it until Perl itself terminates. This is a memory leak.</p> <p>The correct procedure, then, is to use <code class="inline"><span class="w">newRV_noinc</span></code> instead of <code class="inline"><span class="w">newRV_inc</span></code> . Then, if and when the last reference is destroyed, the reference count of the SV will go to zero and it will be destroyed, stopping any memory leak.</p> <p>There are some convenience functions available that can help with the destruction of xVs. These functions introduce the concept of "mortality". An xV that is mortal has had its reference count marked to be decremented, but not actually decremented, until "a short time later". Generally the term "short time later" means a single Perl statement, such as a call to an XSUB function. The actual determinant for when mortal xVs have their reference count decremented depends on two macros, SAVETMPS and FREETMPS. See <a href="perlcall">perlcall</a> and <a href="perlxs">perlxs</a> for more details on these macros.</p> <p>"Mortalization" then is at its simplest a deferred <code class="inline"><span class="w">SvREFCNT_dec</span></code> . However, if you mortalize a variable twice, the reference count will later be decremented twice.</p> <p>"Mortal" SVs are mainly used for SVs that are placed on perl's stack. For example an SV which is created just to pass a number to a called sub is made mortal to have it cleaned up automatically when it's popped off the stack. Similarly, results returned by XSUBs (which are pushed on the stack) are often made mortal.</p> <p>To create a mortal variable, use the functions:</p> <pre class="verbatim" data-language="perl">SV*  sv_newmortal()
SV*  sv_2mortal(SV*)
SV*  sv_mortalcopy(SV*)
</pre>
<p>The first call creates a mortal SV (with no value), the second converts an existing SV to a mortal SV (and thus defers a call to <code class="inline"><span class="w">SvREFCNT_dec</span></code> ), and the third creates a mortal copy of an existing SV. Because <code class="inline"><span class="w">sv_newmortal</span></code> gives the new SV no value, it must normally be given one via <code class="inline"><span class="w">sv_setpv</span></code> , <code class="inline"><span class="w">sv_setiv</span></code> , etc. :</p> <pre class="verbatim" data-language="perl">SV *tmp = sv_newmortal();
sv_setiv(tmp, an_integer);
</pre>
<p>As that is multiple C statements it is quite common so see this idiom instead:</p> <pre class="verbatim" data-language="perl">SV *tmp = sv_2mortal(newSViv(an_integer));
</pre>
<p>You should be careful about creating mortal variables. Strange things can happen if you make the same value mortal within multiple contexts, or if you make a variable mortal multiple times. Thinking of "Mortalization" as deferred <code class="inline"><span class="w">SvREFCNT_dec</span></code> should help to minimize such problems. For example if you are passing an SV which you <i>know</i> has a high enough REFCNT to survive its use on the stack you need not do any mortalization. If you are not sure then doing an <code class="inline"><span class="w">SvREFCNT_inc</span></code> and <code class="inline"><span class="w">sv_2mortal</span></code> , or making a <code class="inline"><span class="w">sv_mortalcopy</span></code> is safer.</p> <p>The mortal routines are not just for SVs; AVs and HVs can be made mortal by passing their address (type-casted to <code class="inline"><span class="w">SV</span>*</code> ) to the <code class="inline"><span class="w">sv_2mortal</span></code> or <code class="inline"><span class="w">sv_mortalcopy</span></code> routines.</p> <h3 id="Stashes-and-Globs">Stashes and Globs</h3> <p>A <b>stash</b> is a hash that contains all variables that are defined within a package. Each key of the stash is a symbol name (shared by all the different types of objects that have the same name), and each value in the hash table is a GV (Glob Value). This GV in turn contains references to the various objects of that name, including (but not limited to) the following:</p> <pre class="verbatim" data-language="perl">Scalar Value
Array Value
Hash Value
I/O Handle
Format
Subroutine
</pre>
<p>There is a single stash called <code class="inline"><span class="w">PL_defstash</span></code> that holds the items that exist in the <code class="inline"><span class="w">main</span></code> package. To get at the items in other packages, append the string "::" to the package name. The items in the <code class="inline"><span class="w">Foo</span></code> package are in the stash <code class="inline"><span class="w">Foo::</span></code> in PL_defstash. The items in the <code class="inline"><span class="w">Bar::Baz</span></code> package are in the stash <code class="inline"><span class="w">Baz::</span></code> in <code class="inline"><span class="w">Bar::</span></code> 's stash.</p> <p>To get the stash pointer for a particular package, use the function:</p> <pre class="verbatim" data-language="perl">HV*  gv_stashpv(const char* name, I32 flags)
HV*  gv_stashsv(SV*, I32 flags)
</pre>
<p>The first function takes a literal string, the second uses the string stored in the SV. Remember that a stash is just a hash table, so you get back an <code class="inline"><span class="w">HV</span>*</code> . The <code class="inline"><span class="w">flags</span></code> flag will create a new package if it is set to GV_ADD.</p> <p>The name that <code class="inline"><span class="w">gv_stash</span>*<span class="w">v</span></code> wants is the name of the package whose symbol table you want. The default package is called <code class="inline"><span class="w">main</span></code> . If you have multiply nested packages, pass their names to <code class="inline"><span class="w">gv_stash</span>*<span class="w">v</span></code> , separated by <code class="inline"><span class="w">::</span></code> as in the Perl language itself.</p> <p>Alternately, if you have an SV that is a blessed reference, you can find out the stash pointer by using:</p> <pre class="verbatim" data-language="perl">HV*  SvSTASH(SvRV(SV*));
</pre>
<p>then use the following to get the package name itself:</p> <pre class="verbatim" data-language="perl">char*  HvNAME(HV* stash);
</pre>
<p>If you need to bless or re-bless an object you can use the following function:</p> <pre class="verbatim" data-language="perl">SV*  sv_bless(SV*, HV* stash)
</pre>
<p>where the first argument, an <code class="inline"><span class="w">SV</span>*</code> , must be a reference, and the second argument is a stash. The returned <code class="inline"><span class="w">SV</span>*</code> can now be used in the same way as any other SV.</p> <p>For more information on references and blessings, consult <a href="perlref">perlref</a>.</p> <h3 id="Double-Typed-SVs">Double-Typed SVs</h3> <p>Scalar variables normally contain only one type of value, an integer, double, pointer, or reference. Perl will automatically convert the actual scalar data from the stored type into the requested type.</p> <p>Some scalar variables contain more than one type of scalar data. For example, the variable <code class="inline"><span class="i">$!</span></code> contains either the numeric value of <code class="inline"><span class="w">errno</span></code> or its string equivalent from either <code class="inline"><span class="w">strerror</span></code> or <code class="inline"><span class="w">sys_errlist</span><span class="s">[</span><span class="s">]</span></code> .</p> <p>To force multiple data values into an SV, you must do two things: use the <code class="inline"><span class="w">sv_set</span>*<span class="w">v</span></code> routines to add the additional scalar type, then set a flag so that Perl will believe it contains more than one type of data. The four macros to set the flags are:</p> <pre class="verbatim" data-language="perl">SvIOK_on
SvNOK_on
SvPOK_on
SvROK_on
</pre>
<p>The particular macro you must use depends on which <code class="inline"><span class="w">sv_set</span>*<span class="w">v</span></code> routine you called first. This is because every <code class="inline"><span class="w">sv_set</span>*<span class="w">v</span></code> routine turns on only the bit for the particular type of data being set, and turns off all the rest.</p> <p>For example, to create a new Perl variable called "dberror" that contains both the numeric and descriptive string error values, you could use the following code:</p> <pre class="verbatim" data-language="perl">extern int  dberror;
extern char *dberror_list;

SV* sv = get_sv("dberror", GV_ADD);
sv_setiv(sv, (IV) dberror);
sv_setpv(sv, dberror_list[dberror]);
SvIOK_on(sv);
</pre>
<p>If the order of <code class="inline"><span class="w">sv_setiv</span></code> and <code class="inline"><span class="w">sv_setpv</span></code> had been reversed, then the macro <code class="inline"><span class="w">SvPOK_on</span></code> would need to be called instead of <code class="inline"><span class="w">SvIOK_on</span></code> .</p> <h3 id="Read-Only-Values">Read-Only Values</h3> <p>In Perl 5.16 and earlier, copy-on-write (see the next section) shared a flag bit with read-only scalars. So the only way to test whether <code class="inline"><span class="w">sv_setsv</span></code> , etc., will raise a "Modification of a read-only value" error in those versions is:</p> <pre class="verbatim" data-language="perl">SvREADONLY(sv) &amp;&amp; !SvIsCOW(sv)
</pre>
<p>Under Perl 5.18 and later, SvREADONLY only applies to read-only variables, and, under 5.20, copy-on-write scalars can also be read-only, so the above check is incorrect. You just want:</p> <pre class="verbatim" data-language="perl">SvREADONLY(sv)
</pre>
<p>If you need to do this check often, define your own macro like this:</p> <pre class="verbatim" data-language="perl">#if PERL_VERSION &gt;= 18
# define SvTRULYREADONLY(sv) SvREADONLY(sv)
#else
# define SvTRULYREADONLY(sv) (SvREADONLY(sv) &amp;&amp; !SvIsCOW(sv))
#endif
</pre>
<h3 id="Copy-on-Write">Copy on Write</h3> <p>Perl implements a copy-on-write (COW) mechanism for scalars, in which string copies are not immediately made when requested, but are deferred until made necessary by one or the other scalar changing. This is mostly transparent, but one must take care not to modify string buffers that are shared by multiple SVs.</p> <p>You can test whether an SV is using copy-on-write with <code class="inline"><span class="i">SvIsCOW</span><span class="s">(</span><span class="w">sv</span><span class="s">)</span></code> .</p> <p>You can force an SV to make its own copy of its string buffer by calling <code class="inline"><span class="i">sv_force_normal</span><span class="s">(</span><span class="w">sv</span><span class="s">)</span></code> or SvPV_force_nolen(sv).</p> <p>If you want to make the SV drop its string buffer, use <code class="inline"><span class="i">sv_force_normal_flags</span><span class="s">(</span><span class="w">sv</span><span class="cm">,</span> <span class="w">SV_COW_DROP_PV</span><span class="s">)</span></code> or simply <code class="inline"><span class="i">sv_setsv</span><span class="s">(</span><span class="w">sv</span><span class="cm">,</span> <span class="w">NULL</span><span class="s">)</span></code> .</p> <p>All of these functions will croak on read-only scalars (see the previous section for more on those).</p> <p>To test that your code is behaving correctly and not modifying COW buffers, on systems that support <i>mmap(2)</i> (i.e., Unix) you can configure perl with <code class="inline">-<span class="w">Accflags</span>=-<span class="w">DPERL_DEBUG_READONLY_COW</span></code> and it will turn buffer violations into crashes. You will find it to be marvellously slow, so you may want to skip perl's own tests.</p> <h3 id="Magic-Variables">Magic Variables</h3> <p>[This section still under construction. Ignore everything here. Post no bills. Everything not permitted is forbidden.]</p> <p>Any SV may be magical, that is, it has special features that a normal SV does not have. These features are stored in the SV structure in a linked list of <code class="inline"><span class="w">struct</span> <span class="w">magic</span></code> 's, typedef'ed to <code class="inline"><span class="w">MAGIC</span></code> .</p> <pre class="verbatim" data-language="perl">struct magic {
    MAGIC*      mg_moremagic;
    MGVTBL*     mg_virtual;
    U16         mg_private;
    char        mg_type;
    U8          mg_flags;
    I32         mg_len;
    SV*         mg_obj;
    char*       mg_ptr;
};
</pre>
<p>Note this is current as of patchlevel 0, and could change at any time.</p> <h3 id="Assigning-Magic">Assigning Magic</h3> <p>Perl adds magic to an SV using the sv_magic function:</p> <pre class="verbatim" data-language="perl">void sv_magic(SV* sv, SV* obj, int how, const char* name, I32 namlen);
</pre>
<p>The <code class="inline"><span class="w">sv</span></code> argument is a pointer to the SV that is to acquire a new magical feature.</p> <p>If <code class="inline"><span class="w">sv</span></code> is not already magical, Perl uses the <code class="inline"><span class="w">SvUPGRADE</span></code> macro to convert <code class="inline"><span class="w">sv</span></code> to type <code class="inline"><span class="w">SVt_PVMG</span></code> . Perl then continues by adding new magic to the beginning of the linked list of magical features. Any prior entry of the same type of magic is deleted. Note that this can be overridden, and multiple instances of the same type of magic can be associated with an SV.</p> <p>The <code class="inline"><span class="w">name</span></code> and <code class="inline"><span class="w">namlen</span></code> arguments are used to associate a string with the magic, typically the name of a variable. <code class="inline"><span class="w">namlen</span></code> is stored in the <code class="inline"><span class="w">mg_len</span></code> field and if <code class="inline"><span class="w">name</span></code> is non-null then either a <code class="inline"><span class="w">savepvn</span></code> copy of <code class="inline"><span class="w">name</span></code> or <code class="inline"><span class="w">name</span></code> itself is stored in the <code class="inline"><span class="w">mg_ptr</span></code> field, depending on whether <code class="inline"><span class="w">namlen</span></code> is greater than zero or equal to zero respectively. As a special case, if <code class="inline"><span class="s">(</span><span class="w">name</span> &amp;&amp; <span class="w">namlen</span> == <span class="w">HEf_SVKEY</span><span class="s">)</span></code> then <code class="inline"><span class="w">name</span></code> is assumed to contain an <code class="inline"><span class="w">SV</span>*</code> and is stored as-is with its REFCNT incremented.</p> <p>The sv_magic function uses <code class="inline"><span class="w">how</span></code> to determine which, if any, predefined "Magic Virtual Table" should be assigned to the <code class="inline"><span class="w">mg_virtual</span></code> field. See the <a href="#Magic-Virtual-Tables">Magic Virtual Tables</a> section below. The <code class="inline"><span class="w">how</span></code> argument is also stored in the <code class="inline"><span class="w">mg_type</span></code> field. The value of <code class="inline"><span class="w">how</span></code> should be chosen from the set of macros <code class="inline"><span class="w">PERL_MAGIC_foo</span></code> found in <i>perl.h</i>. Note that before these macros were added, Perl internals used to directly use character literals, so you may occasionally come across old code or documentation referring to 'U' magic rather than <code class="inline"><span class="w">PERL_MAGIC_uvar</span></code> for example.</p> <p>The <code class="inline"><span class="w">obj</span></code> argument is stored in the <code class="inline"><span class="w">mg_obj</span></code> field of the <code class="inline"><span class="w">MAGIC</span></code> structure. If it is not the same as the <code class="inline"><span class="w">sv</span></code> argument, the reference count of the <code class="inline"><span class="w">obj</span></code> object is incremented. If it is the same, or if the <code class="inline"><span class="w">how</span></code> argument is <code class="inline"><span class="w">PERL_MAGIC_arylen</span></code> , or if it is a NULL pointer, then <code class="inline"><span class="w">obj</span></code> is merely stored, without the reference count being incremented.</p> <p>See also <code class="inline"><span class="w">sv_magicext</span></code> in <a href="perlapi">perlapi</a> for a more flexible way to add magic to an SV.</p> <p>There is also a function to add magic to an <code class="inline"><span class="w">HV</span></code> :</p> <pre class="verbatim" data-language="perl">void hv_magic(HV *hv, GV *gv, int how);
</pre>
<p>This simply calls <code class="inline"><span class="w">sv_magic</span></code> and coerces the <code class="inline"><span class="w">gv</span></code> argument into an <code class="inline"><span class="w">SV</span></code> .</p> <p>To remove the magic from an SV, call the function sv_unmagic:</p> <pre class="verbatim" data-language="perl">int sv_unmagic(SV *sv, int type);
</pre>
<p>The <code class="inline"><span class="w">type</span></code> argument should be equal to the <code class="inline"><span class="w">how</span></code> value when the <code class="inline"><span class="w">SV</span></code> was initially made magical.</p> <p>However, note that <code class="inline"><span class="w">sv_unmagic</span></code> removes all magic of a certain <code class="inline"><span class="w">type</span></code> from the <code class="inline"><span class="w">SV</span></code> . If you want to remove only certain magic of a <code class="inline"><span class="w">type</span></code> based on the magic virtual table, use <code class="inline"><span class="w">sv_unmagicext</span></code> instead:</p> <pre class="verbatim" data-language="perl">int sv_unmagicext(SV *sv, int type, MGVTBL *vtbl);
</pre>
<h3 id="Magic-Virtual-Tables">Magic Virtual Tables</h3> <p>The <code class="inline"><span class="w">mg_virtual</span></code> field in the <code class="inline"><span class="w">MAGIC</span></code> structure is a pointer to an <code class="inline"><span class="w">MGVTBL</span></code> , which is a structure of function pointers and stands for "Magic Virtual Table" to handle the various operations that might be applied to that variable.</p> <p>The <code class="inline"><span class="w">MGVTBL</span></code> has five (or sometimes eight) pointers to the following routine types:</p> <pre class="verbatim" data-language="perl">int  (*svt_get)(SV* sv, MAGIC* mg);
int  (*svt_set)(SV* sv, MAGIC* mg);
U32  (*svt_len)(SV* sv, MAGIC* mg);
int  (*svt_clear)(SV* sv, MAGIC* mg);
int  (*svt_free)(SV* sv, MAGIC* mg);

int  (*svt_copy)(SV *sv, MAGIC* mg, SV *nsv,
                                      const char *name, I32 namlen);
int  (*svt_dup)(MAGIC *mg, CLONE_PARAMS *param);
int  (*svt_local)(SV *nsv, MAGIC *mg);
</pre>
<p>This MGVTBL structure is set at compile-time in <i>perl.h</i> and there are currently 32 types. These different structures contain pointers to various routines that perform additional actions depending on which function is being called.</p> <pre class="verbatim" data-language="perl">Function pointer    Action taken
----------------    ------------
svt_get             Do something before the value of the SV is
                    retrieved.
svt_set             Do something after the SV is assigned a value.
svt_len             Report on the SV's length.
svt_clear           Clear something the SV represents.
svt_free            Free any extra storage associated with the SV.

svt_copy            copy tied variable magic to a tied element
svt_dup             duplicate a magic structure during thread cloning
svt_local           copy magic to local value during 'local'
</pre>
<p>For instance, the MGVTBL structure called <code class="inline"><span class="w">vtbl_sv</span></code> (which corresponds to an <code class="inline"><span class="w">mg_type</span></code> of <code class="inline"><span class="w">PERL_MAGIC_sv</span></code> ) contains:</p> <pre class="verbatim" data-language="perl">{ magic_get, magic_set, magic_len, 0, 0 }
</pre>
<p>Thus, when an SV is determined to be magical and of type <code class="inline"><span class="w">PERL_MAGIC_sv</span></code> , if a get operation is being performed, the routine <code class="inline"><span class="w">magic_get</span></code> is called. All the various routines for the various magical types begin with <code class="inline"><span class="w">magic_</span></code> . NOTE: the magic routines are not considered part of the Perl API, and may not be exported by the Perl library.</p> <p>The last three slots are a recent addition, and for source code compatibility they are only checked for if one of the three flags MGf_COPY, MGf_DUP or MGf_LOCAL is set in mg_flags. This means that most code can continue declaring a vtable as a 5-element value. These three are currently used exclusively by the threading code, and are highly subject to change.</p> <p>The current kinds of Magic Virtual Tables are:</p> <pre class="verbatim" data-language="perl">mg_type
(old-style char and macro)   MGVTBL         Type of magic
--------------------------   ------         -------------
\0 PERL_MAGIC_sv             vtbl_sv        Special scalar variable
#  PERL_MAGIC_arylen         vtbl_arylen    Array length ($#ary)
%  PERL_MAGIC_rhash          (none)         Extra data for restricted
                                            hashes
*  PERL_MAGIC_debugvar       vtbl_debugvar  $DB::single, signal, trace
                                            vars
.  PERL_MAGIC_pos            vtbl_pos       pos() lvalue
:  PERL_MAGIC_symtab         (none)         Extra data for symbol
                                            tables
&lt;  PERL_MAGIC_backref        vtbl_backref   For weak ref data
@  PERL_MAGIC_arylen_p       (none)         To move arylen out of XPVAV
B  PERL_MAGIC_bm             vtbl_regexp    Boyer-Moore 
                                            (fast string search)
c  PERL_MAGIC_overload_table vtbl_ovrld     Holds overload table 
                                            (AMT) on stash
D  PERL_MAGIC_regdata        vtbl_regdata   Regex match position data 
                                            (@+ and @- vars)
d  PERL_MAGIC_regdatum       vtbl_regdatum  Regex match position data
                                            element
E  PERL_MAGIC_env            vtbl_env       %ENV hash
e  PERL_MAGIC_envelem        vtbl_envelem   %ENV hash element
f  PERL_MAGIC_fm             vtbl_regexp    Formline 
                                            ('compiled' format)
g  PERL_MAGIC_regex_global   vtbl_mglob     m//g target
H  PERL_MAGIC_hints          vtbl_hints     %^H hash
h  PERL_MAGIC_hintselem      vtbl_hintselem %^H hash element
I  PERL_MAGIC_isa            vtbl_isa       @ISA array
i  PERL_MAGIC_isaelem        vtbl_isaelem   @ISA array element
k  PERL_MAGIC_nkeys          vtbl_nkeys     scalar(keys()) lvalue
L  PERL_MAGIC_dbfile         (none)         Debugger %_&lt;filename
l  PERL_MAGIC_dbline         vtbl_dbline    Debugger %_&lt;filename
                                            element
N  PERL_MAGIC_shared         (none)         Shared between threads
n  PERL_MAGIC_shared_scalar  (none)         Shared between threads
o  PERL_MAGIC_collxfrm       vtbl_collxfrm  Locale transformation
P  PERL_MAGIC_tied           vtbl_pack      Tied array or hash
p  PERL_MAGIC_tiedelem       vtbl_packelem  Tied array or hash element
q  PERL_MAGIC_tiedscalar     vtbl_packelem  Tied scalar or handle
r  PERL_MAGIC_qr             vtbl_regexp    Precompiled qr// regex
S  PERL_MAGIC_sig            (none)         %SIG hash
s  PERL_MAGIC_sigelem        vtbl_sigelem   %SIG hash element
t  PERL_MAGIC_taint          vtbl_taint     Taintedness
U  PERL_MAGIC_uvar           vtbl_uvar      Available for use by
                                            extensions
u  PERL_MAGIC_uvar_elem      (none)         Reserved for use by
                                            extensions
V  PERL_MAGIC_vstring        (none)         SV was vstring literal
v  PERL_MAGIC_vec            vtbl_vec       vec() lvalue
w  PERL_MAGIC_utf8           vtbl_utf8      Cached UTF-8 information
x  PERL_MAGIC_substr         vtbl_substr    substr() lvalue
y  PERL_MAGIC_defelem        vtbl_defelem   Shadow "foreach" iterator
                                            variable / smart parameter
                                            vivification
\  PERL_MAGIC_lvref          vtbl_lvref     Lvalue reference
                                            constructor
]  PERL_MAGIC_checkcall      vtbl_checkcall Inlining/mutation of call
                                            to this CV
~  PERL_MAGIC_ext            (none)         Available for use by
                                            extensions
</pre>
<p>When an uppercase and lowercase letter both exist in the table, then the uppercase letter is typically used to represent some kind of composite type (a list or a hash), and the lowercase letter is used to represent an element of that composite type. Some internals code makes use of this case relationship. However, 'v' and 'V' (vec and v-string) are in no way related.</p> <p>The <code class="inline"><span class="w">PERL_MAGIC_ext</span></code> and <code class="inline"><span class="w">PERL_MAGIC_uvar</span></code> magic types are defined specifically for use by extensions and will not be used by perl itself. Extensions can use <code class="inline"><span class="w">PERL_MAGIC_ext</span></code> magic to 'attach' private information to variables (typically objects). This is especially useful because there is no way for normal perl code to corrupt this private information (unlike using extra elements of a hash object).</p> <p>Similarly, <code class="inline"><span class="w">PERL_MAGIC_uvar</span></code> magic can be used much like tie() to call a C function any time a scalar's value is used or changed. The <code class="inline"><span class="w">MAGIC</span></code> 's <code class="inline"><span class="w">mg_ptr</span></code> field points to a <code class="inline"><span class="w">ufuncs</span></code> structure:</p> <pre class="verbatim" data-language="perl">struct ufuncs {
    I32 (*uf_val)(pTHX_ IV, SV*);
    I32 (*uf_set)(pTHX_ IV, SV*);
    IV uf_index;
};
</pre>
<p>When the SV is read from or written to, the <code class="inline"><span class="w">uf_val</span></code> or <code class="inline"><span class="w">uf_set</span></code> function will be called with <code class="inline"><span class="w">uf_index</span></code> as the first arg and a pointer to the SV as the second. A simple example of how to add <code class="inline"><span class="w">PERL_MAGIC_uvar</span></code> magic is shown below. Note that the ufuncs structure is copied by sv_magic, so you can safely allocate it on the stack.</p> <pre class="verbatim" data-language="perl">void
Umagic(sv)
    SV *sv;
PREINIT:
    struct ufuncs uf;
CODE:
    uf.uf_val   = &amp;my_get_fn;
    uf.uf_set   = &amp;my_set_fn;
    uf.uf_index = 0;
    sv_magic(sv, 0, PERL_MAGIC_uvar, (char*)&amp;uf, sizeof(uf));
</pre>
<p>Attaching <code class="inline"><span class="w">PERL_MAGIC_uvar</span></code> to arrays is permissible but has no effect.</p> <p>For hashes there is a specialized hook that gives control over hash keys (but not values). This hook calls <code class="inline"><span class="w">PERL_MAGIC_uvar</span></code> 'get' magic if the "set" function in the <code class="inline"><span class="w">ufuncs</span></code> structure is NULL. The hook is activated whenever the hash is accessed with a key specified as an <code class="inline"><span class="w">SV</span></code> through the functions <code class="inline"><span class="w">hv_store_ent</span></code> , <code class="inline"><span class="w">hv_fetch_ent</span></code> , <code class="inline"><span class="w">hv_delete_ent</span></code> , and <code class="inline"><span class="w">hv_exists_ent</span></code> . Accessing the key as a string through the functions without the <code class="inline">...<span class="w">_ent</span></code> suffix circumvents the hook. See <a href="hash/util/fieldhash#GUTS">GUTS in Hash::Util::FieldHash</a> for a detailed description.</p> <p>Note that because multiple extensions may be using <code class="inline"><span class="w">PERL_MAGIC_ext</span></code> or <code class="inline"><span class="w">PERL_MAGIC_uvar</span></code> magic, it is important for extensions to take extra care to avoid conflict. Typically only using the magic on objects blessed into the same class as the extension is sufficient. For <code class="inline"><span class="w">PERL_MAGIC_ext</span></code> magic, it is usually a good idea to define an <code class="inline"><span class="w">MGVTBL</span></code> , even if all its fields will be <code class="inline"><span class="n">0</span></code> , so that individual <code class="inline"><span class="w">MAGIC</span></code> pointers can be identified as a particular kind of magic using their magic virtual table. <code class="inline"><span class="w">mg_findext</span></code> provides an easy way to do that:</p> <pre class="verbatim" data-language="perl">STATIC MGVTBL my_vtbl = { 0, 0, 0, 0, 0, 0, 0, 0 };

MAGIC *mg;
if ((mg = mg_findext(sv, PERL_MAGIC_ext, &amp;my_vtbl))) {
    /* this is really ours, not another module's PERL_MAGIC_ext */
    my_priv_data_t *priv = (my_priv_data_t *)mg-&gt;mg_ptr;
    ...
}
</pre>
<p>Also note that the <code class="inline"><span class="w">sv_set</span>*<span class="s">(</span><span class="s">)</span></code> and <code class="inline"><span class="w">sv_cat</span>*<span class="s">(</span><span class="s">)</span></code> functions described earlier do <b>not</b> invoke 'set' magic on their targets. This must be done by the user either by calling the <code class="inline"><span class="i">SvSETMAGIC</span><span class="s">(</span><span class="s">)</span></code> macro after calling these functions, or by using one of the <code class="inline"><span class="w">sv_set</span>*<span class="i">_mg</span><span class="s">(</span><span class="s">)</span></code> or <code class="inline"><span class="w">sv_cat</span>*<span class="i">_mg</span><span class="s">(</span><span class="s">)</span></code> functions. Similarly, generic C code must call the <code class="inline"><span class="i">SvGETMAGIC</span><span class="s">(</span><span class="s">)</span></code> macro to invoke any 'get' magic if they use an SV obtained from external sources in functions that don't handle magic. See <a href="perlapi">perlapi</a> for a description of these functions. For example, calls to the <code class="inline"><span class="w">sv_cat</span>*<span class="s">(</span><span class="s">)</span></code> functions typically need to be followed by <code class="inline"><span class="i">SvSETMAGIC</span><span class="s">(</span><span class="s">)</span></code> , but they don't need a prior <code class="inline"><span class="i">SvGETMAGIC</span><span class="s">(</span><span class="s">)</span></code> since their implementation handles 'get' magic.</p> <h3 id="Finding-Magic">Finding Magic</h3> <pre class="verbatim" data-language="perl">MAGIC *mg_find(SV *sv, int type); /* Finds the magic pointer of that
                                                                          * type */
</pre>
<p>This routine returns a pointer to a <code class="inline"><span class="w">MAGIC</span></code> structure stored in the SV. If the SV does not have that magical feature, <code class="inline"><span class="w">NULL</span></code> is returned. If the SV has multiple instances of that magical feature, the first one will be returned. <code class="inline"><span class="w">mg_findext</span></code> can be used to find a <code class="inline"><span class="w">MAGIC</span></code> structure of an SV based on both its magic type and its magic virtual table:</p> <pre class="verbatim" data-language="perl">MAGIC *mg_findext(SV *sv, int type, MGVTBL *vtbl);
</pre>
<p>Also, if the SV passed to <code class="inline"><span class="w">mg_find</span></code> or <code class="inline"><span class="w">mg_findext</span></code> is not of type SVt_PVMG, Perl may core dump.</p> <pre class="verbatim" data-language="perl">int mg_copy(SV* sv, SV* nsv, const char* key, STRLEN klen);
</pre>
<p>This routine checks to see what types of magic <code class="inline"><span class="w">sv</span></code> has. If the mg_type field is an uppercase letter, then the mg_obj is copied to <code class="inline"><span class="w">nsv</span></code> , but the mg_type field is changed to be the lowercase letter.</p> <h3 id="Understanding-the-Magic-of-Tied-Hashes-and-Arrays">Understanding the Magic of Tied Hashes and Arrays</h3> <p>Tied hashes and arrays are magical beasts of the <code class="inline"><span class="w">PERL_MAGIC_tied</span></code> magic type.</p> <p>WARNING: As of the 5.004 release, proper usage of the array and hash access functions requires understanding a few caveats. Some of these caveats are actually considered bugs in the API, to be fixed in later releases, and are bracketed with [MAYCHANGE] below. If you find yourself actually applying such information in this section, be aware that the behavior may change in the future, umm, without warning.</p> <p>The perl tie function associates a variable with an object that implements the various GET, SET, etc methods. To perform the equivalent of the perl tie function from an XSUB, you must mimic this behaviour. The code below carries out the necessary steps -- firstly it creates a new hash, and then creates a second hash which it blesses into the class which will implement the tie methods. Lastly it ties the two hashes together, and returns a reference to the new tied hash. Note that the code below does NOT call the TIEHASH method in the MyTie class - see <a href="#Calling-Perl-Routines-from-within-C-Programs">Calling Perl Routines from within C Programs</a> for details on how to do this.</p> <pre class="verbatim" data-language="perl">SV*
mytie()
PREINIT:
    HV *hash;
    HV *stash;
    SV *tie;
CODE:
    hash = newHV();
    tie = newRV_noinc((SV*)newHV());
    stash = gv_stashpv("MyTie", GV_ADD);
    sv_bless(tie, stash);
    hv_magic(hash, (GV*)tie, PERL_MAGIC_tied);
    RETVAL = newRV_noinc(hash);
OUTPUT:
    RETVAL
</pre>
<p>The <code class="inline"><span class="w">av_store</span></code> function, when given a tied array argument, merely copies the magic of the array onto the value to be "stored", using <code class="inline"><span class="w">mg_copy</span></code> . It may also return NULL, indicating that the value did not actually need to be stored in the array. [MAYCHANGE] After a call to <code class="inline"><span class="w">av_store</span></code> on a tied array, the caller will usually need to call <code class="inline"><span class="i">mg_set</span><span class="s">(</span><span class="w">val</span><span class="s">)</span></code> to actually invoke the perl level "STORE" method on the TIEARRAY object. If <code class="inline"><span class="w">av_store</span></code> did return NULL, a call to <code class="inline"><span class="i">SvREFCNT_dec</span><span class="s">(</span><span class="w">val</span><span class="s">)</span></code> will also be usually necessary to avoid a memory leak. [/MAYCHANGE]</p> <p>The previous paragraph is applicable verbatim to tied hash access using the <code class="inline"><span class="w">hv_store</span></code> and <code class="inline"><span class="w">hv_store_ent</span></code> functions as well.</p> <p><code class="inline"><span class="w">av_fetch</span></code> and the corresponding hash functions <code class="inline"><span class="w">hv_fetch</span></code> and <code class="inline"><span class="w">hv_fetch_ent</span></code> actually return an undefined mortal value whose magic has been initialized using <code class="inline"><span class="w">mg_copy</span></code> . Note the value so returned does not need to be deallocated, as it is already mortal. [MAYCHANGE] But you will need to call <code class="inline"><span class="i">mg_get</span><span class="s">(</span><span class="s">)</span></code> on the returned value in order to actually invoke the perl level "FETCH" method on the underlying TIE object. Similarly, you may also call <code class="inline"><span class="i">mg_set</span><span class="s">(</span><span class="s">)</span></code> on the return value after possibly assigning a suitable value to it using <code class="inline"><span class="w">sv_setsv</span></code> , which will invoke the "STORE" method on the TIE object. [/MAYCHANGE]</p> <p>[MAYCHANGE] In other words, the array or hash fetch/store functions don't really fetch and store actual values in the case of tied arrays and hashes. They merely call <code class="inline"><span class="w">mg_copy</span></code> to attach magic to the values that were meant to be "stored" or "fetched". Later calls to <code class="inline"><span class="w">mg_get</span></code> and <code class="inline"><span class="w">mg_set</span></code> actually do the job of invoking the TIE methods on the underlying objects. Thus the magic mechanism currently implements a kind of lazy access to arrays and hashes.</p> <p>Currently (as of perl version 5.004), use of the hash and array access functions requires the user to be aware of whether they are operating on "normal" hashes and arrays, or on their tied variants. The API may be changed to provide more transparent access to both tied and normal data types in future versions. [/MAYCHANGE]</p> <p>You would do well to understand that the TIEARRAY and TIEHASH interfaces are mere sugar to invoke some perl method calls while using the uniform hash and array syntax. The use of this sugar imposes some overhead (typically about two to four extra opcodes per FETCH/STORE operation, in addition to the creation of all the mortal variables required to invoke the methods). This overhead will be comparatively small if the TIE methods are themselves substantial, but if they are only a few statements long, the overhead will not be insignificant.</p> <h3 id="Localizing-changes">Localizing changes</h3> <p>Perl has a very handy construction</p> <pre class="verbatim" data-language="perl">{
  local $var = 2;
  ...
}
</pre>
<p>This construction is <i>approximately</i> equivalent to</p> <pre class="verbatim" data-language="perl">{
  my $oldvar = $var;
  $var = 2;
  ...
  $var = $oldvar;
}
</pre>
<p>The biggest difference is that the first construction would reinstate the initial value of $var, irrespective of how control exits the block: <code class="inline"><a class="l_k" href="functions/goto">goto</a></code>, <code class="inline"><a class="l_k" href="functions/return">return</a></code>, <code class="inline"><a class="l_k" href="functions/die">die</a></code>/<code class="inline"><a class="l_k" href="functions/eval">eval</a></code>, etc. It is a little bit more efficient as well.</p> <p>There is a way to achieve a similar task from C via Perl API: create a <i>pseudo-block</i>, and arrange for some changes to be automatically undone at the end of it, either explicit, or via a non-local exit (via die()). A <i>block</i>-like construct is created by a pair of <code class="inline"><span class="w">ENTER</span></code> /<code class="inline"><span class="w">LEAVE</span></code> macros (see <a href="perlcall#Returning-a-Scalar">Returning a Scalar in perlcall</a>). Such a construct may be created specially for some important localized task, or an existing one (like boundaries of enclosing Perl subroutine/block, or an existing pair for freeing TMPs) may be used. (In the second case the overhead of additional localization must be almost negligible.) Note that any XSUB is automatically enclosed in an <code class="inline"><span class="w">ENTER</span></code> /<code class="inline"><span class="w">LEAVE</span></code> pair.</p> <p>Inside such a <i>pseudo-block</i> the following service is available:</p> <ul> <li id="SAVEINT(int-i)">
<b><code class="inline"><span class="i">SAVEINT</span><span class="s">(</span><a class="l_k" href="functions/int">int</a> <span class="w">i</span><span class="s">)</span></code> </b> </li> <li id="SAVEIV(IV-i)">
<b><code class="inline"><span class="i">SAVEIV</span><span class="s">(</span><span class="w">IV</span> <span class="w">i</span><span class="s">)</span></code> </b> </li> <li id="SAVEI32(I32-i)">
<b><code class="inline"><span class="i">SAVEI32</span><span class="s">(</span><span class="w">I32</span> <span class="w">i</span><span class="s">)</span></code> </b> </li> <li id="SAVELONG(long-i)">
<b><code class="inline"><span class="i">SAVELONG</span><span class="s">(</span><span class="w">long</span> <span class="w">i</span><span class="s">)</span></code> </b> <p>These macros arrange things to restore the value of integer variable <code class="inline"><span class="w">i</span></code> at the end of enclosing <i>pseudo-block</i>.</p> </li> <li id="SAVESPTR(s)">
<b><code class="inline">SAVESPTR(s)</code></b> </li> <li id="SAVEPPTR(p)">
<b><code class="inline"><span class="i">SAVEPPTR</span><span class="s">(</span><span class="w">p</span><span class="s">)</span></code> </b> <p>These macros arrange things to restore the value of pointers <code class="inline"><a class="l_k" href="functions/s">s</a></code> and <code class="inline"><span class="w">p</span></code> . <code class="inline"><a class="l_k" href="functions/s">s</a></code> must be a pointer of a type which survives conversion to <code class="inline"><span class="w">SV</span>*</code> and back, <code class="inline"><span class="w">p</span></code> should be able to survive conversion to <code class="inline"><span class="w">char</span>*</code> and back.</p> </li> <li id="SAVEFREESV(SV-*sv)">
<b><code class="inline"><span class="i">SAVEFREESV</span><span class="s">(</span><span class="w">SV</span> *<span class="w">sv</span><span class="s">)</span></code> </b> <p>The refcount of <code class="inline"><span class="w">sv</span></code> would be decremented at the end of <i>pseudo-block</i>. This is similar to <code class="inline"><span class="w">sv_2mortal</span></code> in that it is also a mechanism for doing a delayed <code class="inline"><span class="w">SvREFCNT_dec</span></code> . However, while <code class="inline"><span class="w">sv_2mortal</span></code> extends the lifetime of <code class="inline"><span class="w">sv</span></code> until the beginning of the next statement, <code class="inline"><span class="w">SAVEFREESV</span></code> extends it until the end of the enclosing scope. These lifetimes can be wildly different.</p> <p>Also compare <code class="inline"><span class="w">SAVEMORTALIZESV</span></code> .</p> </li> <li id="SAVEMORTALIZESV(SV-*sv)">
<b><code class="inline"><span class="i">SAVEMORTALIZESV</span><span class="s">(</span><span class="w">SV</span> *<span class="w">sv</span><span class="s">)</span></code> </b> <p>Just like <code class="inline"><span class="w">SAVEFREESV</span></code> , but mortalizes <code class="inline"><span class="w">sv</span></code> at the end of the current scope instead of decrementing its reference count. This usually has the effect of keeping <code class="inline"><span class="w">sv</span></code> alive until the statement that called the currently live scope has finished executing.</p> </li> <li id="SAVEFREEOP(OP-*op)">
<b><code class="inline"><span class="i">SAVEFREEOP</span><span class="s">(</span><span class="w">OP</span> *<span class="w">op</span><span class="s">)</span></code> </b> <p>The <code class="inline"><span class="w">OP</span> *</code> is op_free()ed at the end of <i>pseudo-block</i>.</p> </li> <li id="SAVEFREEPV(p)">
<b><code class="inline"><span class="i">SAVEFREEPV</span><span class="s">(</span><span class="w">p</span><span class="s">)</span></code> </b> <p>The chunk of memory which is pointed to by <code class="inline"><span class="w">p</span></code> is Safefree()ed at the end of <i>pseudo-block</i>.</p> </li> <li id="SAVECLEARSV(SV-*sv)">
<b><code class="inline"><span class="i">SAVECLEARSV</span><span class="s">(</span><span class="w">SV</span> *<span class="w">sv</span><span class="s">)</span></code> </b> <p>Clears a slot in the current scratchpad which corresponds to <code class="inline"><span class="w">sv</span></code> at the end of <i>pseudo-block</i>.</p> </li> <li id="SAVEDELETE(HV-*hv%2c-char-*key%2c-I32-length)">
<b><code class="inline"><span class="i">SAVEDELETE</span><span class="s">(</span><span class="w">HV</span> *<span class="w">hv</span><span class="cm">,</span> <span class="w">char</span> *<span class="w">key</span><span class="cm">,</span> <span class="w">I32</span> <a class="l_k" href="functions/length">length</a><span class="s">)</span></code> </b> <p>The key <code class="inline"><span class="w">key</span></code> of <code class="inline"><span class="w">hv</span></code> is deleted at the end of <i>pseudo-block</i>. The string pointed to by <code class="inline"><span class="w">key</span></code> is Safefree()ed. If one has a <i>key</i> in short-lived storage, the corresponding string may be reallocated like this:</p> <pre class="verbatim" data-language="perl">SAVEDELETE(PL_defstash, savepv(tmpbuf), strlen(tmpbuf));
</pre>
</li> <li id="SAVEDESTRUCTOR(DESTRUCTORFUNC_NOCONTEXT_t-f%2c-void-*p)">
<b><code class="inline"><span class="i">SAVEDESTRUCTOR</span><span class="s">(</span><span class="w">DESTRUCTORFUNC_NOCONTEXT_t</span> <span class="w">f</span><span class="cm">,</span> <span class="w">void</span> *<span class="w">p</span><span class="s">)</span></code> </b> <p>At the end of <i>pseudo-block</i> the function <code class="inline"><span class="w">f</span></code> is called with the only argument <code class="inline"><span class="w">p</span></code> .</p> </li> <li id="SAVEDESTRUCTOR_X(DESTRUCTORFUNC_t-f%2c-void-*p)">
<b><code class="inline"><span class="i">SAVEDESTRUCTOR_X</span><span class="s">(</span><span class="w">DESTRUCTORFUNC_t</span> <span class="w">f</span><span class="cm">,</span> <span class="w">void</span> *<span class="w">p</span><span class="s">)</span></code> </b> <p>At the end of <i>pseudo-block</i> the function <code class="inline"><span class="w">f</span></code> is called with the implicit context argument (if any), and <code class="inline"><span class="w">p</span></code> .</p> </li> <li id="SAVESTACK_POS()">
<b><code class="inline"><span class="i">SAVESTACK_POS</span><span class="s">(</span><span class="s">)</span></code> </b> <p>The current offset on the Perl internal stack (cf. <code class="inline"><span class="w">SP</span></code> ) is restored at the end of <i>pseudo-block</i>.</p> </li> </ul> <p>The following API list contains functions, thus one needs to provide pointers to the modifiable data explicitly (either C pointers, or Perlish <code class="inline"><span class="w">GV</span> *</code> s). Where the above macros take <code class="inline"><a class="l_k" href="functions/int">int</a></code>, a similar function takes <code class="inline"><a class="l_k" href="functions/int">int</a> <span class="i">*</span></code> .</p> <ul> <li id="SV*-save_scalar(GV-*gv)">
<b><code class="inline"><span class="w">SV</span>* <span class="i">save_scalar</span><span class="s">(</span><span class="w">GV</span> *<span class="w">gv</span><span class="s">)</span></code> </b> <p>Equivalent to Perl code <code class="inline"><a class="l_k" href="functions/local">local</a> <span class="i">$gv</span></code> .</p> </li> <li id="AV*-save_ary(GV-*gv)">
<b><code class="inline"><span class="w">AV</span>* <span class="i">save_ary</span><span class="s">(</span><span class="w">GV</span> *<span class="w">gv</span><span class="s">)</span></code> </b> </li> <li id="HV*-save_hash(GV-*gv)">
<b><code class="inline"><span class="w">HV</span>* <span class="i">save_hash</span><span class="s">(</span><span class="w">GV</span> *<span class="w">gv</span><span class="s">)</span></code> </b> <p>Similar to <code class="inline"><span class="w">save_scalar</span></code> , but localize <code class="inline"><span class="i">@gv</span></code> and <code class="inline"><span class="i">%gv</span></code> .</p> </li> <li id="void-save_item(SV-*item)">
<b><code class="inline"><span class="w">void</span> <span class="i">save_item</span><span class="s">(</span><span class="w">SV</span> *<span class="w">item</span><span class="s">)</span></code> </b> <p>Duplicates the current value of <code class="inline"><span class="w">SV</span></code> , on the exit from the current <code class="inline"><span class="w">ENTER</span></code> /<code class="inline"><span class="w">LEAVE</span></code> <i>pseudo-block</i> will restore the value of <code class="inline"><span class="w">SV</span></code> using the stored value. It doesn't handle magic. Use <code class="inline"><span class="w">save_scalar</span></code> if magic is affected.</p> </li> <li id="void-save_list(SV-**sarg%2c-I32-maxsarg)">
<b><code class="inline"><span class="w">void</span> <span class="i">save_list</span><span class="s">(</span><span class="w">SV</span> **<span class="w">sarg</span><span class="cm">,</span> <span class="w">I32</span> <span class="w">maxsarg</span><span class="s">)</span></code> </b> <p>A variant of <code class="inline"><span class="w">save_item</span></code> which takes multiple arguments via an array <code class="inline"><span class="w">sarg</span></code> of <code class="inline"><span class="w">SV</span>*</code> of length <code class="inline"><span class="w">maxsarg</span></code> .</p> </li> <li id="SV*-save_svref(SV-**sptr)">
<b><code class="inline"><span class="w">SV</span>* <span class="i">save_svref</span><span class="s">(</span><span class="w">SV</span> **<span class="w">sptr</span><span class="s">)</span></code> </b> <p>Similar to <code class="inline"><span class="w">save_scalar</span></code> , but will reinstate an <code class="inline"><span class="w">SV</span> *</code> .</p> </li> <li id="void-save_aptr(AV-**aptr)">
<b><code class="inline"><span class="w">void</span> <span class="i">save_aptr</span><span class="s">(</span><span class="w">AV</span> **<span class="w">aptr</span><span class="s">)</span></code> </b> </li> <li id="void-save_hptr(HV-**hptr)">
<b><code class="inline"><span class="w">void</span> <span class="i">save_hptr</span><span class="s">(</span><span class="w">HV</span> **<span class="w">hptr</span><span class="s">)</span></code> </b> <p>Similar to <code class="inline"><span class="w">save_svref</span></code> , but localize <code class="inline"><span class="w">AV</span> *</code> and <code class="inline"><span class="w">HV</span> *</code> .</p> </li> </ul> <p>The <code class="inline"><span class="w">Alias</span></code> module implements localization of the basic types within the <i>caller's scope</i>. People who are interested in how to localize things in the containing scope should take a look there too.</p> <h2 id="Subroutines">Subroutines</h2> <h3 id="XSUBs-and-the-Argument-Stack">XSUBs and the Argument Stack</h3> <p>The XSUB mechanism is a simple way for Perl programs to access C subroutines. An XSUB routine will have a stack that contains the arguments from the Perl program, and a way to map from the Perl data structures to a C equivalent.</p> <p>The stack arguments are accessible through the <code class="inline"><span class="i">ST</span><span class="s">(</span><span class="w">n</span><span class="s">)</span></code> macro, which returns the <code class="inline"><span class="w">n</span></code> 'th stack argument. Argument 0 is the first argument passed in the Perl subroutine call. These arguments are <code class="inline"><span class="w">SV</span>*</code> , and can be used anywhere an <code class="inline"><span class="w">SV</span>*</code> is used.</p> <p>Most of the time, output from the C routine can be handled through use of the RETVAL and OUTPUT directives. However, there are some cases where the argument stack is not already long enough to handle all the return values. An example is the POSIX tzname() call, which takes no arguments, but returns two, the local time zone's standard and summer time abbreviations.</p> <p>To handle this situation, the PPCODE directive is used and the stack is extended using the macro:</p> <pre class="verbatim" data-language="perl">EXTEND(SP, num);
</pre>
<p>where <code class="inline"><span class="w">SP</span></code> is the macro that represents the local copy of the stack pointer, and <code class="inline"><span class="w">num</span></code> is the number of elements the stack should be extended by.</p> <p>Now that there is room on the stack, values can be pushed on it using <code class="inline"><span class="w">PUSHs</span></code> macro. The pushed values will often need to be "mortal" (See <a href="#Reference-Counts-and-Mortality">Reference Counts and Mortality</a>):</p> <pre class="verbatim" data-language="perl">PUSHs(sv_2mortal(newSViv(an_integer)))
PUSHs(sv_2mortal(newSVuv(an_unsigned_integer)))
PUSHs(sv_2mortal(newSVnv(a_double)))
PUSHs(sv_2mortal(newSVpv("Some String",0)))
/* Although the last example is better written as the more
 * efficient: */
PUSHs(newSVpvs_flags("Some String", SVs_TEMP))
</pre>
<p>And now the Perl program calling <code class="inline"><span class="w">tzname</span></code> , the two values will be assigned as in:</p> <pre class="verbatim" data-language="perl">($standard_abbrev, $summer_abbrev) = POSIX::tzname;
</pre>
<p>An alternate (and possibly simpler) method to pushing values on the stack is to use the macro:</p> <pre class="verbatim" data-language="perl">XPUSHs(SV*)
</pre>
<p>This macro automatically adjusts the stack for you, if needed. Thus, you do not need to call <code class="inline"><span class="w">EXTEND</span></code> to extend the stack.</p> <p>Despite their suggestions in earlier versions of this document the macros <code class="inline">(X)PUSH[iunp]</code> are <i>not</i> suited to XSUBs which return multiple results. For that, either stick to the <code class="inline">(X)PUSHs</code> macros shown above, or use the new <code class="inline"><a class="l_k" href="functions/m">m(X)PUSH[iunp]</a></code> macros instead; see <a href="#Putting-a-C-value-on-Perl-stack">Putting a C value on Perl stack</a>.</p> <p>For more information, consult <a href="perlxs">perlxs</a> and <a href="perlxstut">perlxstut</a>.</p> <h3 id="Autoloading-with-XSUBs">Autoloading with XSUBs</h3> <p>If an AUTOLOAD routine is an XSUB, as with Perl subroutines, Perl puts the fully-qualified name of the autoloaded subroutine in the $AUTOLOAD variable of the XSUB's package.</p> <p>But it also puts the same information in certain fields of the XSUB itself:</p> <pre class="verbatim" data-language="perl">HV *stash           = CvSTASH(cv);
const char *subname = SvPVX(cv);
STRLEN name_length  = SvCUR(cv); /* in bytes */
U32 is_utf8         = SvUTF8(cv);
</pre>
<p><code class="inline"><span class="i">SvPVX</span><span class="s">(</span><span class="w">cv</span><span class="s">)</span></code> contains just the sub name itself, not including the package. For an AUTOLOAD routine in UNIVERSAL or one of its superclasses, <code class="inline"><span class="i">CvSTASH</span><span class="s">(</span><span class="w">cv</span><span class="s">)</span></code> returns NULL during a method call on a nonexistent package.</p> <p><b>Note</b>: Setting $AUTOLOAD stopped working in 5.6.1, which did not support XS AUTOLOAD subs at all. Perl 5.8.0 introduced the use of fields in the XSUB itself. Perl 5.16.0 restored the setting of $AUTOLOAD. If you need to support 5.8-5.14, use the XSUB's fields.</p> <h3 id="Calling-Perl-Routines-from-within-C-Programs">Calling Perl Routines from within C Programs</h3> <p>There are four routines that can be used to call a Perl subroutine from within a C program. These four are:</p> <pre class="verbatim" data-language="perl">I32  call_sv(SV*, I32);
I32  call_pv(const char*, I32);
I32  call_method(const char*, I32);
I32  call_argv(const char*, I32, char**);
</pre>
<p>The routine most often used is <code class="inline"><span class="w">call_sv</span></code> . The <code class="inline"><span class="w">SV</span>*</code> argument contains either the name of the Perl subroutine to be called, or a reference to the subroutine. The second argument consists of flags that control the context in which the subroutine is called, whether or not the subroutine is being passed arguments, how errors should be trapped, and how to treat return values.</p> <p>All four routines return the number of arguments that the subroutine returned on the Perl stack.</p> <p>These routines used to be called <code class="inline"><span class="w">perl_call_sv</span></code> , etc., before Perl v5.6.0, but those names are now deprecated; macros of the same name are provided for compatibility.</p> <p>When using any of these routines (except <code class="inline"><span class="w">call_argv</span></code> ), the programmer must manipulate the Perl stack. These include the following macros and functions:</p> <pre class="verbatim" data-language="perl">dSP
SP
PUSHMARK()
PUTBACK
SPAGAIN
ENTER
SAVETMPS
FREETMPS
LEAVE
XPUSH*()
POP*()
</pre>
<p>For a detailed description of calling conventions from C to Perl, consult <a href="perlcall">perlcall</a>.</p> <h3 id="Putting-a-C-value-on-Perl-stack">Putting a C value on Perl stack</h3> <p>A lot of opcodes (this is an elementary operation in the internal perl stack machine) put an SV* on the stack. However, as an optimization the corresponding SV is (usually) not recreated each time. The opcodes reuse specially assigned SVs (<i>target</i>s) which are (as a corollary) not constantly freed/created.</p> <p>Each of the targets is created only once (but see <a href="#Scratchpads-and-recursion">Scratchpads and recursion</a> below), and when an opcode needs to put an integer, a double, or a string on stack, it just sets the corresponding parts of its <i>target</i> and puts the <i>target</i> on stack.</p> <p>The macro to put this target on stack is <code class="inline"><span class="w">PUSHTARG</span></code> , and it is directly used in some opcodes, as well as indirectly in zillions of others, which use it via <code class="inline">(X)PUSH[iunp]</code>.</p> <p>Because the target is reused, you must be careful when pushing multiple values on the stack. The following code will not do what you think:</p> <pre class="verbatim" data-language="perl">XPUSHi(10);
XPUSHi(20);
</pre>
<p>This translates as "set <code class="inline"><span class="w">TARG</span></code> to 10, push a pointer to <code class="inline"><span class="w">TARG</span></code> onto the stack; set <code class="inline"><span class="w">TARG</span></code> to 20, push a pointer to <code class="inline"><span class="w">TARG</span></code> onto the stack". At the end of the operation, the stack does not contain the values 10 and 20, but actually contains two pointers to <code class="inline"><span class="w">TARG</span></code> , which we have set to 20.</p> <p>If you need to push multiple different values then you should either use the <code class="inline">(X)PUSHs</code> macros, or else use the new <code class="inline"><a class="l_k" href="functions/m">m(X)PUSH[iunp]</a></code> macros, none of which make use of <code class="inline"><span class="w">TARG</span></code> . The <code class="inline">(X)PUSHs</code> macros simply push an SV* on the stack, which, as noted under <a href="#XSUBs-and-the-Argument-Stack">XSUBs and the Argument Stack</a>, will often need to be "mortal". The new <code class="inline"><a class="l_k" href="functions/m">m(X)PUSH[iunp]</a></code> macros make this a little easier to achieve by creating a new mortal for you (via <code class="inline">(X)PUSHmortal</code>), pushing that onto the stack (extending it if necessary in the case of the <code class="inline"><span class="w">mXPUSH</span><span class="s">[</span><span class="w">iunp</span><span class="s">]</span></code> macros), and then setting its value. Thus, instead of writing this to "fix" the example above:</p> <pre class="verbatim" data-language="perl">XPUSHs(sv_2mortal(newSViv(10)))
XPUSHs(sv_2mortal(newSViv(20)))
</pre>
<p>you can simply write:</p> <pre class="verbatim" data-language="perl">mXPUSHi(10)
mXPUSHi(20)
</pre>
<p>On a related note, if you do use <code class="inline">(X)PUSH[iunp]</code>, then you're going to need a <code class="inline"><span class="w">dTARG</span></code> in your variable declarations so that the <code class="inline"><span class="i">*PUSH</span>*</code> macros can make use of the local variable <code class="inline"><span class="w">TARG</span></code> . See also <code class="inline"><span class="w">dTARGET</span></code> and <code class="inline"><span class="w">dXSTARG</span></code> .</p> <h3 id="Scratchpads">Scratchpads</h3> <p>The question remains on when the SVs which are <i>target</i>s for opcodes are created. The answer is that they are created when the current unit--a subroutine or a file (for opcodes for statements outside of subroutines)--is compiled. During this time a special anonymous Perl array is created, which is called a scratchpad for the current unit.</p> <p>A scratchpad keeps SVs which are lexicals for the current unit and are targets for opcodes. A previous version of this document stated that one can deduce that an SV lives on a scratchpad by looking on its flags: lexicals have <code class="inline"><span class="w">SVs_PADMY</span></code> set, and <i>target</i>s have <code class="inline"><span class="w">SVs_PADTMP</span></code> set. But this has never been fully true. <code class="inline"><span class="w">SVs_PADMY</span></code> could be set on a variable that no longer resides in any pad. While <i>target</i>s do have <code class="inline"><span class="w">SVs_PADTMP</span></code> set, it can also be set on variables that have never resided in a pad, but nonetheless act like <i>target</i>s. As of perl 5.21.5, the <code class="inline"><span class="w">SVs_PADMY</span></code> flag is no longer used and is defined as 0. <code class="inline"><span class="i">SvPADMY</span><span class="s">(</span><span class="s">)</span></code> now returns true for anything without <code class="inline"><span class="w">SVs_PADTMP</span></code> .</p> <p>The correspondence between OPs and <i>target</i>s is not 1-to-1. Different OPs in the compile tree of the unit can use the same target, if this would not conflict with the expected life of the temporary.</p> <h3 id="Scratchpads-and-recursion">Scratchpads and recursion</h3> <p>In fact it is not 100% true that a compiled unit contains a pointer to the scratchpad AV. In fact it contains a pointer to an AV of (initially) one element, and this element is the scratchpad AV. Why do we need an extra level of indirection?</p> <p>The answer is <b>recursion</b>, and maybe <b>threads</b>. Both these can create several execution pointers going into the same subroutine. For the subroutine-child not write over the temporaries for the subroutine-parent (lifespan of which covers the call to the child), the parent and the child should have different scratchpads. (<i>And</i> the lexicals should be separate anyway!)</p> <p>So each subroutine is born with an array of scratchpads (of length 1). On each entry to the subroutine it is checked that the current depth of the recursion is not more than the length of this array, and if it is, new scratchpad is created and pushed into the array.</p> <p>The <i>target</i>s on this scratchpad are <code class="inline"><a class="l_k" href="functions/undef">undef</a></code>s, but they are already marked with correct flags.</p> <h2 id="Memory-Allocation">Memory Allocation</h2> <h3 id="Allocation">Allocation</h3> <p>All memory meant to be used with the Perl API functions should be manipulated using the macros described in this section. The macros provide the necessary transparency between differences in the actual malloc implementation that is used within perl.</p> <p>It is suggested that you enable the version of malloc that is distributed with Perl. It keeps pools of various sizes of unallocated memory in order to satisfy allocation requests more quickly. However, on some platforms, it may cause spurious malloc or free errors.</p> <p>The following three macros are used to initially allocate memory :</p> <pre class="verbatim" data-language="perl">Newx(pointer, number, type);
Newxc(pointer, number, type, cast);
Newxz(pointer, number, type);
</pre>
<p>The first argument <code class="inline"><span class="w">pointer</span></code> should be the name of a variable that will point to the newly allocated memory.</p> <p>The second and third arguments <code class="inline"><span class="w">number</span></code> and <code class="inline"><span class="w">type</span></code> specify how many of the specified type of data structure should be allocated. The argument <code class="inline"><span class="w">type</span></code> is passed to <code class="inline"><span class="w">sizeof</span></code> . The final argument to <code class="inline"><span class="w">Newxc</span></code> , <code class="inline"><span class="w">cast</span></code> , should be used if the <code class="inline"><span class="w">pointer</span></code> argument is different from the <code class="inline"><span class="w">type</span></code> argument.</p> <p>Unlike the <code class="inline"><span class="w">Newx</span></code> and <code class="inline"><span class="w">Newxc</span></code> macros, the <code class="inline"><span class="w">Newxz</span></code> macro calls <code class="inline"><span class="w">memzero</span></code> to zero out all the newly allocated memory.</p> <h3 id="Reallocation">Reallocation</h3> <pre class="verbatim" data-language="perl">Renew(pointer, number, type);
Renewc(pointer, number, type, cast);
Safefree(pointer)
</pre>
<p>These three macros are used to change a memory buffer size or to free a piece of memory no longer needed. The arguments to <code class="inline"><span class="w">Renew</span></code> and <code class="inline"><span class="w">Renewc</span></code> match those of <code class="inline"><span class="w">New</span></code> and <code class="inline"><span class="w">Newc</span></code> with the exception of not needing the "magic cookie" argument.</p> <h3 id="Moving">Moving</h3> <pre class="verbatim" data-language="perl">Move(source, dest, number, type);
Copy(source, dest, number, type);
Zero(dest, number, type);
</pre>
<p>These three macros are used to move, copy, or zero out previously allocated memory. The <code class="inline"><span class="w">source</span></code> and <code class="inline"><span class="w">dest</span></code> arguments point to the source and destination starting points. Perl will move, copy, or zero out <code class="inline"><span class="w">number</span></code> instances of the size of the <code class="inline"><span class="w">type</span></code> data structure (using the <code class="inline"><span class="w">sizeof</span></code> function).</p> <h2 id="PerlIO">PerlIO</h2> <p>The most recent development releases of Perl have been experimenting with removing Perl's dependency on the "normal" standard I/O suite and allowing other stdio implementations to be used. This involves creating a new abstraction layer that then calls whichever implementation of stdio Perl was compiled with. All XSUBs should now use the functions in the PerlIO abstraction layer and not make any assumptions about what kind of stdio is being used.</p> <p>For a complete description of the PerlIO abstraction, consult <a href="perlapio">perlapio</a>.</p> <h2 id="Compiled-code">Compiled code</h2> <h3 id="Code-tree">Code tree</h3> <p>Here we describe the internal form your code is converted to by Perl. Start with a simple example:</p> <pre class="verbatim" data-language="perl">$a = $b + $c;
</pre>
<p>This is converted to a tree similar to this one:</p> <pre class="verbatim" data-language="perl">       assign-to
     /           \
    +             $a
  /   \
$b     $c
</pre>
<p>(but slightly more complicated). This tree reflects the way Perl parsed your code, but has nothing to do with the execution order. There is an additional "thread" going through the nodes of the tree which shows the order of execution of the nodes. In our simplified example above it looks like:</p> <pre class="verbatim" data-language="perl">$b ---&gt; $c ---&gt; + ---&gt; $a ---&gt; assign-to
</pre>
<p>But with the actual compile tree for <code class="inline"><span class="i">$a</span> = <span class="i">$b</span> + <span class="i">$c</span></code> it is different: some nodes <i>optimized away</i>. As a corollary, though the actual tree contains more nodes than our simplified example, the execution order is the same as in our example.</p> <h3 id="Examining-the-tree">Examining the tree</h3> <p>If you have your perl compiled for debugging (usually done with <code class="inline">-<span class="w">DDEBUGGING</span></code> on the <code class="inline"><span class="w">Configure</span></code> command line), you may examine the compiled tree by specifying <code class="inline">-<span class="w">Dx</span></code> on the Perl command line. The output takes several lines per node, and for <code class="inline"><span class="i">$b</span>+<span class="i">$c</span></code> it looks like this:</p> <pre class="verbatim" data-language="perl">5           TYPE = add  ===&gt; 6
            TARG = 1
            FLAGS = (SCALAR,KIDS)
            {
                TYPE = null  ===&gt; (4)
                  (was rv2sv)
                FLAGS = (SCALAR,KIDS)
                {
3                   TYPE = gvsv  ===&gt; 4
                    FLAGS = (SCALAR)
                    GV = main::b
                }
            }
            {
                TYPE = null  ===&gt; (5)
                  (was rv2sv)
                FLAGS = (SCALAR,KIDS)
                {
4                   TYPE = gvsv  ===&gt; 5
                    FLAGS = (SCALAR)
                    GV = main::c
                }
            }
</pre>
<p>This tree has 5 nodes (one per <code class="inline"><span class="w">TYPE</span></code> specifier), only 3 of them are not optimized away (one per number in the left column). The immediate children of the given node correspond to <code class="inline"><span class="s">{</span><span class="s">}</span></code> pairs on the same level of indentation, thus this listing corresponds to the tree:</p> <pre class="verbatim" data-language="perl">    add
  /     \
null    null
 |       |
gvsv    gvsv
</pre>
<p>The execution order is indicated by <code class="inline">==<span class="cm">=&gt;</span></code> marks, thus it is <code class="inline">3
4 5 6</code> (node <code class="inline"><span class="n">6</span></code> is not included into above listing), i.e., <code class="inline"><span class="w">gvsv</span> <span class="w">gvsv</span> <span class="w">add</span> <span class="w">whatever</span></code> .</p> <p>Each of these nodes represents an op, a fundamental operation inside the Perl core. The code which implements each operation can be found in the <i>pp*.c</i> files; the function which implements the op with type <code class="inline"><span class="w">gvsv</span></code> is <code class="inline"><span class="w">pp_gvsv</span></code> , and so on. As the tree above shows, different ops have different numbers of children: <code class="inline"><span class="w">add</span></code> is a binary operator, as one would expect, and so has two children. To accommodate the various different numbers of children, there are various types of op data structure, and they link together in different ways.</p> <p>The simplest type of op structure is <code class="inline"><span class="w">OP</span></code> : this has no children. Unary operators, <code class="inline"><span class="w">UNOP</span></code> s, have one child, and this is pointed to by the <code class="inline"><span class="w">op_first</span></code> field. Binary operators (<code class="inline"><span class="w">BINOP</span></code> s) have not only an <code class="inline"><span class="w">op_first</span></code> field but also an <code class="inline"><span class="w">op_last</span></code> field. The most complex type of op is a <code class="inline"><span class="w">LISTOP</span></code> , which has any number of children. In this case, the first child is pointed to by <code class="inline"><span class="w">op_first</span></code> and the last child by <code class="inline"><span class="w">op_last</span></code> . The children in between can be found by iteratively following the <code class="inline"><span class="w">OpSIBLING</span></code> pointer from the first child to the last (but see below).</p> <p>There are also some other op types: a <code class="inline"><span class="w">PMOP</span></code> holds a regular expression, and has no children, and a <code class="inline"><span class="w">LOOP</span></code> may or may not have children. If the <code class="inline"><span class="w">op_children</span></code> field is non-zero, it behaves like a <code class="inline"><span class="w">LISTOP</span></code> . To complicate matters, if a <code class="inline"><span class="w">UNOP</span></code> is actually a <code class="inline"><span class="w">null</span></code> op after optimization (see <a href="#Compile-pass-2%3a-context-propagation">Compile pass 2: context propagation</a>) it will still have children in accordance with its former type.</p> <p>Finally, there is a <code class="inline"><span class="w">LOGOP</span></code> , or logic op. Like a <code class="inline"><span class="w">LISTOP</span></code> , this has one or more children, but it doesn't have an <code class="inline"><span class="w">op_last</span></code> field: so you have to follow <code class="inline"><span class="w">op_first</span></code> and then the <code class="inline"><span class="w">OpSIBLING</span></code> chain itself to find the last child. Instead it has an <code class="inline"><span class="w">op_other</span></code> field, which is comparable to the <code class="inline"><span class="w">op_next</span></code> field described below, and represents an alternate execution path. Operators like <code class="inline">and</code> , <code class="inline">or</code> and <code class="inline">?</code> are <code class="inline"><span class="w">LOGOP</span></code> s. Note that in general, <code class="inline"><span class="w">op_other</span></code> may not point to any of the direct children of the <code class="inline"><span class="w">LOGOP</span></code> .</p> <p>Starting in version 5.21.2, perls built with the experimental define <code class="inline">-<span class="w">DPERL_OP_PARENT</span></code> add an extra boolean flag for each op, <code class="inline"><span class="w">op_moresib</span></code> . When not set, this indicates that this is the last op in an <code class="inline"><span class="w">OpSIBLING</span></code> chain. This frees up the <code class="inline"><span class="w">op_sibling</span></code> field on the last sibling to point back to the parent op. Under this build, that field is also renamed <code class="inline"><span class="w">op_sibparent</span></code> to reflect its joint role. The macro <code class="inline"><span class="i">OpSIBLING</span><span class="s">(</span><span class="w">o</span><span class="s">)</span></code> wraps this special behaviour, and always returns NULL on the last sibling. With this build the <code class="inline"><span class="i">op_parent</span><span class="s">(</span><span class="w">o</span><span class="s">)</span></code> function can be used to find the parent of any op. Thus for forward compatibility, you should always use the <code class="inline"><span class="i">OpSIBLING</span><span class="s">(</span><span class="w">o</span><span class="s">)</span></code> macro rather than accessing <code class="inline"><span class="w">op_sibling</span></code> directly.</p> <p>Another way to examine the tree is to use a compiler back-end module, such as <a href="b/concise">B::Concise</a>.</p> <h3 id="Compile-pass-1%3a-check-routines">Compile pass 1: check routines</h3> <p>The tree is created by the compiler while <i>yacc</i> code feeds it the constructions it recognizes. Since <i>yacc</i> works bottom-up, so does the first pass of perl compilation.</p> <p>What makes this pass interesting for perl developers is that some optimization may be performed on this pass. This is optimization by so-called "check routines". The correspondence between node names and corresponding check routines is described in <i>opcode.pl</i> (do not forget to run <code class="inline"><span class="w">make</span> <span class="w">regen_headers</span></code> if you modify this file).</p> <p>A check routine is called when the node is fully constructed except for the execution-order thread. Since at this time there are no back-links to the currently constructed node, one can do most any operation to the top-level node, including freeing it and/or creating new nodes above/below it.</p> <p>The check routine returns the node which should be inserted into the tree (if the top-level node was not modified, check routine returns its argument).</p> <p>By convention, check routines have names <code class="inline"><span class="w">ck_</span>*</code> . They are usually called from <code class="inline"><span class="w">new</span>*<span class="w">OP</span></code> subroutines (or <code class="inline"><span class="w">convert</span></code> ) (which in turn are called from <i>perly.y</i>).</p> <h3 id="Compile-pass-1a%3a-constant-folding">Compile pass 1a: constant folding</h3> <p>Immediately after the check routine is called the returned node is checked for being compile-time executable. If it is (the value is judged to be constant) it is immediately executed, and a <i>constant</i> node with the "return value" of the corresponding subtree is substituted instead. The subtree is deleted.</p> <p>If constant folding was not performed, the execution-order thread is created.</p> <h3 id="Compile-pass-2%3a-context-propagation">Compile pass 2: context propagation</h3> <p>When a context for a part of compile tree is known, it is propagated down through the tree. At this time the context can have 5 values (instead of 2 for runtime context): void, boolean, scalar, list, and lvalue. In contrast with the pass 1 this pass is processed from top to bottom: a node's context determines the context for its children.</p> <p>Additional context-dependent optimizations are performed at this time. Since at this moment the compile tree contains back-references (via "thread" pointers), nodes cannot be free()d now. To allow optimized-away nodes at this stage, such nodes are null()ified instead of free()ing (i.e. their type is changed to OP_NULL).</p> <h3 id="Compile-pass-3%3a-peephole-optimization">Compile pass 3: peephole optimization</h3> <p>After the compile tree for a subroutine (or for an <code class="inline"><a class="l_k" href="functions/eval">eval</a></code> or a file) is created, an additional pass over the code is performed. This pass is neither top-down or bottom-up, but in the execution order (with additional complications for conditionals). Optimizations performed at this stage are subject to the same restrictions as in the pass 2.</p> <p>Peephole optimizations are done by calling the function pointed to by the global variable <code class="inline"><span class="w">PL_peepp</span></code> . By default, <code class="inline"><span class="w">PL_peepp</span></code> just calls the function pointed to by the global variable <code class="inline"><span class="w">PL_rpeepp</span></code> . By default, that performs some basic op fixups and optimisations along the execution-order op chain, and recursively calls <code class="inline"><span class="w">PL_rpeepp</span></code> for each side chain of ops (resulting from conditionals). Extensions may provide additional optimisations or fixups, hooking into either the per-subroutine or recursive stage, like this:</p> <pre class="verbatim" data-language="perl">static peep_t prev_peepp;
static void my_peep(pTHX_ OP *o)
{
    /* custom per-subroutine optimisation goes here */
    prev_peepp(aTHX_ o);
    /* custom per-subroutine optimisation may also go here */
}
BOOT:
    prev_peepp = PL_peepp;
    PL_peepp = my_peep;

static peep_t prev_rpeepp;
static void my_rpeep(pTHX_ OP *o)
{
    OP *orig_o = o;
    for(; o; o = o-&gt;op_next) {
        /* custom per-op optimisation goes here */
    }
    prev_rpeepp(aTHX_ orig_o);
}
BOOT:
    prev_rpeepp = PL_rpeepp;
    PL_rpeepp = my_rpeep;
</pre>
<h3 id="Pluggable-runops">Pluggable runops</h3> <p>The compile tree is executed in a runops function. There are two runops functions, in <i>run.c</i> and in <i>dump.c</i>. <code class="inline"><span class="w">Perl_runops_debug</span></code> is used with DEBUGGING and <code class="inline"><span class="w">Perl_runops_standard</span></code> is used otherwise. For fine control over the execution of the compile tree it is possible to provide your own runops function.</p> <p>It's probably best to copy one of the existing runops functions and change it to suit your needs. Then, in the BOOT section of your XS file, add the line:</p> <pre class="verbatim" data-language="perl">PL_runops = my_runops;
</pre>
<p>This function should be as efficient as possible to keep your programs running as fast as possible.</p> <h3 id="Compile-time-scope-hooks">Compile-time scope hooks</h3> <p>As of perl 5.14 it is possible to hook into the compile-time lexical scope mechanism using <code class="inline"><span class="w">Perl_blockhook_register</span></code> . This is used like this:</p> <pre class="verbatim" data-language="perl">STATIC void my_start_hook(pTHX_ int full);
STATIC BHK my_hooks;

BOOT:
    BhkENTRY_set(&amp;my_hooks, bhk_start, my_start_hook);
    Perl_blockhook_register(aTHX_ &amp;my_hooks);
</pre>
<p>This will arrange to have <code class="inline"><span class="w">my_start_hook</span></code> called at the start of compiling every lexical scope. The available hooks are:</p> <ul> <li id="void-bhk_start(pTHX_-int-full)">
<b><code class="inline"><span class="w">void</span> <span class="i">bhk_start</span><span class="s">(</span><span class="w">pTHX_</span> <a class="l_k" href="functions/int">int</a> <span class="w">full</span><span class="s">)</span></code> </b> <p>This is called just after starting a new lexical scope. Note that Perl code like</p> <pre class="verbatim" data-language="perl">if ($x) { ... }
</pre>
<p>creates two scopes: the first starts at the <code class="inline">(</code> and has <code class="inline"><span class="w">full</span> == <span class="n">1</span></code> , the second starts at the <code class="inline">{</code> and has <code class="inline"><span class="w">full</span> == <span class="n">0</span></code> . Both end at the <code class="inline">}</code>, so calls to <code class="inline"><span class="w">start</span></code> and <code class="inline"><span class="w">pre</span>/<span class="w">post_end</span></code> will match. Anything pushed onto the save stack by this hook will be popped just before the scope ends (between the <code class="inline"><span class="w">pre_</span></code> and <code class="inline"><span class="w">post_end</span></code> hooks, in fact).</p> </li> <li id="void-bhk_pre_end(pTHX_-OP-**o)">
<b><code class="inline"><span class="w">void</span> <span class="i">bhk_pre_end</span><span class="s">(</span><span class="w">pTHX_</span> <span class="w">OP</span> **<span class="w">o</span><span class="s">)</span></code> </b> <p>This is called at the end of a lexical scope, just before unwinding the stack. <i>o</i> is the root of the optree representing the scope; it is a double pointer so you can replace the OP if you need to.</p> </li> <li id="void-bhk_post_end(pTHX_-OP-**o)">
<b><code class="inline"><span class="w">void</span> <span class="i">bhk_post_end</span><span class="s">(</span><span class="w">pTHX_</span> <span class="w">OP</span> **<span class="w">o</span><span class="s">)</span></code> </b> <p>This is called at the end of a lexical scope, just after unwinding the stack. <i>o</i> is as above. Note that it is possible for calls to <code class="inline"><span class="w">pre_</span></code> and <code class="inline"><span class="w">post_end</span></code> to nest, if there is something on the save stack that calls string eval.</p> </li> <li id="void-bhk_eval(pTHX_-OP-*const-o)">
<b><code class="inline"><span class="w">void</span> <span class="i">bhk_eval</span><span class="s">(</span><span class="w">pTHX_</span> <span class="w">OP</span> *<span class="w">const</span> <span class="w">o</span><span class="s">)</span></code> </b> <p>This is called just before starting to compile an <code class="inline"><a class="l_k" href="functions/eval">eval</a> <span class="w">STRING</span></code> , <code class="inline"><a class="l_k" href="functions/do">do</a>
<span class="w">FILE</span></code> , <code class="inline"><a class="l_k" href="functions/require">require</a></code> or <code class="inline"><a class="l_k" href="functions/use">use</a></code>, after the eval has been set up. <i>o</i> is the OP that requested the eval, and will normally be an <code class="inline"><span class="w">OP_ENTEREVAL</span></code> , <code class="inline"><span class="w">OP_DOFILE</span></code> or <code class="inline"><span class="w">OP_REQUIRE</span></code> .</p> </li> </ul> <p>Once you have your hook functions, you need a <code class="inline"><span class="w">BHK</span></code> structure to put them in. It's best to allocate it statically, since there is no way to free it once it's registered. The function pointers should be inserted into this structure using the <code class="inline"><span class="w">BhkENTRY_set</span></code> macro, which will also set flags indicating which entries are valid. If you do need to allocate your <code class="inline"><span class="w">BHK</span></code> dynamically for some reason, be sure to zero it before you start.</p> <p>Once registered, there is no mechanism to switch these hooks off, so if that is necessary you will need to do this yourself. An entry in <code class="inline"><span class="i">%^H</span></code> is probably the best way, so the effect is lexically scoped; however it is also possible to use the <code class="inline"><span class="w">BhkDISABLE</span></code> and <code class="inline"><span class="w">BhkENABLE</span></code> macros to temporarily switch entries on and off. You should also be aware that generally speaking at least one scope will have opened before your extension is loaded, so you will see some <code class="inline"><span class="w">pre</span>/<span class="w">post_end</span></code> pairs that didn't have a matching <code class="inline"><span class="w">start</span></code> .</p> <h2 id="Examining-internal-data-structures-with-the-dump-functions">Examining internal data structures with the <code class="inline"><a class="l_k" href="functions/dump">dump</a></code> functions</h2> <p>To aid debugging, the source file <i>dump.c</i> contains a number of functions which produce formatted output of internal data structures.</p> <p>The most commonly used of these functions is <code class="inline"><span class="w">Perl_sv_dump</span></code> ; it's used for dumping SVs, AVs, HVs, and CVs. The <code class="inline"><span class="w">Devel::Peek</span></code> module calls <code class="inline"><span class="w">sv_dump</span></code> to produce debugging output from Perl-space, so users of that module should already be familiar with its format.</p> <p><code class="inline"><span class="w">Perl_op_dump</span></code> can be used to dump an <code class="inline"><span class="w">OP</span></code> structure or any of its derivatives, and produces output similar to <code class="inline"><span class="w">perl</span> -<span class="w">Dx</span></code> ; in fact, <code class="inline"><span class="w">Perl_dump_eval</span></code> will dump the main root of the code being evaluated, exactly like <code class="inline">-<span class="w">Dx</span></code> .</p> <p>Other useful functions are <code class="inline"><span class="w">Perl_dump_sub</span></code> , which turns a <code class="inline"><span class="w">GV</span></code> into an op tree, <code class="inline"><span class="w">Perl_dump_packsubs</span></code> which calls <code class="inline"><span class="w">Perl_dump_sub</span></code> on all the subroutines in a package like so: (Thankfully, these are all xsubs, so there is no op tree)</p> <pre class="verbatim" data-language="perl">(gdb) print Perl_dump_packsubs(PL_defstash)

SUB attributes::bootstrap = (xsub 0x811fedc 0)

SUB UNIVERSAL::can = (xsub 0x811f50c 0)

SUB UNIVERSAL::isa = (xsub 0x811f304 0)

SUB UNIVERSAL::VERSION = (xsub 0x811f7ac 0)

SUB DynaLoader::boot_DynaLoader = (xsub 0x805b188 0)
</pre>
<p>and <code class="inline"><span class="w">Perl_dump_all</span></code> , which dumps all the subroutines in the stash and the op tree of the main root.</p> <h2 id="How-multiple-interpreters-and-concurrency-are-supported">How multiple interpreters and concurrency are supported</h2> <h3 id="Background-and-PERL_IMPLICIT_CONTEXT">Background and PERL_IMPLICIT_CONTEXT</h3> <p>The Perl interpreter can be regarded as a closed box: it has an API for feeding it code or otherwise making it do things, but it also has functions for its own use. This smells a lot like an object, and there are ways for you to build Perl so that you can have multiple interpreters, with one interpreter represented either as a C structure, or inside a thread-specific structure. These structures contain all the context, the state of that interpreter.</p> <p>One macro controls the major Perl build flavor: MULTIPLICITY. The MULTIPLICITY build has a C structure that packages all the interpreter state. With multiplicity-enabled perls, PERL_IMPLICIT_CONTEXT is also normally defined, and enables the support for passing in a "hidden" first argument that represents all three data structures. MULTIPLICITY makes multi-threaded perls possible (with the ithreads threading model, related to the macro USE_ITHREADS.)</p> <p>Two other "encapsulation" macros are the PERL_GLOBAL_STRUCT and PERL_GLOBAL_STRUCT_PRIVATE (the latter turns on the former, and the former turns on MULTIPLICITY.) The PERL_GLOBAL_STRUCT causes all the internal variables of Perl to be wrapped inside a single global struct, struct perl_vars, accessible as (globals) &amp;PL_Vars or PL_VarsPtr or the function Perl_GetVars(). The PERL_GLOBAL_STRUCT_PRIVATE goes one step further, there is still a single struct (allocated in main() either from heap or from stack) but there are no global data symbols pointing to it. In either case the global struct should be initialized as the very first thing in main() using Perl_init_global_struct() and correspondingly tear it down after perl_free() using Perl_free_global_struct(), please see <i>miniperlmain.c</i> for usage details. You may also need to use <code class="inline"><span class="w">dVAR</span></code> in your coding to "declare the global variables" when you are using them. dTHX does this for you automatically.</p> <p>To see whether you have non-const data you can use a BSD (or GNU) compatible <code class="inline"><span class="w">nm</span></code> :</p> <pre class="verbatim" data-language="perl">nm libperl.a | grep -v ' [TURtr] '
</pre>
<p>If this displays any <code class="inline"><span class="w">D</span></code> or <code class="inline"><span class="w">d</span></code> symbols (or possibly <code class="inline"><span class="w">C</span></code> or <code class="inline"><span class="w">c</span></code> ), you have non-const data. The symbols the <code class="inline"><a class="l_k" href="functions/grep">grep</a></code> removed are as follows: <code class="inline"><span class="w">Tt</span></code> are <i>text</i>, or code, the <code class="inline"><span class="w">Rr</span></code> are <i>read-only</i> (const) data, and the <code class="inline"><span class="w">U</span></code> is &lt;undefined&gt;, external symbols referred to.</p> <p>The test <i>t/porting/libperl.t</i> does this kind of symbol sanity checking on <code class="inline"><span class="w">libperl</span>.<span class="w">a</span></code> .</p> <p>For backward compatibility reasons defining just PERL_GLOBAL_STRUCT doesn't actually hide all symbols inside a big global struct: some PerlIO_xxx vtables are left visible. The PERL_GLOBAL_STRUCT_PRIVATE then hides everything (see how the PERLIO_FUNCS_DECL is used).</p> <p>All this obviously requires a way for the Perl internal functions to be either subroutines taking some kind of structure as the first argument, or subroutines taking nothing as the first argument. To enable these two very different ways of building the interpreter, the Perl source (as it does in so many other situations) makes heavy use of macros and subroutine naming conventions.</p> <p>First problem: deciding which functions will be public API functions and which will be private. All functions whose names begin <code class="inline"><span class="w">S_</span></code> are private (think "S" for "secret" or "static"). All other functions begin with "Perl_", but just because a function begins with "Perl_" does not mean it is part of the API. (See <a href="#Internal-Functions">Internal Functions</a>.) The easiest way to be <b>sure</b> a function is part of the API is to find its entry in <a href="perlapi">perlapi</a>. If it exists in <a href="perlapi">perlapi</a>, it's part of the API. If it doesn't, and you think it should be (i.e., you need it for your extension), send mail via <a href="perlbug">perlbug</a> explaining why you think it should be.</p> <p>Second problem: there must be a syntax so that the same subroutine declarations and calls can pass a structure as their first argument, or pass nothing. To solve this, the subroutines are named and declared in a particular way. Here's a typical start of a static function used within the Perl guts:</p> <pre class="verbatim" data-language="perl">STATIC void
S_incline(pTHX_ char *s)
</pre>
<p>STATIC becomes "static" in C, and may be #define'd to nothing in some configurations in the future.</p> <p>A public function (i.e. part of the internal API, but not necessarily sanctioned for use in extensions) begins like this:</p> <pre class="verbatim" data-language="perl">void
Perl_sv_setiv(pTHX_ SV* dsv, IV num)
</pre>
<p><code class="inline"><span class="w">pTHX_</span></code> is one of a number of macros (in <i>perl.h</i>) that hide the details of the interpreter's context. THX stands for "thread", "this", or "thingy", as the case may be. (And no, George Lucas is not involved. :-) The first character could be 'p' for a <b>p</b>rototype, 'a' for <b>a</b>rgument, or 'd' for <b>d</b>eclaration, so we have <code class="inline"><span class="w">pTHX</span></code> , <code class="inline"><span class="w">aTHX</span></code> and <code class="inline"><span class="w">dTHX</span></code> , and their variants.</p> <p>When Perl is built without options that set PERL_IMPLICIT_CONTEXT, there is no first argument containing the interpreter's context. The trailing underscore in the pTHX_ macro indicates that the macro expansion needs a comma after the context argument because other arguments follow it. If PERL_IMPLICIT_CONTEXT is not defined, pTHX_ will be ignored, and the subroutine is not prototyped to take the extra argument. The form of the macro without the trailing underscore is used when there are no additional explicit arguments.</p> <p>When a core function calls another, it must pass the context. This is normally hidden via macros. Consider <code class="inline"><span class="w">sv_setiv</span></code> . It expands into something like this:</p> <pre class="verbatim" data-language="perl">#ifdef PERL_IMPLICIT_CONTEXT
  #define sv_setiv(a,b)      Perl_sv_setiv(aTHX_ a, b)
  /* can't do this for vararg functions, see below */
#else
  #define sv_setiv           Perl_sv_setiv
#endif
</pre>
<p>This works well, and means that XS authors can gleefully write:</p> <pre class="verbatim" data-language="perl">sv_setiv(foo, bar);
</pre>
<p>and still have it work under all the modes Perl could have been compiled with.</p> <p>This doesn't work so cleanly for varargs functions, though, as macros imply that the number of arguments is known in advance. Instead we either need to spell them out fully, passing <code class="inline"><span class="w">aTHX_</span></code> as the first argument (the Perl core tends to do this with functions like Perl_warner), or use a context-free version.</p> <p>The context-free version of Perl_warner is called Perl_warner_nocontext, and does not take the extra argument. Instead it does dTHX; to get the context from thread-local storage. We <code class="inline"><span class="c">#define warner Perl_warner_nocontext</span></code> so that extensions get source compatibility at the expense of performance. (Passing an arg is cheaper than grabbing it from thread-local storage.)</p> <p>You can ignore [pad]THXx when browsing the Perl headers/sources. Those are strictly for use within the core. Extensions and embedders need only be aware of [pad]THX.</p> <h3 id="So-what-happened-to-dTHR%3f">So what happened to dTHR?</h3> <p><code class="inline"><span class="w">dTHR</span></code> was introduced in perl 5.005 to support the older thread model. The older thread model now uses the <code class="inline"><span class="w">THX</span></code> mechanism to pass context pointers around, so <code class="inline"><span class="w">dTHR</span></code> is not useful any more. Perl 5.6.0 and later still have it for backward source compatibility, but it is defined to be a no-op.</p> <h3 id="How-do-I-use-all-this-in-extensions%3f">How do I use all this in extensions?</h3> <p>When Perl is built with PERL_IMPLICIT_CONTEXT, extensions that call any functions in the Perl API will need to pass the initial context argument somehow. The kicker is that you will need to write it in such a way that the extension still compiles when Perl hasn't been built with PERL_IMPLICIT_CONTEXT enabled.</p> <p>There are three ways to do this. First, the easy but inefficient way, which is also the default, in order to maintain source compatibility with extensions: whenever <i>XSUB.h</i> is #included, it redefines the aTHX and aTHX_ macros to call a function that will return the context. Thus, something like:</p> <pre class="verbatim" data-language="perl">sv_setiv(sv, num);
</pre>
<p>in your extension will translate to this when PERL_IMPLICIT_CONTEXT is in effect:</p> <pre class="verbatim" data-language="perl">Perl_sv_setiv(Perl_get_context(), sv, num);
</pre>
<p>or to this otherwise:</p> <pre class="verbatim" data-language="perl">Perl_sv_setiv(sv, num);
</pre>
<p>You don't have to do anything new in your extension to get this; since the Perl library provides Perl_get_context(), it will all just work.</p> <p>The second, more efficient way is to use the following template for your Foo.xs:</p> <pre class="verbatim" data-language="perl">#define PERL_NO_GET_CONTEXT     /* we want efficiency */
#include "EXTERN.h"
#include "perl.h"
#include "XSUB.h"

STATIC void my_private_function(int arg1, int arg2);

STATIC void
my_private_function(int arg1, int arg2)
{
    dTHX;       /* fetch context */
    ... call many Perl API functions ...
}

[... etc ...]

MODULE = Foo            PACKAGE = Foo

/* typical XSUB */

void
my_xsub(arg)
        int arg
    CODE:
        my_private_function(arg, 10);
</pre>
<p>Note that the only two changes from the normal way of writing an extension is the addition of a <code class="inline"><span class="c">#define PERL_NO_GET_CONTEXT</span></code> before including the Perl headers, followed by a <code class="inline"><span class="w">dTHX</span><span class="sc">;</span></code> declaration at the start of every function that will call the Perl API. (You'll know which functions need this, because the C compiler will complain that there's an undeclared identifier in those functions.) No changes are needed for the XSUBs themselves, because the XS() macro is correctly defined to pass in the implicit context if needed.</p> <p>The third, even more efficient way is to ape how it is done within the Perl guts:</p> <pre class="verbatim" data-language="perl">#define PERL_NO_GET_CONTEXT     /* we want efficiency */
#include "EXTERN.h"
#include "perl.h"
#include "XSUB.h"

/* pTHX_ only needed for functions that call Perl API */
STATIC void my_private_function(pTHX_ int arg1, int arg2);

STATIC void
my_private_function(pTHX_ int arg1, int arg2)
{
    /* dTHX; not needed here, because THX is an argument */
    ... call Perl API functions ...
}

[... etc ...]

MODULE = Foo            PACKAGE = Foo

/* typical XSUB */

void
my_xsub(arg)
        int arg
    CODE:
        my_private_function(aTHX_ arg, 10);
</pre>
<p>This implementation never has to fetch the context using a function call, since it is always passed as an extra argument. Depending on your needs for simplicity or efficiency, you may mix the previous two approaches freely.</p> <p>Never add a comma after <code class="inline"><span class="w">pTHX</span></code> yourself--always use the form of the macro with the underscore for functions that take explicit arguments, or the form without the argument for functions with no explicit arguments.</p> <p>If one is compiling Perl with the <code class="inline">-<span class="w">DPERL_GLOBAL_STRUCT</span></code> the <code class="inline"><span class="w">dVAR</span></code> definition is needed if the Perl global variables (see <i>perlvars.h</i> or <i>globvar.sym</i>) are accessed in the function and <code class="inline"><span class="w">dTHX</span></code> is not used (the <code class="inline"><span class="w">dTHX</span></code> includes the <code class="inline"><span class="w">dVAR</span></code> if necessary). One notices the need for <code class="inline"><span class="w">dVAR</span></code> only with the said compile-time define, because otherwise the Perl global variables are visible as-is.</p> <h3 id="Should-I-do-anything-special-if-I-call-perl-from-multiple-threads%3f">Should I do anything special if I call perl from multiple threads?</h3> <p>If you create interpreters in one thread and then proceed to call them in another, you need to make sure perl's own Thread Local Storage (TLS) slot is initialized correctly in each of those threads.</p> <p>The <code class="inline"><span class="w">perl_alloc</span></code> and <code class="inline"><span class="w">perl_clone</span></code> API functions will automatically set the TLS slot to the interpreter they created, so that there is no need to do anything special if the interpreter is always accessed in the same thread that created it, and that thread did not create or call any other interpreters afterwards. If that is not the case, you have to set the TLS slot of the thread before calling any functions in the Perl API on that particular interpreter. This is done by calling the <code class="inline"><span class="w">PERL_SET_CONTEXT</span></code> macro in that thread as the first thing you do:</p> <pre class="verbatim" data-language="perl">/* do this before doing anything else with some_perl */
PERL_SET_CONTEXT(some_perl);

... other Perl API calls on some_perl go here ...
</pre>
<h3 id="Future-Plans-and-PERL_IMPLICIT_SYS">Future Plans and PERL_IMPLICIT_SYS</h3> <p>Just as PERL_IMPLICIT_CONTEXT provides a way to bundle up everything that the interpreter knows about itself and pass it around, so too are there plans to allow the interpreter to bundle up everything it knows about the environment it's running on. This is enabled with the PERL_IMPLICIT_SYS macro. Currently it only works with USE_ITHREADS on Windows.</p> <p>This allows the ability to provide an extra pointer (called the "host" environment) for all the system calls. This makes it possible for all the system stuff to maintain their own state, broken down into seven C structures. These are thin wrappers around the usual system calls (see <i>win32/perllib.c</i>) for the default perl executable, but for a more ambitious host (like the one that would do fork() emulation) all the extra work needed to pretend that different interpreters are actually different "processes", would be done here.</p> <p>The Perl engine/interpreter and the host are orthogonal entities. There could be one or more interpreters in a process, and one or more "hosts", with free association between them.</p> <h2 id="Internal-Functions">Internal Functions</h2> <p>All of Perl's internal functions which will be exposed to the outside world are prefixed by <code class="inline"><span class="w">Perl_</span></code> so that they will not conflict with XS functions or functions used in a program in which Perl is embedded. Similarly, all global variables begin with <code class="inline"><span class="w">PL_</span></code> . (By convention, static functions start with <code class="inline"><span class="w">S_</span></code> .)</p> <p>Inside the Perl core (<code class="inline"><span class="w">PERL_CORE</span></code> defined), you can get at the functions either with or without the <code class="inline"><span class="w">Perl_</span></code> prefix, thanks to a bunch of defines that live in <i>embed.h</i>. Note that extension code should <i>not</i> set <code class="inline"><span class="w">PERL_CORE</span></code> ; this exposes the full perl internals, and is likely to cause breakage of the XS in each new perl release.</p> <p>The file <i>embed.h</i> is generated automatically from <i>embed.pl</i> and <i>embed.fnc</i>. <i>embed.pl</i> also creates the prototyping header files for the internal functions, generates the documentation and a lot of other bits and pieces. It's important that when you add a new function to the core or change an existing one, you change the data in the table in <i>embed.fnc</i> as well. Here's a sample entry from that table:</p> <pre class="verbatim" data-language="perl">Apd |SV**   |av_fetch   |AV* ar|I32 key|I32 lval
</pre>
<p>The second column is the return type, the third column the name. Columns after that are the arguments. The first column is a set of flags:</p> <ul> <li id="A">
<b>A</b> <p>This function is a part of the public API. All such functions should also have 'd', very few do not.</p> </li> <li id="p">
<b>p</b> <p>This function has a <code class="inline"><span class="w">Perl_</span></code> prefix; i.e. it is defined as <code class="inline"><span class="w">Perl_av_fetch</span></code> .</p> </li> <li id="d">
<b>d</b> <p>This function has documentation using the <code class="inline"><span class="w">apidoc</span></code> feature which we'll look at in a second. Some functions have 'd' but not 'A'; docs are good.</p> </li> </ul> <p>Other available flags are:</p> <ul> <li id="s">
<b>s</b> <p>This is a static function and is defined as <code class="inline"><span class="w">STATIC</span> <span class="w">S_whatever</span></code> , and usually called within the sources as <code class="inline"><span class="i">whatever</span><span class="s">(</span>...<span class="s">)</span></code> .</p> </li> <li id="n">
<b>n</b> <p>This does not need an interpreter context, so the definition has no <code class="inline"><span class="w">pTHX</span></code> , and it follows that callers don't use <code class="inline"><span class="w">aTHX</span></code> . (See <a href="#Background-and-PERL_IMPLICIT_CONTEXT">Background and PERL_IMPLICIT_CONTEXT</a>.)</p> </li> <li id="r">
<b>r</b> <p>This function never returns; <code class="inline"><span class="w">croak</span></code> , <code class="inline"><a class="l_k" href="functions/exit">exit</a></code> and friends.</p> </li> <li id="f">
<b>f</b> <p>This function takes a variable number of arguments, <code class="inline"><a class="l_k" href="functions/printf">printf</a></code> style. The argument list should end with <code class="inline">...</code> , like this:</p> <pre class="verbatim" data-language="perl">Afprd   |void   |croak          |const char* pat|...
</pre>
</li> <li id="M">
<b>M</b> <p>This function is part of the experimental development API, and may change or disappear without notice.</p> </li> <li id="o">
<b>o</b> <p>This function should not have a compatibility macro to define, say, <code class="inline"><span class="w">Perl_parse</span></code> to <code class="inline"><span class="w">parse</span></code> . It must be called as <code class="inline"><span class="w">Perl_parse</span></code> .</p> </li> <li id="x">
<b>x</b> <p>This function isn't exported out of the Perl core.</p> </li> <li id="m">
<b>m</b> <p>This is implemented as a macro.</p> </li> <li id="X">
<b>X</b> <p>This function is explicitly exported.</p> </li> <li id="E">
<b>E</b> <p>This function is visible to extensions included in the Perl core.</p> </li> <li id="b">
<b>b</b> <p>Binary backward compatibility; this function is a macro but also has a <code class="inline"><span class="w">Perl_</span></code> implementation (which is exported).</p> </li> <li id="others">
<b>others</b> <p>See the comments at the top of <code class="inline"><span class="w">embed</span>.<span class="w">fnc</span></code> for others.</p> </li> </ul> <p>If you edit <i>embed.pl</i> or <i>embed.fnc</i>, you will need to run <code class="inline"><span class="w">make</span> <span class="w">regen_headers</span></code> to force a rebuild of <i>embed.h</i> and other auto-generated files.</p> <h3 id="Formatted-Printing-of-IVs%2c-UVs%2c-and-NVs">Formatted Printing of IVs, UVs, and NVs</h3> <p>If you are printing IVs, UVs, or NVS instead of the stdio(3) style formatting codes like <code class="inline"><span class="i">%d</span></code> , <code class="inline"><span class="i">%ld</span></code> , <code class="inline"><span class="i">%f</span></code> , you should use the following macros for portability</p> <pre class="verbatim" data-language="perl">IVdf            IV in decimal
UVuf            UV in decimal
UVof            UV in octal
UVxf            UV in hexadecimal
NVef            NV %e-like
NVff            NV %f-like
NVgf            NV %g-like
</pre>
<p>These will take care of 64-bit integers and long doubles. For example:</p> <pre class="verbatim" data-language="perl">printf("IV is %"IVdf"\n", iv);
</pre>
<p>The IVdf will expand to whatever is the correct format for the IVs.</p> <p>Note that there are different "long doubles": Perl will use whatever the compiler has.</p> <p>If you are printing addresses of pointers, use UVxf combined with PTR2UV(), do not use %lx or %p.</p> <h3 id="Pointer-To-Integer-and-Integer-To-Pointer">Pointer-To-Integer and Integer-To-Pointer</h3> <p>Because pointer size does not necessarily equal integer size, use the follow macros to do it right.</p> <pre class="verbatim" data-language="perl">PTR2UV(pointer)
PTR2IV(pointer)
PTR2NV(pointer)
INT2PTR(pointertotype, integer)
</pre>
<p>For example:</p> <pre class="verbatim" data-language="perl">IV  iv = ...;
SV *sv = INT2PTR(SV*, iv);
</pre>
<p>and</p> <pre class="verbatim" data-language="perl">AV *av = ...;
UV  uv = PTR2UV(av);
</pre>
<h3 id="Exception-Handling">Exception Handling</h3> <p>There are a couple of macros to do very basic exception handling in XS modules. You have to define <code class="inline"><span class="w">NO_XSLOCKS</span></code> before including <i>XSUB.h</i> to be able to use these macros:</p> <pre class="verbatim" data-language="perl">#define NO_XSLOCKS
#include "XSUB.h"
</pre>
<p>You can use these macros if you call code that may croak, but you need to do some cleanup before giving control back to Perl. For example:</p> <pre class="verbatim" data-language="perl">dXCPT;    /* set up necessary variables */

XCPT_TRY_START {
  code_that_may_croak();
} XCPT_TRY_END

XCPT_CATCH
{
  /* do cleanup here */
  XCPT_RETHROW;
}
</pre>
<p>Note that you always have to rethrow an exception that has been caught. Using these macros, it is not possible to just catch the exception and ignore it. If you have to ignore the exception, you have to use the <code class="inline"><span class="w">call_</span>*</code> function.</p> <p>The advantage of using the above macros is that you don't have to setup an extra function for <code class="inline"><span class="w">call_</span>*</code> , and that using these macros is faster than using <code class="inline"><span class="w">call_</span>*</code> .</p> <h3 id="Source-Documentation">Source Documentation</h3> <p>There's an effort going on to document the internal functions and automatically produce reference manuals from them -- <a href="perlapi">perlapi</a> is one such manual which details all the functions which are available to XS writers. <a href="perlintern">perlintern</a> is the autogenerated manual for the functions which are not part of the API and are supposedly for internal use only.</p> <p>Source documentation is created by putting POD comments into the C source, like this:</p> <pre class="verbatim" data-language="perl">/*
 =for apidoc sv_setiv

 Copies an integer into the given SV.  Does not handle 'set' magic.  See
 C&lt;sv_setiv_mg&gt;.

 =cut
 */
</pre>
<p>Please try and supply some documentation if you add functions to the Perl core.</p> <h3 id="Backwards-compatibility">Backwards compatibility</h3> <p>The Perl API changes over time. New functions are added or the interfaces of existing functions are changed. The <code class="inline"><span class="w">Devel::PPPort</span></code> module tries to provide compatibility code for some of these changes, so XS writers don't have to code it themselves when supporting multiple versions of Perl.</p> <p><code class="inline"><span class="w">Devel::PPPort</span></code> generates a C header file <i>ppport.h</i> that can also be run as a Perl script. To generate <i>ppport.h</i>, run:</p> <pre class="verbatim" data-language="perl">perl -MDevel::PPPort -eDevel::PPPort::WriteFile
</pre>
<p>Besides checking existing XS code, the script can also be used to retrieve compatibility information for various API calls using the <code class="inline">--<span class="w">api</span>-<span class="w">info</span></code> command line switch. For example:</p> <pre class="verbatim" data-language="perl">% perl ppport.h --api-info=sv_magicext
</pre>
<p>For details, see <code class="inline"><span class="w">perldoc</span> <span class="w">ppport</span>.<span class="w">h</span></code> .</p> <h2 id="Unicode-Support">Unicode Support</h2> <p>Perl 5.6.0 introduced Unicode support. It's important for porters and XS writers to understand this support and make sure that the code they write does not corrupt Unicode data.</p> <h3 id="What-*is*-Unicode%2c-anyway%3f">What <b>is</b> Unicode, anyway?</h3> <p>In the olden, less enlightened times, we all used to use ASCII. Most of us did, anyway. The big problem with ASCII is that it's American. Well, no, that's not actually the problem; the problem is that it's not particularly useful for people who don't use the Roman alphabet. What used to happen was that particular languages would stick their own alphabet in the upper range of the sequence, between 128 and 255. Of course, we then ended up with plenty of variants that weren't quite ASCII, and the whole point of it being a standard was lost.</p> <p>Worse still, if you've got a language like Chinese or Japanese that has hundreds or thousands of characters, then you really can't fit them into a mere 256, so they had to forget about ASCII altogether, and build their own systems using pairs of numbers to refer to one character.</p> <p>To fix this, some people formed Unicode, Inc. and produced a new character set containing all the characters you can possibly think of and more. There are several ways of representing these characters, and the one Perl uses is called UTF-8. UTF-8 uses a variable number of bytes to represent a character. You can learn more about Unicode and Perl's Unicode model in <a href="perlunicode">perlunicode</a>.</p> <p>(On EBCDIC platforms, Perl uses instead UTF-EBCDIC, which is a form of UTF-8 adapted for EBCDIC platforms. Below, we just talk about UTF-8. UTF-EBCDIC is like UTF-8, but the details are different. The macros hide the differences from you, just remember that the particular numbers and bit patterns presented below will differ in UTF-EBCDIC.)</p> <h3 id="How-can-I-recognise-a-UTF-8-string%3f">How can I recognise a UTF-8 string?</h3> <p>You can't. This is because UTF-8 data is stored in bytes just like non-UTF-8 data. The Unicode character 200, (<code class="inline"><span class="n">0xC8</span></code> for you hex types) capital E with a grave accent, is represented by the two bytes <code class="inline"><span class="v">v196.172</span></code> . Unfortunately, the non-Unicode string <code class="inline"><a class="l_k" href="functions/chr">chr(196).chr(172)</a></code> has that byte sequence as well. So you can't tell just by looking -- this is what makes Unicode input an interesting problem.</p> <p>In general, you either have to know what you're dealing with, or you have to guess. The API function <code class="inline"><span class="w">is_utf8_string</span></code> can help; it'll tell you if a string contains only valid UTF-8 characters, and the chances of a non-UTF-8 string looking like valid UTF-8 become very small very quickly with increasing string length. On a character-by-character basis, <code class="inline"><span class="w">isUTF8_CHAR</span></code> will tell you whether the current character in a string is valid UTF-8.</p> <h3 id="How-does-UTF-8-represent-Unicode-characters%3f">How does UTF-8 represent Unicode characters?</h3> <p>As mentioned above, UTF-8 uses a variable number of bytes to store a character. Characters with values 0...127 are stored in one byte, just like good ol' ASCII. Character 128 is stored as <code class="inline"><span class="v">v194.128</span></code> ; this continues up to character 191, which is <code class="inline"><span class="v">v194.191</span></code> . Now we've run out of bits (191 is binary <code class="inline"><span class="n">10111111</span></code> ) so we move on; character 192 is <code class="inline"><span class="v">v195.128</span></code> . And so it goes on, moving to three bytes at character 2048. <a href="perlunicode#Unicode-Encodings">Unicode Encodings in perlunicode</a> has pictures of how this works.</p> <p>Assuming you know you're dealing with a UTF-8 string, you can find out how long the first character in it is with the <code class="inline"><span class="w">UTF8SKIP</span></code> macro:</p> <pre class="verbatim" data-language="perl">char *utf = "\305\233\340\240\201";
I32 len;

len = UTF8SKIP(utf); /* len is 2 here */
utf += len;
len = UTF8SKIP(utf); /* len is 3 here */
</pre>
<p>Another way to skip over characters in a UTF-8 string is to use <code class="inline"><span class="w">utf8_hop</span></code> , which takes a string and a number of characters to skip over. You're on your own about bounds checking, though, so don't use it lightly.</p> <p>All bytes in a multi-byte UTF-8 character will have the high bit set, so you can test if you need to do something special with this character like this (the <code class="inline"><span class="i">UTF8_IS_INVARIANT</span><span class="s">(</span><span class="s">)</span></code> is a macro that tests whether the byte is encoded as a single byte even in UTF-8):</p> <pre class="verbatim" data-language="perl">U8 *utf;
U8 *utf_end; /* 1 beyond buffer pointed to by utf */
UV uv;	/* Note: a UV, not a U8, not a char */
STRLEN len; /* length of character in bytes */

if (!UTF8_IS_INVARIANT(*utf))
    /* Must treat this as UTF-8 */
            uv = utf8_to_uvchr_buf(utf, utf_end, &amp;len);
    else
            /* OK to treat this character as a byte */
            uv = *utf;
</pre>
<p>You can also see in that example that we use <code class="inline"><span class="w">utf8_to_uvchr_buf</span></code> to get the value of the character; the inverse function <code class="inline"><span class="w">uvchr_to_utf8</span></code> is available for putting a UV into UTF-8:</p> <pre class="verbatim" data-language="perl">if (!UVCHR_IS_INVARIANT(uv))
    /* Must treat this as UTF8 */
            utf8 = uvchr_to_utf8(utf8, uv);
    else
            /* OK to treat this character as a byte */
            *utf8++ = uv;
</pre>
<p>You <b>must</b> convert characters to UVs using the above functions if you're ever in a situation where you have to match UTF-8 and non-UTF-8 characters. You may not skip over UTF-8 characters in this case. If you do this, you'll lose the ability to match hi-bit non-UTF-8 characters; for instance, if your UTF-8 string contains <code class="inline"><span class="v">v196.172</span></code> , and you skip that character, you can never match a <code class="inline"><a class="l_k" href="functions/chr">chr(200)</a></code> in a non-UTF-8 string. So don't do that!</p> <p>(Note that we don't have to test for invariant characters in the examples above. The functions work on any well-formed UTF-8 input. It's just that its faster to avoid the function overhead when it's not needed.)</p> <h3 id="How-does-Perl-store-UTF-8-strings%3f">How does Perl store UTF-8 strings?</h3> <p>Currently, Perl deals with UTF-8 strings and non-UTF-8 strings slightly differently. A flag in the SV, <code class="inline"><span class="w">SVf_UTF8</span></code> , indicates that the string is internally encoded as UTF-8. Without it, the byte value is the codepoint number and vice versa. This flag is only meaningful if the SV is <code class="inline"><span class="w">SvPOK</span></code> or immediately after stringification via <code class="inline"><span class="w">SvPV</span></code> or a similar macro. You can check and manipulate this flag with the following macros:</p> <pre class="verbatim" data-language="perl">SvUTF8(sv)
SvUTF8_on(sv)
SvUTF8_off(sv)
</pre>
<p>This flag has an important effect on Perl's treatment of the string: if UTF-8 data is not properly distinguished, regular expressions, <code class="inline"><a class="l_k" href="functions/length">length</a></code>, <code class="inline"><a class="l_k" href="functions/substr">substr</a></code> and other string handling operations will have undesirable (wrong) results.</p> <p>The problem comes when you have, for instance, a string that isn't flagged as UTF-8, and contains a byte sequence that could be UTF-8 -- especially when combining non-UTF-8 and UTF-8 strings.</p> <p>Never forget that the <code class="inline"><span class="w">SVf_UTF8</span></code> flag is separate from the PV value; you need to be sure you don't accidentally knock it off while you're manipulating SVs. More specifically, you cannot expect to do this:</p> <pre class="verbatim" data-language="perl">SV *sv;
SV *nsv;
STRLEN len;
char *p;

p = SvPV(sv, len);
frobnicate(p);
nsv = newSVpvn(p, len);
</pre>
<p>The <code class="inline"><span class="w">char</span>*</code> string does not tell you the whole story, and you can't copy or reconstruct an SV just by copying the string value. Check if the old SV has the UTF8 flag set (<i>after</i> the <code class="inline"><span class="w">SvPV</span></code> call), and act accordingly:</p> <pre class="verbatim" data-language="perl">p = SvPV(sv, len);
is_utf8 = SvUTF8(sv);
frobnicate(p, is_utf8);
nsv = newSVpvn(p, len);
if (is_utf8)
    SvUTF8_on(nsv);
</pre>
<p>In the above, your <code class="inline"><span class="w">frobnicate</span></code> function has been changed to be made aware of whether or not it's dealing with UTF-8 data, so that it can handle the string appropriately.</p> <p>Since just passing an SV to an XS function and copying the data of the SV is not enough to copy the UTF8 flags, even less right is just passing a <code class="inline"><span class="w">char</span> *</code> to an XS function.</p> <p>For full generality, use the <a href="perlapi#DO_UTF8">DO_UTF8 in perlapi</a> macro to see if the string in an SV is to be <i>treated</i> as UTF-8. This takes into account if the call to the XS function is being made from within the scope of <a href="bytes">use bytes </a>. If so, the underlying bytes that comprise the UTF-8 string are to be exposed, rather than the character they represent. But this pragma should only really be used for debugging and perhaps low-level testing at the byte level. Hence most XS code need not concern itself with this, but various areas of the perl core do need to support it.</p> <p>And this isn't the whole story. Starting in Perl v5.12, strings that aren't encoded in UTF-8 may also be treated as Unicode under various conditions (see <a href="perlunicode#ASCII-Rules-versus-Unicode-Rules">ASCII Rules versus Unicode Rules in perlunicode</a>). This is only really a problem for characters whose ordinals are between 128 and 255, and their behavior varies under ASCII versus Unicode rules in ways that your code cares about (see <a href="perlunicode#The-%22Unicode-Bug%22">The Unicode Bug in perlunicode</a>). There is no published API for dealing with this, as it is subject to change, but you can look at the code for <code class="inline"><span class="w">pp_lc</span></code> in <i>pp.c</i> for an example as to how it's currently done.</p> <h3 id="How-do-I-convert-a-string-to-UTF-8%3f">How do I convert a string to UTF-8?</h3> <p>If you're mixing UTF-8 and non-UTF-8 strings, it is necessary to upgrade the non-UTF-8 strings to UTF-8. If you've got an SV, the easiest way to do this is:</p> <pre class="verbatim" data-language="perl">sv_utf8_upgrade(sv);
</pre>
<p>However, you must not do this, for example:</p> <pre class="verbatim" data-language="perl">if (!SvUTF8(left))
    sv_utf8_upgrade(left);
</pre>
<p>If you do this in a binary operator, you will actually change one of the strings that came into the operator, and, while it shouldn't be noticeable by the end user, it can cause problems in deficient code.</p> <p>Instead, <code class="inline"><span class="w">bytes_to_utf8</span></code> will give you a UTF-8-encoded <b>copy</b> of its string argument. This is useful for having the data available for comparisons and so on, without harming the original SV. There's also <code class="inline"><span class="w">utf8_to_bytes</span></code> to go the other way, but naturally, this will fail if the string contains any characters above 255 that can't be represented in a single byte.</p> <h3 id="How-do-I-compare-strings%3f">How do I compare strings?</h3> <p><a href="perlapi#sv_cmp">sv_cmp in perlapi</a> and <a href="perlapi#sv_cmp_flags">sv_cmp_flags in perlapi</a> do a lexigraphic comparison of two SV's, and handle UTF-8ness properly. Note, however, that Unicode specifies a much fancier mechanism for collation, available via the <a href="unicode/collate">Unicode::Collate</a> module.</p> <p>To just compare two strings for equality/non-equality, you can just use <a href="perlapi#memEQ">memEQ() </a> and <a href="perlapi#memEQ">memNE() </a> as usual, except the strings must be both UTF-8 or not UTF-8 encoded.</p> <p>To compare two strings case-insensitively, use <a href="perlapi#foldEQ_utf8">foldEQ_utf8() </a> (the strings don't have to have the same UTF-8ness).</p> <h3 id="Is-there-anything-else-I-need-to-know%3f">Is there anything else I need to know?</h3> <p>Not really. Just remember these things:</p> <ul> <li> <p>There's no way to tell if a <code class="inline"><span class="w">char</span> *</code> or <code class="inline"><span class="w">U8</span> *</code> string is UTF-8 or not. But you can tell if an SV is to be treated as UTF-8 by calling <code class="inline"><span class="w">DO_UTF8</span></code> on it, after stringifying it with <code class="inline"><span class="w">SvPV</span></code> or a similar macro. And, you can tell if SV is actually UTF-8 (even if it is not to be treated as such) by looking at its <code class="inline"><span class="w">SvUTF8</span></code> flag (again after stringifying it). Don't forget to set the flag if something should be UTF-8. Treat the flag as part of the PV, even though it's not -- if you pass on the PV to somewhere, pass on the flag too.</p> </li> <li> <p>If a string is UTF-8, <b>always</b> use <code class="inline"><span class="w">utf8_to_uvchr_buf</span></code> to get at the value, unless <code class="inline"><span class="i">UTF8_IS_INVARIANT</span><span class="s">(</span><span class="i">*s</span><span class="s">)</span></code> in which case you can use <code class="inline"><span class="i">*s</span></code> .</p> </li> <li> <p>When writing a character UV to a UTF-8 string, <b>always</b> use <code class="inline"><span class="w">uvchr_to_utf8</span></code> , unless <code class="inline"><span class="i">UVCHR_IS_INVARIANT</span><span class="s">(</span><span class="w">uv</span><span class="s">)</span><span class="p">)</span></code> in which case you can use <code class="inline"><span class="i">*s</span> = <span class="w">uv</span></code> .</p> </li> <li> <p>Mixing UTF-8 and non-UTF-8 strings is tricky. Use <code class="inline"><span class="w">bytes_to_utf8</span></code> to get a new string which is UTF-8 encoded, and then combine them.</p> </li> </ul> <h2 id="Custom-Operators">Custom Operators</h2> <p>Custom operator support is an experimental feature that allows you to define your own ops. This is primarily to allow the building of interpreters for other languages in the Perl core, but it also allows optimizations through the creation of "macro-ops" (ops which perform the functions of multiple ops which are usually executed together, such as <code class="inline"><span class="w">gvsv</span><span class="cm">,</span> <span class="w">gvsv</span><span class="cm">,</span> <span class="w">add</span></code> .)</p> <p>This feature is implemented as a new op type, <code class="inline"><span class="w">OP_CUSTOM</span></code> . The Perl core does not "know" anything special about this op type, and so it will not be involved in any optimizations. This also means that you can define your custom ops to be any op structure -- unary, binary, list and so on -- you like.</p> <p>It's important to know what custom operators won't do for you. They won't let you add new syntax to Perl, directly. They won't even let you add new keywords, directly. In fact, they won't change the way Perl compiles a program at all. You have to do those changes yourself, after Perl has compiled the program. You do this either by manipulating the op tree using a <code class="inline">CHECK</code> block and the <code class="inline"><span class="w">B::Generate</span></code> module, or by adding a custom peephole optimizer with the <code class="inline"><span class="w">optimize</span></code> module.</p> <p>When you do this, you replace ordinary Perl ops with custom ops by creating ops with the type <code class="inline"><span class="w">OP_CUSTOM</span></code> and the <code class="inline"><span class="w">op_ppaddr</span></code> of your own PP function. This should be defined in XS code, and should look like the PP ops in <code class="inline">pp_*.c</code>. You are responsible for ensuring that your op takes the appropriate number of values from the stack, and you are responsible for adding stack marks if necessary.</p> <p>You should also "register" your op with the Perl interpreter so that it can produce sensible error and warning messages. Since it is possible to have multiple custom ops within the one "logical" op type <code class="inline"><span class="w">OP_CUSTOM</span></code> , Perl uses the value of <code class="inline"><span class="w">o</span><span class="w">-&gt;op_ppaddr</span></code> to determine which custom op it is dealing with. You should create an <code class="inline"><span class="w">XOP</span></code> structure for each ppaddr you use, set the properties of the custom op with <code class="inline"><span class="w">XopENTRY_set</span></code> , and register the structure against the ppaddr using <code class="inline"><span class="w">Perl_custom_op_register</span></code> . A trivial example might look like:</p> <pre class="verbatim" data-language="perl">static XOP my_xop;
static OP *my_pp(pTHX);

BOOT:
    XopENTRY_set(&amp;my_xop, xop_name, "myxop");
    XopENTRY_set(&amp;my_xop, xop_desc, "Useless custom op");
    Perl_custom_op_register(aTHX_ my_pp, &amp;my_xop);
</pre>
<p>The available fields in the structure are:</p> <ul> <li id="xop_name">
<b>xop_name</b> <p>A short name for your op. This will be included in some error messages, and will also be returned as <code class="inline"><span class="i">$op</span><span class="i">-&gt;name</span></code> by the <a href="b">B</a> module, so it will appear in the output of module like <a href="b/concise">B::Concise</a>.</p> </li> <li id="xop_desc">
<b>xop_desc</b> <p>A short description of the function of the op.</p> </li> <li id="xop_class">
<b>xop_class</b> <p>Which of the various <code class="inline"><span class="i">*OP</span></code> structures this op uses. This should be one of the <code class="inline"><span class="w">OA_</span>*</code> constants from <i>op.h</i>, namely</p> <ul> <li id="OA_BASEOP">
<b>OA_BASEOP</b> </li> <li id="OA_UNOP">
<b>OA_UNOP</b> </li> <li id="OA_BINOP">
<b>OA_BINOP</b> </li> <li id="OA_LOGOP">
<b>OA_LOGOP</b> </li> <li id="OA_LISTOP">
<b>OA_LISTOP</b> </li> <li id="OA_PMOP">
<b>OA_PMOP</b> </li> <li id="OA_SVOP">
<b>OA_SVOP</b> </li> <li id="OA_PADOP">
<b>OA_PADOP</b> </li> <li id="OA_PVOP_OR_SVOP">
<b>OA_PVOP_OR_SVOP</b> <p>This should be interpreted as '<code class="inline"><span class="w">PVOP</span></code> ' only. The <code class="inline"><span class="w">_OR_SVOP</span></code> is because the only core <code class="inline"><span class="w">PVOP</span></code> , <code class="inline"><span class="w">OP_TRANS</span></code> , can sometimes be a <code class="inline"><span class="w">SVOP</span></code> instead.</p> </li> <li id="OA_LOOP">
<b>OA_LOOP</b> </li> <li id="OA_COP">
<b>OA_COP</b> </li> </ul> <p>The other <code class="inline"><span class="w">OA_</span>*</code> constants should not be used.</p> </li> <li id="xop_peep">
<b>xop_peep</b> <p>This member is of type <code class="inline"><span class="w">Perl_cpeep_t</span></code> , which expands to <code class="inline"><span class="i">void</span>
<span class="s">(</span><span class="i">*Perl_cpeep_t</span><span class="s">)</span><span class="s">(</span><span class="w">aTHX_</span> <span class="w">OP</span> *<span class="w">o</span><span class="cm">,</span> <span class="w">OP</span> *<span class="w">oldop</span><span class="s">)</span></code> . If it is set, this function will be called from <code class="inline"><span class="w">Perl_rpeep</span></code> when ops of this type are encountered by the peephole optimizer. <i>o</i> is the OP that needs optimizing; <i>oldop</i> is the previous OP optimized, whose <code class="inline"><span class="w">op_next</span></code> points to <i>o</i>.</p> </li> </ul> <p><code class="inline"><span class="w">B::Generate</span></code> directly supports the creation of custom ops by name.</p> <h2 id="AUTHORS">AUTHORS</h2> <p>Until May 1997, this document was maintained by Jeff Okamoto &lt;okamoto@corp.hp.com&gt;. It is now maintained as part of Perl itself by the Perl 5 Porters &lt;perl5-porters@perl.org&gt;.</p> <p>With lots of help and suggestions from Dean Roehrich, Malcolm Beattie, Andreas Koenig, Paul Hudson, Ilya Zakharevich, Paul Marquess, Neil Bowers, Matthew Green, Tim Bunce, Spider Boardman, Ulrich Pfeifer, Stephen McCamant, and Gurusamy Sarathy.</p> <h2 id="SEE-ALSO">SEE ALSO</h2> <p><a href="perlapi">perlapi</a>, <a href="perlintern">perlintern</a>, <a href="perlxs">perlxs</a>, <a href="perlembed">perlembed</a></p>
<div class="_attribution">
  <p class="_attribution-p">
    © 1993–2016 Larry Wall and others<br>Licensed under the GNU General Public License version 1 or later, or the Artistic License.<br>The Perl logo is a trademark of the Perl Foundation.<br>
    <a href="https://perldoc.perl.org/5.26.0/perlguts.html" class="_attribution-link">https://perldoc.perl.org/5.26.0/perlguts.html</a>
  </p>
</div>

				
			</div>
			<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-2572770204602497"
     data-ad-slot="1992473792"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
		</div>
	</section>

	</div>
	<svg style="display:none">
		<symbol id="icon-dir"><svg viewBox="0 0 20 20"><path d="M15 10c0 .3-.305.515-.305.515l-8.56 5.303c-.625.41-1.135.106-1.135-.67V4.853c0-.777.51-1.078 1.135-.67l8.56 5.305S15 9.702 15 10z"/></svg></symbol>
	  </svg>
</body>
</html>
