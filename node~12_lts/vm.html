
<!DOCTYPE HTML>

<html lang="en" class="_theme-default">

<head>
  <meta charset="utf-8">
  <title>Vm - Node.js 12 LTS - W3cubDocs</title>
  
  <meta name="description" content=" Source Code&#58; lib&#47;vm.js ">
  <meta name="keywords" content="vm, executing, javascript, node, js, lts, node~12_lts">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="mobile-web-app-capable" content="yes">
  
  <link rel="canonical" href="https://docs.w3cub.com/node~12_lts/vm.html">
  <link href="/favicon.png" rel="icon">
  <link rel="stylesheet" type="text/css" href="/assets/application-e4ebd3a2a5652ff55173659804c4390a004917f3bdd17b5bb3ba78ea5c9c46fe181cadaac34517ccd815f5bdc982bbfe67179d6f4ac2f084ef2265e2a3dc8dc5.css" integrity="sha512-5OvToqVlL/VRc2WYBMQ5CgBJF/O90Xtbs7p46lycRv4YHK2qw0UXzNgV9b3Jgrv+Zxedb0rC8ITvImXio9yNxQ==" crossorigin="anonymous">
  <script type="text/javascript" integrity="sha512-EpkDeu98lN/jPKijllzVWdRg/dUSSMCaldYZNFz6bcNoBvpWRNz0HSTRQJ3ENmQc5Cuj1zDW1vHd7b0DzpOgyA==" crossorigin="anonymous" src="/assets/application-1299037aef7c94dfe33ca8a3965cd559d460fdd51248c09a95d619345cfa6dc36806fa5644dcf41d24d1409dc436641ce42ba3d730d6d6f1ddedbd03ce93a0c8.js"></script>
  <script src="/json/node~12_lts.js"></script>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-71174418-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>
  <script data-ad-client="ca-pub-2572770204602497" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script async custom-element="amp-auto-ads"
  src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
</script>


</head>

<body>
	<amp-auto-ads type="adsense"
              data-ad-client="ca-pub-2572770204602497">
	</amp-auto-ads>
	<div class="_app">
	<header class="_header">
  
  <form class="_search">
    <input type="search" class="_search-input" placeholder="Search&hellip;" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" maxlength="20">
    <a class="_search-clear"></a>
    <div class="_search-tag"></div>
  </form>
  
  <a class="_home-link" href="/" ></a>
  <a class="_menu-link"></a>
  <h1 class="_logo">
    <a href="/" class="_nav-link" title="API Documentation Browser">W3cubDocs</a>
  </h1>
  
  <span class="_logo-sub-nav">/</span><span class="_logo-sub-nav"><a href="/node~12_lts/" class="_nav-link" title="" style="margin-left:0;">Node.js 12 LTS</a></span>
  
  <nav class="_nav">
    <a href="https://tools.w3cub.com/?_sp=docs" target="_blank" class="_nav-link ">W3cubTools</a>
    <a href="/cheatsheets/" class="_nav-link ">Cheatsheets</a>
    <a href="/about/" class="_nav-link ">About</a>
  </nav>
</header>
	<section class="_sidebar">
		<div class="_list-wrap">
			<div class="_list">
			
			</div>
		</div>
	</section>
	<section class="_container ">
		<div class="_content">
			<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-2572770204602497"
     data-ad-slot="6861657091"
     data-ad-format="link"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
			<div class="_page _node">
				
				
<h1 id="vm_vm_executing_javascript">VM (executing JavaScript)</h1> 
<div class="api_stability api_stability_2">
<a href="https://nodejs.org/dist/latest-v12.x/docs/api/documentation.html#documentation_stability_index">Stability: 2</a> - Stable</div>
 <p><strong>Source Code:</strong> <a href="https://github.com/nodejs/node/blob/v12.19.0/lib/vm.js">lib/vm.js</a></p> <p>The <code>vm</code> module enables compiling and running code within V8 Virtual Machine contexts. <strong>The <code>vm</code> module is not a security mechanism. Do not use it to run untrusted code</strong>.</p> <p>JavaScript code can be compiled and run immediately or compiled, saved, and run later.</p> <p>A common use case is to run the code in a different V8 Context. This means invoked code has a different global object than the invoking code.</p> <p>One can provide the context by <a href="#vm_what_does_it_mean_to_contextify_an_object"><em>contextifying</em></a> an object. The invoked code treats any property in the context like a global variable. Any changes to global variables caused by the invoked code are reflected in the context object.</p> <pre data-language="js">const vm = require('vm');

const x = 1;

const context = { x: 2 };
vm.createContext(context); // Contextify the object.

const code = 'x += 40; var y = 17;';
// `x` and `y` are global variables in the context.
// Initially, x has the value 2 because that is the value of context.x.
vm.runInContext(code, context);

console.log(context.x); // 42
console.log(context.y); // 17

console.log(x); // 1; y is not defined.</pre> <h2 id="vm_class_vm_script">Class: <code>vm.Script</code>
</h2> <div class="api_metadata"> <span>Added in: v0.3.1</span> </div> <p>Instances of the <code>vm.Script</code> class contain precompiled scripts that can be executed in specific contexts.</p> <h3 id="vm_new_vm_script_code_options"><code>new vm.Script(code[, options])</code></h3> <div class="api_metadata"> <details class="changelog"><summary>History</summary> <table> <tbody>
<tr>
<th>Version</th>
<th>Changes</th>
</tr> <tr>
<td>v10.6.0</td> <td><p>The <code>produceCachedData</code> is deprecated in favour of <code>script.createCachedData()</code></p></td>
</tr> <tr>
<td>v5.7.0</td> <td><p>The <code>cachedData</code> and <code>produceCachedData</code> options are supported now.</p></td>
</tr> <tr>
<td>v0.3.1</td> <td><p><span>Added in: v0.3.1</span></p></td>
</tr> </tbody>
</table> </details> </div> <ul> <li>
<code>code</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="type">&lt;string&gt;</a> The JavaScript code to compile.</li> <li> <p><code>options</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" class="type">&lt;Object&gt;</a> | <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="type">&lt;string&gt;</a></p> <ul> <li>
<code>filename</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="type">&lt;string&gt;</a> Specifies the filename used in stack traces produced by this script. <strong>Default:</strong> <code>'evalmachine.&lt;anonymous&gt;'</code>.</li> <li>
<code>lineOffset</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type" class="type">&lt;number&gt;</a> Specifies the line number offset that is displayed in stack traces produced by this script. <strong>Default:</strong> <code>0</code>.</li> <li>
<code>columnOffset</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type" class="type">&lt;number&gt;</a> Specifies the column number offset that is displayed in stack traces produced by this script. <strong>Default:</strong> <code>0</code>.</li> <li>
<code>cachedData</code> <a href="buffer#buffer_class_buffer" class="type">&lt;Buffer&gt;</a> | <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/TypedArray" class="type">&lt;TypedArray&gt;</a> | <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/DataView" class="type">&lt;DataView&gt;</a> Provides an optional <code>Buffer</code> or <code>TypedArray</code>, or <code>DataView</code> with V8's code cache data for the supplied source. When supplied, the <code>cachedDataRejected</code> value will be set to either <code>true</code> or <code>false</code> depending on acceptance of the data by V8.</li> <li>
<code>produceCachedData</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type" class="type">&lt;boolean&gt;</a> When <code>true</code> and no <code>cachedData</code> is present, V8 will attempt to produce code cache data for <code>code</code>. Upon success, a <code>Buffer</code> with V8's code cache data will be produced and stored in the <code>cachedData</code> property of the returned <code>vm.Script</code> instance. The <code>cachedDataProduced</code> value will be set to either <code>true</code> or <code>false</code> depending on whether code cache data is produced successfully. This option is <strong>deprecated</strong> in favor of <code>script.createCachedData()</code>. <strong>Default:</strong> <code>false</code>.</li> <li> <p><code>importModuleDynamically</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" class="type">&lt;Function&gt;</a> Called during evaluation of this module when <code>import()</code> is called. If this option is not specified, calls to <code>import()</code> will reject with <a href="errors#ERR_VM_DYNAMIC_IMPORT_CALLBACK_MISSING"><code>ERR_VM_DYNAMIC_IMPORT_CALLBACK_MISSING</code></a>. This option is part of the experimental modules API, and should not be considered stable.</p> <ul> <li>
<code>specifier</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="type">&lt;string&gt;</a> specifier passed to <code>import()</code>
</li> <li>
<code>module</code> <a href="vm#vm_class_vm_module" class="type">&lt;vm.Module&gt;</a>
</li> <li>Returns: <a href="https://tc39.github.io/ecma262/#sec-module-namespace-exotic-objects" class="type">&lt;Module Namespace Object&gt;</a> | <a href="vm#vm_class_vm_module" class="type">&lt;vm.Module&gt;</a> Returning a <code>vm.Module</code> is recommended in order to take advantage of error tracking, and to avoid issues with namespaces that contain <code>then</code> function exports.</li> </ul> </li> </ul> </li> </ul> <p>If <code>options</code> is a string, then it specifies the filename.</p> <p>Creating a new <code>vm.Script</code> object compiles <code>code</code> but does not run it. The compiled <code>vm.Script</code> can be run later multiple times. The <code>code</code> is not bound to any global object; rather, it is bound before each run, just for that run.</p> <h3 id="vm_script_createcacheddata"><code>script.createCachedData()</code></h3> <div class="api_metadata"> <span>Added in: v10.6.0</span> </div> <ul> <li>Returns: <a href="buffer#buffer_class_buffer" class="type">&lt;Buffer&gt;</a>
</li> </ul> <p>Creates a code cache that can be used with the Script constructor's <code>cachedData</code> option. Returns a Buffer. This method may be called at any time and any number of times.</p> <pre data-language="js">const script = new vm.Script(`
function add(a, b) {
  return a + b;
}

const x = add(1, 2);
`);

const cacheWithoutX = script.createCachedData();

script.runInThisContext();

const cacheWithX = script.createCachedData();</pre> <h3 id="vm_script_runincontext_contextifiedobject_options"><code>script.runInContext(contextifiedObject[, options])</code></h3> <div class="api_metadata"> <details class="changelog"><summary>History</summary> <table> <tbody>
<tr>
<th>Version</th>
<th>Changes</th>
</tr> <tr>
<td>v6.3.0</td> <td><p>The <code>breakOnSigint</code> option is supported now.</p></td>
</tr> <tr>
<td>v0.3.1</td> <td><p><span>Added in: v0.3.1</span></p></td>
</tr> </tbody>
</table> </details> </div> <ul> <li>
<code>contextifiedObject</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" class="type">&lt;Object&gt;</a> A <a href="#vm_what_does_it_mean_to_contextify_an_object">contextified</a> object as returned by the <code>vm.createContext()</code> method.</li> <li> <p><code>options</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" class="type">&lt;Object&gt;</a></p> <ul> <li>
<code>displayErrors</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type" class="type">&lt;boolean&gt;</a> When <code>true</code>, if an <a href="errors#errors_class_error"><code>Error</code></a> occurs while compiling the <code>code</code>, the line of code causing the error is attached to the stack trace. <strong>Default:</strong> <code>true</code>.</li> <li>
<code>timeout</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type" class="type">&lt;integer&gt;</a> Specifies the number of milliseconds to execute <code>code</code> before terminating execution. If execution is terminated, an <a href="errors#errors_class_error"><code>Error</code></a> will be thrown. This value must be a strictly positive integer.</li> <li>
<code>breakOnSigint</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type" class="type">&lt;boolean&gt;</a> If <code>true</code>, the execution will be terminated when <code>SIGINT</code> (Ctrl+C) is received. Existing handlers for the event that have been attached via <code>process.on('SIGINT')</code> will be disabled during script execution, but will continue to work after that. If execution is terminated, an <a href="errors#errors_class_error"><code>Error</code></a> will be thrown. <strong>Default:</strong> <code>false</code>.</li> </ul> </li> <li>Returns: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Data_types" class="type">&lt;any&gt;</a> the result of the very last statement executed in the script.</li> </ul> <p>Runs the compiled code contained by the <code>vm.Script</code> object within the given <code>contextifiedObject</code> and returns the result. Running code does not have access to local scope.</p> <p>The following example compiles code that increments a global variable, sets the value of another global variable, then execute the code multiple times. The globals are contained in the <code>context</code> object.</p> <pre data-language="js">const vm = require('vm');

const context = {
  animal: 'cat',
  count: 2
};

const script = new vm.Script('count += 1; name = "kitty";');

vm.createContext(context);
for (let i = 0; i &lt; 10; ++i) {
  script.runInContext(context);
}

console.log(context);
// Prints: { animal: 'cat', count: 12, name: 'kitty' }</pre> <p>Using the <code>timeout</code> or <code>breakOnSigint</code> options will result in new event loops and corresponding threads being started, which have a non-zero performance overhead.</p> <h3 id="vm_script_runinnewcontext_contextobject_options"><code>script.runInNewContext([contextObject[, options]])</code></h3> <div class="api_metadata"> <details class="changelog"><summary>History</summary> <table> <tbody>
<tr>
<th>Version</th>
<th>Changes</th>
</tr> <tr>
<td>v10.0.0</td> <td><p>The <code>contextCodeGeneration</code> option is supported now.</p></td>
</tr> <tr>
<td>v6.3.0</td> <td><p>The <code>breakOnSigint</code> option is supported now.</p></td>
</tr> <tr>
<td>v0.3.1</td> <td><p><span>Added in: v0.3.1</span></p></td>
</tr> </tbody>
</table> </details> </div> <ul> <li>
<code>contextObject</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" class="type">&lt;Object&gt;</a> An object that will be <a href="#vm_what_does_it_mean_to_contextify_an_object">contextified</a>. If <code>undefined</code>, a new object will be created.</li> <li> <p><code>options</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" class="type">&lt;Object&gt;</a></p> <ul> <li>
<code>displayErrors</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type" class="type">&lt;boolean&gt;</a> When <code>true</code>, if an <a href="errors#errors_class_error"><code>Error</code></a> occurs while compiling the <code>code</code>, the line of code causing the error is attached to the stack trace. <strong>Default:</strong> <code>true</code>.</li> <li>
<code>timeout</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type" class="type">&lt;integer&gt;</a> Specifies the number of milliseconds to execute <code>code</code> before terminating execution. If execution is terminated, an <a href="errors#errors_class_error"><code>Error</code></a> will be thrown. This value must be a strictly positive integer.</li> <li>
<code>breakOnSigint</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type" class="type">&lt;boolean&gt;</a> If <code>true</code>, the execution will be terminated when <code>SIGINT</code> (Ctrl+C) is received. Existing handlers for the event that have been attached via <code>process.on('SIGINT')</code> will be disabled during script execution, but will continue to work after that. If execution is terminated, an <a href="errors#errors_class_error"><code>Error</code></a> will be thrown. <strong>Default:</strong> <code>false</code>.</li> <li>
<code>contextName</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="type">&lt;string&gt;</a> Human-readable name of the newly created context. <strong>Default:</strong> <code>'VM Context i'</code>, where <code>i</code> is an ascending numerical index of the created context.</li> <li>
<code>contextOrigin</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="type">&lt;string&gt;</a> <a href="https://developer.mozilla.org/en-US/docs/Glossary/Origin">Origin</a> corresponding to the newly created context for display purposes. The origin should be formatted like a URL, but with only the scheme, host, and port (if necessary), like the value of the <a href="url#url_url_origin"><code>url.origin</code></a> property of a <a href="url#url_class_url"><code>URL</code></a> object. Most notably, this string should omit the trailing slash, as that denotes a path. <strong>Default:</strong> <code>''</code>.</li> <li> <p><code>contextCodeGeneration</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" class="type">&lt;Object&gt;</a></p> <ul> <li>
<code>strings</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type" class="type">&lt;boolean&gt;</a> If set to false any calls to <code>eval</code> or function constructors (<code>Function</code>, <code>GeneratorFunction</code>, etc) will throw an <code>EvalError</code>. <strong>Default:</strong> <code>true</code>.</li> <li>
<code>wasm</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type" class="type">&lt;boolean&gt;</a> If set to false any attempt to compile a WebAssembly module will throw a <code>WebAssembly.CompileError</code>. <strong>Default:</strong> <code>true</code>.</li> </ul> </li> </ul> </li> <li>Returns: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Data_types" class="type">&lt;any&gt;</a> the result of the very last statement executed in the script.</li> </ul> <p>First contextifies the given <code>contextObject</code>, runs the compiled code contained by the <code>vm.Script</code> object within the created context, and returns the result. Running code does not have access to local scope.</p> <p>The following example compiles code that sets a global variable, then executes the code multiple times in different contexts. The globals are set on and contained within each individual <code>context</code>.</p> <pre data-language="js">const vm = require('vm');

const script = new vm.Script('globalVar = "set"');

const contexts = [{}, {}, {}];
contexts.forEach((context) =&gt; {
  script.runInNewContext(context);
});

console.log(contexts);
// Prints: [{ globalVar: 'set' }, { globalVar: 'set' }, { globalVar: 'set' }]</pre> <h3 id="vm_script_runinthiscontext_options"><code>script.runInThisContext([options])</code></h3> <div class="api_metadata"> <details class="changelog"><summary>History</summary> <table> <tbody>
<tr>
<th>Version</th>
<th>Changes</th>
</tr> <tr>
<td>v6.3.0</td> <td><p>The <code>breakOnSigint</code> option is supported now.</p></td>
</tr> <tr>
<td>v0.3.1</td> <td><p><span>Added in: v0.3.1</span></p></td>
</tr> </tbody>
</table> </details> </div> <ul> <li> <p><code>options</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" class="type">&lt;Object&gt;</a></p> <ul> <li>
<code>displayErrors</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type" class="type">&lt;boolean&gt;</a> When <code>true</code>, if an <a href="errors#errors_class_error"><code>Error</code></a> occurs while compiling the <code>code</code>, the line of code causing the error is attached to the stack trace. <strong>Default:</strong> <code>true</code>.</li> <li>
<code>timeout</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type" class="type">&lt;integer&gt;</a> Specifies the number of milliseconds to execute <code>code</code> before terminating execution. If execution is terminated, an <a href="errors#errors_class_error"><code>Error</code></a> will be thrown. This value must be a strictly positive integer.</li> <li>
<code>breakOnSigint</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type" class="type">&lt;boolean&gt;</a> If <code>true</code>, the execution will be terminated when <code>SIGINT</code> (Ctrl+C) is received. Existing handlers for the event that have been attached via <code>process.on('SIGINT')</code> will be disabled during script execution, but will continue to work after that. If execution is terminated, an <a href="errors#errors_class_error"><code>Error</code></a> will be thrown. <strong>Default:</strong> <code>false</code>.</li> </ul> </li> <li>Returns: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Data_types" class="type">&lt;any&gt;</a> the result of the very last statement executed in the script.</li> </ul> <p>Runs the compiled code contained by the <code>vm.Script</code> within the context of the current <code>global</code> object. Running code does not have access to local scope, but <em>does</em> have access to the current <code>global</code> object.</p> <p>The following example compiles code that increments a <code>global</code> variable then executes that code multiple times:</p> <pre data-language="js">const vm = require('vm');

global.globalVar = 0;

const script = new vm.Script('globalVar += 1', { filename: 'myfile.vm' });

for (let i = 0; i &lt; 1000; ++i) {
  script.runInThisContext();
}

console.log(globalVar);

// 1000</pre> <h2 id="vm_class_vm_module">Class: <code>vm.Module</code>
</h2> <div class="api_metadata"> <span>Added in: v12.16.0</span> </div> 
<div class="api_stability api_stability_1">
<a href="https://nodejs.org/dist/latest-v12.x/docs/api/documentation.html#documentation_stability_index">Stability: 1</a> - Experimental</div>
 <p><em>This feature is only available with the <code>--experimental-vm-modules</code> command flag enabled.</em></p> <p>The <code>vm.Module</code> class provides a low-level interface for using ECMAScript modules in VM contexts. It is the counterpart of the <code>vm.Script</code> class that closely mirrors <a href="https://www.ecma-international.org/ecma-262/#sec-abstract-module-records">Module Record</a>s as defined in the ECMAScript specification.</p> <p>Unlike <code>vm.Script</code> however, every <code>vm.Module</code> object is bound to a context from its creation. Operations on <code>vm.Module</code> objects are intrinsically asynchronous, in contrast with the synchronous nature of <code>vm.Script</code> objects. The use of 'async' functions can help with manipulating <code>vm.Module</code> objects.</p> <p>Using a <code>vm.Module</code> object requires three distinct steps: creation/parsing, linking, and evaluation. These three steps are illustrated in the following example.</p> <p>This implementation lies at a lower level than the <a href="esm#esm_ecmascript_modules">ECMAScript Module loader</a>. There is also no way to interact with the Loader yet, though support is planned.</p> <pre data-language="js">const vm = require('vm');

const contextifiedObject = vm.createContext({ secret: 42 });

(async () =&gt; {
  // Step 1
  //
  // Create a Module by constructing a new `vm.SourceTextModule` object. This
  // parses the provided source text, throwing a `SyntaxError` if anything goes
  // wrong. By default, a Module is created in the top context. But here, we
  // specify `contextifiedObject` as the context this Module belongs to.
  //
  // Here, we attempt to obtain the default export from the module "foo", and
  // put it into local binding "secret".

  const bar = new vm.SourceTextModule(`
    import s from 'foo';
    s;
  `, { context: contextifiedObject });

  // Step 2
  //
  // "Link" the imported dependencies of this Module to it.
  //
  // The provided linking callback (the "linker") accepts two arguments: the
  // parent module (`bar` in this case) and the string that is the specifier of
  // the imported module. The callback is expected to return a Module that
  // corresponds to the provided specifier, with certain requirements documented
  // in `module.link()`.
  //
  // If linking has not started for the returned Module, the same linker
  // callback will be called on the returned Module.
  //
  // Even top-level Modules without dependencies must be explicitly linked. The
  // callback provided would never be called, however.
  //
  // The link() method returns a Promise that will be resolved when all the
  // Promises returned by the linker resolve.
  //
  // Note: This is a contrived example in that the linker function creates a new
  // "foo" module every time it is called. In a full-fledged module system, a
  // cache would probably be used to avoid duplicated modules.

  async function linker(specifier, referencingModule) {
    if (specifier === 'foo') {
      return new vm.SourceTextModule(`
        // The "secret" variable refers to the global variable we added to
        // "contextifiedObject" when creating the context.
        export default secret;
      `, { context: referencingModule.context });

      // Using `contextifiedObject` instead of `referencingModule.context`
      // here would work as well.
    }
    throw new Error(`Unable to resolve dependency: ${specifier}`);
  }
  await bar.link(linker);

  // Step 3
  //
  // Evaluate the Module. The evaluate() method returns a Promise with a single
  // property "result" that contains the result of the very last statement
  // executed in the Module. In the case of `bar`, it is `s;`, which refers to
  // the default export of the `foo` module, the `secret` we set in the
  // beginning to 42.

  const { result } = await bar.evaluate();

  console.log(result);
  // Prints 42.
})();</pre> <h3 id="vm_module_dependencyspecifiers"><code>module.dependencySpecifiers</code></h3> <ul> <li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="type">&lt;string[]&gt;</a></li> </ul> <p>The specifiers of all dependencies of this module. The returned array is frozen to disallow any changes to it.</p> <p>Corresponds to the <code>[[RequestedModules]]</code> field of <a href="https://tc39.es/ecma262/#sec-cyclic-module-records">Cyclic Module Record</a>s in the ECMAScript specification.</p> <h3 id="vm_module_error"><code>module.error</code></h3> <ul> <li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Data_types" class="type">&lt;any&gt;</a></li> </ul> <p>If the <code>module.status</code> is <code>'errored'</code>, this property contains the exception thrown by the module during evaluation. If the status is anything else, accessing this property will result in a thrown exception.</p> <p>The value <code>undefined</code> cannot be used for cases where there is not a thrown exception due to possible ambiguity with <code>throw undefined;</code>.</p> <p>Corresponds to the <code>[[EvaluationError]]</code> field of <a href="https://tc39.es/ecma262/#sec-cyclic-module-records">Cyclic Module Record</a>s in the ECMAScript specification.</p> <h3 id="vm_module_evaluate_options"><code>module.evaluate([options])</code></h3> <ul> <li> <p><code>options</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" class="type">&lt;Object&gt;</a></p> <ul> <li>
<code>timeout</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type" class="type">&lt;integer&gt;</a> Specifies the number of milliseconds to evaluate before terminating execution. If execution is interrupted, an <a href="errors#errors_class_error"><code>Error</code></a> will be thrown. This value must be a strictly positive integer.</li> <li>
<code>breakOnSigint</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type" class="type">&lt;boolean&gt;</a> If <code>true</code>, the execution will be terminated when <code>SIGINT</code> (Ctrl+C) is received. Existing handlers for the event that have been attached via <code>process.on('SIGINT')</code> will be disabled during script execution, but will continue to work after that. If execution is interrupted, an <a href="errors#errors_class_error"><code>Error</code></a> will be thrown. <strong>Default:</strong> <code>false</code>.</li> </ul> </li> <li>Returns: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise" class="type">&lt;Promise&gt;</a>
</li> </ul> <p>Evaluate the module.</p> <p>This must be called after the module has been linked; otherwise it will throw an error. It could be called also when the module has already been evaluated, in which case it will do one of the following two things:</p> <ul> <li>return <code>undefined</code> if the initial evaluation ended in success (<code>module.status</code> is <code>'evaluated'</code>)</li> <li>rethrow the same exception the initial evaluation threw if the initial evaluation ended in an error (<code>module.status</code> is <code>'errored'</code>)</li> </ul> <p>This method cannot be called while the module is being evaluated (<code>module.status</code> is <code>'evaluating'</code>) to prevent infinite recursion.</p> <p>Corresponds to the <a href="https://tc39.es/ecma262/#sec-moduleevaluation">Evaluate() concrete method</a> field of <a href="https://tc39.es/ecma262/#sec-cyclic-module-records">Cyclic Module Record</a>s in the ECMAScript specification.</p> <h3 id="vm_module_link_linker"><code>module.link(linker)</code></h3> <ul> <li> <p><code>linker</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" class="type">&lt;Function&gt;</a></p> <ul> <li> <p><code>specifier</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="type">&lt;string&gt;</a> The specifier of the requested module:</p>  <pre data-language="js">import foo from 'foo';
//              ^^^^^ the module specifier</pre> </li> <li> <p><code>referencingModule</code> <a href="vm#vm_class_vm_module" class="type">&lt;vm.Module&gt;</a> The <code>Module</code> object <code>link()</code> is called on.</p> </li> <li> <p>Returns: <a href="vm#vm_class_vm_module" class="type">&lt;vm.Module&gt;</a> | <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise" class="type">&lt;Promise&gt;</a></p> </li> </ul> </li> <li> <p>Returns: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Promise" class="type">&lt;Promise&gt;</a></p> </li> </ul> <p>Link module dependencies. This method must be called before evaluation, and can only be called once per module.</p> <p>The function is expected to return a <code>Module</code> object or a <code>Promise</code> that eventually resolves to a <code>Module</code> object. The returned <code>Module</code> must satisfy the following two invariants:</p> <ul> <li>It must belong to the same context as the parent <code>Module</code>.</li> <li>Its <code>status</code> must not be <code>'errored'</code>.</li> </ul> <p>If the returned <code>Module</code>'s <code>status</code> is <code>'unlinked'</code>, this method will be recursively called on the returned <code>Module</code> with the same provided <code>linker</code> function.</p> <p><code>link()</code> returns a <code>Promise</code> that will either get resolved when all linking instances resolve to a valid <code>Module</code>, or rejected if the linker function either throws an exception or returns an invalid <code>Module</code>.</p> <p>The linker function roughly corresponds to the implementation-defined <a href="https://tc39.es/ecma262/#sec-hostresolveimportedmodule">HostResolveImportedModule</a> abstract operation in the ECMAScript specification, with a few key differences:</p> <ul> <li>The linker function is allowed to be asynchronous while <a href="https://tc39.es/ecma262/#sec-hostresolveimportedmodule">HostResolveImportedModule</a> is synchronous.</li> </ul> <p>The actual <a href="https://tc39.es/ecma262/#sec-hostresolveimportedmodule">HostResolveImportedModule</a> implementation used during module linking is one that returns the modules linked during linking. Since at that point all modules would have been fully linked already, the <a href="https://tc39.es/ecma262/#sec-hostresolveimportedmodule">HostResolveImportedModule</a> implementation is fully synchronous per specification.</p> <p>Corresponds to the <a href="https://tc39.es/ecma262/#sec-moduledeclarationlinking">Link() concrete method</a> field of <a href="https://tc39.es/ecma262/#sec-cyclic-module-records">Cyclic Module Record</a>s in the ECMAScript specification.</p> <h3 id="vm_module_namespace"><code>module.namespace</code></h3> <ul> <li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" class="type">&lt;Object&gt;</a></li> </ul> <p>The namespace object of the module. This is only available after linking (<code>module.link()</code>) has completed.</p> <p>Corresponds to the <a href="https://tc39.es/ecma262/#sec-getmodulenamespace">GetModuleNamespace</a> abstract operation in the ECMAScript specification.</p> <h3 id="vm_module_status"><code>module.status</code></h3> <ul> <li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="type">&lt;string&gt;</a></li> </ul> <p>The current status of the module. Will be one of:</p> <ul> <li> <p><code>'unlinked'</code>: <code>module.link()</code> has not yet been called.</p> </li> <li> <p><code>'linking'</code>: <code>module.link()</code> has been called, but not all Promises returned by the linker function have been resolved yet.</p> </li> <li> <p><code>'linked'</code>: The module has been linked successfully, and all of its dependencies are linked, but <code>module.evaluate()</code> has not yet been called.</p> </li> <li> <p><code>'evaluating'</code>: The module is being evaluated through a <code>module.evaluate()</code> on itself or a parent module.</p> </li> <li> <p><code>'evaluated'</code>: The module has been successfully evaluated.</p> </li> <li> <p><code>'errored'</code>: The module has been evaluated, but an exception was thrown.</p> </li> </ul> <p>Other than <code>'errored'</code>, this status string corresponds to the specification's <a href="https://tc39.es/ecma262/#sec-cyclic-module-records">Cyclic Module Record</a>'s <code>[[Status]]</code> field. <code>'errored'</code> corresponds to <code>'evaluated'</code> in the specification, but with <code>[[EvaluationError]]</code> set to a value that is not <code>undefined</code>.</p> <h3 id="vm_module_identifier"><code>module.identifier</code></h3> <ul> <li><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="type">&lt;string&gt;</a></li> </ul> <p>The identifier of the current module, as set in the constructor.</p> <h2 id="vm_class_vm_sourcetextmodule">Class: <code>vm.SourceTextModule</code>
</h2> <div class="api_metadata"> <span>Added in: v9.6.0</span> </div> 
<div class="api_stability api_stability_1">
<a href="https://nodejs.org/dist/latest-v12.x/docs/api/documentation.html#documentation_stability_index">Stability: 1</a> - Experimental</div>
 <p><em>This feature is only available with the <code>--experimental-vm-modules</code> command flag enabled.</em></p> <ul> <li>Extends: <a href="vm#vm_class_vm_module" class="type">&lt;vm.Module&gt;</a>
</li> </ul> <p>The <code>vm.SourceTextModule</code> class provides the <a href="https://tc39.es/ecma262/#sec-source-text-module-records">Source Text Module Record</a> as defined in the ECMAScript specification.</p> <h3 id="vm_new_vm_sourcetextmodule_code_options"><code>new vm.SourceTextModule(code[, options])</code></h3> <ul> <li>
<code>code</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="type">&lt;string&gt;</a> JavaScript Module code to parse</li> <li> <p><code>options</code></p> <ul> <li>
<code>identifier</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="type">&lt;string&gt;</a> String used in stack traces. <strong>Default:</strong> <code>'vm:module(i)'</code> where <code>i</code> is a context-specific ascending index.</li> <li>
<code>cachedData</code> <a href="buffer#buffer_class_buffer" class="type">&lt;Buffer&gt;</a> | <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/TypedArray" class="type">&lt;TypedArray&gt;</a> | <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/DataView" class="type">&lt;DataView&gt;</a> Provides an optional <code>Buffer</code> or <code>TypedArray</code>, or <code>DataView</code> with V8's code cache data for the supplied source. The <code>code</code> must be the same as the module from which this <code>cachedData</code> was created.</li> <li>
<code>context</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" class="type">&lt;Object&gt;</a> The <a href="#vm_what_does_it_mean_to_contextify_an_object">contextified</a> object as returned by the <code>vm.createContext()</code> method, to compile and evaluate this <code>Module</code> in.</li> <li>
<code>lineOffset</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type" class="type">&lt;integer&gt;</a> Specifies the line number offset that is displayed in stack traces produced by this <code>Module</code>. <strong>Default:</strong> <code>0</code>.</li> <li>
<code>columnOffset</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type" class="type">&lt;integer&gt;</a> Specifies the column number offset that is displayed in stack traces produced by this <code>Module</code>. <strong>Default:</strong> <code>0</code>.</li> <li> <p><code>initializeImportMeta</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" class="type">&lt;Function&gt;</a> Called during evaluation of this <code>Module</code> to initialize the <code>import.meta</code>.</p> <ul> <li>
<code>meta</code> <a href="esm#esm_import_meta" class="type">&lt;import.meta&gt;</a>
</li> <li>
<code>module</code> <a href="vm#vm_class_vm_sourcetextmodule" class="type">&lt;vm.SourceTextModule&gt;</a>
</li> </ul> </li> <li> <p><code>importModuleDynamically</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" class="type">&lt;Function&gt;</a> Called during evaluation of this module when <code>import()</code> is called. If this option is not specified, calls to <code>import()</code> will reject with <a href="errors#ERR_VM_DYNAMIC_IMPORT_CALLBACK_MISSING"><code>ERR_VM_DYNAMIC_IMPORT_CALLBACK_MISSING</code></a>.</p> <ul> <li>
<code>specifier</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="type">&lt;string&gt;</a> specifier passed to <code>import()</code>
</li> <li>
<code>module</code> <a href="vm#vm_class_vm_module" class="type">&lt;vm.Module&gt;</a>
</li> <li>Returns: <a href="https://tc39.github.io/ecma262/#sec-module-namespace-exotic-objects" class="type">&lt;Module Namespace Object&gt;</a> | <a href="vm#vm_class_vm_module" class="type">&lt;vm.Module&gt;</a> Returning a <code>vm.Module</code> is recommended in order to take advantage of error tracking, and to avoid issues with namespaces that contain <code>then</code> function exports.</li> </ul> </li> </ul> </li> </ul> <p>Creates a new <code>SourceTextModule</code> instance.</p> <p>Properties assigned to the <code>import.meta</code> object that are objects may allow the module to access information outside the specified <code>context</code>. Use <code>vm.runInContext()</code> to create objects in a specific context.</p> <pre data-language="js">const vm = require('vm');

const contextifiedObject = vm.createContext({ secret: 42 });

(async () =&gt; {
  const module = new vm.SourceTextModule(
    'Object.getPrototypeOf(import.meta.prop).secret = secret;',
    {
      initializeImportMeta(meta) {
        // Note: this object is created in the top context. As such,
        // Object.getPrototypeOf(import.meta.prop) points to the
        // Object.prototype in the top context rather than that in
        // the contextified object.
        meta.prop = {};
      }
    });
  // Since module has no dependencies, the linker function will never be called.
  await module.link(() =&gt; {});
  await module.evaluate();

  // Now, Object.prototype.secret will be equal to 42.
  //
  // To fix this problem, replace
  //     meta.prop = {};
  // above with
  //     meta.prop = vm.runInContext('{}', contextifiedObject);
})();</pre> <h3 id="vm_sourcetextmodule_createcacheddata"><code>sourceTextModule.createCachedData()</code></h3> <div class="api_metadata"> <span>Added in: v12.17.0</span> </div> <ul> <li>Returns: <a href="buffer#buffer_class_buffer" class="type">&lt;Buffer&gt;</a>
</li> </ul> <p>Creates a code cache that can be used with the SourceTextModule constructor's <code>cachedData</code> option. Returns a Buffer. This method may be called any number of times before the module has been evaluated.</p> <pre data-language="js">// Create an initial module
const module = new vm.SourceTextModule('const a = 1;');

// Create cached data from this module
const cachedData = module.createCachedData();

// Create a new module using the cached data. The code must be the same.
const module2 = new vm.SourceTextModule('const a = 1;', { cachedData });</pre> <h2 id="vm_class_vm_syntheticmodule">Class: <code>vm.SyntheticModule</code>
</h2> <div class="api_metadata"> <span>Added in: v12.16.0</span> </div> 
<div class="api_stability api_stability_1">
<a href="https://nodejs.org/dist/latest-v12.x/docs/api/documentation.html#documentation_stability_index">Stability: 1</a> - Experimental</div>
 <p><em>This feature is only available with the <code>--experimental-vm-modules</code> command flag enabled.</em></p> <ul> <li>Extends: <a href="vm#vm_class_vm_module" class="type">&lt;vm.Module&gt;</a>
</li> </ul> <p>The <code>vm.SyntheticModule</code> class provides the <a href="https://heycam.github.io/webidl/#synthetic-module-records">Synthetic Module Record</a> as defined in the WebIDL specification. The purpose of synthetic modules is to provide a generic interface for exposing non-JavaScript sources to ECMAScript module graphs.</p> <pre data-language="js">const vm = require('vm');

const source = '{ "a": 1 }';
const module = new vm.SyntheticModule(['default'], function() {
  const obj = JSON.parse(source);
  this.setExport('default', obj);
});

// Use `module` in linking...</pre> <h3 id="vm_new_vm_syntheticmodule_exportnames_evaluatecallback_options"><code>new vm.SyntheticModule(exportNames, evaluateCallback[, options])</code></h3> <div class="api_metadata"> <span>Added in: v12.16.0</span> </div> <ul> <li>
<code>exportNames</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="type">&lt;string[]&gt;</a> Array of names that will be exported from the module.</li> <li>
<code>evaluateCallback</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" class="type">&lt;Function&gt;</a> Called when the module is evaluated.</li> <li> <p><code>options</code></p> <ul> <li>
<code>identifier</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="type">&lt;string&gt;</a> String used in stack traces. <strong>Default:</strong> <code>'vm:module(i)'</code> where <code>i</code> is a context-specific ascending index.</li> <li>
<code>context</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" class="type">&lt;Object&gt;</a> The <a href="#vm_what_does_it_mean_to_contextify_an_object">contextified</a> object as returned by the <code>vm.createContext()</code> method, to compile and evaluate this <code>Module</code> in.</li> </ul> </li> </ul> <p>Creates a new <code>SyntheticModule</code> instance.</p> <p>Objects assigned to the exports of this instance may allow importers of the module to access information outside the specified <code>context</code>. Use <code>vm.runInContext()</code> to create objects in a specific context.</p> <h3 id="vm_syntheticmodule_setexport_name_value"><code>syntheticModule.setExport(name, value)</code></h3> <div class="api_metadata"> <span>Added in: v12.16.0</span> </div> <ul> <li>
<code>name</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="type">&lt;string&gt;</a> Name of the export to set.</li> <li>
<code>value</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Data_types" class="type">&lt;any&gt;</a> The value to set the export to.</li> </ul> <p>This method is used after the module is linked to set the values of exports. If it is called before the module is linked, an <a href="errors#ERR_VM_MODULE_STATUS"><code>ERR_VM_MODULE_STATUS</code></a> error will be thrown.</p> <pre data-language="js">const vm = require('vm');

(async () =&gt; {
  const m = new vm.SyntheticModule(['x'], () =&gt; {
    m.setExport('x', 1);
  });

  await m.link(() =&gt; {});
  await m.evaluate();

  assert.strictEqual(m.namespace.x, 1);
})();</pre> <h2 id="vm_vm_compilefunction_code_params_options"><code>vm.compileFunction(code[, params[, options]])</code></h2> <div class="api_metadata"> <span>Added in: v10.10.0</span> </div> <ul> <li>
<code>code</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="type">&lt;string&gt;</a> The body of the function to compile.</li> <li>
<code>params</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="type">&lt;string[]&gt;</a> An array of strings containing all parameters for the function.</li> <li> <p><code>options</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" class="type">&lt;Object&gt;</a></p> <ul> <li>
<code>filename</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="type">&lt;string&gt;</a> Specifies the filename used in stack traces produced by this script. <strong>Default:</strong> <code>''</code>.</li> <li>
<code>lineOffset</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type" class="type">&lt;number&gt;</a> Specifies the line number offset that is displayed in stack traces produced by this script. <strong>Default:</strong> <code>0</code>.</li> <li>
<code>columnOffset</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type" class="type">&lt;number&gt;</a> Specifies the column number offset that is displayed in stack traces produced by this script. <strong>Default:</strong> <code>0</code>.</li> <li>
<code>cachedData</code> <a href="buffer#buffer_class_buffer" class="type">&lt;Buffer&gt;</a> | <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/TypedArray" class="type">&lt;TypedArray&gt;</a> | <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/DataView" class="type">&lt;DataView&gt;</a> Provides an optional <code>Buffer</code> or <code>TypedArray</code>, or <code>DataView</code> with V8's code cache data for the supplied source.</li> <li>
<code>produceCachedData</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type" class="type">&lt;boolean&gt;</a> Specifies whether to produce new cache data. <strong>Default:</strong> <code>false</code>.</li> <li>
<code>parsingContext</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" class="type">&lt;Object&gt;</a> The <a href="#vm_what_does_it_mean_to_contextify_an_object">contextified</a> object in which the said function should be compiled in.</li> <li>
<code>contextExtensions</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" class="type">&lt;Object[]&gt;</a> An array containing a collection of context extensions (objects wrapping the current scope) to be applied while compiling. <strong>Default:</strong> <code>[]</code>.</li> </ul> </li> <li>Returns: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" class="type">&lt;Function&gt;</a>
</li> </ul> <p>Compiles the given code into the provided context (if no context is supplied, the current context is used), and returns it wrapped inside a function with the given <code>params</code>.</p> <h2 id="vm_vm_createcontext_contextobject_options"><code>vm.createContext([contextObject[, options]])</code></h2> <div class="api_metadata"> <details class="changelog"><summary>History</summary> <table> <tbody>
<tr>
<th>Version</th>
<th>Changes</th>
</tr> <tr>
<td>v10.0.0</td> <td><p>The first argument can no longer be a function.</p></td>
</tr> <tr>
<td>v10.0.0</td> <td><p>The <code>codeGeneration</code> option is supported now.</p></td>
</tr> <tr>
<td>v0.3.1</td> <td><p><span>Added in: v0.3.1</span></p></td>
</tr> </tbody>
</table> </details> </div> <ul> <li>
<code>contextObject</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" class="type">&lt;Object&gt;</a>
</li> <li> <p><code>options</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" class="type">&lt;Object&gt;</a></p> <ul> <li>
<code>name</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="type">&lt;string&gt;</a> Human-readable name of the newly created context. <strong>Default:</strong> <code>'VM Context i'</code>, where <code>i</code> is an ascending numerical index of the created context.</li> <li>
<code>origin</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="type">&lt;string&gt;</a> <a href="https://developer.mozilla.org/en-US/docs/Glossary/Origin">Origin</a> corresponding to the newly created context for display purposes. The origin should be formatted like a URL, but with only the scheme, host, and port (if necessary), like the value of the <a href="url#url_url_origin"><code>url.origin</code></a> property of a <a href="url#url_class_url"><code>URL</code></a> object. Most notably, this string should omit the trailing slash, as that denotes a path. <strong>Default:</strong> <code>''</code>.</li> <li> <p><code>codeGeneration</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" class="type">&lt;Object&gt;</a></p> <ul> <li>
<code>strings</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type" class="type">&lt;boolean&gt;</a> If set to false any calls to <code>eval</code> or function constructors (<code>Function</code>, <code>GeneratorFunction</code>, etc) will throw an <code>EvalError</code>. <strong>Default:</strong> <code>true</code>.</li> <li>
<code>wasm</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type" class="type">&lt;boolean&gt;</a> If set to false any attempt to compile a WebAssembly module will throw a <code>WebAssembly.CompileError</code>. <strong>Default:</strong> <code>true</code>.</li> </ul> </li> </ul> </li> <li>Returns: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" class="type">&lt;Object&gt;</a> contextified object.</li> </ul> <p>If given a <code>contextObject</code>, the <code>vm.createContext()</code> method will <a href="#vm_what_does_it_mean_to_contextify_an_object">prepare that object</a> so that it can be used in calls to <a href="#vm_vm_runincontext_code_contextifiedobject_options"><code>vm.runInContext()</code></a> or <a href="#vm_script_runincontext_contextifiedobject_options"><code>script.runInContext()</code></a>. Inside such scripts, the <code>contextObject</code> will be the global object, retaining all of its existing properties but also having the built-in objects and functions any standard <a href="https://es5.github.io/#x15.1">global object</a> has. Outside of scripts run by the vm module, global variables will remain unchanged.</p> <pre data-language="js">const vm = require('vm');

global.globalVar = 3;

const context = { globalVar: 1 };
vm.createContext(context);

vm.runInContext('globalVar *= 2;', context);

console.log(context);
// Prints: { globalVar: 2 }

console.log(global.globalVar);
// Prints: 3</pre> <p>If <code>contextObject</code> is omitted (or passed explicitly as <code>undefined</code>), a new, empty <a href="#vm_what_does_it_mean_to_contextify_an_object">contextified</a> object will be returned.</p> <p>The <code>vm.createContext()</code> method is primarily useful for creating a single context that can be used to run multiple scripts. For instance, if emulating a web browser, the method can be used to create a single context representing a window's global object, then run all <code>&lt;script&gt;</code> tags together within that context.</p> <p>The provided <code>name</code> and <code>origin</code> of the context are made visible through the Inspector API.</p> <h2 id="vm_vm_iscontext_object"><code>vm.isContext(object)</code></h2> <div class="api_metadata"> <span>Added in: v0.11.7</span> </div> <ul> <li>
<code>object</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" class="type">&lt;Object&gt;</a>
</li> <li>Returns: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type" class="type">&lt;boolean&gt;</a>
</li> </ul> <p>Returns <code>true</code> if the given <code>oject</code> object has been <a href="#vm_what_does_it_mean_to_contextify_an_object">contextified</a> using <a href="#vm_vm_createcontext_contextobject_options"><code>vm.createContext()</code></a>.</p> <h2 id="vm_vm_runincontext_code_contextifiedobject_options"><code>vm.runInContext(code, contextifiedObject[, options])</code></h2> <div class="api_metadata"> <details class="changelog"><summary>History</summary> <table> <tbody>
<tr>
<th>Version</th>
<th>Changes</th>
</tr> <tr>
<td>v6.3.0</td> <td><p>The <code>breakOnSigint</code> option is supported now.</p></td>
</tr> <tr>
<td>v0.3.1</td> <td><p><span>Added in: v0.3.1</span></p></td>
</tr> </tbody>
</table> </details> </div> <ul> <li>
<code>code</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="type">&lt;string&gt;</a> The JavaScript code to compile and run.</li> <li>
<code>contextifiedObject</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" class="type">&lt;Object&gt;</a> The <a href="#vm_what_does_it_mean_to_contextify_an_object">contextified</a> object that will be used as the <code>global</code> when the <code>code</code> is compiled and run.</li> <li> <p><code>options</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" class="type">&lt;Object&gt;</a> | <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="type">&lt;string&gt;</a></p> <ul> <li>
<code>filename</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="type">&lt;string&gt;</a> Specifies the filename used in stack traces produced by this script. <strong>Default:</strong> <code>'evalmachine.&lt;anonymous&gt;'</code>.</li> <li>
<code>lineOffset</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type" class="type">&lt;number&gt;</a> Specifies the line number offset that is displayed in stack traces produced by this script. <strong>Default:</strong> <code>0</code>.</li> <li>
<code>columnOffset</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type" class="type">&lt;number&gt;</a> Specifies the column number offset that is displayed in stack traces produced by this script. <strong>Default:</strong> <code>0</code>.</li> <li>
<code>displayErrors</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type" class="type">&lt;boolean&gt;</a> When <code>true</code>, if an <a href="errors#errors_class_error"><code>Error</code></a> occurs while compiling the <code>code</code>, the line of code causing the error is attached to the stack trace. <strong>Default:</strong> <code>true</code>.</li> <li>
<code>timeout</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type" class="type">&lt;integer&gt;</a> Specifies the number of milliseconds to execute <code>code</code> before terminating execution. If execution is terminated, an <a href="errors#errors_class_error"><code>Error</code></a> will be thrown. This value must be a strictly positive integer.</li> <li>
<code>breakOnSigint</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type" class="type">&lt;boolean&gt;</a> If <code>true</code>, the execution will be terminated when <code>SIGINT</code> (Ctrl+C) is received. Existing handlers for the event that have been attached via <code>process.on('SIGINT')</code> will be disabled during script execution, but will continue to work after that. If execution is terminated, an <a href="errors#errors_class_error"><code>Error</code></a> will be thrown. <strong>Default:</strong> <code>false</code>.</li> <li>
<code>cachedData</code> <a href="buffer#buffer_class_buffer" class="type">&lt;Buffer&gt;</a> | <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/TypedArray" class="type">&lt;TypedArray&gt;</a> | <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/DataView" class="type">&lt;DataView&gt;</a> Provides an optional <code>Buffer</code> or <code>TypedArray</code>, or <code>DataView</code> with V8's code cache data for the supplied source. When supplied, the <code>cachedDataRejected</code> value will be set to either <code>true</code> or <code>false</code> depending on acceptance of the data by V8.</li> <li>
<code>produceCachedData</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type" class="type">&lt;boolean&gt;</a> When <code>true</code> and no <code>cachedData</code> is present, V8 will attempt to produce code cache data for <code>code</code>. Upon success, a <code>Buffer</code> with V8's code cache data will be produced and stored in the <code>cachedData</code> property of the returned <code>vm.Script</code> instance. The <code>cachedDataProduced</code> value will be set to either <code>true</code> or <code>false</code> depending on whether code cache data is produced successfully. This option is <strong>deprecated</strong> in favor of <code>script.createCachedData()</code>. <strong>Default:</strong> <code>false</code>.</li> <li> <p><code>importModuleDynamically</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" class="type">&lt;Function&gt;</a> Called during evaluation of this module when <code>import()</code> is called. If this option is not specified, calls to <code>import()</code> will reject with <a href="errors#ERR_VM_DYNAMIC_IMPORT_CALLBACK_MISSING"><code>ERR_VM_DYNAMIC_IMPORT_CALLBACK_MISSING</code></a>. This option is part of the experimental modules API, and should not be considered stable.</p> <ul> <li>
<code>specifier</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="type">&lt;string&gt;</a> specifier passed to <code>import()</code>
</li> <li>
<code>module</code> <a href="vm#vm_class_vm_module" class="type">&lt;vm.Module&gt;</a>
</li> <li>Returns: <a href="https://tc39.github.io/ecma262/#sec-module-namespace-exotic-objects" class="type">&lt;Module Namespace Object&gt;</a> | <a href="vm#vm_class_vm_module" class="type">&lt;vm.Module&gt;</a> Returning a <code>vm.Module</code> is recommended in order to take advantage of error tracking, and to avoid issues with namespaces that contain <code>then</code> function exports.</li> </ul> </li> </ul> </li> <li>Returns: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Data_types" class="type">&lt;any&gt;</a> the result of the very last statement executed in the script.</li> </ul> <p>The <code>vm.runInContext()</code> method compiles <code>code</code>, runs it within the context of the <code>contextifiedObject</code>, then returns the result. Running code does not have access to the local scope. The <code>contextifiedObject</code> object <em>must</em> have been previously <a href="#vm_what_does_it_mean_to_contextify_an_object">contextified</a> using the <a href="#vm_vm_createcontext_contextobject_options"><code>vm.createContext()</code></a> method.</p> <p>If <code>options</code> is a string, then it specifies the filename.</p> <p>The following example compiles and executes different scripts using a single <a href="#vm_what_does_it_mean_to_contextify_an_object">contextified</a> object:</p> <pre data-language="js">const vm = require('vm');

const contextObject = { globalVar: 1 };
vm.createContext(contextObject);

for (let i = 0; i &lt; 10; ++i) {
  vm.runInContext('globalVar *= 2;', contextObject);
}
console.log(contextObject);
// Prints: { globalVar: 1024 }</pre> <h2 id="vm_vm_runinnewcontext_code_contextobject_options"><code>vm.runInNewContext(code[, contextObject[, options]])</code></h2> <div class="api_metadata"> <details class="changelog"><summary>History</summary> <table> <tbody>
<tr>
<th>Version</th>
<th>Changes</th>
</tr> <tr>
<td>v10.0.0</td> <td><p>The <code>contextCodeGeneration</code> option is supported now.</p></td>
</tr> <tr>
<td>v6.3.0</td> <td><p>The <code>breakOnSigint</code> option is supported now.</p></td>
</tr> <tr>
<td>v0.3.1</td> <td><p><span>Added in: v0.3.1</span></p></td>
</tr> </tbody>
</table> </details> </div> <ul> <li>
<code>code</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="type">&lt;string&gt;</a> The JavaScript code to compile and run.</li> <li>
<code>contextObject</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" class="type">&lt;Object&gt;</a> An object that will be <a href="#vm_what_does_it_mean_to_contextify_an_object">contextified</a>. If <code>undefined</code>, a new object will be created.</li> <li> <p><code>options</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" class="type">&lt;Object&gt;</a> | <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="type">&lt;string&gt;</a></p> <ul> <li>
<code>filename</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="type">&lt;string&gt;</a> Specifies the filename used in stack traces produced by this script. <strong>Default:</strong> <code>'evalmachine.&lt;anonymous&gt;'</code>.</li> <li>
<code>lineOffset</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type" class="type">&lt;number&gt;</a> Specifies the line number offset that is displayed in stack traces produced by this script. <strong>Default:</strong> <code>0</code>.</li> <li>
<code>columnOffset</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type" class="type">&lt;number&gt;</a> Specifies the column number offset that is displayed in stack traces produced by this script. <strong>Default:</strong> <code>0</code>.</li> <li>
<code>displayErrors</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type" class="type">&lt;boolean&gt;</a> When <code>true</code>, if an <a href="errors#errors_class_error"><code>Error</code></a> occurs while compiling the <code>code</code>, the line of code causing the error is attached to the stack trace. <strong>Default:</strong> <code>true</code>.</li> <li>
<code>timeout</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type" class="type">&lt;integer&gt;</a> Specifies the number of milliseconds to execute <code>code</code> before terminating execution. If execution is terminated, an <a href="errors#errors_class_error"><code>Error</code></a> will be thrown. This value must be a strictly positive integer.</li> <li>
<code>breakOnSigint</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type" class="type">&lt;boolean&gt;</a> If <code>true</code>, the execution will be terminated when <code>SIGINT</code> (Ctrl+C) is received. Existing handlers for the event that have been attached via <code>process.on('SIGINT')</code> will be disabled during script execution, but will continue to work after that. If execution is terminated, an <a href="errors#errors_class_error"><code>Error</code></a> will be thrown. <strong>Default:</strong> <code>false</code>.</li> <li>
<code>contextName</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="type">&lt;string&gt;</a> Human-readable name of the newly created context. <strong>Default:</strong> <code>'VM Context i'</code>, where <code>i</code> is an ascending numerical index of the created context.</li> <li>
<code>contextOrigin</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="type">&lt;string&gt;</a> <a href="https://developer.mozilla.org/en-US/docs/Glossary/Origin">Origin</a> corresponding to the newly created context for display purposes. The origin should be formatted like a URL, but with only the scheme, host, and port (if necessary), like the value of the <a href="url#url_url_origin"><code>url.origin</code></a> property of a <a href="url#url_class_url"><code>URL</code></a> object. Most notably, this string should omit the trailing slash, as that denotes a path. <strong>Default:</strong> <code>''</code>.</li> <li> <p><code>contextCodeGeneration</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" class="type">&lt;Object&gt;</a></p> <ul> <li>
<code>strings</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type" class="type">&lt;boolean&gt;</a> If set to false any calls to <code>eval</code> or function constructors (<code>Function</code>, <code>GeneratorFunction</code>, etc) will throw an <code>EvalError</code>. <strong>Default:</strong> <code>true</code>.</li> <li>
<code>wasm</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type" class="type">&lt;boolean&gt;</a> If set to false any attempt to compile a WebAssembly module will throw a <code>WebAssembly.CompileError</code>. <strong>Default:</strong> <code>true</code>.</li> </ul> </li> <li>
<code>cachedData</code> <a href="buffer#buffer_class_buffer" class="type">&lt;Buffer&gt;</a> | <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/TypedArray" class="type">&lt;TypedArray&gt;</a> | <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/DataView" class="type">&lt;DataView&gt;</a> Provides an optional <code>Buffer</code> or <code>TypedArray</code>, or <code>DataView</code> with V8's code cache data for the supplied source. When supplied, the <code>cachedDataRejected</code> value will be set to either <code>true</code> or <code>false</code> depending on acceptance of the data by V8.</li> <li>
<code>produceCachedData</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type" class="type">&lt;boolean&gt;</a> When <code>true</code> and no <code>cachedData</code> is present, V8 will attempt to produce code cache data for <code>code</code>. Upon success, a <code>Buffer</code> with V8's code cache data will be produced and stored in the <code>cachedData</code> property of the returned <code>vm.Script</code> instance. The <code>cachedDataProduced</code> value will be set to either <code>true</code> or <code>false</code> depending on whether code cache data is produced successfully. This option is <strong>deprecated</strong> in favor of <code>script.createCachedData()</code>. <strong>Default:</strong> <code>false</code>.</li> <li> <p><code>importModuleDynamically</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" class="type">&lt;Function&gt;</a> Called during evaluation of this module when <code>import()</code> is called. If this option is not specified, calls to <code>import()</code> will reject with <a href="errors#ERR_VM_DYNAMIC_IMPORT_CALLBACK_MISSING"><code>ERR_VM_DYNAMIC_IMPORT_CALLBACK_MISSING</code></a>. This option is part of the experimental modules API, and should not be considered stable.</p> <ul> <li>
<code>specifier</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="type">&lt;string&gt;</a> specifier passed to <code>import()</code>
</li> <li>
<code>module</code> <a href="vm#vm_class_vm_module" class="type">&lt;vm.Module&gt;</a>
</li> <li>Returns: <a href="https://tc39.github.io/ecma262/#sec-module-namespace-exotic-objects" class="type">&lt;Module Namespace Object&gt;</a> | <a href="vm#vm_class_vm_module" class="type">&lt;vm.Module&gt;</a> Returning a <code>vm.Module</code> is recommended in order to take advantage of error tracking, and to avoid issues with namespaces that contain <code>then</code> function exports.</li> </ul> </li> </ul> </li> <li>Returns: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Data_types" class="type">&lt;any&gt;</a> the result of the very last statement executed in the script.</li> </ul> <p>The <code>vm.runInNewContext()</code> first contextifies the given <code>contextObject</code> (or creates a new <code>contextObject</code> if passed as <code>undefined</code>), compiles the <code>code</code>, runs it within the created context, then returns the result. Running code does not have access to the local scope.</p> <p>If <code>options</code> is a string, then it specifies the filename.</p> <p>The following example compiles and executes code that increments a global variable and sets a new one. These globals are contained in the <code>contextObject</code>.</p> <pre data-language="js">const vm = require('vm');

const contextObject = {
  animal: 'cat',
  count: 2
};

vm.runInNewContext('count += 1; name = "kitty"', contextObject);
console.log(contextObject);
// Prints: { animal: 'cat', count: 3, name: 'kitty' }</pre> <h2 id="vm_vm_runinthiscontext_code_options"><code>vm.runInThisContext(code[, options])</code></h2> <div class="api_metadata"> <details class="changelog"><summary>History</summary> <table> <tbody>
<tr>
<th>Version</th>
<th>Changes</th>
</tr> <tr>
<td>v6.3.0</td> <td><p>The <code>breakOnSigint</code> option is supported now.</p></td>
</tr> <tr>
<td>v0.3.1</td> <td><p><span>Added in: v0.3.1</span></p></td>
</tr> </tbody>
</table> </details> </div> <ul> <li>
<code>code</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="type">&lt;string&gt;</a> The JavaScript code to compile and run.</li> <li> <p><code>options</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Object" class="type">&lt;Object&gt;</a> | <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="type">&lt;string&gt;</a></p> <ul> <li>
<code>filename</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="type">&lt;string&gt;</a> Specifies the filename used in stack traces produced by this script. <strong>Default:</strong> <code>'evalmachine.&lt;anonymous&gt;'</code>.</li> <li>
<code>lineOffset</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type" class="type">&lt;number&gt;</a> Specifies the line number offset that is displayed in stack traces produced by this script. <strong>Default:</strong> <code>0</code>.</li> <li>
<code>columnOffset</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type" class="type">&lt;number&gt;</a> Specifies the column number offset that is displayed in stack traces produced by this script. <strong>Default:</strong> <code>0</code>.</li> <li>
<code>displayErrors</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type" class="type">&lt;boolean&gt;</a> When <code>true</code>, if an <a href="errors#errors_class_error"><code>Error</code></a> occurs while compiling the <code>code</code>, the line of code causing the error is attached to the stack trace. <strong>Default:</strong> <code>true</code>.</li> <li>
<code>timeout</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Number_type" class="type">&lt;integer&gt;</a> Specifies the number of milliseconds to execute <code>code</code> before terminating execution. If execution is terminated, an <a href="errors#errors_class_error"><code>Error</code></a> will be thrown. This value must be a strictly positive integer.</li> <li>
<code>breakOnSigint</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type" class="type">&lt;boolean&gt;</a> If <code>true</code>, the execution will be terminated when <code>SIGINT</code> (Ctrl+C) is received. Existing handlers for the event that have been attached via <code>process.on('SIGINT')</code> will be disabled during script execution, but will continue to work after that. If execution is terminated, an <a href="errors#errors_class_error"><code>Error</code></a> will be thrown. <strong>Default:</strong> <code>false</code>.</li> <li>
<code>cachedData</code> <a href="buffer#buffer_class_buffer" class="type">&lt;Buffer&gt;</a> | <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/TypedArray" class="type">&lt;TypedArray&gt;</a> | <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/DataView" class="type">&lt;DataView&gt;</a> Provides an optional <code>Buffer</code> or <code>TypedArray</code>, or <code>DataView</code> with V8's code cache data for the supplied source. When supplied, the <code>cachedDataRejected</code> value will be set to either <code>true</code> or <code>false</code> depending on acceptance of the data by V8.</li> <li>
<code>produceCachedData</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Boolean_type" class="type">&lt;boolean&gt;</a> When <code>true</code> and no <code>cachedData</code> is present, V8 will attempt to produce code cache data for <code>code</code>. Upon success, a <code>Buffer</code> with V8's code cache data will be produced and stored in the <code>cachedData</code> property of the returned <code>vm.Script</code> instance. The <code>cachedDataProduced</code> value will be set to either <code>true</code> or <code>false</code> depending on whether code cache data is produced successfully. This option is <strong>deprecated</strong> in favor of <code>script.createCachedData()</code>. <strong>Default:</strong> <code>false</code>.</li> <li> <p><code>importModuleDynamically</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Function" class="type">&lt;Function&gt;</a> Called during evaluation of this module when <code>import()</code> is called. If this option is not specified, calls to <code>import()</code> will reject with <a href="errors#ERR_VM_DYNAMIC_IMPORT_CALLBACK_MISSING"><code>ERR_VM_DYNAMIC_IMPORT_CALLBACK_MISSING</code></a>. This option is part of the experimental modules API, and should not be considered stable.</p> <ul> <li>
<code>specifier</code> <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#String_type" class="type">&lt;string&gt;</a> specifier passed to <code>import()</code>
</li> <li>
<code>module</code> <a href="vm#vm_class_vm_module" class="type">&lt;vm.Module&gt;</a>
</li> <li>Returns: <a href="https://tc39.github.io/ecma262/#sec-module-namespace-exotic-objects" class="type">&lt;Module Namespace Object&gt;</a> | <a href="vm#vm_class_vm_module" class="type">&lt;vm.Module&gt;</a> Returning a <code>vm.Module</code> is recommended in order to take advantage of error tracking, and to avoid issues with namespaces that contain <code>then</code> function exports.</li> </ul> </li> </ul> </li> <li>Returns: <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Data_structures#Data_types" class="type">&lt;any&gt;</a> the result of the very last statement executed in the script.</li> </ul> <p><code>vm.runInThisContext()</code> compiles <code>code</code>, runs it within the context of the current <code>global</code> and returns the result. Running code does not have access to local scope, but does have access to the current <code>global</code> object.</p> <p>If <code>options</code> is a string, then it specifies the filename.</p> <p>The following example illustrates using both <code>vm.runInThisContext()</code> and the JavaScript <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/eval"><code>eval()</code></a> function to run the same code:</p>  <pre data-language="js">const vm = require('vm');
let localVar = 'initial value';

const vmResult = vm.runInThisContext('localVar = "vm";');
console.log(`vmResult: '${vmResult}', localVar: '${localVar}'`);
// Prints: vmResult: 'vm', localVar: 'initial value'

const evalResult = eval('localVar = "eval";');
console.log(`evalResult: '${evalResult}', localVar: '${localVar}'`);
// Prints: evalResult: 'eval', localVar: 'eval'</pre> <p>Because <code>vm.runInThisContext()</code> does not have access to the local scope, <code>localVar</code> is unchanged. In contrast, <a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/eval"><code>eval()</code></a> <em>does</em> have access to the local scope, so the value <code>localVar</code> is changed. In this way <code>vm.runInThisContext()</code> is much like an <a href="https://es5.github.io/#x10.4.2">indirect <code>eval()</code> call</a>, e.g. <code>(0,eval)('code')</code>.</p> <h2 id="vm_example_running_an_http_server_within_a_vm">Example: Running an HTTP server within a VM</h2> <p>When using either <a href="#vm_script_runinthiscontext_options"><code>script.runInThisContext()</code></a> or <a href="#vm_vm_runinthiscontext_code_options"><code>vm.runInThisContext()</code></a>, the code is executed within the current V8 global context. The code passed to this VM context will have its own isolated scope.</p> <p>In order to run a simple web server using the <code>http</code> module the code passed to the context must either call <code>require('http')</code> on its own, or have a reference to the <code>http</code> module passed to it. For instance:</p> <pre data-language="js">'use strict';
const vm = require('vm');

const code = `
((require) =&gt; {
  const http = require('http');

  http.createServer((request, response) =&gt; {
    response.writeHead(200, { 'Content-Type': 'text/plain' });
    response.end('Hello World\\n');
  }).listen(8124);

  console.log('Server running at http://127.0.0.1:8124/');
})`;

vm.runInThisContext(code)(require);</pre> <p>The <code>require()</code> in the above case shares the state with the context it is passed from. This may introduce risks when untrusted code is executed, e.g. altering objects in the context in unwanted ways.</p> <h2 id="vm_what_does_it_mean_to_contextify_an_object">What does it mean to "contextify" an object?</h2> <p>All JavaScript executed within Node.js runs within the scope of a "context". According to the <a href="https://v8.dev/docs/embed#contexts">V8 Embedder's Guide</a>:</p> <blockquote> <p>In V8, a context is an execution environment that allows separate, unrelated, JavaScript applications to run in a single instance of V8. You must explicitly specify the context in which you want any JavaScript code to be run.</p> </blockquote> <p>When the method <code>vm.createContext()</code> is called, the <code>contextObject</code> argument (or a newly-created object if <code>contextObject</code> is <code>undefined</code>) is associated internally with a new instance of a V8 Context. This V8 Context provides the <code>code</code> run using the <code>vm</code> module's methods with an isolated global environment within which it can operate. The process of creating the V8 Context and associating it with the <code>contextObject</code> is what this document refers to as "contextifying" the object.</p> <h2 id="vm_timeout_limitations_when_using_process_nexttick_promises_and_queuemicrotask">Timeout limitations when using <code>process.nextTick()</code>, promises, and <code>queueMicrotask()</code>
</h2> <p>Because of the internal mechanics of how the <code>process.nextTick()</code> queue and the microtask queue that underlies Promises are implemented within V8 and Node.js, it is possible for code running within a context to "escape" the <code>timeout</code> set using <code>vm.runInContext()</code>, <code>vm.runInNewContext()</code>, and <code>vm.runInThisContext()</code>.</p> <p>For example, the following code executed by <code>vm.runInNewContext()</code> with a timeout of 5 milliseconds schedules an infinite loop to run after a promise resolves. The scheduled loop is never interrupted by the timeout:</p> <pre data-language="js">const vm = require('vm');

function loop() {
  while (1) console.log(Date.now());
}

vm.runInNewContext(
  'Promise.resolve().then(loop);',
  { loop, console },
  { timeout: 5 }
);</pre> <p>This issue also occurs when the <code>loop()</code> call is scheduled using the <code>process.nextTick()</code> and <code>queueMicrotask()</code> functions.</p> <p>This issue occurs because all contexts share the same microtask and nextTick queues.</p>
<div class="_attribution">
  <p class="_attribution-p">
    © Joyent, Inc. and other Node contributors<br>Licensed under the MIT License.<br>Node.js is a trademark of Joyent, Inc. and is used with its permission.<br>We are not endorsed by or affiliated with Joyent.<br>
    <a href="https://nodejs.org/dist/latest-v12.x/docs/api/vm.html" class="_attribution-link">https://nodejs.org/dist/latest-v12.x/docs/api/vm.html</a>
  </p>
</div>

				
			</div>
			<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-2572770204602497"
     data-ad-slot="1992473792"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
		</div>
	</section>

	</div>
	<svg style="display:none">
		<symbol id="icon-dir"><svg viewBox="0 0 20 20"><path d="M15 10c0 .3-.305.515-.305.515l-8.56 5.303c-.625.41-1.135.106-1.135-.67V4.853c0-.777.51-1.078 1.135-.67l8.56 5.305S15 9.702 15 10z"/></svg></symbol>
	  </svg>
</body>
</html>
