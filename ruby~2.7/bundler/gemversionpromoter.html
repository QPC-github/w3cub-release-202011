
<!DOCTYPE HTML>

<html lang="en" class="_theme-default">

<head>
  <meta charset="utf-8">
  <title>Bundler&#58;&#58;GemVersionPromoter - Ruby 2.7 - W3cubDocs</title>
  
  <meta name="description" content="This class contains all of the logic for determining the next version of a Gem to update to based on the requested level (patch, minor, major). &hellip;">
  <meta name="keywords" content="class, bundler, gemversionpromoter, ruby, ruby~2.7">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="mobile-web-app-capable" content="yes">
  
  <link rel="canonical" href="https://docs.w3cub.com/ruby~2.7/bundler/gemversionpromoter.html">
  <link href="/favicon.png" rel="icon">
  <link rel="stylesheet" type="text/css" href="/assets/application-01fda2ddb8339756caccf7add5ad4cf849ab52d069bd799015c7f04f93164f64753bff0d15a49d8060b1e66e41002bb301ccadc2350937df079cea3cd52d3cca.css">
  <script src="/assets/application-d9be6f56a823612443fc15b2e027a630e02c4ad2685bb750d13fa4fae28d46c3e7f7ebb69bd4bafddf116f218f9372e9be44021d4247dc20424e2fd1ff8cef81.js" type="text/javascript"></script>
  <script src="/json/ruby~2.7.js"></script>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-71174418-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>
  <script data-ad-client="ca-pub-2572770204602497" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script async custom-element="amp-auto-ads"
  src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
</script>


</head>

<body class="docs">
	<amp-auto-ads type="adsense"
              data-ad-client="ca-pub-2572770204602497">
	</amp-auto-ads>
	<div class="_app">
	<header class="_header">

  <a class="_home-link" href="/" ></a>
  <a class="_menu-link"></a>
  <h1 class="_logo">
    <a href="/" class="_nav-link" title="API Documentation Browser">W3cubDocs</a>
  </h1>
  
  <span class="_logo-sub-nav">/</span><span class="_logo-sub-nav"><a href="/ruby~2.7/" class="_nav-link" title="" style="margin-left:0;">Ruby 2.7</a></span>
  
  <nav class="_nav">
    <a href="https://tools.w3cub.com/?_sp=docs" target="_blank" class="_nav-link ">W3cubTools</a>
    <a href="/cheatsheets/" class="_nav-link ">Cheatsheets</a>
    <a href="/about/" class="_nav-link ">About</a>
  </nav>
</header>
	<section class="_sidebar">
		
		<form class="_search">
		  <input type="search" class="_search-input" placeholder="Search&hellip;" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" maxlength="20">
		  <a class="_search-clear"></a>
		  <div class="_search-tag"></div>
		</form>
		
		<div class="_list-wrap">
			<div class="_list">
			
			</div>
		</div>
	</section>
	<section class="_container ">
		<div class="_content">
			<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-2572770204602497"
     data-ad-slot="6861657091"
     data-ad-format="link"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
			<div class="_page _rdoc">
				
				
<h1 id="class-Bundler::GemVersionPromoter" class="class"> class Bundler::GemVersionPromoter </h1>
<dl class="meta">
<dt>Parent:</dt>
<dd class="meta-parent"><a href="../object">Object</a></dd>
</dl> <section class="description"> <p>This class contains all of the logic for determining the next version of a Gem to update to based on the requested level (patch, minor, major). Primarily designed to work with <a href="resolver"><code>Resolver</code></a> which will provide it the list of available dependency versions as found in its index, before returning it to to the resolution engine to select the best version.</p> </section> <section id="5Buntitled-5D" class="documentation-section"> <section class="constants-list"> <header> <h3>Constants</h3> </header> <dl> <dt id="DEBUG">DEBUG </dt>

</dl> </section> <section class="attribute-method-details"> <header> <h3>Attributes</h3> </header> <div class="method-detail"> <div class="method-heading attribute-method-heading" id="attribute-i-level"> <span class="method-name">level</span><span class="attribute-access-type">[R]</span> </div>  </div> <div class="method-detail"> <div class="method-heading attribute-method-heading" id="attribute-i-locked_specs"> <span class="method-name">locked_specs</span><span class="attribute-access-type">[R]</span> </div>  </div> <div class="method-detail"> <div class="method-heading attribute-method-heading" id="attribute-i-prerelease_specified"> <span class="method-name">prerelease_specified</span><span class="attribute-access-type">[RW]</span> </div>  </div> <div class="method-detail"> <div class="method-heading attribute-method-heading" id="attribute-i-strict"> <span class="method-name">strict</span><span class="attribute-access-type">[RW]</span> </div> <div class="method-description"> <p>By default, strict is false, meaning every available version of a gem is returned from sort_versions. The order gives preference to the requested level (:patch, :minor, :major) but in complicated requirement cases some gems will by necessity by promoted past the requested level, or even reverted to older versions.</p> <p>If strict is set to true, the results from <a href="gemversionpromoter#method-i-sort_versions"><code>sort_versions</code></a> will be truncated, eliminating any version outside the current level scope. This can lead to unexpected outcomes or even <a href="versionconflict"><code>VersionConflict</code></a> exceptions that report a version of a gem not existing for versions that indeed do existing in the referenced source.</p> </div> </div> <div class="method-detail"> <div class="method-heading attribute-method-heading" id="attribute-i-unlock_gems"> <span class="method-name">unlock_gems</span><span class="attribute-access-type">[R]</span> </div>  </div> </section> <section id="public-class-5Buntitled-5D-method-details" class="method-section"> <header> <h3>Public Class Methods</h3> </header> <div class="method-detail "> <div class="method-heading" id="method-c-new"> <span class="method-name">new</span><span class="method-args">(locked_specs = SpecSet.new([]), unlock_gems = [])</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="new-source"> <pre class="ruby" data-language="ruby"># File lib/bundler/gem_version_promoter.rb, line 38
def initialize(locked_specs = SpecSet.new([]), unlock_gems = [])
  @level = :major
  @strict = false
  @locked_specs = locked_specs
  @unlock_gems = unlock_gems
  @sort_versions = {}
  @prerelease_specified = {}
end</pre> </div> <p>Given a list of <a href="gemversionpromoter#attribute-i-locked_specs"><code>locked_specs</code></a> and a list of gems to unlock creates a <a href="gemversionpromoter"><code>GemVersionPromoter</code></a> instance.</p> <p>@param <a href="gemversionpromoter#attribute-i-locked_specs"><code>locked_specs</code></a> [SpecSet] All current locked specs. Unlike <a href="definition"><code>Definition</code></a></p> <pre>where this list is empty if all gems are being updated, this should
always be populated for all gems so this class can properly function.</pre> <p>@param <a href="gemversionpromoter#attribute-i-unlock_gems"><code>unlock_gems</code></a> [String] List of gem names being unlocked. If empty,</p> <pre>all gems will be considered unlocked.</pre> <p>@return [GemVersionPromoter]</p>  </div> </div> </section> <section id="public-instance-5Buntitled-5D-method-details" class="method-section"> <header> <h3>Public Instance Methods</h3> </header> <div class="method-detail "> <div class="method-heading" id="method-i-level-3D"> <span class="method-name">level=</span><span class="method-args">(value)</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="level-3D-source"> <pre class="ruby" data-language="ruby"># File lib/bundler/gem_version_promoter.rb, line 48
def level=(value)
  v = case value
      when String, Symbol
        value.to_sym
  end

  raise ArgumentError, "Unexpected level #{v}. Must be :major, :minor or :patch" unless [:major, :minor, :patch].include?(v)
  @level = v
end</pre> </div> <p>@param value [Symbol] One of three Symbols: :major, :minor or :patch.</p>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-major-3F"> <span class="method-name">major?</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="major-3F-source"> <pre class="ruby" data-language="ruby"># File lib/bundler/gem_version_promoter.rb, line 92
def major?
  level == :major
end</pre> </div> <p>@return [bool] Convenience method for testing value of level variable.</p>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-minor-3F"> <span class="method-name">minor?</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="minor-3F-source"> <pre class="ruby" data-language="ruby"># File lib/bundler/gem_version_promoter.rb, line 97
def minor?
  level == :minor
end</pre> </div> <p>@return [bool] Convenience method for testing value of level variable.</p>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-sort_versions"> <span class="method-name">sort_versions</span><span class="method-args">(dep, spec_groups)</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="sort_versions-source"> <pre class="ruby" data-language="ruby"># File lib/bundler/gem_version_promoter.rb, line 68
def sort_versions(dep, spec_groups)
  before_result = "before sort_versions: #{debug_format_result(dep, spec_groups).inspect}" if DEBUG

  @sort_versions[dep] ||= begin
    gem_name = dep.name

    # An Array per version returned, different entries for different platforms.
    # We only need the version here so it's ok to hard code this to the first instance.
    locked_spec = locked_specs[gem_name].first

    if strict
      filter_dep_specs(spec_groups, locked_spec)
    else
      sort_dep_specs(spec_groups, locked_spec)
    end.tap do |specs|
      if DEBUG
        warn before_result
        warn " after sort_versions: #{debug_format_result(dep, specs).inspect}"
      end
    end
  end
end</pre> </div> <p>Given a <a href="dependency"><code>Dependency</code></a> and an <a href="../array"><code>Array</code></a> of SpecGroups of available versions for a gem, this method will return the <a href="../array"><code>Array</code></a> of SpecGroups sorted (and possibly truncated if strict is true) in an order to give preference to the current level (:major, :minor or :patch) when resolution is deciding what versions best resolve all dependencies in the bundle. @param dep [Dependency] The <a href="dependency"><code>Dependency</code></a> of the gem. @param spec_groups [SpecGroup] An array of SpecGroups for the same gem</p> <pre>named in the @dep param.</pre> <p>@return [SpecGroup] A new instance of the SpecGroup <a href="../array"><code>Array</code></a> sorted and</p> <pre>possibly filtered.</pre>  </div> </div> </section> <section id="private-instance-5Buntitled-5D-method-details" class="method-section"> <header> <h3>Private Instance Methods</h3> </header> <div class="method-detail "> <div class="method-heading" id="method-i-debug_format_result"> <span class="method-name">debug_format_result</span><span class="method-args">(dep, spec_groups)</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="debug_format_result-source"> <pre class="ruby" data-language="ruby"># File lib/bundler/gem_version_promoter.rb, line 183
def debug_format_result(dep, spec_groups)
  a = [dep.to_s,
       spec_groups.map {|sg| [sg.version, sg.dependencies_for_activated_platforms.map {|dp| [dp.name, dp.requirement.to_s] }] }]
  last_map = a.last.map {|sg_data| [sg_data.first.version, sg_data.last.map {|aa| aa.join(" ") }] }
  [a.first, last_map, level, strict ? :strict : :not_strict]
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-either_version_older_than_locked"> <span class="method-name">either_version_older_than_locked</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="either_version_older_than_locked-source"> <pre class="ruby" data-language="ruby"># File lib/bundler/gem_version_promoter.rb, line 153
def either_version_older_than_locked
  @a_ver &lt; @locked_version || @b_ver &lt; @locked_version
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-filter_dep_specs"> <span class="method-name">filter_dep_specs</span><span class="method-args">(spec_groups, locked_spec)</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="filter_dep_specs-source"> <pre class="ruby" data-language="ruby"># File lib/bundler/gem_version_promoter.rb, line 103
def filter_dep_specs(spec_groups, locked_spec)
  res = spec_groups.select do |spec_group|
    if locked_spec &amp;&amp; !major?
      gsv = spec_group.version
      lsv = locked_spec.version

      must_match = minor? ? [0] : [0, 1]

      matches = must_match.map {|idx| gsv.segments[idx] == lsv.segments[idx] }
      matches.uniq == [true] ? (gsv &gt;= lsv) : false
    else
      true
    end
  end

  sort_dep_specs(res, locked_spec)
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-move_version_to_end"> <span class="method-name">move_version_to_end</span><span class="method-args">(result, version)</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="move_version_to_end-source"> <pre class="ruby" data-language="ruby"># File lib/bundler/gem_version_promoter.rb, line 178
def move_version_to_end(result, version)
  move, keep = result.partition {|s| s.version.to_s == version.to_s }
  keep.concat(move)
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-post_sort"> <span class="method-name">post_sort</span><span class="method-args">(result)</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="post_sort-source"> <pre class="ruby" data-language="ruby"># File lib/bundler/gem_version_promoter.rb, line 168
def post_sort(result)
  # default :major behavior in Bundler does not do this
  return result if major?
  if unlocking_gem?
    result
  else
    move_version_to_end(result, @locked_version)
  end
end</pre> </div> <p>Specific version moves can't always reliably be done during sorting as not all elements are compared against each other.</p>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-segments_do_not_match"> <span class="method-name">segments_do_not_match</span><span class="method-args">(level)</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="segments_do_not_match-source"> <pre class="ruby" data-language="ruby"># File lib/bundler/gem_version_promoter.rb, line 157
def segments_do_not_match(level)
  index = [:major, :minor].index(level)
  @a_ver.segments[index] != @b_ver.segments[index]
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-sort_dep_specs"> <span class="method-name">sort_dep_specs</span><span class="method-args">(spec_groups, locked_spec)</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="sort_dep_specs-source"> <pre class="ruby" data-language="ruby"># File lib/bundler/gem_version_promoter.rb, line 121
def sort_dep_specs(spec_groups, locked_spec)
  return spec_groups unless locked_spec
  @gem_name = locked_spec.name
  @locked_version = locked_spec.version

  result = spec_groups.sort do |a, b|
    @a_ver = a.version
    @b_ver = b.version

    unless @prerelease_specified[@gem_name]
      a_pre = @a_ver.prerelease?
      b_pre = @b_ver.prerelease?

      next -1 if a_pre &amp;&amp; !b_pre
      next  1 if b_pre &amp;&amp; !a_pre
    end

    if major?
      @a_ver &lt;=&gt; @b_ver
    elsif either_version_older_than_locked
      @a_ver &lt;=&gt; @b_ver
    elsif segments_do_not_match(:major)
      @b_ver &lt;=&gt; @a_ver
    elsif !minor? &amp;&amp; segments_do_not_match(:minor)
      @b_ver &lt;=&gt; @a_ver
    else
      @a_ver &lt;=&gt; @b_ver
    end
  end
  post_sort(result)
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-unlocking_gem-3F"> <span class="method-name">unlocking_gem?</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="unlocking_gem-3F-source"> <pre class="ruby" data-language="ruby"># File lib/bundler/gem_version_promoter.rb, line 162
def unlocking_gem?
  unlock_gems.empty? || unlock_gems.include?(@gem_name)
end</pre> </div>  </div> </div> </section> </section><div class="_attribution">
  <p class="_attribution-p">
    Ruby Core © 1993–2017 Yukihiro Matsumoto<br>Licensed under the Ruby License.<br>Ruby Standard Library © contributors<br>Licensed under their own licenses.<br>
    
  </p>
</div>

				
			</div>
			<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-2572770204602497"
     data-ad-slot="1992473792"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
		</div>
	</section>

	</div>
	<svg style="display:none">
		<symbol id="icon-dir"><svg viewBox="0 0 20 20"><path d="M15 10c0 .3-.305.515-.305.515l-8.56 5.303c-.625.41-1.135.106-1.135-.67V4.853c0-.777.51-1.078 1.135-.67l8.56 5.305S15 9.702 15 10z"/></svg></symbol>
	  </svg>
</body>
</html>
