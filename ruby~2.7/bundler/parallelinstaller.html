
<!DOCTYPE HTML>

<html lang="en" class="_theme-default">

<head>
  <meta charset="utf-8">
  <title>Bundler&#58;&#58;ParallelInstaller - Ruby 2.7 - W3cubDocs</title>
  
  <meta name="description" content="Keys in the remains hash represent uninstalled gems specs. We enqueue all gem specs that do not have any dependencies. Later we call this lambda &hellip;">
  <meta name="keywords" content="class, bundler, parallelinstaller, ruby, ruby~2.7">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="mobile-web-app-capable" content="yes">
  
  <link rel="canonical" href="https://docs.w3cub.com/ruby~2.7/bundler/parallelinstaller.html">
  <link href="/favicon.png" rel="icon">
  <link rel="stylesheet" type="text/css" href="/assets/application-e498cd0ebe8746846fec95b1a53ab3bb0fb7f47f794f0a38f44c98a1f0d03b21d777ae2c583732e44a5a890f6eacb79a5333545db9d5f3616091ba21ca17d916.css">
  <script src="/assets/application-79c555f6b25481fffac2cac30a7f3e54e608ca09e9e8e42bb1790095ba6d0fcace47d6bc624ddce952c70370892f2d46864f89e6943d4f7f7ff16c8a3231a91a.js" type="text/javascript"></script>
  <script src="/json/ruby~2.7.js"></script>
  
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-R3WC07G3GB"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-R3WC07G3GB');
</script>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2572770204602497"
     crossorigin="anonymous"></script>
<script async custom-element="amp-auto-ads"
  src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
</script>


</head>

<body class="docs">
	<amp-auto-ads type="adsense"
              data-ad-client="ca-pub-2572770204602497">
	</amp-auto-ads>
	<div class="_app">
	<header class="_header">

  <a class="_home-link" href="/" ></a>
  <a class="_menu-link"></a>
  <h1 class="_logo">
    <a href="/" class="_nav-link" title="API Documentation Browser">W3cubDocs</a>
  </h1>
  
  <span class="_logo-sub-nav">/</span><span class="_logo-sub-nav"><a href="/ruby~2.7/" class="_nav-link" title="" style="margin-left:0;">Ruby 2.7</a></span>
  
  <nav class="_nav">
    <a href="https://tools.w3cub.com/?_sp=docs" target="_blank" class="_nav-link ">W3cubTools</a>
    <a href="/cheatsheets/" class="_nav-link ">Cheatsheets</a>
    <a href="/about/" class="_nav-link ">About</a>
  </nav>
</header>
	<section class="_sidebar">
		
		<form class="_search">
		  <input type="search" class="_search-input" placeholder="Search&hellip;" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" maxlength="20">
		  <a class="_search-clear"></a>
		  <div class="_search-tag"></div>
		</form>
		
		<div class="_list-wrap">
			<div class="_list">
			
			</div>
		</div>
	</section>
	<section class="_container ">
		<div class="_content">
			<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-2572770204602497"
     data-ad-slot="6861657091"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
			<div class="_page _rdoc">
				
				
<h1 id="class-Bundler::ParallelInstaller" class="class"> class Bundler::ParallelInstaller </h1>
<dl class="meta">
<dt>Parent:</dt>
<dd class="meta-parent"><a href="../object">Object</a></dd>
</dl>  <section id="5Buntitled-5D" class="documentation-section"> <section class="attribute-method-details"> <header> <h3>Attributes</h3> </header> <div class="method-detail"> <div class="method-heading attribute-method-heading" id="attribute-i-size"> <span class="method-name">size</span><span class="attribute-access-type">[R]</span> </div>  </div> </section> <section id="public-class-5Buntitled-5D-method-details" class="method-section"> <header> <h3>Public Class Methods</h3> </header> <div class="method-detail "> <div class="method-heading" id="method-c-call"> <span class="method-name">call</span><span class="method-args">(*args)</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="call-source"> <pre class="ruby" data-language="ruby"># File lib/bundler/installer/parallel_installer.rb, line 77
def self.call(*args)
  new(*args).call
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-c-new"> <span class="method-name">new</span><span class="method-args">(installer, all_specs, size, standalone, force)</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="new-source"> <pre class="ruby" data-language="ruby"># File lib/bundler/installer/parallel_installer.rb, line 83
def initialize(installer, all_specs, size, standalone, force)
  @installer = installer
  @size = size
  @standalone = standalone
  @force = force
  @specs = all_specs.map {|s| SpecInstallation.new(s) }
  @spec_set = all_specs
  @rake = @specs.find {|s| s.name == "rake" }
end</pre> </div>  </div> </div> </section> <section id="public-instance-5Buntitled-5D-method-details" class="method-section"> <header> <h3>Public Instance Methods</h3> </header> <div class="method-detail "> <div class="method-heading" id="method-i-call"> <span class="method-name">call</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="call-source"> <pre class="ruby" data-language="ruby"># File lib/bundler/installer/parallel_installer.rb, line 93
def call
  check_for_corrupt_lockfile

  if @size &gt; 1
    install_with_worker
  else
    install_serially
  end

  handle_error if @specs.any?(&amp;:failed?)
  @specs
ensure
  worker_pool &amp;&amp; worker_pool.stop
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-check_for_corrupt_lockfile"> <span class="method-name">check_for_corrupt_lockfile</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="check_for_corrupt_lockfile-source"> <pre class="ruby" data-language="ruby"># File lib/bundler/installer/parallel_installer.rb, line 108
def check_for_corrupt_lockfile
  missing_dependencies = @specs.map do |s|
    [
      s,
      s.missing_lockfile_dependencies(@specs.map(&amp;:name)),
    ]
  end.reject {|a| a.last.empty? }
  return if missing_dependencies.empty?

  warning = []
  warning &lt;&lt; "Your lockfile was created by an old Bundler that left some things out."
  if @size != 1
    warning &lt;&lt; "Because of the missing DEPENDENCIES, we can only install gems one at a time, instead of installing #{@size} at a time."
    @size = 1
  end
  warning &lt;&lt; "You can fix this by adding the missing gems to your Gemfile, running bundle install, and then removing the gems from your Gemfile."
  warning &lt;&lt; "The missing gems are:"

  missing_dependencies.each do |spec, missing|
    warning &lt;&lt; "* #{missing.map(&amp;:name).join(", ")} depended upon by #{spec.name}"
  end

  Bundler.ui.warn(warning.join("\n"))
end</pre> </div>  </div> </div> </section> <section id="private-instance-5Buntitled-5D-method-details" class="method-section"> <header> <h3>Private Instance Methods</h3> </header> <div class="method-detail "> <div class="method-heading" id="method-i-do_install"> <span class="method-name">do_install</span><span class="method-args">(spec_install, worker_num)</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="do_install-source"> <pre class="ruby" data-language="ruby"># File lib/bundler/installer/parallel_installer.rb, line 154
def do_install(spec_install, worker_num)
  Plugin.hook(Plugin::Events::GEM_BEFORE_INSTALL, spec_install)
  gem_installer = Bundler::GemInstaller.new(
    spec_install.spec, @installer, @standalone, worker_num, @force
  )
  success, message = begin
    gem_installer.install_from_spec
  rescue RuntimeError =&gt; e
    raise e, "#{e}\n\n#{require_tree_for_spec(spec_install.spec)}"
  end
  if success
    spec_install.state = :installed
    spec_install.post_install_message = message unless message.nil?
  else
    spec_install.state = :failed
    spec_install.error = "#{message}\n\n#{require_tree_for_spec(spec_install.spec)}"
  end
  Plugin.hook(Plugin::Events::GEM_AFTER_INSTALL, spec_install)
  spec_install
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-enqueue_specs"> <span class="method-name">enqueue_specs</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="enqueue_specs-source"> <pre class="ruby" data-language="ruby"># File lib/bundler/installer/parallel_installer.rb, line 218
def enqueue_specs
  @specs.select(&amp;:ready_to_enqueue?).each do |spec|
    next if @rake &amp;&amp; !@rake.installed? &amp;&amp; spec.name != @rake.name

    if spec.dependencies_installed? @specs
      spec.state = :enqueued
      worker_pool.enq spec
    end
  end
end</pre> </div> <p>Keys in the remains hash represent uninstalled gems specs. We enqueue all gem specs that do not have any dependencies. Later we call this lambda again to install specs that depended on previously installed specifications. We continue until all specs are installed.</p>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-finished_installing-3F"> <span class="method-name">finished_installing?</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="finished_installing-3F-source"> <pre class="ruby" data-language="ruby"># File lib/bundler/installer/parallel_installer.rb, line 185
def finished_installing?
  @specs.all? do |spec|
    return true if spec.failed?
    spec.installed?
  end
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-handle_error"> <span class="method-name">handle_error</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="handle_error-source"> <pre class="ruby" data-language="ruby"># File lib/bundler/installer/parallel_installer.rb, line 192
def handle_error
  errors = @specs.select(&amp;:failed?).map(&amp;:error)
  if exception = errors.find {|e| e.is_a?(Bundler::BundlerError) }
    raise exception
  end
  raise Bundler::InstallError, errors.map(&amp;:to_s).join("\n\n")
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-install_serially"> <span class="method-name">install_serially</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="install_serially-source"> <pre class="ruby" data-language="ruby"># File lib/bundler/installer/parallel_installer.rb, line 140
def install_serially
  until finished_installing?
    raise "failed to find a spec to enqueue while installing serially" unless spec_install = @specs.find(&amp;:ready_to_enqueue?)
    spec_install.state = :enqueued
    do_install(spec_install, 0)
  end
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-install_with_worker"> <span class="method-name">install_with_worker</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="install_with_worker-source"> <pre class="ruby" data-language="ruby"># File lib/bundler/installer/parallel_installer.rb, line 135
def install_with_worker
  enqueue_specs
  process_specs until finished_installing?
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-process_specs"> <span class="method-name">process_specs</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="process_specs-source"> <pre class="ruby" data-language="ruby"># File lib/bundler/installer/parallel_installer.rb, line 180
def process_specs
  worker_pool.deq
  enqueue_specs
end</pre> </div> <p>Dequeue a spec and save its post-install message and then enqueue the remaining specs. Some specs might've had to wait til this spec was installed to be processed so the call to `enqueue_specs` is important after every dequeue.</p>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-require_tree_for_spec"> <span class="method-name">require_tree_for_spec</span><span class="method-args">(spec)</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="require_tree_for_spec-source"> <pre class="ruby" data-language="ruby"># File lib/bundler/installer/parallel_installer.rb, line 200
def require_tree_for_spec(spec)
  tree = @spec_set.what_required(spec)
  t = String.new("In #{File.basename(SharedHelpers.default_gemfile)}:\n")
  tree.each_with_index do |s, depth|
    t &lt;&lt; "  " * depth.succ &lt;&lt; s.name
    unless tree.last == s
      t &lt;&lt; %( was resolved to #{s.version}, which depends on)
    end
    t &lt;&lt; %(\n)
  end
  t
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-worker_pool"> <span class="method-name">worker_pool</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="worker_pool-source"> <pre class="ruby" data-language="ruby"># File lib/bundler/installer/parallel_installer.rb, line 148
def worker_pool
  @worker_pool ||= Bundler::Worker.new @size, "Parallel Installer", lambda {|spec_install, worker_num|
    do_install(spec_install, worker_num)
  }
end</pre> </div>  </div> </div> </section> </section><div class="_attribution">
  <p class="_attribution-p">
    Ruby Core © 1993–2017 Yukihiro Matsumoto<br>Licensed under the Ruby License.<br>Ruby Standard Library © contributors<br>Licensed under their own licenses.<br>
    
  </p>
</div>

				
			</div>
			<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-2572770204602497"
     data-ad-slot="1992473792"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
		</div>
	</section>

	</div>
	<svg style="display:none">
		<symbol id="icon-dir"><svg viewBox="0 0 20 20"><path d="M15 10c0 .3-.305.515-.305.515l-8.56 5.303c-.625.41-1.135.106-1.135-.67V4.853c0-.777.51-1.078 1.135-.67l8.56 5.305S15 9.702 15 10z"/></svg></symbol>
	  </svg>
</body>
</html>
