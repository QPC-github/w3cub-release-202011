
<!DOCTYPE HTML>

<html lang="en" class="_theme-default">

<head>
  <meta charset="utf-8">
  <title>Bundler&#58;&#58;Injector - Ruby 2.7 - W3cubDocs</title>
  
  <meta name="description" content="&#64;param [Pathname] gemfile_path The Gemfile in which to inject the new dependency. &#64;param [Pathname] lockfile_path The lockfile in which to &hellip;">
  <meta name="keywords" content="class, bundler, injector, ruby, ruby~2.7">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="mobile-web-app-capable" content="yes">
  
  <link rel="canonical" href="https://docs.w3cub.com/ruby~2.7/bundler/injector.html">
  <link href="/favicon.png" rel="icon">
  <link rel="stylesheet" type="text/css" href="/assets/application-01fda2ddb8339756caccf7add5ad4cf849ab52d069bd799015c7f04f93164f64753bff0d15a49d8060b1e66e41002bb301ccadc2350937df079cea3cd52d3cca.css">
  <script src="/assets/application-d9be6f56a823612443fc15b2e027a630e02c4ad2685bb750d13fa4fae28d46c3e7f7ebb69bd4bafddf116f218f9372e9be44021d4247dc20424e2fd1ff8cef81.js" type="text/javascript"></script>
  <script src="/json/ruby~2.7.js"></script>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-71174418-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>
  <script data-ad-client="ca-pub-2572770204602497" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script async custom-element="amp-auto-ads"
  src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
</script>


</head>

<body class="docs">
	<amp-auto-ads type="adsense"
              data-ad-client="ca-pub-2572770204602497">
	</amp-auto-ads>
	<div class="_app">
	<header class="_header">

  <a class="_home-link" href="/" ></a>
  <a class="_menu-link"></a>
  <h1 class="_logo">
    <a href="/" class="_nav-link" title="API Documentation Browser">W3cubDocs</a>
  </h1>
  
  <span class="_logo-sub-nav">/</span><span class="_logo-sub-nav"><a href="/ruby~2.7/" class="_nav-link" title="" style="margin-left:0;">Ruby 2.7</a></span>
  
  <nav class="_nav">
    <a href="https://tools.w3cub.com/?_sp=docs" target="_blank" class="_nav-link ">W3cubTools</a>
    <a href="/cheatsheets/" class="_nav-link ">Cheatsheets</a>
    <a href="/about/" class="_nav-link ">About</a>
  </nav>
</header>
	<section class="_sidebar">
		
		<form class="_search">
		  <input type="search" class="_search-input" placeholder="Search&hellip;" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" maxlength="20">
		  <a class="_search-clear"></a>
		  <div class="_search-tag"></div>
		</form>
		
		<div class="_list-wrap">
			<div class="_list">
			
			</div>
		</div>
	</section>
	<section class="_container ">
		<div class="_content">
			<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-2572770204602497"
     data-ad-slot="6861657091"
     data-ad-format="link"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
			<div class="_page _rdoc">
				
				
<h1 id="class-Bundler::Injector" class="class"> class Bundler::Injector </h1>
<dl class="meta">
<dt>Parent:</dt>
<dd class="meta-parent"><a href="../object">Object</a></dd>
</dl>  <section id="5Buntitled-5D" class="documentation-section"> <section class="constants-list"> <header> <h3>Constants</h3> </header> <dl> <dt id="INJECTED_GEMS">INJECTED_GEMS </dt>

</dl> </section> <section id="public-class-5Buntitled-5D-method-details" class="method-section"> <header> <h3>Public Class Methods</h3> </header> <div class="method-detail "> <div class="method-heading" id="method-c-inject"> <span class="method-name">inject</span><span class="method-args">(new_deps, options = {})</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="inject-source"> <pre class="ruby" data-language="ruby"># File lib/bundler/injector.rb, line 7
def self.inject(new_deps, options = {})
  injector = new(new_deps, options)
  injector.inject(Bundler.default_gemfile, Bundler.default_lockfile)
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-c-new"> <span class="method-name">new</span><span class="method-args">(deps, options = {})</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="new-source"> <pre class="ruby" data-language="ruby"># File lib/bundler/injector.rb, line 17
def initialize(deps, options = {})
  @deps = deps
  @options = options
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-c-remove"> <span class="method-name">remove</span><span class="method-args">(gems, options = {})</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="remove-source"> <pre class="ruby" data-language="ruby"># File lib/bundler/injector.rb, line 12
def self.remove(gems, options = {})
  injector = new(gems, options)
  injector.remove(Bundler.default_gemfile, Bundler.default_lockfile)
end</pre> </div>  </div> </div> </section> <section id="public-instance-5Buntitled-5D-method-details" class="method-section"> <header> <h3>Public Instance Methods</h3> </header> <div class="method-detail "> <div class="method-heading" id="method-i-inject"> <span class="method-name">inject</span><span class="method-args">(gemfile_path, lockfile_path)</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="inject-source"> <pre class="ruby" data-language="ruby"># File lib/bundler/injector.rb, line 25
def inject(gemfile_path, lockfile_path)
  if Bundler.frozen_bundle?
    # ensure the lock and Gemfile are synced
    Bundler.definition.ensure_equivalent_gemfile_and_lockfile(true)
  end

  # temporarily unfreeze
  Bundler.settings.temporary(:deployment =&gt; false, :frozen =&gt; false) do
    # evaluate the Gemfile we have now
    builder = Dsl.new
    builder.eval_gemfile(gemfile_path)

    # don't inject any gems that are already in the Gemfile
    @deps -= builder.dependencies

    # add new deps to the end of the in-memory Gemfile
    # Set conservative versioning to false because
    # we want to let the resolver resolve the version first
    builder.eval_gemfile(INJECTED_GEMS, build_gem_lines(false)) if @deps.any?

    # resolve to see if the new deps broke anything
    @definition = builder.to_definition(lockfile_path, {})
    @definition.resolve_remotely!

    # since nothing broke, we can add those gems to the gemfile
    append_to(gemfile_path, build_gem_lines(@options[:conservative_versioning])) if @deps.any?

    # since we resolved successfully, write out the lockfile
    @definition.lock(Bundler.default_lockfile)

    # invalidate the cached Bundler.definition
    Bundler.reset_paths!

    # return an array of the deps that we added
    @deps
  end
end</pre> </div> <p>@param [Pathname] gemfile_path The Gemfile in which to inject the new dependency. @param [Pathname] lockfile_path The lockfile in which to inject the new dependency. @return [Array]</p>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-remove"> <span class="method-name">remove</span><span class="method-args">(gemfile_path, lockfile_path)</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="remove-source"> <pre class="ruby" data-language="ruby"># File lib/bundler/injector.rb, line 66
def remove(gemfile_path, lockfile_path)
  # remove gems from each gemfiles we have
  Bundler.definition.gemfiles.each do |path|
    deps = remove_deps(path)

    show_warning("No gems were removed from the gemfile.") if deps.empty?

    deps.each {|dep| Bundler.ui.confirm "#{SharedHelpers.pretty_dependency(dep, false)} was removed." }
  end
end</pre> </div> <p>@param [Pathname] gemfile_path The Gemfile from which to remove dependencies. @param [Pathname] lockfile_path The lockfile from which to remove dependencies. @return [Array]</p>  </div> </div> </section> <section id="private-instance-5Buntitled-5D-method-details" class="method-section"> <header> <h3>Private Instance Methods</h3> </header> <div class="method-detail "> <div class="method-heading" id="method-i-append_to"> <span class="method-name">append_to</span><span class="method-args">(gemfile_path, new_gem_lines)</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="append_to-source"> <pre class="ruby" data-language="ruby"># File lib/bundler/injector.rb, line 121
def append_to(gemfile_path, new_gem_lines)
  gemfile_path.open("a") do |f|
    f.puts
    f.puts new_gem_lines
  end
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-build_gem_lines"> <span class="method-name">build_gem_lines</span><span class="method-args">(conservative_versioning)</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="build_gem_lines-source"> <pre class="ruby" data-language="ruby"># File lib/bundler/injector.rb, line 99
def build_gem_lines(conservative_versioning)
  @deps.map do |d|
    name = d.name.dump

    requirement = if conservative_versioning
      ", \"#{conservative_version(@definition.specs[d.name][0])}\""
    else
      ", #{d.requirement.as_list.map(&amp;:dump).join(", ")}"
    end

    if d.groups != Array(:default)
      group = d.groups.size == 1 ? ", :group =&gt; #{d.groups.first.inspect}" : ", :groups =&gt; #{d.groups.inspect}"
    end

    source = ", :source =&gt; \"#{d.source}\"" unless d.source.nil?
    git = ", :git =&gt; \"#{d.git}\"" unless d.git.nil?
    branch = ", :branch =&gt; \"#{d.branch}\"" unless d.branch.nil?

    %(gem #{name}#{requirement}#{group}#{source}#{git}#{branch})
  end.join("\n")
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-conservative_version"> <span class="method-name">conservative_version</span><span class="method-args">(spec)</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="conservative_version-source"> <pre class="ruby" data-language="ruby"># File lib/bundler/injector.rb, line 79
def conservative_version(spec)
  version = spec.version
  return "&gt;= 0" if version.nil?
  segments = version.segments
  seg_end_index = version &gt;= Gem::Version.new("1.0") ? 1 : 2

  prerelease_suffix = version.to_s.gsub(version.release.to_s, "") if version.prerelease?
  "#{version_prefix}#{segments[0..seg_end_index].join(".")}#{prerelease_suffix}"
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-cross_check_for_errors"> <span class="method-name">cross_check_for_errors</span><span class="method-args">(gemfile_path, original_deps, removed_deps, initial_gemfile)</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="cross_check_for_errors-source"> <pre class="ruby" data-language="ruby"># File lib/bundler/injector.rb, line 226
def cross_check_for_errors(gemfile_path, original_deps, removed_deps, initial_gemfile)
  # evaluate the new gemfile to look for any failure cases
  builder = Dsl.new
  builder.eval_gemfile(gemfile_path)

  # record gems which were removed but not requested
  extra_removed_gems = original_deps - builder.dependencies

  # if some extra gems were removed then raise error
  # and revert Gemfile to original
  unless extra_removed_gems.empty?
    SharedHelpers.write_to_gemfile(gemfile_path, initial_gemfile.join)

    raise InvalidOption, "Gems could not be removed. #{extra_removed_gems.join(", ")} would also have been removed. Bundler cannot continue."
  end

  # record gems which could not be removed due to some reasons
  errored_deps = builder.dependencies.select {|d| d.gemfile == gemfile_path } &amp; removed_deps.select {|d| d.gemfile == gemfile_path }

  show_warning "#{errored_deps.map(&amp;:name).join(", ")} could not be removed." unless errored_deps.empty?

  # return actual removed dependencies
  removed_deps - errored_deps
end</pre> </div> <p>@param [Pathname] gemfile_path The Gemfile from which to remove dependencies. @param [Array] original_deps <a href="../array"><code>Array</code></a> of original dependencies. @param [Array] removed_deps <a href="../array"><code>Array</code></a> of removed dependencies. @param [Array] initial_gemfile Contents of original Gemfile before any operation.</p>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-remove_deps"> <span class="method-name">remove_deps</span><span class="method-args">(gemfile_path)</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="remove_deps-source"> <pre class="ruby" data-language="ruby"># File lib/bundler/injector.rb, line 130
def remove_deps(gemfile_path)
  initial_gemfile = IO.readlines(gemfile_path)

  Bundler.ui.info "Removing gems from #{gemfile_path}"

  # evaluate the Gemfile we have
  builder = Dsl.new
  builder.eval_gemfile(gemfile_path)

  removed_deps = remove_gems_from_dependencies(builder, @deps, gemfile_path)

  # abort the operation if no gems were removed
  # no need to operate on gemfile further
  return [] if removed_deps.empty?

  cleaned_gemfile = remove_gems_from_gemfile(@deps, gemfile_path)

  SharedHelpers.write_to_gemfile(gemfile_path, cleaned_gemfile)

  # check for errors
  # including extra gems being removed
  # or some gems not being removed
  # and return the actual removed deps
  cross_check_for_errors(gemfile_path, builder.dependencies, removed_deps, initial_gemfile)
end</pre> </div> <p>evaluates a gemfile to remove the specified gem from it.</p>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-remove_gems_from_dependencies"> <span class="method-name">remove_gems_from_dependencies</span><span class="method-args">(builder, gems, gemfile_path)</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="remove_gems_from_dependencies-source"> <pre class="ruby" data-language="ruby"># File lib/bundler/injector.rb, line 160
def remove_gems_from_dependencies(builder, gems, gemfile_path)
  removed_deps = []

  gems.each do |gem_name|
    deleted_dep = builder.dependencies.find {|d| d.name == gem_name }

    if deleted_dep.nil?
      raise GemfileError, "`#{gem_name}` is not specified in #{gemfile_path} so it could not be removed."
    end

    builder.dependencies.delete(deleted_dep)

    removed_deps &lt;&lt; deleted_dep
  end

  removed_deps
end</pre> </div> <p>@param [Dsl] builder <a href="dsl"><code>Dsl</code></a> object of current Gemfile. @param [Array] gems <a href="../array"><code>Array</code></a> of names of gems to be removed. @param [Pathname] gemfile_path Path of the Gemfile. @return [Array] <a href="../array"><code>Array</code></a> of removed dependencies.</p>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-remove_gems_from_gemfile"> <span class="method-name">remove_gems_from_gemfile</span><span class="method-args">(gems, gemfile_path)</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="remove_gems_from_gemfile-source"> <pre class="ruby" data-language="ruby"># File lib/bundler/injector.rb, line 180
def remove_gems_from_gemfile(gems, gemfile_path)
  patterns = /gem\s+(['"])#{Regexp.union(gems)}\1|gem\s*\((['"])#{Regexp.union(gems)}\2\)/

  # remove lines which match the regex
  new_gemfile = IO.readlines(gemfile_path).reject {|line| line.match(patterns) }

  # remove lone \n and append them with other strings
  new_gemfile.each_with_index do |_line, index|
    if new_gemfile[index + 1] == "\n"
      new_gemfile[index] += new_gemfile[index + 1]
      new_gemfile.delete_at(index + 1)
    end
  end

  %w[group source env install_if].each {|block| remove_nested_blocks(new_gemfile, block) }

  new_gemfile.join.chomp
end</pre> </div> <p>@param [Array] gems <a href="../array"><code>Array</code></a> of names of gems to be removed. @param [Pathname] gemfile_path The Gemfile from which to remove dependencies.</p>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-remove_nested_blocks"> <span class="method-name">remove_nested_blocks</span><span class="method-args">(gemfile, block_name)</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="remove_nested_blocks-source"> <pre class="ruby" data-language="ruby"># File lib/bundler/injector.rb, line 201
def remove_nested_blocks(gemfile, block_name)
  nested_blocks = 0

  # count number of nested blocks
  gemfile.each_with_index {|line, index| nested_blocks += 1 if !gemfile[index + 1].nil? &amp;&amp; gemfile[index + 1].include?(block_name) &amp;&amp; line.include?(block_name) }

  while nested_blocks &gt;= 0
    nested_blocks -= 1

    gemfile.each_with_index do |line, index|
      next unless !line.nil? &amp;&amp; line.strip.start_with?(block_name)
      if gemfile[index + 1] =~ /^\s*end\s*$/
        gemfile[index] = nil
        gemfile[index + 1] = nil
      end
    end

    gemfile.compact!
  end
end</pre> </div> <p>@param [Array] gemfile <a href="../array"><code>Array</code></a> of gemfile contents. @param [String] block_name Name of block name to look for.</p>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-show_warning"> <span class="method-name">show_warning</span><span class="method-args">(message)</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="show_warning-source"> <pre class="ruby" data-language="ruby"># File lib/bundler/injector.rb, line 251
def show_warning(message)
  Bundler.ui.info Bundler.ui.add_color(message, :yellow)
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-version_prefix"> <span class="method-name">version_prefix</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="version_prefix-source"> <pre class="ruby" data-language="ruby"># File lib/bundler/injector.rb, line 89
def version_prefix
  if @options[:strict]
    "= "
  elsif @options[:optimistic]
    "&gt;= "
  else
    "~&gt; "
  end
end</pre> </div>  </div> </div> </section> </section><div class="_attribution">
  <p class="_attribution-p">
    Ruby Core © 1993–2017 Yukihiro Matsumoto<br>Licensed under the Ruby License.<br>Ruby Standard Library © contributors<br>Licensed under their own licenses.<br>
    
  </p>
</div>

				
			</div>
			<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-2572770204602497"
     data-ad-slot="1992473792"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
		</div>
	</section>

	</div>
	<svg style="display:none">
		<symbol id="icon-dir"><svg viewBox="0 0 20 20"><path d="M15 10c0 .3-.305.515-.305.515l-8.56 5.303c-.625.41-1.135.106-1.135-.67V4.853c0-.777.51-1.078 1.135-.67l8.56 5.305S15 9.702 15 10z"/></svg></symbol>
	  </svg>
</body>
</html>
