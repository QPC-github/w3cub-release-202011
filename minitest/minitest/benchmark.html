
<!DOCTYPE HTML>

<html lang="en" class="_theme-default">

<head>
  <meta charset="utf-8">
  <title>Minitest&#58;&#58;Benchmark - Ruby &#47; Minitest - W3cubDocs</title>
  
  <meta name="description" content=" Subclass Benchmark to create your own benchmark runs. Methods starting with “bench_” get executed on a per-class. ">
  <meta name="keywords" content="class, minitest, benchmark, ruby">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="mobile-web-app-capable" content="yes">
  
  <link rel="canonical" href="https://docs.w3cub.com/minitest/minitest/benchmark.html">
  <link href="/favicon.png" rel="icon">
  <link rel="stylesheet" type="text/css" href="/assets/application-01fda2ddb8339756caccf7add5ad4cf849ab52d069bd799015c7f04f93164f64753bff0d15a49d8060b1e66e41002bb301ccadc2350937df079cea3cd52d3cca.css">
  <script src="/assets/application-d9be6f56a823612443fc15b2e027a630e02c4ad2685bb750d13fa4fae28d46c3e7f7ebb69bd4bafddf116f218f9372e9be44021d4247dc20424e2fd1ff8cef81.js" type="text/javascript"></script>
  <script src="/json/minitest.js"></script>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-71174418-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>
  <script data-ad-client="ca-pub-2572770204602497" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script async custom-element="amp-auto-ads"
  src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
</script>


</head>

<body class="docs">
	<amp-auto-ads type="adsense"
              data-ad-client="ca-pub-2572770204602497">
	</amp-auto-ads>
	<div class="_app">
	<header class="_header">

  <a class="_home-link" href="/" ></a>
  <a class="_menu-link"></a>
  <h1 class="_logo">
    <a href="/" class="_nav-link" title="API Documentation Browser">W3cubDocs</a>
  </h1>
  
  <span class="_logo-sub-nav">/</span><span class="_logo-sub-nav"><a href="/minitest/" class="_nav-link" title="" style="margin-left:0;">Ruby / Minitest</a></span>
  
  <nav class="_nav">
    <a href="https://tools.w3cub.com/?_sp=docs" target="_blank" class="_nav-link ">W3cubTools</a>
    <a href="/cheatsheets/" class="_nav-link ">Cheatsheets</a>
    <a href="/about/" class="_nav-link ">About</a>
  </nav>
</header>
	<section class="_sidebar">
		
		<form class="_search">
		  <input type="search" class="_search-input" placeholder="Search&hellip;" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" maxlength="20">
		  <a class="_search-clear"></a>
		  <div class="_search-tag"></div>
		</form>
		
		<div class="_list-wrap">
			<div class="_list">
			
			</div>
		</div>
	</section>
	<section class="_container ">
		<div class="_content">
			<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-2572770204602497"
     data-ad-slot="6861657091"
     data-ad-format="link"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
			<div class="_page _rdoc">
				
				
<h1 id="class-Minitest::Benchmark" class="class"> class Minitest::Benchmark </h1>
<dl class="meta">
<dt>Parent:</dt>
<dd class="meta-parent">Test</dd>
</dl> <section class="description"> <p>Subclass <a href="benchmark">Benchmark</a> to create your own benchmark runs. Methods starting with “bench_” get executed on a per-class.</p> <p>See <a href="assertions">Minitest::Assertions</a></p> </section> <section id="5Buntitled-5D" class="documentation-section"> <section id="public-class-5Buntitled-5D-method-details" class="method-section"> <header> <h3>Public Class Methods</h3> </header> <div class="method-detail "> <div class="method-heading" id="method-c-bench_exp"> <span class="method-name">bench_exp</span><span class="method-args">(min, max, base = 10)</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="bench_exp-source"> <pre class="ruby" data-language="ruby"># File lib/minitest/benchmark.rb, line 35
def self.bench_exp min, max, base = 10
  min = (Math.log10(min) / Math.log10(base)).to_i
  max = (Math.log10(max) / Math.log10(base)).to_i

  (min..max).map { |m| base ** m }.to_a
end</pre> </div> <p>Returns a set of ranges stepped exponentially from <code>min</code> to <code>max</code> by powers of <code>base</code>. Eg:</p> <pre class="ruby" data-language="ruby">bench_exp(2, 16, 2) # =&gt; [2, 4, 8, 16]
</pre>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-c-bench_linear"> <span class="method-name">bench_linear</span><span class="method-args">(min, max, step = 10)</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="bench_linear-source"> <pre class="ruby" data-language="ruby"># File lib/minitest/benchmark.rb, line 48
def self.bench_linear min, max, step = 10
  (min..max).step(step).to_a
rescue LocalJumpError # 1.8.6
  r = []; (min..max).step(step) { |n| r &lt;&lt; n }; r
end</pre> </div> <p>Returns a set of ranges stepped linearly from <code>min</code> to <code>max</code> by <code>step</code>. Eg:</p> <pre class="ruby" data-language="ruby">bench_linear(20, 40, 10) # =&gt; [20, 30, 40]
</pre>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-c-bench_range"> <span class="method-name">bench_range</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="bench_range-source"> <pre class="ruby" data-language="ruby"># File lib/minitest/benchmark.rb, line 61
def self.bench_range
  bench_exp 1, 10_000
end</pre> </div> <p>Specifies the ranges used for benchmarking for that class. Defaults to exponential growth from 1 to 10k by powers of 10. Override if you need different ranges for your benchmarks.</p> <p>See also: <a href="benchmark#method-c-bench_exp">::bench_exp</a> and <a href="benchmark#method-c-bench_linear">::bench_linear</a>.</p>  </div> </div> </section> <section id="public-instance-5Buntitled-5D-method-details" class="method-section"> <header> <h3>Public Instance Methods</h3> </header> <div class="method-detail "> <div class="method-heading" id="method-i-assert_performance"> <span class="method-name">assert_performance</span><span class="method-args">(validation, &amp;work)</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="assert_performance-source"> <pre class="ruby" data-language="ruby"># File lib/minitest/benchmark.rb, line 83
def assert_performance validation, &amp;work
  range = self.class.bench_range

  io.print "#{self.name}"

  times = []

  range.each do |x|
    GC.start
    t0 = Minitest.clock_time
    instance_exec(x, &amp;work)
    t = Minitest.clock_time - t0

    io.print "\t%9.6f" % t
    times &lt;&lt; t
  end
  io.puts

  validation[range, times]
end</pre> </div> <p>Runs the given <code>work</code>, gathering the times of each run. Range and times are then passed to a given <code>validation</code> proc. Outputs the benchmark name and times in tab-separated format, making it easy to paste into a spreadsheet for graphing or further analysis.</p> <p>Ranges are specified by <a href="benchmark#method-c-bench_range">::bench_range</a>.</p> <p>Eg:</p> <pre>def bench_algorithm
  validation = proc { |x, y| ... }
  assert_performance validation do |n|
    @obj.algorithm(n)
  end
end</pre>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-assert_performance_constant"> <span class="method-name">assert_performance_constant</span><span class="method-args">(threshold = 0.99, &amp;work)</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="assert_performance_constant-source"> <pre class="ruby" data-language="ruby"># File lib/minitest/benchmark.rb, line 127
def assert_performance_constant threshold = 0.99, &amp;work
  validation = proc do |range, times|
    a, b, rr = fit_linear range, times
    assert_in_delta 0, b, 1 - threshold
    [a, b, rr]
  end

  assert_performance validation, &amp;work
end</pre> </div> <p>Runs the given <code>work</code> and asserts that the times gathered fit to match a constant rate (eg, linear slope == 0) within a given <code>threshold</code>. Note: because we're testing for a slope of 0, R^2 is not a good determining factor for the fit, so the threshold is applied against the slope itself. As such, you probably want to tighten it from the default.</p> <p>See <a href="http://www.graphpad.com/curvefit/goodness_of_fit.htm">www.graphpad.com/curvefit/goodness_of_fit.htm</a> for more details.</p> <p>Fit is calculated by <a href="benchmark#method-i-fit_linear">fit_linear</a>.</p> <p>Ranges are specified by <a href="benchmark#method-c-bench_range">::bench_range</a>.</p> <p>Eg:</p> <pre class="ruby" data-language="ruby">def bench_algorithm
  assert_performance_constant 0.9999 do |n|
    @obj.algorithm(n)
  end
end
</pre>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-assert_performance_exponential"> <span class="method-name">assert_performance_exponential</span><span class="method-args">(threshold = 0.99, &amp;work)</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="assert_performance_exponential-source"> <pre class="ruby" data-language="ruby"># File lib/minitest/benchmark.rb, line 153
def assert_performance_exponential threshold = 0.99, &amp;work
  assert_performance validation_for_fit(:exponential, threshold), &amp;work
end</pre> </div> <p>Runs the given <code>work</code> and asserts that the times gathered fit to match a exponential curve within a given error <code>threshold</code>.</p> <p>Fit is calculated by <a href="benchmark#method-i-fit_exponential">fit_exponential</a>.</p> <p>Ranges are specified by <a href="benchmark#method-c-bench_range">::bench_range</a>.</p> <p>Eg:</p> <pre class="ruby" data-language="ruby">def bench_algorithm
  assert_performance_exponential 0.9999 do |n|
    @obj.algorithm(n)
  end
end
</pre>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-assert_performance_linear"> <span class="method-name">assert_performance_linear</span><span class="method-args">(threshold = 0.99, &amp;work)</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="assert_performance_linear-source"> <pre class="ruby" data-language="ruby"># File lib/minitest/benchmark.rb, line 193
def assert_performance_linear threshold = 0.99, &amp;work
  assert_performance validation_for_fit(:linear, threshold), &amp;work
end</pre> </div> <p>Runs the given <code>work</code> and asserts that the times gathered fit to match a straight line within a given error <code>threshold</code>.</p> <p>Fit is calculated by <a href="benchmark#method-i-fit_linear">fit_linear</a>.</p> <p>Ranges are specified by <a href="benchmark#method-c-bench_range">::bench_range</a>.</p> <p>Eg:</p> <pre class="ruby" data-language="ruby">def bench_algorithm
  assert_performance_linear 0.9999 do |n|
    @obj.algorithm(n)
  end
end
</pre>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-assert_performance_logarithmic"> <span class="method-name">assert_performance_logarithmic</span><span class="method-args">(threshold = 0.99, &amp;work)</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="assert_performance_logarithmic-source"> <pre class="ruby" data-language="ruby"># File lib/minitest/benchmark.rb, line 173
def assert_performance_logarithmic threshold = 0.99, &amp;work
  assert_performance validation_for_fit(:logarithmic, threshold), &amp;work
end</pre> </div> <p>Runs the given <code>work</code> and asserts that the times gathered fit to match a logarithmic curve within a given error <code>threshold</code>.</p> <p>Fit is calculated by <a href="benchmark#method-i-fit_logarithmic">fit_logarithmic</a>.</p> <p>Ranges are specified by <a href="benchmark#method-c-bench_range">::bench_range</a>.</p> <p>Eg:</p> <pre class="ruby" data-language="ruby">def bench_algorithm
  assert_performance_logarithmic 0.9999 do |n|
    @obj.algorithm(n)
  end
end
</pre>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-assert_performance_power"> <span class="method-name">assert_performance_power</span><span class="method-args">(threshold = 0.99, &amp;work)</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="assert_performance_power-source"> <pre class="ruby" data-language="ruby"># File lib/minitest/benchmark.rb, line 213
def assert_performance_power threshold = 0.99, &amp;work
  assert_performance validation_for_fit(:power, threshold), &amp;work
end</pre> </div> <p>Runs the given <code>work</code> and asserts that the times gathered curve fit to match a power curve within a given error <code>threshold</code>.</p> <p>Fit is calculated by <a href="benchmark#method-i-fit_power">fit_power</a>.</p> <p>Ranges are specified by <a href="benchmark#method-c-bench_range">::bench_range</a>.</p> <p>Eg:</p> <pre class="ruby" data-language="ruby">def bench_algorithm
  assert_performance_power 0.9999 do |x|
    @obj.algorithm
  end
end
</pre>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-fit_error"> <span class="method-name">fit_error</span><span class="method-args">(xys) { |x| ... }</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="fit_error-source"> <pre class="ruby" data-language="ruby"># File lib/minitest/benchmark.rb, line 222
def fit_error xys
  y_bar  = sigma(xys) { |_, y| y } / xys.size.to_f
  ss_tot = sigma(xys) { |_, y| (y    - y_bar) ** 2 }
  ss_err = sigma(xys) { |x, y| (yield(x) - y) ** 2 }

  1 - (ss_err / ss_tot)
end</pre> </div> <p>Takes an array of x/y pairs and calculates the general R^2 value.</p> <p>See: <a href="http://en.wikipedia.org/wiki/Coefficient_of_determination">en.wikipedia.org/wiki/Coefficient_of_determination</a></p>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-fit_exponential"> <span class="method-name">fit_exponential</span><span class="method-args">(xs, ys)</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="fit_exponential-source"> <pre class="ruby" data-language="ruby"># File lib/minitest/benchmark.rb, line 237
def fit_exponential xs, ys
  n     = xs.size
  xys   = xs.zip(ys)
  sxlny = sigma(xys) { |x, y| x * Math.log(y) }
  slny  = sigma(xys) { |_, y| Math.log(y)     }
  sx2   = sigma(xys) { |x, _| x * x           }
  sx    = sigma xs

  c = n * sx2 - sx ** 2
  a = (slny * sx2 - sx * sxlny) / c
  b = ( n * sxlny - sx * slny ) / c

  return Math.exp(a), b, fit_error(xys) { |x| Math.exp(a + b * x) }
end</pre> </div> <p>To fit a functional form: y = ae^(bx).</p> <p>Takes x and y values and returns [a, b, r^2].</p> <p>See: <a href="http://mathworld.wolfram.com/LeastSquaresFittingExponential.html">mathworld.wolfram.com/LeastSquaresFittingExponential.html</a></p>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-fit_linear"> <span class="method-name">fit_linear</span><span class="method-args">(xs, ys)</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="fit_linear-source"> <pre class="ruby" data-language="ruby"># File lib/minitest/benchmark.rb, line 281
def fit_linear xs, ys
  n   = xs.size
  xys = xs.zip(ys)
  sx  = sigma xs
  sy  = sigma ys
  sx2 = sigma(xs)  { |x|   x ** 2 }
  sxy = sigma(xys) { |x, y| x * y  }

  c = n * sx2 - sx**2
  a = (sy * sx2 - sx * sxy) / c
  b = ( n * sxy - sx * sy ) / c

  return a, b, fit_error(xys) { |x| a + b * x }
end</pre> </div> <p>Fits the functional form: a + bx.</p> <p>Takes x and y values and returns [a, b, r^2].</p> <p>See: <a href="http://mathworld.wolfram.com/LeastSquaresFitting.html">mathworld.wolfram.com/LeastSquaresFitting.html</a></p>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-fit_logarithmic"> <span class="method-name">fit_logarithmic</span><span class="method-args">(xs, ys)</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="fit_logarithmic-source"> <pre class="ruby" data-language="ruby"># File lib/minitest/benchmark.rb, line 259
def fit_logarithmic xs, ys
  n     = xs.size
  xys   = xs.zip(ys)
  slnx2 = sigma(xys) { |x, _| Math.log(x) ** 2 }
  slnx  = sigma(xys) { |x, _| Math.log(x)      }
  sylnx = sigma(xys) { |x, y| y * Math.log(x)  }
  sy    = sigma(xys) { |_, y| y                }

  c = n * slnx2 - slnx ** 2
  b = ( n * sylnx - sy * slnx ) / c
  a = (sy - b * slnx) / n

  return a, b, fit_error(xys) { |x| a + b * Math.log(x) }
end</pre> </div> <p>To fit a functional form: y = a + b*ln(x).</p> <p>Takes x and y values and returns [a, b, r^2].</p> <p>See: <a href="http://mathworld.wolfram.com/LeastSquaresFittingLogarithmic.html">mathworld.wolfram.com/LeastSquaresFittingLogarithmic.html</a></p>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-fit_power"> <span class="method-name">fit_power</span><span class="method-args">(xs, ys)</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="fit_power-source"> <pre class="ruby" data-language="ruby"># File lib/minitest/benchmark.rb, line 303
def fit_power xs, ys
  n       = xs.size
  xys     = xs.zip(ys)
  slnxlny = sigma(xys) { |x, y| Math.log(x) * Math.log(y) }
  slnx    = sigma(xs)  { |x   | Math.log(x)               }
  slny    = sigma(ys)  { |   y| Math.log(y)               }
  slnx2   = sigma(xs)  { |x   | Math.log(x) ** 2          }

  b = (n * slnxlny - slnx * slny) / (n * slnx2 - slnx ** 2)
  a = (slny - b * slnx) / n

  return Math.exp(a), b, fit_error(xys) { |x| (Math.exp(a) * (x ** b)) }
end</pre> </div> <p>To fit a functional form: y = ax^b.</p> <p>Takes x and y values and returns [a, b, r^2].</p> <p>See: <a href="http://mathworld.wolfram.com/LeastSquaresFittingPowerLaw.html">mathworld.wolfram.com/LeastSquaresFittingPowerLaw.html</a></p>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-sigma"> <span class="method-name">sigma</span><span class="method-args">(enum, &amp;block)</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="sigma-source"> <pre class="ruby" data-language="ruby"># File lib/minitest/benchmark.rb, line 324
def sigma enum, &amp;block
  enum = enum.map(&amp;block) if block
  enum.inject { |sum, n| sum + n }
end</pre> </div> <p>Enumerates over <code>enum</code> mapping <code>block</code> if given, returning the sum of the result. Eg:</p> <pre class="ruby" data-language="ruby">sigma([1, 2, 3])                # =&gt; 1 + 2 + 3 =&gt; 6
sigma([1, 2, 3]) { |n| n ** 2 } # =&gt; 1 + 4 + 9 =&gt; 14
</pre>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-validation_for_fit"> <span class="method-name">validation_for_fit</span><span class="method-args">(msg, threshold)</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="validation_for_fit-source"> <pre class="ruby" data-language="ruby"># File lib/minitest/benchmark.rb, line 333
def validation_for_fit msg, threshold
  proc do |range, times|
    a, b, rr = send "fit_#{msg}", range, times
    assert_operator rr, :&gt;=, threshold
    [a, b, rr]
  end
end</pre> </div> <p>Returns a proc that calls the specified fit method and asserts that the error is within a tolerable threshold.</p>  </div> </div> </section> </section><div class="_attribution">
  <p class="_attribution-p">
    © Ryan Davis, seattle.rb<br>Licensed under the MIT License.<br>
    
  </p>
</div>

				
			</div>
			<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-2572770204602497"
     data-ad-slot="1992473792"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
		</div>
	</section>

	</div>
	<svg style="display:none">
		<symbol id="icon-dir"><svg viewBox="0 0 20 20"><path d="M15 10c0 .3-.305.515-.305.515l-8.56 5.303c-.625.41-1.135.106-1.135-.67V4.853c0-.777.51-1.078 1.135-.67l8.56 5.305S15 9.702 15 10z"/></svg></symbol>
	  </svg>
</body>
</html>
