
<!DOCTYPE HTML>

<html lang="en" class="_theme-default">

<head>
  <meta charset="utf-8">
  <title>ActiveRecord&#58;&#58;Encryption&#58;&#58;EncryptableRecord - Ruby on Rails 7.0 - W3cubDocs</title>
  
  <meta name="description" content="This is the concern mixed in Active Record models to make them encryptable. It adds the encrypts attribute declaration, as well as the API to &hellip;">
  <meta name="keywords" content="module, activerecord, encryption, encryptablerecord, ruby, on, rails, rails~7.0">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="mobile-web-app-capable" content="yes">
  
  <link rel="canonical" href="https://docs.w3cub.com/rails~7.0/activerecord/encryption/encryptablerecord.html">
  <link href="/favicon.png" rel="icon">
  <link rel="stylesheet" type="text/css" href="/assets/application-e498cd0ebe8746846fec95b1a53ab3bb0fb7f47f794f0a38f44c98a1f0d03b21d777ae2c583732e44a5a890f6eacb79a5333545db9d5f3616091ba21ca17d916.css">
  <script src="/assets/application-79c555f6b25481fffac2cac30a7f3e54e608ca09e9e8e42bb1790095ba6d0fcace47d6bc624ddce952c70370892f2d46864f89e6943d4f7f7ff16c8a3231a91a.js" type="text/javascript"></script>
  <script src="/json/rails~7.0.js"></script>
  
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-R3WC07G3GB"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-R3WC07G3GB');
</script>
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2572770204602497"
     crossorigin="anonymous"></script>
<script async custom-element="amp-auto-ads"
  src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
</script>


</head>

<body class="docs">
	<amp-auto-ads type="adsense"
              data-ad-client="ca-pub-2572770204602497">
	</amp-auto-ads>
	<div class="_app">
	<header class="_header">

  <a class="_home-link" href="/" ></a>
  <a class="_menu-link"></a>
  <h1 class="_logo">
    <a href="/" class="_nav-link" title="API Documentation Browser">W3cubDocs</a>
  </h1>
  
  <span class="_logo-sub-nav">/</span><span class="_logo-sub-nav"><a href="/rails~7.0/" class="_nav-link" title="" style="margin-left:0;">Ruby on Rails 7.0</a></span>
  
  <nav class="_nav">
    <a href="https://tools.w3cub.com/?_sp=docs" target="_blank" class="_nav-link ">W3cubTools</a>
    <a href="/cheatsheets/" class="_nav-link ">Cheatsheets</a>
    <a href="/about/" class="_nav-link ">About</a>
  </nav>
</header>
	<section class="_sidebar">
		
		<form class="_search">
		  <input type="search" class="_search-input" placeholder="Search&hellip;" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" maxlength="20">
		  <a class="_search-clear"></a>
		  <div class="_search-tag"></div>
		</form>
		
		<div class="_list-wrap">
			<div class="_list">
			
			</div>
		</div>
	</section>
	<section class="_container ">
		<div class="_content">
			<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-2572770204602497"
     data-ad-slot="6861657091"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
			<div class="_page _rdoc">
				
				
<h1 id="module-ActiveRecord::Encryption::EncryptableRecord" class="module"> module ActiveRecord::Encryption::EncryptableRecord </h1> <section class="description"> <p>This is the concern mixed in Active Record models to make them encryptable. It adds the <code>encrypts</code> attribute declaration, as well as the API to encrypt and decrypt records.</p> </section> <section id="5Buntitled-5D" class="documentation-section"> <section class="constants-list"> <header> <h3>Constants</h3> </header> <dl> <dt id="ORIGINAL_ATTRIBUTE_PREFIX">ORIGINAL_ATTRIBUTE_PREFIX </dt>

</dl> </section> <section id="public-instance-5Buntitled-5D-method-details" class="method-section"> <header> <h3>Public Instance Methods</h3> </header> <div class="method-detail "> <div class="method-heading" id="method-i-add_length_validation_for_encrypted_columns"> <span class="method-name">add_length_validation_for_encrypted_columns</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="add_length_validation_for_encrypted_columns-source"> <pre class="ruby" data-language="ruby"># File activerecord/lib/active_record/encryption/encryptable_record.rb, line 129
def add_length_validation_for_encrypted_columns
  encrypted_attributes&amp;.each do |attribute_name|
    validate_column_size attribute_name
  end
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-ciphertext_for"> <span class="method-name">ciphertext_for</span><span class="method-args">(attribute_name)</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="ciphertext_for-source"> <pre class="ruby" data-language="ruby"># File activerecord/lib/active_record/encryption/encryptable_record.rb, line 148
def ciphertext_for(attribute_name)
  read_attribute_before_type_cast(attribute_name)
end</pre> </div> <p>Returns the ciphertext for <code>attribute_name</code>.</p>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-decrypt"> <span class="method-name">decrypt</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="decrypt-source"> <pre class="ruby" data-language="ruby"># File activerecord/lib/active_record/encryption/encryptable_record.rb, line 158
def decrypt
  decrypt_attributes if has_encrypted_attributes?
end</pre> </div> <p>Decrypts all the encryptable attributes and saves the changes.</p>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-deterministic_encrypted_attributes"> <span class="method-name">deterministic_encrypted_attributes</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="deterministic_encrypted_attributes-source"> <pre class="ruby" data-language="ruby"># File activerecord/lib/active_record/encryption/encryptable_record.rb, line 58
def deterministic_encrypted_attributes
  @deterministic_encrypted_attributes ||= encrypted_attributes&amp;.find_all do |attribute_name|
    type_for_attribute(attribute_name).deterministic?
  end
end</pre> </div> <p>Returns the list of deterministic encryptable attributes in the model class.</p>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-encrypt"> <span class="method-name">encrypt</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="encrypt-source"> <pre class="ruby" data-language="ruby"># File activerecord/lib/active_record/encryption/encryptable_record.rb, line 153
def encrypt
  encrypt_attributes if has_encrypted_attributes?
end</pre> </div> <p>Encrypts all the encryptable attributes and saves the changes.</p>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-encrypt_attribute"> <span class="method-name">encrypt_attribute</span><span class="method-args">(name, attribute_scheme)</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="encrypt_attribute-source"> <pre class="ruby" data-language="ruby"># File activerecord/lib/active_record/encryption/encryptable_record.rb, line 84
def encrypt_attribute(name, attribute_scheme)
  encrypted_attributes &lt;&lt; name.to_sym

  attribute name do |cast_type|
    ActiveRecord::Encryption::EncryptedAttributeType.new scheme: attribute_scheme, cast_type: cast_type
  end

  preserve_original_encrypted(name) if attribute_scheme.ignore_case?
  ActiveRecord::Encryption.encrypted_attribute_was_declared(self, name)
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-encrypted_attribute-3F"> <span class="method-name">encrypted_attribute?</span><span class="method-args">(attribute_name)</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="encrypted_attribute-3F-source"> <pre class="ruby" data-language="ruby"># File activerecord/lib/active_record/encryption/encryptable_record.rb, line 143
def encrypted_attribute?(attribute_name)
  ActiveRecord::Encryption.encryptor.encrypted? ciphertext_for(attribute_name)
end</pre> </div> <p>Returns whether a given attribute is encrypted or not.</p>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-encrypts"> <span class="method-name">encrypts</span><span class="method-args">(*names, key_provider: nil, key: nil, deterministic: false, downcase: false, ignore_case: false, previous: [], **context_properties)</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="encrypts-source"> <pre class="ruby" data-language="ruby"># File activerecord/lib/active_record/encryption/encryptable_record.rb, line 47
def encrypts(*names, key_provider: nil, key: nil, deterministic: false, downcase: false, ignore_case: false, previous: [], **context_properties)
  self.encrypted_attributes ||= Set.new # not using :default because the instance would be shared across classes
  scheme = scheme_for key_provider: key_provider, key: key, deterministic: deterministic, downcase: downcase, \
      ignore_case: ignore_case, previous: previous, **context_properties

  names.each do |name|
    encrypt_attribute name, scheme
  end
end</pre> </div> <p>Encrypts the <code>name</code> attribute.</p> <h3 id="method-i-encrypts-label-Options">Options</h3> <ul>
<li> <p><code>:key_provider</code> - Configure a <code>KeyProvider</code> for serving the keys to encrypt and decrypt this attribute. If not provided, it will default to <code>ActiveRecord::Encryption.key_provider</code>.</p> </li>
<li> <p><code>:key</code> - A password to derive the key from. It's a shorthand for a <code>:key_provider</code> that serves derivated keys. Both options can't be used at the same time.</p> </li>
<li> <p><code>:key_provider</code> - Set a <code>:key_provider</code> to provide encryption and decryption keys. If not provided, it will default to the key provider set with `config.key_provider`.</p> </li>
<li> <p><code>:deterministic</code> - By default, encryption is not deterministic. It will use a random initialization vector for each encryption operation. This means that encrypting the same content with the same key twice will generate different ciphertexts. When set to <code>true</code>, it will generate the initialization vector based on the encrypted content. This means that the same content will generate the same ciphertexts. This enables querying encrypted text with Active Record. Deterministic encryption will use the oldest encryption scheme to encrypt new data by default. You can change this by setting +deterministic: { fixed: false }+. That will make it use the newest encryption scheme for encrypting new data.</p> </li>
<li> <p><code>:downcase</code> - When true, it converts the encrypted content to downcase automatically. This allows to effectively ignore case when querying data. Notice that the case is lost. Use <code>:ignore_case</code> if you are interested in preserving it.</p> </li>
<li> <p><code>:ignore_case</code> - When true, it behaves like <code>:downcase</code> but, it also preserves the original case in a specially designated column +original_&lt;name&gt;+. When reading the encrypted content, the version with the original case is served. But you can still execute queries that will ignore the case. This option can only be used when <code>:deterministic</code> is true.</p> </li>
<li> <p><code>:context_properties</code> - Additional properties that will override <code>Context</code> settings when this attribute is encrypted and decrypted. E.g: <code>encryptor:</code>, <code>cipher:</code>, <code>message_serializer:</code>, etc.</p> </li>
<li> <p><code>:previous</code> - List of previous encryption schemes. When provided, they will be used in order when trying to read the attribute. Each entry of the list can contain the properties supported by <a href="encryptablerecord#method-i-encrypts"><code>encrypts</code></a>. Also, when deterministic encryption is used, they will be used to generate additional ciphertexts to check in the queries.</p> </li>
</ul>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-global_previous_schemes_for"> <span class="method-name">global_previous_schemes_for</span><span class="method-args">(scheme)</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="global_previous_schemes_for-source"> <pre class="ruby" data-language="ruby"># File activerecord/lib/active_record/encryption/encryptable_record.rb, line 78
def global_previous_schemes_for(scheme)
  ActiveRecord::Encryption.config.previous_schemes.collect do |previous_scheme|
    scheme.merge(previous_scheme)
  end
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-load_schema-21"> <span class="method-name">load_schema!</span><span class="method-args">()</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="load_schema-21-source"> <pre class="ruby" data-language="ruby"># File activerecord/lib/active_record/encryption/encryptable_record.rb, line 123
def load_schema!
  super

  add_length_validation_for_encrypted_columns if ActiveRecord::Encryption.config.validate_column_size
end</pre> </div> <div class="method-calls-super"> Calls superclass method </div>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-override_accessors_to_preserve_original"> <span class="method-name">override_accessors_to_preserve_original</span><span class="method-args">(name, original_attribute_name)</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="override_accessors_to_preserve_original-source"> <pre class="ruby" data-language="ruby"># File activerecord/lib/active_record/encryption/encryptable_record.rb, line 106
def override_accessors_to_preserve_original(name, original_attribute_name)
  include(Module.new do
    define_method name do
      if ((value = super()) &amp;&amp; encrypted_attribute?(name)) || !ActiveRecord::Encryption.config.support_unencrypted_data
        send(original_attribute_name)
      else
        value
      end
    end

    define_method "#{name}=" do |value|
      self.send "#{original_attribute_name}=", value
      super(value)
    end
  end)
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-preserve_original_encrypted"> <span class="method-name">preserve_original_encrypted</span><span class="method-args">(name)</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="preserve_original_encrypted-source"> <pre class="ruby" data-language="ruby"># File activerecord/lib/active_record/encryption/encryptable_record.rb, line 95
def preserve_original_encrypted(name)
  original_attribute_name = "#{ORIGINAL_ATTRIBUTE_PREFIX}#{name}".to_sym

  if !ActiveRecord::Encryption.config.support_unencrypted_data &amp;&amp; !column_names.include?(original_attribute_name.to_s)
    raise Errors::Configuration, "To use :ignore_case for '#{name}' you must create an additional column named '#{original_attribute_name}'"
  end

  encrypts original_attribute_name
  override_accessors_to_preserve_original name, original_attribute_name
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-scheme_for"> <span class="method-name">scheme_for</span><span class="method-args">(key_provider: nil, key: nil, deterministic: false, downcase: false, ignore_case: false, previous: [], **context_properties)</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="scheme_for-source"> <pre class="ruby" data-language="ruby"># File activerecord/lib/active_record/encryption/encryptable_record.rb, line 70
def scheme_for(key_provider: nil, key: nil, deterministic: false, downcase: false, ignore_case: false, previous: [], **context_properties)
  ActiveRecord::Encryption::Scheme.new(key_provider: key_provider, key: key, deterministic: deterministic,
                                       downcase: downcase, ignore_case: ignore_case, **context_properties).tap do |scheme|
    scheme.previous_schemes = global_previous_schemes_for(scheme) +
      Array.wrap(previous).collect { |scheme_config| ActiveRecord::Encryption::Scheme.new(**scheme_config) }
  end
end</pre> </div>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-source_attribute_from_preserved_attribute"> <span class="method-name">source_attribute_from_preserved_attribute</span><span class="method-args">(attribute_name)</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="source_attribute_from_preserved_attribute-source"> <pre class="ruby" data-language="ruby"># File activerecord/lib/active_record/encryption/encryptable_record.rb, line 65
def source_attribute_from_preserved_attribute(attribute_name)
  attribute_name.to_s.sub(ORIGINAL_ATTRIBUTE_PREFIX, "") if /^#{ORIGINAL_ATTRIBUTE_PREFIX}/.match?(attribute_name)
end</pre> </div> <p>Given a attribute name, it returns the name of the source attribute when it's a preserved one.</p>  </div> </div> <div class="method-detail "> <div class="method-heading" id="method-i-validate_column_size"> <span class="method-name">validate_column_size</span><span class="method-args">(attribute_name)</span> <a class="method-click-advice">Show source</a> </div> <div class="method-description">
<div class="method-source-code" id="validate_column_size-source"> <pre class="ruby" data-language="ruby"># File activerecord/lib/active_record/encryption/encryptable_record.rb, line 135
def validate_column_size(attribute_name)
  if limit = columns_hash[attribute_name.to_s]&amp;.limit
    validates_length_of attribute_name, maximum: limit
  end
end</pre> </div>  </div> </div> </section> </section><div class="_attribution">
  <p class="_attribution-p">
    © 2004–2021 David Heinemeier Hansson<br>Licensed under the MIT License.<br>
    
  </p>
</div>

				
			</div>
			<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-2572770204602497"
     data-ad-slot="1992473792"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
		</div>
	</section>

	</div>
	<svg style="display:none">
		<symbol id="icon-dir"><svg viewBox="0 0 20 20"><path d="M15 10c0 .3-.305.515-.305.515l-8.56 5.303c-.625.41-1.135.106-1.135-.67V4.853c0-.777.51-1.078 1.135-.67l8.56 5.305S15 9.702 15 10z"/></svg></symbol>
	  </svg>
</body>
</html>
