
<!DOCTYPE HTML>

<html lang="en" class="_theme-default">

<head>
  <meta charset="utf-8">
  <title>Versions in CustomResourceDefinitions - Kubernetes - W3cubDocs</title>
  
  <meta name="description" content="This page explains how to add versioning information to CustomResourceDefinitions, to indicate the stability level of your CustomResourceDefinitions &hellip;">
  <meta name="keywords" content="versions, customresourcedefinitions, kubernetes">
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="mobile-web-app-capable" content="yes">
  
  <link rel="canonical" href="https://docs.w3cub.com/kubernetes/tasks/extend-kubernetes/custom-resources/custom-resource-definition-versioning/">
  <link href="/favicon.png" rel="icon">
  <link rel="stylesheet" type="text/css" href="/assets/application-60a6449bb52e9968d95c133a29f066ffcb8dbe4f077d4022e51c991ce30bf256c8e19c508207a4193c414ffd0414826564317669b0f27f9f85c1cb21b84e097e.css">
  <script src="/assets/application-d9be6f56a823612443fc15b2e027a630e02c4ad2685bb750d13fa4fae28d46c3e7f7ebb69bd4bafddf116f218f9372e9be44021d4247dc20424e2fd1ff8cef81.js" type="text/javascript"></script>
  <script src="/json/kubernetes.js"></script>
  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-71174418-1']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>
  <script data-ad-client="ca-pub-2572770204602497" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
  <script async custom-element="amp-auto-ads"
  src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
</script>


</head>

<body class="docs">
	<amp-auto-ads type="adsense"
              data-ad-client="ca-pub-2572770204602497">
	</amp-auto-ads>
	<div class="_app">
	<header class="_header">

  <a class="_home-link" href="/" ></a>
  <a class="_menu-link"></a>
  <h1 class="_logo">
    <a href="/" class="_nav-link" title="API Documentation Browser">W3cubDocs</a>
  </h1>
  
  <span class="_logo-sub-nav">/</span><span class="_logo-sub-nav"><a href="/kubernetes/" class="_nav-link" title="" style="margin-left:0;">Kubernetes</a></span>
  
  <nav class="_nav">
    <a href="https://tools.w3cub.com/?_sp=docs" target="_blank" class="_nav-link ">W3cubTools</a>
    <a href="/cheatsheets/" class="_nav-link ">Cheatsheets</a>
    <a href="/about/" class="_nav-link ">About</a>
  </nav>
</header>
	<section class="_sidebar">
		
		<form class="_search">
		  <input type="search" class="_search-input" placeholder="Search&hellip;" autocomplete="off" autocapitalize="off" autocorrect="off" spellcheck="false" maxlength="20">
		  <a class="_search-clear"></a>
		  <div class="_search-tag"></div>
		</form>
		
		<div class="_list-wrap">
			<div class="_list">
			
			</div>
		</div>
	</section>
	<section class="_container ">
		<div class="_content">
			<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-2572770204602497"
     data-ad-slot="6861657091"
     data-ad-format="link"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
			<div class="_page _kubernetes">
				
				
<h1>Versions in CustomResourceDefinitions</h1>  <p>This page explains how to add versioning information to <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.23/#customresourcedefinition-v1beta1-apiextensions">CustomResourceDefinitions</a>, to indicate the stability level of your CustomResourceDefinitions or advance your API to a new version with conversion between API representations. It also describes how to upgrade an object from one version to another.</p> <h2 id="before-you-begin">Before you begin</h2> <p>You need to have a Kubernetes cluster, and the kubectl command-line tool must be configured to communicate with your cluster. It is recommended to run this tutorial on a cluster with at least two nodes that are not acting as control plane hosts. If you do not already have a cluster, you can create one by using <a href="https://minikube.sigs.k8s.io/docs/tutorials/multi_node/">minikube</a> or you can use one of these Kubernetes playgrounds:</p> <ul> <li><a href="https://www.katacoda.com/courses/kubernetes/playground">Katacoda</a></li> <li><a href="http://labs.play-with-k8s.com/">Play with Kubernetes</a></li> </ul> <p>You should have a initial understanding of <a href="../../../../concepts/extend-kubernetes/api-extension/custom-resources/index">custom resources</a>.</p> Your Kubernetes server must be at or later than version v1.16. To check the version, enter <code>kubectl version</code>.  <h2 id="overview">Overview</h2> <p>The CustomResourceDefinition API provides a workflow for introducing and upgrading to new versions of a CustomResourceDefinition.</p> <p>When a CustomResourceDefinition is created, the first version is set in the CustomResourceDefinition <code>spec.versions</code> list to an appropriate stability level and a version number. For example <code>v1beta1</code> would indicate that the first version is not yet stable. All custom resource objects will initially be stored at this version.</p> <p>Once the CustomResourceDefinition is created, clients may begin using the <code>v1beta1</code> API.</p> <p>Later it might be necessary to add new version such as <code>v1</code>.</p> <p>Adding a new version:</p> <ol> <li>Pick a conversion strategy. Since custom resource objects need to be able to be served at both versions, that means they will sometimes be served at a different version than their storage version. In order for this to be possible, the custom resource objects must sometimes be converted between the version they are stored at and the version they are served at. If the conversion involves schema changes and requires custom logic, a conversion webhook should be used. If there are no schema changes, the default <code>None</code> conversion strategy may be used and only the <code>apiVersion</code> field will be modified when serving different versions.</li> <li>If using conversion webhooks, create and deploy the conversion webhook. See the <a href="#webhook-conversion">Webhook conversion</a> for more details.</li> <li>Update the CustomResourceDefinition to include the new version in the <code>spec.versions</code> list with <code>served:true</code>. Also, set <code>spec.conversion</code> field to the selected conversion strategy. If using a conversion webhook, configure <code>spec.conversion.webhookClientConfig</code> field to call the webhook.</li> </ol> <p>Once the new version is added, clients may incrementally migrate to the new version. It is perfectly safe for some clients to use the old version while others use the new version.</p> <p>Migrate stored objects to the new version:</p> <ol> <li>See the <a href="#upgrade-existing-objects-to-a-new-stored-version">upgrade existing objects to a new stored version</a> section.</li> </ol> <p>It is safe for clients to use both the old and new version before, during and after upgrading the objects to a new stored version.</p> <p>Removing an old version:</p> <ol> <li>Ensure all clients are fully migrated to the new version. The kube-apiserver logs can be reviewed to help identify any clients that are still accessing via the old version.</li> <li>Set <code>served</code> to <code>false</code> for the old version in the <code>spec.versions</code> list. If any clients are still unexpectedly using the old version they may begin reporting errors attempting to access the custom resource objects at the old version. If this occurs, switch back to using <code>served:true</code> on the old version, migrate the remaining clients to the new version and repeat this step.</li> <li>Ensure the <a href="#upgrade-existing-objects-to-a-new-stored-version">upgrade of existing objects to the new stored version</a> step has been completed. <ol> <li>Verify that the <code>storage</code> is set to <code>true</code> for the new version in the <code>spec.versions</code> list in the CustomResourceDefinition.</li> <li>Verify that the old version is no longer listed in the CustomResourceDefinition <code>status.storedVersions</code>.</li> </ol> </li> <li>Remove the old version from the CustomResourceDefinition <code>spec.versions</code> list.</li> <li>Drop conversion support for the old version in conversion webhooks.</li> </ol> <h2 id="specify-multiple-versions">Specify multiple versions</h2> <p>The CustomResourceDefinition API <code>versions</code> field can be used to support multiple versions of custom resources that you have developed. Versions can have different schemas, and conversion webhooks can convert custom resources between versions. Webhook conversions should follow the <a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api-conventions.md">Kubernetes API conventions</a> wherever applicable. Specifically, See the <a href="https://github.com/kubernetes/community/blob/master/contributors/devel/sig-architecture/api_changes.md">API change documentation</a> for a set of useful gotchas and suggestions.</p> <div class="alert alert-info note callout" role="alert"> <strong>Note:</strong> In <code>apiextensions.k8s.io/v1beta1</code>, there was a <code>version</code> field instead of <code>versions</code>. The <code>version</code> field is deprecated and optional, but if it is not empty, it must match the first item in the <code>versions</code> field. </div> <p>This example shows a CustomResourceDefinition with two versions. For the first example, the assumption is all versions share the same schema with no conversion between them. The comments in the YAML provide more context.</p> <ul class="nav nav-tabs" id="customresourcedefinition-versioning-example-1" role="tablist">
<li class="nav-item"><a data-toggle="tab" class="nav-link active" href="#customresourcedefinition-versioning-example-1-0" role="tab" aria-controls="customresourcedefinition-versioning-example-1-0" aria-selected="true">apiextensions.k8s.io/v1</a></li> <li class="nav-item"><a data-toggle="tab" class="nav-link" href="#customresourcedefinition-versioning-example-1-1" role="tab" aria-controls="customresourcedefinition-versioning-example-1-1">apiextensions.k8s.io/v1beta1</a></li>
</ul> <div class="tab-content" id="customresourcedefinition-versioning-example-1">
<div id="customresourcedefinition-versioning-example-1-0" class="tab-pane show active" role="tabpanel" aria-labelledby="customresourcedefinition-versioning-example-1-0"> 
<pre class="highlight" data-language="yaml">apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  # name must match the spec fields below, and be in the form: &lt;plural&gt;.&lt;group&gt;
  name: crontabs.example.com
spec:
  # group name to use for REST API: /apis/&lt;group&gt;/&lt;version&gt;
  group: example.com
  # list of versions supported by this CustomResourceDefinition
  versions:
  - name: v1beta1
    # Each version can be enabled/disabled by Served flag.
    served: true
    # One and only one version must be marked as the storage version.
    storage: true
    # A schema is required
    schema:
      openAPIV3Schema:
        type: object
        properties:
          host:
            type: string
          port:
            type: string
  - name: v1
    served: true
    storage: false
    schema:
      openAPIV3Schema:
        type: object
        properties:
          host:
            type: string
          port:
            type: string
  # The conversion section is introduced in Kubernetes 1.13+ with a default value of
  # None conversion (strategy sub-field set to None).
  conversion:
    # None conversion assumes the same schema for all versions and only sets the apiVersion
    # field of custom resources to the proper value
    strategy: None
  # either Namespaced or Cluster
  scope: Namespaced
  names:
    # plural name to be used in the URL: /apis/&lt;group&gt;/&lt;version&gt;/&lt;plural&gt;
    plural: crontabs
    # singular name to be used as an alias on the CLI and for display
    singular: crontab
    # kind is normally the CamelCased singular type. Your resource manifests use this.
    kind: CronTab
    # shortNames allow shorter string to match your resource on the CLI
    shortNames:
    - ct
</pre>
</div> <div id="customresourcedefinition-versioning-example-1-1" class="tab-pane" role="tabpanel" aria-labelledby="customresourcedefinition-versioning-example-1-1"> 
<pre class="highlight" data-language="yaml"># Deprecated in v1.16 in favor of apiextensions.k8s.io/v1
apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  # name must match the spec fields below, and be in the form: &lt;plural&gt;.&lt;group&gt;
  name: crontabs.example.com
spec:
  # group name to use for REST API: /apis/&lt;group&gt;/&lt;version&gt;
  group: example.com
  # list of versions supported by this CustomResourceDefinition
  versions:
  - name: v1beta1
    # Each version can be enabled/disabled by Served flag.
    served: true
    # One and only one version must be marked as the storage version.
    storage: true
  - name: v1
    served: true
    storage: false
  validation:
    openAPIV3Schema:
      type: object
      properties:
        host:
          type: string
        port:
          type: string
  # The conversion section is introduced in Kubernetes 1.13+ with a default value of
  # None conversion (strategy sub-field set to None).
  conversion:
    # None conversion assumes the same schema for all versions and only sets the apiVersion
    # field of custom resources to the proper value
    strategy: None
  # either Namespaced or Cluster
  scope: Namespaced
  names:
    # plural name to be used in the URL: /apis/&lt;group&gt;/&lt;version&gt;/&lt;plural&gt;
    plural: crontabs
    # singular name to be used as an alias on the CLI and for display
    singular: crontab
    # kind is normally the PascalCased singular type. Your resource manifests use this.
    kind: CronTab
    # shortNames allow shorter string to match your resource on the CLI
    shortNames:
    - ct
</pre>
</div>
</div> <p>You can save the CustomResourceDefinition in a YAML file, then use <code>kubectl apply</code> to create it.</p> <pre class="highlight" data-language="shell">kubectl apply -f my-versioned-crontab.yaml
</pre>
<p>After creation, the API server starts to serve each enabled version at an HTTP REST endpoint. In the above example, the API versions are available at <code>/apis/example.com/v1beta1</code> and <code>/apis/example.com/v1</code>.</p> <h3 id="version-priority">Version priority</h3> <p>Regardless of the order in which versions are defined in a CustomResourceDefinition, the version with the highest priority is used by kubectl as the default version to access objects. The priority is determined by parsing the <em>name</em> field to determine the version number, the stability (GA, Beta, or Alpha), and the sequence within that stability level.</p> <p>The algorithm used for sorting the versions is designed to sort versions in the same way that the Kubernetes project sorts Kubernetes versions. Versions start with a <code>v</code> followed by a number, an optional <code>beta</code> or <code>alpha</code> designation, and optional additional numeric versioning information. Broadly, a version string might look like <code>v2</code> or <code>v2beta1</code>. Versions are sorted using the following algorithm:</p> <ul> <li>Entries that follow Kubernetes version patterns are sorted before those that do not.</li> <li>For entries that follow Kubernetes version patterns, the numeric portions of the version string is sorted largest to smallest.</li> <li>If the strings <code>beta</code> or <code>alpha</code> follow the first numeric portion, they sorted in that order, after the equivalent string without the <code>beta</code> or <code>alpha</code> suffix (which is presumed to be the GA version).</li> <li>If another number follows the <code>beta</code>, or <code>alpha</code>, those numbers are also sorted from largest to smallest.</li> <li>Strings that don't fit the above format are sorted alphabetically and the numeric portions are not treated specially. Notice that in the example below, <code>foo1</code> is sorted above <code>foo10</code>. This is different from the sorting of the numeric portion of entries that do follow the Kubernetes version patterns.</li> </ul> <p>This might make sense if you look at the following sorted version list:</p> <pre><code class="language-none" data-lang="none">- v10
- v2
- v1
- v11beta2
- v10beta3
- v3beta1
- v12alpha1
- v11alpha2
- foo1
- foo10
</code></pre>
<p>For the example in <a href="#specify-multiple-versions">Specify multiple versions</a>, the version sort order is <code>v1</code>, followed by <code>v1beta1</code>. This causes the kubectl command to use <code>v1</code> as the default version unless the provided object specifies the version.</p> <h3 id="version-deprecation">Version deprecation</h3> <div style="margin-top: 10px; margin-bottom: 10px;"> <b>FEATURE STATE:</b> <code>Kubernetes v1.19 [stable]</code> </div> <p>Starting in v1.19, a CustomResourceDefinition can indicate a particular version of the resource it defines is deprecated. When API requests to a deprecated version of that resource are made, a warning message is returned in the API response as a header. The warning message for each deprecated version of the resource can be customized if desired.</p> <p>A customized warning message should indicate the deprecated API group, version, and kind, and should indicate what API group, version, and kind should be used instead, if applicable.</p> <ul class="nav nav-tabs" id="customresourcedefinition-versioning-deprecated" role="tablist">
<li class="nav-item"><a data-toggle="tab" class="nav-link active" href="#customresourcedefinition-versioning-deprecated-0" role="tab" aria-controls="customresourcedefinition-versioning-deprecated-0" aria-selected="true">apiextensions.k8s.io/v1</a></li> <li class="nav-item"><a data-toggle="tab" class="nav-link" href="#customresourcedefinition-versioning-deprecated-1" role="tab" aria-controls="customresourcedefinition-versioning-deprecated-1">apiextensions.k8s.io/v1beta1</a></li>
</ul> <div class="tab-content" id="customresourcedefinition-versioning-deprecated">
<div id="customresourcedefinition-versioning-deprecated-0" class="tab-pane show active" role="tabpanel" aria-labelledby="customresourcedefinition-versioning-deprecated-0"> 
<pre class="highlight" data-language="yaml">apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
  name: crontabs.example.com
spec:
  group: example.com
  names:
    plural: crontabs
    singular: crontab
    kind: CronTab
  scope: Namespaced
  versions:
  - name: v1alpha1
    served: true
    # This indicates the v1alpha1 version of the custom resource is deprecated.
    # API requests to this version receive a warning header in the server response.
    deprecated: true
    # This overrides the default warning returned to API clients making v1alpha1 API requests.
    deprecationWarning: "example.com/v1alpha1 CronTab is deprecated; see http://example.com/v1alpha1-v1 for instructions to migrate to example.com/v1 CronTab"
    schema: ...
  - name: v1beta1
    served: true
    # This indicates the v1beta1 version of the custom resource is deprecated.
    # API requests to this version receive a warning header in the server response.
    # A default warning message is returned for this version.
    deprecated: true
    schema: ...
  - name: v1
    served: true
    storage: true
    schema: ...
</pre>
</div> <div id="customresourcedefinition-versioning-deprecated-1" class="tab-pane" role="tabpanel" aria-labelledby="customresourcedefinition-versioning-deprecated-1"> 
<pre class="highlight" data-language="yaml"># Deprecated in v1.16 in favor of apiextensions.k8s.io/v1
apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  name: crontabs.example.com
spec:
  group: example.com
  names:
    plural: crontabs
    singular: crontab
    kind: CronTab
  scope: Namespaced
  validation: ...
  versions:
  - name: v1alpha1
    served: true
    # This indicates the v1alpha1 version of the custom resource is deprecated.
    # API requests to this version receive a warning header in the server response.
    deprecated: true
    # This overrides the default warning returned to API clients making v1alpha1 API requests.
    deprecationWarning: "example.com/v1alpha1 CronTab is deprecated; see http://example.com/v1alpha1-v1 for instructions to migrate to example.com/v1 CronTab"
  - name: v1beta1
    served: true
    # This indicates the v1beta1 version of the custom resource is deprecated.
    # API requests to this version receive a warning header in the server response.
    # A default warning message is returned for this version.
    deprecated: true
  - name: v1
    served: true
    storage: true
</pre>
</div>
</div> <h2 id="webhook-conversion">Webhook conversion</h2> <div style="margin-top: 10px; margin-bottom: 10px;"> <b>FEATURE STATE:</b> <code>Kubernetes v1.16 [stable]</code> </div> <div class="alert alert-info note callout" role="alert"> <strong>Note:</strong> Webhook conversion is available as beta since 1.15, and as alpha since Kubernetes 1.13. The <code>CustomResourceWebhookConversion</code> feature must be enabled, which is the case automatically for many clusters for beta features. Please refer to the <a href="../../../../reference/command-line-tools-reference/feature-gates/index">feature gate</a> documentation for more information. </div> <p>The above example has a None conversion between versions which only sets the <code>apiVersion</code> field on conversion and does not change the rest of the object. The API server also supports webhook conversions that call an external service in case a conversion is required. For example when:</p> <ul> <li>custom resource is requested in a different version than stored version.</li> <li>Watch is created in one version but the changed object is stored in another version.</li> <li>custom resource PUT request is in a different version than storage version.</li> </ul> <p>To cover all of these cases and to optimize conversion by the API server, the conversion requests may contain multiple objects in order to minimize the external calls. The webhook should perform these conversions independently.</p> <h3 id="write-a-conversion-webhook-server">Write a conversion webhook server</h3> <p>Please refer to the implementation of the <a href="https://github.com/kubernetes/kubernetes/tree/v1.15.0/test/images/crd-conversion-webhook/main.go">custom resource conversion webhook server</a> that is validated in a Kubernetes e2e test. The webhook handles the <code>ConversionReview</code> requests sent by the API servers, and sends back conversion results wrapped in <code>ConversionResponse</code>. Note that the request contains a list of custom resources that need to be converted independently without changing the order of objects. The example server is organized in a way to be reused for other conversions. Most of the common code are located in the <a href="https://github.com/kubernetes/kubernetes/tree/v1.15.0/test/images/crd-conversion-webhook/converter/framework.go">framework file</a> that leaves only <a href="https://github.com/kubernetes/kubernetes/blob/v1.15.0/test/images/crd-conversion-webhook/converter/example_converter.go#L29-L80">one function</a> to be implemented for different conversions.</p> <div class="alert alert-info note callout" role="alert"> <strong>Note:</strong> The example conversion webhook server leaves the <code>ClientAuth</code> field <a href="https://github.com/kubernetes/kubernetes/tree/v1.13.0/test/images/crd-conversion-webhook/config.go#L47-L48">empty</a>, which defaults to <code>NoClientCert</code>. This means that the webhook server does not authenticate the identity of the clients, supposedly API servers. If you need mutual TLS or other ways to authenticate the clients, see how to <a href="../../../../reference/access-authn-authz/extensible-admission-controllers/index#authenticate-apiservers">authenticate API servers</a>. </div> <h4 id="permissible-mutations">Permissible mutations</h4> <p>A conversion webhook must not mutate anything inside of <code>metadata</code> of the converted object other than <code>labels</code> and <code>annotations</code>. Attempted changes to <code>name</code>, <code>UID</code> and <code>namespace</code> are rejected and fail the request which caused the conversion. All other changes are ignored.</p> <h3 id="deploy-the-conversion-webhook-service">Deploy the conversion webhook service</h3> <p>Documentation for deploying the conversion webhook is the same as for the <a href="../../../../reference/access-authn-authz/extensible-admission-controllers/index#deploy_the_admission_webhook_service">admission webhook example service</a>. The assumption for next sections is that the conversion webhook server is deployed to a service named <code>example-conversion-webhook-server</code> in <code>default</code> namespace and serving traffic on path <code>/crdconvert</code>.</p> <div class="alert alert-info note callout" role="alert"> <strong>Note:</strong> When the webhook server is deployed into the Kubernetes cluster as a service, it has to be exposed via a service on port 443 (The server itself can have an arbitrary port but the service object should map it to port 443). The communication between the API server and the webhook service may fail if a different port is used for the service. </div> <h3 id="configure-customresourcedefinition-to-use-conversion-webhooks">Configure CustomResourceDefinition to use conversion webhooks</h3> <p>The <code>None</code> conversion example can be extended to use the conversion webhook by modifying <code>conversion</code> section of the <code>spec</code>:</p> <ul class="nav nav-tabs" id="customresourcedefinition-versioning-example-2" role="tablist">
<li class="nav-item"><a data-toggle="tab" class="nav-link active" href="#customresourcedefinition-versioning-example-2-0" role="tab" aria-controls="customresourcedefinition-versioning-example-2-0" aria-selected="true">apiextensions.k8s.io/v1</a></li> <li class="nav-item"><a data-toggle="tab" class="nav-link" href="#customresourcedefinition-versioning-example-2-1" role="tab" aria-controls="customresourcedefinition-versioning-example-2-1">apiextensions.k8s.io/v1beta1</a></li>
</ul> <div class="tab-content" id="customresourcedefinition-versioning-example-2">
<div id="customresourcedefinition-versioning-example-2-0" class="tab-pane show active" role="tabpanel" aria-labelledby="customresourcedefinition-versioning-example-2-0"> 
<pre class="highlight" data-language="yaml">apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
metadata:
  # name must match the spec fields below, and be in the form: &lt;plural&gt;.&lt;group&gt;
  name: crontabs.example.com
spec:
  # group name to use for REST API: /apis/&lt;group&gt;/&lt;version&gt;
  group: example.com
  # list of versions supported by this CustomResourceDefinition
  versions:
  - name: v1beta1
    # Each version can be enabled/disabled by Served flag.
    served: true
    # One and only one version must be marked as the storage version.
    storage: true
    # Each version can define it's own schema when there is no top-level
    # schema is defined.
    schema:
      openAPIV3Schema:
        type: object
        properties:
          hostPort:
            type: string
  - name: v1
    served: true
    storage: false
    schema:
      openAPIV3Schema:
        type: object
        properties:
          host:
            type: string
          port:
            type: string
  conversion:
    # a Webhook strategy instruct API server to call an external webhook for any conversion between custom resources.
    strategy: Webhook
    # webhook is required when strategy is `Webhook` and it configures the webhook endpoint to be called by API server.
    webhook:
      # conversionReviewVersions indicates what ConversionReview versions are understood/preferred by the webhook.
      # The first version in the list understood by the API server is sent to the webhook.
      # The webhook must respond with a ConversionReview object in the same version it received.
      conversionReviewVersions: ["v1","v1beta1"]
      clientConfig:
        service:
          namespace: default
          name: example-conversion-webhook-server
          path: /crdconvert
        caBundle: "Ci0tLS0tQk...&lt;base64-encoded PEM bundle&gt;...tLS0K"
  # either Namespaced or Cluster
  scope: Namespaced
  names:
    # plural name to be used in the URL: /apis/&lt;group&gt;/&lt;version&gt;/&lt;plural&gt;
    plural: crontabs
    # singular name to be used as an alias on the CLI and for display
    singular: crontab
    # kind is normally the CamelCased singular type. Your resource manifests use this.
    kind: CronTab
    # shortNames allow shorter string to match your resource on the CLI
    shortNames:
    - ct
</pre>
</div> <div id="customresourcedefinition-versioning-example-2-1" class="tab-pane" role="tabpanel" aria-labelledby="customresourcedefinition-versioning-example-2-1"> 
<pre class="highlight" data-language="yaml"># Deprecated in v1.16 in favor of apiextensions.k8s.io/v1
apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
  # name must match the spec fields below, and be in the form: &lt;plural&gt;.&lt;group&gt;
  name: crontabs.example.com
spec:
  # group name to use for REST API: /apis/&lt;group&gt;/&lt;version&gt;
  group: example.com
  # prunes object fields that are not specified in OpenAPI schemas below.
  preserveUnknownFields: false
  # list of versions supported by this CustomResourceDefinition
  versions:
  - name: v1beta1
    # Each version can be enabled/disabled by Served flag.
    served: true
    # One and only one version must be marked as the storage version.
    storage: true
    # Each version can define it's own schema when there is no top-level
    # schema is defined.
    schema:
      openAPIV3Schema:
        type: object
        properties:
          hostPort:
            type: string
  - name: v1
    served: true
    storage: false
    schema:
      openAPIV3Schema:
        type: object
        properties:
          host:
            type: string
          port:
            type: string
  conversion:
    # a Webhook strategy instruct API server to call an external webhook for any conversion between custom resources.
    strategy: Webhook
    # webhookClientConfig is required when strategy is `Webhook` and it configures the webhook endpoint to be called by API server.
    webhookClientConfig:
      service:
        namespace: default
        name: example-conversion-webhook-server
        path: /crdconvert
      caBundle: "Ci0tLS0tQk...&lt;base64-encoded PEM bundle&gt;...tLS0K"
  # either Namespaced or Cluster
  scope: Namespaced
  names:
    # plural name to be used in the URL: /apis/&lt;group&gt;/&lt;version&gt;/&lt;plural&gt;
    plural: crontabs
    # singular name to be used as an alias on the CLI and for display
    singular: crontab
    # kind is normally the CamelCased singular type. Your resource manifests use this.
    kind: CronTab
    # shortNames allow shorter string to match your resource on the CLI
    shortNames:
    - ct
</pre>
</div>
</div> <p>You can save the CustomResourceDefinition in a YAML file, then use <code>kubectl apply</code> to apply it.</p> <pre class="highlight" data-language="shell">kubectl apply -f my-versioned-crontab-with-conversion.yaml
</pre>
<p>Make sure the conversion service is up and running before applying new changes.</p> <h3 id="contacting-the-webhook">Contacting the webhook</h3> <p>Once the API server has determined a request should be sent to a conversion webhook, it needs to know how to contact the webhook. This is specified in the <code>webhookClientConfig</code> stanza of the webhook configuration.</p> <p>Conversion webhooks can either be called via a URL or a service reference, and can optionally include a custom CA bundle to use to verify the TLS connection.</p> <h3 id="url">URL</h3> <p><code>url</code> gives the location of the webhook, in standard URL form (<code>scheme://host:port/path</code>).</p> <p>The <code>host</code> should not refer to a service running in the cluster; use a service reference by specifying the <code>service</code> field instead. The host might be resolved via external DNS in some apiservers (i.e., <code>kube-apiserver</code> cannot resolve in-cluster DNS as that would be a layering violation). <code>host</code> may also be an IP address.</p> <p>Please note that using <code>localhost</code> or <code>127.0.0.1</code> as a <code>host</code> is risky unless you take great care to run this webhook on all hosts which run an apiserver which might need to make calls to this webhook. Such installations are likely to be non-portable or not readily run in a new cluster.</p> <p>The scheme must be "https"; the URL must begin with "https://".</p> <p>Attempting to use a user or basic auth (for example "user:password@") is not allowed. Fragments ("#...") and query parameters ("?...") are also not allowed.</p> <p>Here is an example of a conversion webhook configured to call a URL (and expects the TLS certificate to be verified using system trust roots, so does not specify a caBundle):</p> <ul class="nav nav-tabs" id="customresourcedefinition-versioning-example-3" role="tablist">
<li class="nav-item"><a data-toggle="tab" class="nav-link active" href="#customresourcedefinition-versioning-example-3-0" role="tab" aria-controls="customresourcedefinition-versioning-example-3-0" aria-selected="true">apiextensions.k8s.io/v1</a></li> <li class="nav-item"><a data-toggle="tab" class="nav-link" href="#customresourcedefinition-versioning-example-3-1" role="tab" aria-controls="customresourcedefinition-versioning-example-3-1">apiextensions.k8s.io/v1beta1</a></li>
</ul> <div class="tab-content" id="customresourcedefinition-versioning-example-3">
<div id="customresourcedefinition-versioning-example-3-0" class="tab-pane show active" role="tabpanel" aria-labelledby="customresourcedefinition-versioning-example-3-0"> 
<pre class="highlight" data-language="yaml">apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
...
spec:
  ...
  conversion:
    strategy: Webhook
    webhook:
      clientConfig:
        url: "https://my-webhook.example.com:9443/my-webhook-path"
...
</pre>
</div> <div id="customresourcedefinition-versioning-example-3-1" class="tab-pane" role="tabpanel" aria-labelledby="customresourcedefinition-versioning-example-3-1"> 
<pre class="highlight" data-language="yaml"># Deprecated in v1.16 in favor of apiextensions.k8s.io/v1
apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
...
spec:
  ...
  conversion:
    strategy: Webhook
    webhookClientConfig:
      url: "https://my-webhook.example.com:9443/my-webhook-path"
...
</pre>
</div>
</div> <h3 id="service-reference">Service Reference</h3> <p>The <code>service</code> stanza inside <code>webhookClientConfig</code> is a reference to the service for a conversion webhook. If the webhook is running within the cluster, then you should use <code>service</code> instead of <code>url</code>. The service namespace and name are required. The port is optional and defaults to 443. The path is optional and defaults to "/".</p> <p>Here is an example of a webhook that is configured to call a service on port "1234" at the subpath "/my-path", and to verify the TLS connection against the ServerName <code>my-service-name.my-service-namespace.svc</code> using a custom CA bundle.</p> <ul class="nav nav-tabs" id="customresourcedefinition-versioning-example-4" role="tablist">
<li class="nav-item"><a data-toggle="tab" class="nav-link active" href="#customresourcedefinition-versioning-example-4-0" role="tab" aria-controls="customresourcedefinition-versioning-example-4-0" aria-selected="true">apiextensions.k8s.io/v1</a></li> <li class="nav-item"><a data-toggle="tab" class="nav-link" href="#customresourcedefinition-versioning-example-4-1" role="tab" aria-controls="customresourcedefinition-versioning-example-4-1">apiextensions.k8s.io/v1beta1</a></li>
</ul> <div class="tab-content" id="customresourcedefinition-versioning-example-4">
<div id="customresourcedefinition-versioning-example-4-0" class="tab-pane show active" role="tabpanel" aria-labelledby="customresourcedefinition-versioning-example-4-0"> 
<pre class="highlight" data-language="yaml">apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
...
spec:
  ...
  conversion:
    strategy: Webhook
    webhook:
      clientConfig:
        service:
          namespace: my-service-namespace
          name: my-service-name
          path: /my-path
          port: 1234
        caBundle: "Ci0tLS0tQk...&lt;base64-encoded PEM bundle&gt;...tLS0K"
...
</pre>
</div> <div id="customresourcedefinition-versioning-example-4-1" class="tab-pane" role="tabpanel" aria-labelledby="customresourcedefinition-versioning-example-4-1"> 
<pre class="highlight" data-language="yaml"># Deprecated in v1.16 in favor of apiextensions.k8s.io/v1
apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
...
spec:
  ...
  conversion:
    strategy: Webhook
    webhookClientConfig:
      service:
        namespace: my-service-namespace
        name: my-service-name
        path: /my-path
        port: 1234
      caBundle: "Ci0tLS0tQk...&lt;base64-encoded PEM bundle&gt;...tLS0K"
...
</pre>
</div>
</div> <h2 id="webhook-request-and-response">Webhook request and response</h2> <h3 id="request">Request</h3> <p>Webhooks are sent a POST request, with <code>Content-Type: application/json</code>, with a <code>ConversionReview</code> API object in the <code>apiextensions.k8s.io</code> API group serialized to JSON as the body.</p> <p>Webhooks can specify what versions of <code>ConversionReview</code> objects they accept with the <code>conversionReviewVersions</code> field in their CustomResourceDefinition:</p> <ul class="nav nav-tabs" id="conversionreviewversions" role="tablist">
<li class="nav-item"><a data-toggle="tab" class="nav-link active" href="#conversionreviewversions-0" role="tab" aria-controls="conversionreviewversions-0" aria-selected="true">apiextensions.k8s.io/v1</a></li> <li class="nav-item"><a data-toggle="tab" class="nav-link" href="#conversionreviewversions-1" role="tab" aria-controls="conversionreviewversions-1">apiextensions.k8s.io/v1beta1</a></li>
</ul> <div class="tab-content" id="conversionreviewversions">
<div id="conversionreviewversions-0" class="tab-pane show active" role="tabpanel" aria-labelledby="conversionreviewversions-0"> 
<pre class="highlight" data-language="yaml">apiVersion: apiextensions.k8s.io/v1
kind: CustomResourceDefinition
...
spec:
  ...
  conversion:
    strategy: Webhook
    webhook:
      conversionReviewVersions: ["v1", "v1beta1"]
      ...
</pre>
<p><code>conversionReviewVersions</code> is a required field when creating <code>apiextensions.k8s.io/v1</code> custom resource definitions. Webhooks are required to support at least one <code>ConversionReview</code> version understood by the current and previous API server.</p> </div> <div id="conversionreviewversions-1" class="tab-pane" role="tabpanel" aria-labelledby="conversionreviewversions-1"> 
<pre class="highlight" data-language="yaml"># Deprecated in v1.16 in favor of apiextensions.k8s.io/v1
apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
...
spec:
  ...
  conversion:
    strategy: Webhook
    conversionReviewVersions: ["v1", "v1beta1"]
    ...
</pre>
<p>If no <code>conversionReviewVersions</code> are specified, the default when creating <code>apiextensions.k8s.io/v1beta1</code> custom resource definitions is <code>v1beta1</code>.</p> </div>
</div> <p>API servers send the first <code>ConversionReview</code> version in the <code>conversionReviewVersions</code> list they support. If none of the versions in the list are supported by the API server, the custom resource definition will not be allowed to be created. If an API server encounters a conversion webhook configuration that was previously created and does not support any of the <code>ConversionReview</code> versions the API server knows how to send, attempts to call to the webhook will fail.</p> <p>This example shows the data contained in an <code>ConversionReview</code> object for a request to convert <code>CronTab</code> objects to <code>example.com/v1</code>:</p> <ul class="nav nav-tabs" id="conversionreview-request" role="tablist">
<li class="nav-item"><a data-toggle="tab" class="nav-link active" href="#conversionreview-request-0" role="tab" aria-controls="conversionreview-request-0" aria-selected="true">apiextensions.k8s.io/v1</a></li> <li class="nav-item"><a data-toggle="tab" class="nav-link" href="#conversionreview-request-1" role="tab" aria-controls="conversionreview-request-1">apiextensions.k8s.io/v1beta1</a></li>
</ul> <div class="tab-content" id="conversionreview-request">
<div id="conversionreview-request-0" class="tab-pane show active" role="tabpanel" aria-labelledby="conversionreview-request-0"> 
<pre class="highlight" data-language="yaml">{
  "apiVersion": "apiextensions.k8s.io/v1",
  "kind": "ConversionReview",
  "request": {
    # Random uid uniquely identifying this conversion call
    "uid": "705ab4f5-6393-11e8-b7cc-42010a800002",
    
    # The API group and version the objects should be converted to
    "desiredAPIVersion": "example.com/v1",
    
    # The list of objects to convert.
    # May contain one or more objects, in one or more versions.
    "objects": [
      {
        "kind": "CronTab",
        "apiVersion": "example.com/v1beta1",
        "metadata": {
          "creationTimestamp": "2019-09-04T14:03:02Z",
          "name": "local-crontab",
          "namespace": "default",
          "resourceVersion": "143",
          "uid": "3415a7fc-162b-4300-b5da-fd6083580d66"
        },
        "hostPort": "localhost:1234"
      },
      {
        "kind": "CronTab",
        "apiVersion": "example.com/v1beta1",
        "metadata": {
          "creationTimestamp": "2019-09-03T13:02:01Z",
          "name": "remote-crontab",
          "resourceVersion": "12893",
          "uid": "359a83ec-b575-460d-b553-d859cedde8a0"
        },
        "hostPort": "example.com:2345"
      }
    ]
  }
}
</pre>
</div> <div id="conversionreview-request-1" class="tab-pane" role="tabpanel" aria-labelledby="conversionreview-request-1"> 
<pre class="highlight" data-language="yaml">{
  # Deprecated in v1.16 in favor of apiextensions.k8s.io/v1
  "apiVersion": "apiextensions.k8s.io/v1beta1",
  "kind": "ConversionReview",
  "request": {
    # Random uid uniquely identifying this conversion call
    "uid": "705ab4f5-6393-11e8-b7cc-42010a800002",
    
    # The API group and version the objects should be converted to
    "desiredAPIVersion": "example.com/v1",
    
    # The list of objects to convert.
    # May contain one or more objects, in one or more versions.
    "objects": [
      {
        "kind": "CronTab",
        "apiVersion": "example.com/v1beta1",
        "metadata": {
          "creationTimestamp": "2019-09-04T14:03:02Z",
          "name": "local-crontab",
          "namespace": "default",
          "resourceVersion": "143",
          "uid": "3415a7fc-162b-4300-b5da-fd6083580d66"
        },
        "hostPort": "localhost:1234"
      },
      {
        "kind": "CronTab",
        "apiVersion": "example.com/v1beta1",
        "metadata": {
          "creationTimestamp": "2019-09-03T13:02:01Z",
          "name": "remote-crontab",
          "resourceVersion": "12893",
          "uid": "359a83ec-b575-460d-b553-d859cedde8a0"
        },
        "hostPort": "example.com:2345"
      }
    ]
  }
}
</pre>
</div>
</div> <h3 id="response">Response</h3> <p>Webhooks respond with a 200 HTTP status code, <code>Content-Type: application/json</code>, and a body containing a <code>ConversionReview</code> object (in the same version they were sent), with the <code>response</code> stanza populated, serialized to JSON.</p> <p>If conversion succeeds, a webhook should return a <code>response</code> stanza containing the following fields:</p> <ul> <li>
<code>uid</code>, copied from the <code>request.uid</code> sent to the webhook</li> <li>
<code>result</code>, set to <code>{"status":"Success"}</code>
</li> <li>
<code>convertedObjects</code>, containing all of the objects from <code>request.objects</code>, converted to <code>request.desiredVersion</code>
</li> </ul> <p>Example of a minimal successful response from a webhook:</p> <ul class="nav nav-tabs" id="conversionreview-response-success" role="tablist">
<li class="nav-item"><a data-toggle="tab" class="nav-link active" href="#conversionreview-response-success-0" role="tab" aria-controls="conversionreview-response-success-0" aria-selected="true">apiextensions.k8s.io/v1</a></li> <li class="nav-item"><a data-toggle="tab" class="nav-link" href="#conversionreview-response-success-1" role="tab" aria-controls="conversionreview-response-success-1">apiextensions.k8s.io/v1beta1</a></li>
</ul> <div class="tab-content" id="conversionreview-response-success">
<div id="conversionreview-response-success-0" class="tab-pane show active" role="tabpanel" aria-labelledby="conversionreview-response-success-0"> 
<pre class="highlight" data-language="yaml">{
  "apiVersion": "apiextensions.k8s.io/v1",
  "kind": "ConversionReview",
  "response": {
    # must match &lt;request.uid&gt;
    "uid": "705ab4f5-6393-11e8-b7cc-42010a800002",
    "result": {
      "status": "Success"
    },
    # Objects must match the order of request.objects, and have apiVersion set to &lt;request.desiredAPIVersion&gt;.
    # kind, metadata.uid, metadata.name, and metadata.namespace fields must not be changed by the webhook.
    # metadata.labels and metadata.annotations fields may be changed by the webhook.
    # All other changes to metadata fields by the webhook are ignored.
    "convertedObjects": [
      {
        "kind": "CronTab",
        "apiVersion": "example.com/v1",
        "metadata": {
          "creationTimestamp": "2019-09-04T14:03:02Z",
          "name": "local-crontab",
          "namespace": "default",
          "resourceVersion": "143",
          "uid": "3415a7fc-162b-4300-b5da-fd6083580d66"
        },
        "host": "localhost",
        "port": "1234"
      },
      {
        "kind": "CronTab",
        "apiVersion": "example.com/v1",
        "metadata": {
          "creationTimestamp": "2019-09-03T13:02:01Z",
          "name": "remote-crontab",
          "resourceVersion": "12893",
          "uid": "359a83ec-b575-460d-b553-d859cedde8a0"
        },
        "host": "example.com",
        "port": "2345"
      }
    ]
  }
}
</pre>
</div> <div id="conversionreview-response-success-1" class="tab-pane" role="tabpanel" aria-labelledby="conversionreview-response-success-1"> 
<pre class="highlight" data-language="yaml">{
  # Deprecated in v1.16 in favor of apiextensions.k8s.io/v1
  "apiVersion": "apiextensions.k8s.io/v1beta1",
  "kind": "ConversionReview",
  "response": {
    # must match &lt;request.uid&gt;
    "uid": "705ab4f5-6393-11e8-b7cc-42010a800002",
    "result": {
      "status": "Failed"
    },
    # Objects must match the order of request.objects, and have apiVersion set to &lt;request.desiredAPIVersion&gt;.
    # kind, metadata.uid, metadata.name, and metadata.namespace fields must not be changed by the webhook.
    # metadata.labels and metadata.annotations fields may be changed by the webhook.
    # All other changes to metadata fields by the webhook are ignored.
    "convertedObjects": [
      {
        "kind": "CronTab",
        "apiVersion": "example.com/v1",
        "metadata": {
          "creationTimestamp": "2019-09-04T14:03:02Z",
          "name": "local-crontab",
          "namespace": "default",
          "resourceVersion": "143",
          "uid": "3415a7fc-162b-4300-b5da-fd6083580d66"
        },
        "host": "localhost",
        "port": "1234"
      },
      {
        "kind": "CronTab",
        "apiVersion": "example.com/v1",
        "metadata": {
          "creationTimestamp": "2019-09-03T13:02:01Z",
          "name": "remote-crontab",
          "resourceVersion": "12893",
          "uid": "359a83ec-b575-460d-b553-d859cedde8a0"
        },
        "host": "example.com",
        "port": "2345"
      }
    ]
  }
}
</pre>
</div>
</div> <p>If conversion fails, a webhook should return a <code>response</code> stanza containing the following fields:</p> <ul> <li>
<code>uid</code>, copied from the <code>request.uid</code> sent to the webhook</li> <li>
<code>result</code>, set to <code>{"status":"Failed"}</code>
</li> </ul> <div class="alert alert-danger warning callout" role="alert"> <strong>Warning:</strong> Failing conversion can disrupt read and write access to the custom resources, including the ability to update or delete the resources. Conversion failures should be avoided whenever possible, and should not be used to enforce validation constraints (use validation schemas or webhook admission instead). </div> <p>Example of a response from a webhook indicating a conversion request failed, with an optional message: </p>
<ul class="nav nav-tabs" id="conversionreview-response-failure" role="tablist">
<li class="nav-item"><a data-toggle="tab" class="nav-link active" href="#conversionreview-response-failure-0" role="tab" aria-controls="conversionreview-response-failure-0" aria-selected="true">apiextensions.k8s.io/v1</a></li> <li class="nav-item"><a data-toggle="tab" class="nav-link" href="#conversionreview-response-failure-1" role="tab" aria-controls="conversionreview-response-failure-1">apiextensions.k8s.io/v1beta1</a></li>
</ul> <div class="tab-content" id="conversionreview-response-failure">
<div id="conversionreview-response-failure-0" class="tab-pane show active" role="tabpanel" aria-labelledby="conversionreview-response-failure-0"> 
<pre class="highlight" data-language="yaml">{
  "apiVersion": "apiextensions.k8s.io/v1",
  "kind": "ConversionReview",
  "response": {
    "uid": "&lt;value from request.uid&gt;",
    "result": {
      "status": "Failed",
      "message": "hostPort could not be parsed into a separate host and port"
    }
  }
}
</pre>
</div> <div id="conversionreview-response-failure-1" class="tab-pane" role="tabpanel" aria-labelledby="conversionreview-response-failure-1"> 
<pre class="highlight" data-language="yaml">{
  # Deprecated in v1.16 in favor of apiextensions.k8s.io/v1
  "apiVersion": "apiextensions.k8s.io/v1beta1",
  "kind": "ConversionReview",
  "response": {
    "uid": "&lt;value from request.uid&gt;",
    "result": {
      "status": "Failed",
      "message": "hostPort could not be parsed into a separate host and port"
    }
  }
}
</pre>
</div>
</div> <h2 id="writing-reading-and-updating-versioned-customresourcedefinition-objects">Writing, reading, and updating versioned CustomResourceDefinition objects</h2> <p>When an object is written, it is persisted at the version designated as the storage version at the time of the write. If the storage version changes, existing objects are never converted automatically. However, newly-created or updated objects are written at the new storage version. It is possible for an object to have been written at a version that is no longer served.</p> <p>When you read an object, you specify the version as part of the path. If you specify a version that is different from the object's persisted version, Kubernetes returns the object to you at the version you requested, but the persisted object is neither changed on disk, nor converted in any way (other than changing the <code>apiVersion</code> string) while serving the request. You can request an object at any version that is currently served.</p> <p>If you update an existing object, it is rewritten at the version that is currently the storage version. This is the only way that objects can change from one version to another.</p> <p>To illustrate this, consider the following hypothetical series of events:</p> <ol> <li>The storage version is <code>v1beta1</code>. You create an object. It is persisted in storage at version <code>v1beta1</code>
</li> <li>You add version <code>v1</code> to your CustomResourceDefinition and designate it as the storage version.</li> <li>You read your object at version <code>v1beta1</code>, then you read the object again at version <code>v1</code>. Both returned objects are identical except for the apiVersion field.</li> <li>You create a new object. It is persisted in storage at version <code>v1</code>. You now have two objects, one of which is at <code>v1beta1</code>, and the other of which is at <code>v1</code>.</li> <li>You update the first object. It is now persisted at version <code>v1</code> since that is the current storage version.</li> </ol> <h3 id="previous-storage-versions">Previous storage versions</h3> <p>The API server records each version which has ever been marked as the storage version in the status field <code>storedVersions</code>. Objects may have been persisted at any version that has ever been designated as a storage version. No objects can exist in storage at a version that has never been a storage version.</p> <h2 id="upgrade-existing-objects-to-a-new-stored-version">Upgrade existing objects to a new stored version</h2> <p>When deprecating versions and dropping support, select a storage upgrade procedure.</p> <p><em>Option 1:</em> Use the Storage Version Migrator</p> <ol> <li>Run the <a href="https://github.com/kubernetes-sigs/kube-storage-version-migrator">storage Version migrator</a>
</li> <li>Remove the old version from the CustomResourceDefinition <code>status.storedVersions</code> field.</li> </ol> <p><em>Option 2:</em> Manually upgrade the existing objects to a new stored version</p> <p>The following is an example procedure to upgrade from <code>v1beta1</code> to <code>v1</code>.</p> <ol> <li>Set <code>v1</code> as the storage in the CustomResourceDefinition file and apply it using kubectl. The <code>storedVersions</code> is now <code>v1beta1, v1</code>.</li> <li>Write an upgrade procedure to list all existing objects and write them with the same content. This forces the backend to write objects in the current storage version, which is <code>v1</code>.</li> <li>Remove <code>v1beta1</code> from the CustomResourceDefinition <code>status.storedVersions</code> field.</li> </ol> <div class="alert alert-info note callout" role="alert"> <strong>Note:</strong> <p>The <code>kubectl</code> tool currently cannot be used to edit or patch the <code>status</code> subresource on a CRD: see the <a href="https://github.com/kubernetes/enhancements/tree/master/keps/sig-cli/2590-kubectl-subresource">Kubectl Subresource Support KEP</a> for more details.</p> <p>The easier way to patch the status subresource from the CLI is directly interacting with the API server using the <code>curl</code> tool, in this example:</p> <pre class="highlight" data-language="bash">kubectl proxy &amp;
curl --header "Content-Type: application/json-patch+json" \
  --request PATCH http://localhost:8001/apis/apiextensions.k8s.io/v1/customresourcedefinitions/&lt;your CRD name here&gt;/status \
  --data '[{"op": "replace", "path": "/status/storedVersions", "value":["v1"]}]'
</pre> </div>
<div class="_attribution">
  <p class="_attribution-p">
    © 2022 The Kubernetes Authors<br>Documentation Distributed under CC BY 4.0.<br>
    <a href="https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definition-versioning/" class="_attribution-link">https://kubernetes.io/docs/tasks/extend-kubernetes/custom-resources/custom-resource-definition-versioning/</a>
  </p>
</div>

				
			</div>
			<ins class="adsbygoogle"
     style="display:block"
     data-ad-client="ca-pub-2572770204602497"
     data-ad-slot="1992473792"
     data-ad-format="auto"
     data-full-width-responsive="true"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
		</div>
	</section>

	</div>
	<svg style="display:none">
		<symbol id="icon-dir"><svg viewBox="0 0 20 20"><path d="M15 10c0 .3-.305.515-.305.515l-8.56 5.303c-.625.41-1.135.106-1.135-.67V4.853c0-.777.51-1.078 1.135-.67l8.56 5.305S15 9.702 15 10z"/></svg></symbol>
	  </svg>
</body>
</html>
